# 程序策划书：批量提示词生成（电商产品图）

版本：v1.0

## 1. 项目概述
现有电商图生成流程依赖手工编写提示词，效率低且一致性不稳定。本项目在“产品库 + 电商图生成”基础上新增“批量提示词生成”能力：用户选择产品图作为主体，上传参考图片/文本，由LLM反向分析摄影要素并生成结构化提示词，支持编辑与批量选择，最终批量触发产品图生成。

## 2. 目标与成功指标
**目标**
- 支持多参考对象并行分析，缩短提示词生成时长。
- 以结构化字段输出并以中文表单展示，避免JSON直出。
- 支持编辑、选择与批量生成流程联动。

**成功指标（KPI）**
- 30秒内生成≥5条提示词（多参考并行）。
- ≥70%提示词仅需轻微修改即可使用。
- 批量生成流程可连续完成且具备进度与错误反馈。

## 3. 范围与非目标
**范围**
- 单产品场景下的批量提示词生成、编辑与选择。
- 参考对象：多图上传（JPEG/PNG，≤10MB）、多行文本。
- 与产品属性上下文联动生成中文提示词。

**非目标**
- 实时生成/边输入边生成。
- 提示词持久化与历史管理。
- 多产品同时批量生成。

## 4. 用户角色与核心场景
**用户角色**：电商运营、商品摄影/设计、内容制作人员。

**核心场景**
1) 用户选择产品与产品图作为主体；
2) 上传多张参考图片或输入参考文本；
3) 触发提示词生成，系统并行分析并返回结构化提示词；
4) 用户在卡片中编辑字段，查看“完整提示词预览”；
5) 选择多条提示词并批量生成产品图，查看进度与错误。

## 5. 需求说明（功能性）
### 5.1 参考对象输入
- 支持多张图片上传，预览网格展示，可逐张删除。
- 支持多行文本输入并作为独立参考项处理。
- 支持图片格式JPEG/PNG，单张≤10MB。

### 5.2 LLM配置与初始化
- 从`.env`读取`API_BASE_URL`、`API_KEY`、`LLM_MODEL`。
- 后端服务启动即初始化LLM客户端并全局复用。

### 5.3 LLM提示词抽取
- 图像分析抽取：场景、角度、光线、风格、构图、背景、道具、氛围、置信度。
- 文本分析抽取：根据描述推断摄影要素并生成同结构字段。
- 结合产品上下文（名称、尺寸、特性、特征）生成完整提示词。

### 5.4 结构化输出
**字段定义**
- `id`：唯一标识
- `scene`/`angle`/`lighting`/`style`/`composition`/`background`/`props`/`mood`
- `fullPrompt`：组合后的完整中文提示词
- `confidence`：0.0-1.0
- `sourceType`：image|text
- `sourceIndex`：参考对象索引

### 5.5 提示词展示与选择
- 卡片化展示，中文标签输入字段，不显示JSON。
- 置信度以进度条与百分比展示（绿>70%、黄50-70%、红<50%）。
- 支持点击卡片选择/取消选择，支持全选/取消全选。

### 5.6 提示词编辑
- 进入编辑模式后，字段可编辑并实时更新“完整提示词预览”。
- 支持取消编辑，恢复原值。

### 5.7 批量生成
- 选中提示词后批量触发生成接口。
- 使用产品图作为主体，逐条提示词生成；显示进度与失败信息。

## 6. 交互与界面设计
### 6.1 页面结构与组件树
- BatchPromptPage
  - ProductSelector（复用）
  - ReferenceInputPanel（图片拖拽 + 文本输入）
  - GenerateButton
  - PromptResultsPanel
    - PromptCard × N
    - BatchActionBar（全选/取消全选/生成）
  - GenerationProgressModal

### 6.2 PromptCard展示要点
- 顶部显示来源（图片/文本 + 索引）与置信度。
- 每个字段以中文标签+输入框展示，props为逗号分隔。
- “完整提示词预览”使用只读文本框。
- 操作区：编辑/复制/选择。

### 6.3 前端状态
```ts
interface BatchPromptState {
  selectedProduct: Product | null;
  selectedProductImages: string[];
  referenceImages: File[];
  referenceTexts: string[];
  generatedPrompts: GeneratedPrompt[];
  selectedPromptIds: string[];
  isGenerating: boolean;
  generationProgress: number;
  generationError: string | null;
  editingPromptId: string | null;
  editedPrompts: Map<string, Partial<GeneratedPrompt>>;
}
```

## 7. 系统架构与数据流
### 7.1 架构概述
- 前端（Vue 3）：输入、展示、编辑与批量选择。
- 后端（FastAPI）：提示词生成服务、并行LLM调用、聚合输出。
- LLM服务：图像/文本结构化分析。

### 7.2 API设计
**接口**：`POST /api/v1/prompts/generate`（multipart/form-data）
- `product_id`（必填）
- `references`（可选，File[]）
- `reference_texts`（可选，string[]）
- `options`（可选，JSON string）
  - `language`（默认zh）
  - `include_product_context`（默认true）

**响应**：`{ prompts: GeneratedPrompt[], metadata }`
- `metadata`包含处理耗时、成功/失败数量等。

### 7.3 数据模型
- `ReferenceType`：image|text
- `GeneratedPrompt`：结构化字段 + fullPrompt + confidence + source
- `PromptGenerationRequest/Response`

## 8. 关键流程说明
1) 产品选择 → 参考输入 → 触发生成
2) 后端校验与预处理 → 并行LLM分析 → 聚合结构化结果
3) 前端卡片展示 → 编辑与选择 → 批量生成

## 9. 非功能要求
**性能**
- 参考对象并行处理，建议最大并发5。
- 图片>2MB时压缩后分析。
- 逐步加载提示词结果并显示生成进度。

**错误处理**
- 未选产品/未提供参考：禁用生成按钮并提示。
- 部分LLM失败：成功结果仍返回并标注失败。
- 全部失败：显示错误并允许重试。

**安全**
- 文件类型/大小校验。
- 速率限制与重试退避。
- 用户隔离与内容安全过滤（如有需要）。

## 10. 实施计划与里程碑
**M1 后端基础（1.1-1.5）**
- Schema、LLM提示词、并行服务、API接口、路由注册。

**M2 参考输入与页面结构（2.1-2.3）**
- 参考输入面板、页面框架、产品选择复用。

**M3 提示词生成与展示（3.1-3.3）**
- API联调、PromptCard、结果面板与多选。

**M4 编辑与批量操作（4.1-4.2）**
- 编辑模式、批量操作栏与全选。

**M5 生成集成（5.1-5.2）**
- 批量生成接口调用与进度弹窗。

**M6 质量与测试（6.1-6.4）**
- 错误处理、加载态、集成测试、导航路由。

## 11. 验收标准
- 满足功能需求：多参考输入、结构化输出、中文表单展示、编辑与批量生成。
- 端到端流程可跑通：选产品→上传参考→生成提示词→编辑→批量生成。
- 支持并行处理与部分失败容错。
- 界面不展示JSON，字段完整且可编辑。

## 12. 风险与对策
- **LLM质量不稳定**：保留编辑能力；置信度提示。
- **处理时间过长**：并行处理、压缩与进度提示。
- **限流**：并发上限与退避重试。

## 13. 依赖与资源
- 既有产品库模块与产品属性信息。
- 现有LLM客户端（StructLLM）与`.env`配置。
- 既有图像生成API。
