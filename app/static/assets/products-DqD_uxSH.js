import{d as K,r as u,j as Y,k as Z,o as ee,c as i,a as l,b as s,e as p,f as te,t as d,w as M,v as U,F as se,l as ae,g as ne}from"./runtime-dom.esm-bundler-8m2sFMtS.js";import{g as oe}from"./auth-DhJl3iPe.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                   */function le(T,O){const r=`; ${document.cookie||""}`.split(`; ${T}=`);return r.length===2&&r.pop().split(";").shift()||null}function re(){const T=le("csrf_token");return T?{"X-CSRF-Token":T}:{}}const ce={class:"products-page"},ue={class:"container"},de={class:"products-header"},ve={class:"header-actions"},me={key:0,href:"/admin",class:"btn btn-secondary",style:{"text-decoration":"none"}},fe={key:0,class:"card error-banner",style:{"margin-bottom":"18px"}},pe={key:1,class:"card success-banner",style:{"margin-bottom":"18px"}},he={class:"card"},ge={class:"card-title-row"},_e={style:{margin:"0"}},ye={class:"card-actions"},be={class:"form-grid",style:{"margin-top":"16px"}},we={class:"form-group"},xe=["disabled"],ke={class:"form-group"},Te={class:"preview-box"},Se=["src"],Ce={key:1,class:"preview-placeholder"},Pe={key:0,class:"form-hint"},je={class:"form-grid",style:{"margin-top":"8px"}},Ee={class:"form-group"},Me={class:"form-group"},Ue={class:"form-grid",style:{"margin-top":"8px"}},Oe={class:"form-group"},$e={class:"form-group"},Ae={class:"form-actions"},Ne=["disabled"],Le=["disabled"],De={class:"card"},Fe={class:"card-title-row"},Ie={class:"card-actions"},Ve={key:0,class:"loading"},Be={key:1},He={key:0,class:"empty-state"},Je={key:1,class:"products-grid"},Re={class:"product-thumb"},Ge=["src","alt"],Qe={class:"product-body"},We={class:"product-title"},Xe={class:"product-meta"},qe={key:0},ze={key:1},Ke={key:0,class:"product-meta"},Ye={class:"product-actions"},Ze=["disabled","onClick"],et=["disabled","onClick"],tt={key:2,class:"pagination"},st=["disabled"],at={class:"meta-text"},nt=["disabled"],ot=K({__name:"products-page",setup(T){const O=u(!1),S=u([]),$=u(!1),r=u(!1),C=u(""),P=u(""),c=u(0),v=u(20),w=u(0),A=u("");let I=null;const f=u(null),x=u(null),h=u(null),_=u(null),n=Y({name:"",dimensions:"",featuresText:"",characteristicsText:""}),N=Z(()=>!!h.value);function k(){C.value="",P.value=""}function y(t){C.value=t,P.value=""}function L(t){P.value=t,C.value=""}function B(t){try{return new Date(t).toLocaleString()}catch{return t}}function D(t){return t.split(`
`).map(e=>e.trim()).filter(Boolean)}function F(){f.value&&f.value.startsWith("blob:")&&URL.revokeObjectURL(f.value)}async function j(t){const e=await t.text();try{const a=JSON.parse(e),o=(a==null?void 0:a.detail)??(a==null?void 0:a.error)??(a==null?void 0:a.message)??e;if(typeof o=="string")return o;if(o&&typeof o=="object"){const g=o==null?void 0:o.message;return typeof g=="string"?g:JSON.stringify(o)}return String(o||`HTTP ${t.status}`)}catch{return e||`HTTP ${t.status}`}}async function E(t,e={}){const a=(e.method||"GET").toUpperCase(),o=new Headers(e.headers||{});if(!["GET","HEAD","OPTIONS"].includes(a))for(const[g,m]of Object.entries(re()))o.set(g,m);return fetch(t,{...e,headers:o,credentials:"include"})}async function b(){$.value=!0;try{const t=new URLSearchParams;t.set("offset",String(c.value)),t.set("limit",String(v.value)),A.value.trim()&&t.set("name",A.value.trim());const e=await E(`/api/v1/products?${t.toString()}`);if(!e.ok)throw new Error(await j(e));const a=await e.json();S.value=a.products,w.value=a.total,c.value=a.offset,v.value=a.limit}catch(t){y(t.message||String(t))}finally{$.value=!1}}async function H(t){const e=await E(`/api/v1/products/${t}`);if(!e.ok)throw new Error(await j(e));return await e.json()}function V(){k(),F(),f.value=null,x.value=null,h.value=null,_.value=null,n.name="",n.dimensions="",n.featuresText="",n.characteristicsText=""}function J(t){var o;const a=(o=t.target.files)==null?void 0:o[0];a&&(k(),x.value=a,h.value=null,_.value=null,F(),f.value=URL.createObjectURL(a))}async function R(){if(k(),!x.value){y("请先选择图片");return}r.value=!0;try{const t=new FormData;t.append("image",x.value);const e=n.name.trim();e&&t.append("name",e),n.dimensions.trim()&&t.append("dimensions",n.dimensions.trim());const a=D(n.featuresText),o=D(n.characteristicsText);a.length&&t.append("features",JSON.stringify(a)),o.length&&t.append("characteristics",JSON.stringify(o));const g=await E("/api/v1/products",{method:"POST",body:t});if(!g.ok)throw new Error(await j(g));const m=await g.json();L(`创建成功（AI：${Math.round((m.recognition_confidence??0)*100)}%），可继续编辑后保存`),h.value=m.id,_.value=m.recognition_confidence??0,F(),f.value=m.original_image_url,x.value=null,n.name=m.name||"",n.dimensions=m.dimensions||"",n.featuresText=(m.features||[]).join(`
`),n.characteristicsText=(m.characteristics||[]).join(`
`),await b()}catch(t){y(t.message||String(t))}finally{r.value=!1}}async function G(){if(k(),!!h.value){if(!n.name.trim()){y("产品名称不能为空");return}r.value=!0;try{const t={name:n.name.trim(),dimensions:n.dimensions.trim()||null,features:D(n.featuresText),characteristics:D(n.characteristicsText)},e=await E(`/api/v1/products/${h.value}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(await j(e));const a=await e.json();_.value=a.recognition_confidence,L("已保存修改"),await b()}catch(t){y(t.message||String(t))}finally{r.value=!1}}}async function Q(t){k(),r.value=!0;try{const e=await H(t);h.value=e.id,_.value=e.recognition_confidence??null,F(),f.value=e.original_image_url,x.value=null,n.name=e.name||"",n.dimensions=e.dimensions||"",n.featuresText=(e.features||[]).join(`
`),n.characteristicsText=(e.characteristics||[]).join(`
`),L("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{r.value=!1}}async function W(t){if(k(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){r.value=!0;try{const e=await E(`/api/v1/products/${t}`,{method:"DELETE"});if(!e.ok&&e.status!==204)throw new Error(await j(e));h.value===t&&V(),L("已删除产品"),c.value>0&&S.value.length===1&&(c.value=Math.max(0,c.value-v.value)),await b()}catch(e){y(e.message||String(e))}finally{r.value=!1}}}function X(){c.value=Math.max(0,c.value-v.value),b()}function q(){c.value+v.value>=w.value||(c.value=c.value+v.value,b())}function z(){I&&window.clearTimeout(I),I=window.setTimeout(()=>{c.value=0,b()},250)}return ee(async()=>{try{const t=await oe();O.value=!!(t!=null&&t.is_admin)}catch{O.value=!1}await b()}),(t,e)=>(l(),i("div",ce,[s("div",ue,[s("header",de,[e[8]||(e[8]=te('<div class="header-left" data-v-5b864707><a href="/" class="btn btn-secondary" style="text-decoration:none;" data-v-5b864707><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-5b864707><path d="M19 12H5M12 19l-7-7 7-7" data-v-5b864707></path></svg> 返回首页 </a><div data-v-5b864707><h1 style="margin:0;text-align:left;" data-v-5b864707>产品库</h1><div class="meta-text" data-v-5b864707>上传产品图片，AI识别后可手动修正</div></div></div>',1)),s("div",ve,[e[5]||(e[5]=s("a",{href:"/video",class:"btn btn-secondary",style:{"text-decoration":"none"}},"视频",-1)),e[6]||(e[6]=s("a",{href:"/image",class:"btn btn-secondary",style:{"text-decoration":"none"}},"图片",-1)),e[7]||(e[7]=s("a",{href:"/storage",class:"btn btn-secondary",style:{"text-decoration":"none"}},"存储",-1)),O.value?(l(),i("a",me,"Admin")):p("",!0)])]),C.value?(l(),i("section",fe,d(C.value),1)):p("",!0),P.value?(l(),i("section",pe,d(P.value),1)):p("",!0),s("section",he,[s("div",ge,[s("h2",_e,d(N.value?"编辑产品信息":"上传新产品"),1),s("div",ye,[N.value?(l(),i("button",{key:0,class:"btn btn-secondary btn-sm",type:"button",onClick:V}," 取消编辑 ")):p("",!0)])]),s("div",be,[s("div",we,[e[9]||(e[9]=s("label",null,"产品图片",-1)),s("input",{type:"file",accept:"image/jpeg,image/png",disabled:N.value,onChange:J},null,40,xe),e[10]||(e[10]=s("div",{class:"form-hint"}," 支持 JPG/PNG；上传后服务端会进行 AI 识别（大图会自动压缩用于识别，不影响原图存储） ",-1))]),s("div",ke,[e[11]||(e[11]=s("label",null,"图片预览",-1)),s("div",Te,[f.value?(l(),i("img",{key:0,src:f.value,alt:"preview",class:"preview-image"},null,8,Se)):(l(),i("div",Ce,"未选择图片"))]),_.value!==null?(l(),i("div",Pe," AI 置信度："+d(Math.round(_.value*100))+"% ",1)):p("",!0)])]),s("div",je,[s("div",Ee,[e[12]||(e[12]=s("label",null,"产品名称",-1)),M(s("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>n.name=a),type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[U,n.name]])]),s("div",Me,[e[13]||(e[13]=s("label",null,"尺寸规格",-1)),M(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>n.dimensions=a),type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[U,n.dimensions]])])]),s("div",Ue,[s("div",Oe,[e[14]||(e[14]=s("label",null,"功能特征（每行一个）",-1)),M(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>n.featuresText=a),rows:"5",placeholder:`例如：
24小时保温
不锈钢内胆`},null,512),[[U,n.featuresText]])]),s("div",$e,[e[15]||(e[15]=s("label",null,"产品特点（每行一个）",-1)),M(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>n.characteristicsText=a),rows:"5",placeholder:`例如：
便携
大容量`},null,512),[[U,n.characteristicsText]])])]),s("div",Ae,[N.value?(l(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:r.value,onClick:G},d(r.value?"保存中...":"保存修改"),9,Le)):(l(),i("button",{key:0,class:"btn btn-primary",type:"button",disabled:r.value,onClick:R},d(r.value?"上传中...":"上传并识别"),9,Ne))])]),s("section",De,[s("div",Fe,[e[16]||(e[16]=s("h2",{style:{margin:"0"}},"我的产品",-1)),s("div",Ie,[M(s("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>A.value=a),type:"text",placeholder:"搜索名称...",style:{width:"260px","max-width":"100%"},onInput:z},null,544),[[U,A.value]])])]),$.value?(l(),i("div",Ve,"加载中...")):(l(),i("div",Be,[S.value.length===0?(l(),i("div",He,"暂无产品")):(l(),i("div",Je,[(l(!0),i(se,null,ae(S.value,a=>(l(),i("div",{key:a.id,class:"product-card"},[s("div",Re,[s("img",{src:a.original_image_url,alt:a.name},null,8,Ge)]),s("div",Qe,[s("div",We,d(a.name),1),s("div",Xe,[a.dimensions?(l(),i("span",qe,d(a.dimensions),1)):p("",!0),a.created_at?(l(),i("span",ze,"· "+d(B(a.created_at)),1)):p("",!0)]),a.recognition_confidence!==null?(l(),i("div",Ke," AI："+d(Math.round((a.recognition_confidence??0)*100))+"% ",1)):p("",!0),s("div",Ye,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:r.value,onClick:o=>Q(a.id)}," 编辑 ",8,Ze),s("button",{class:"btn btn-secondary btn-sm danger",type:"button",disabled:r.value,onClick:o=>W(a.id)}," 删除 ",8,et)])])]))),128))])),w.value>v.value?(l(),i("div",tt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:c.value===0||r.value,onClick:X}," 上一页 ",8,st),s("span",at," 第 "+d(Math.floor(c.value/v.value)+1)+" / "+d(Math.max(1,Math.ceil(w.value/v.value)))+" 页（"+d(w.value)+" 条） ",1),s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:c.value+v.value>=w.value||r.value,onClick:q}," 下一页 ",8,nt)])):p("",!0)]))])])]))}}),it=ie(ot,[["__scopeId","data-v-5b864707"]]);ne(it).mount("#app");
