import{d as Ce,r as u,j as Ie,k as R,o as Pe,c as o,a as l,b as n,e as d,f as ne,t as m,l as C,n as Q,F as X,m as q,w as M,v as E,g as je}from"./runtime-dom.esm-bundler-CzCxjph-.js";import{g as De}from"./auth-DhJl3iPe.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                   */function Me(A,z){const r=`; ${document.cookie||""}`.split(`; ${A}=`);return r.length===2&&r.pop().split(";").shift()||null}function Ee(){const A=Me("csrf_token");return A?{"X-CSRF-Token":A}:{}}const Ae={class:"products-page"},$e={class:"container"},Oe={class:"products-header"},Le={class:"header-actions"},Ne={key:0,href:"/admin",class:"btn btn-secondary",style:{"text-decoration":"none"}},Fe={key:0,class:"card error-banner",style:{"margin-bottom":"18px"}},Re={key:1,class:"card success-banner",style:{"margin-bottom":"18px"}},ze={class:"card"},Ve={class:"card-title-row"},Be={style:{margin:"0"}},Je={class:"card-actions"},He={class:"form-grid image-grid",style:{"margin-top":"16px"}},Ge={class:"form-group"},We=["disabled"],Qe={class:"dropzone-inner"},Xe={class:"dropzone-actions"},qe=["disabled"],Ke={class:"form-group"},Ye={class:"preview-box"},Ze=["src"],et={key:1,class:"preview-placeholder"},tt={key:0,class:"form-hint"},at={key:0,class:"image-meta"},nt={class:"meta-text"},st={key:0,class:"meta-text"},it={key:1,class:"image-preview-grid product-image-grid"},ot=["src","alt"],lt={key:0,class:"preview-badge"},rt={class:"preview-actions"},ct=["onClick"],ut=["onClick"],dt={key:2,class:"image-preview-grid product-image-grid"},vt=["src","alt"],mt={key:0,class:"preview-badge"},ft={class:"form-grid",style:{"margin-top":"8px"}},pt={class:"form-group"},gt={class:"form-group"},ht={class:"form-group",style:{"margin-top":"8px"}},yt=["disabled"],_t={class:"form-grid",style:{"margin-top":"8px"}},bt={class:"form-group"},wt={class:"form-group"},kt={class:"form-actions"},xt=["disabled"],Tt=["disabled"],St=["disabled"],Ct={class:"card"},It={class:"card-title-row"},Pt={class:"card-actions"},jt={key:0,class:"loading"},Dt={key:1},Ut={key:0,class:"empty-state"},Mt={key:1,class:"products-grid"},Et={class:"product-thumb"},At=["src","alt"],$t={key:0,class:"image-count-badge"},Ot={class:"product-body"},Lt={class:"product-title"},Nt={class:"product-meta"},Ft={key:0},Rt={key:1},zt={key:2},Vt={key:0,class:"product-meta"},Bt={class:"product-actions"},Jt=["disabled","onClick"],Ht=["disabled","onClick"],Gt={key:2,class:"pagination"},Wt=["disabled"],Qt={class:"meta-text"},Xt=["disabled"],qt=Ce({__name:"products-page",setup(A){const z=u(!1),$=u([]),V=u(!1),r=u(!1),O=u(""),L=u(""),f=u(0),_=u(20),I=u(0),B=u("");let G=null;const K=u(null),P=u(!1),c=u([]),h=u([]),v=u(0),w=u(null),k=u(null),j=u(!1),x=u(null),s=Ie({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),p=R(()=>!!w.value),W=R(()=>c.value[v.value]??null),se=R(()=>h.value.find(t=>t.is_primary)??h.value[0]??null),Y=R(()=>{var t,e;return((t=W.value)==null?void 0:t.url)||((e=se.value)==null?void 0:e.image_url)||null}),Z=R(()=>c.value.length>0?c.value.length:h.value.length);function T(){O.value="",L.value=""}function y(t){O.value=t,L.value=""}function N(t){L.value=t,O.value=""}function ie(t){try{return new Date(t).toLocaleString()}catch{return t}}function J(t){return t.split(`
`).map(e=>e.trim()).filter(Boolean)}function F(){k.value=null,x.value=null}function H(){for(const t of c.value)t.url.startsWith("blob:")&&URL.revokeObjectURL(t.url)}function oe(){return globalThis.crypto&&"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function le(t){const e=t.type.toLowerCase();if(e==="image/jpeg"||e==="image/png")return!0;const a=t.name.toLowerCase();return a.endsWith(".jpg")||a.endsWith(".jpeg")||a.endsWith(".png")}function ee(t){if(p.value){y("编辑模式下无法更换图片");return}const e=Array.from(t);if(e.length===0)return;T();let a=0;for(const i of e){if(!le(i)){a+=1;continue}const g=URL.createObjectURL(i);c.value.push({id:oe(),file:i,url:g})}c.value.length>0&&(v.value=Math.min(v.value,c.value.length-1),w.value=null,h.value=[],F()),a>0&&y("仅支持 JPG/PNG 图片")}function te(){var t;p.value||(t=K.value)==null||t.click()}function re(){p.value||(P.value=!0)}function ce(){p.value||(P.value=!0)}function ue(){P.value=!1}function de(t){var e;p.value||(P.value=!1,(e=t.dataTransfer)!=null&&e.files&&ee(t.dataTransfer.files))}function ve(){H(),c.value=[],v.value=0,F()}function me(t){var a;const[e]=c.value.splice(t,1);(a=e==null?void 0:e.url)!=null&&a.startsWith("blob:")&&URL.revokeObjectURL(e.url),c.value.length===0||t===v.value?v.value=0:t<v.value&&(v.value-=1),F()}function fe(t){t<0||t>=c.value.length||(v.value=t,F())}function pe(t){const e=t.target;e.files&&(ee(e.files),e.value="")}async function D(t){const e=await t.text();try{const a=JSON.parse(e),i=(a==null?void 0:a.detail)??(a==null?void 0:a.error)??(a==null?void 0:a.message)??e;if(typeof i=="string")return i;if(i&&typeof i=="object"){const g=i==null?void 0:i.message;return typeof g=="string"?g:JSON.stringify(i)}return String(i||`HTTP ${t.status}`)}catch{return e||`HTTP ${t.status}`}}async function U(t,e={}){const a=(e.method||"GET").toUpperCase(),i=new Headers(e.headers||{});if(!["GET","HEAD","OPTIONS"].includes(a))for(const[g,b]of Object.entries(Ee()))i.set(g,b);return fetch(t,{...e,headers:i,credentials:"include"})}async function S(){V.value=!0;try{const t=new URLSearchParams;t.set("offset",String(f.value)),t.set("limit",String(_.value)),B.value.trim()&&t.set("name",B.value.trim());const e=await U(`/api/v1/products?${t.toString()}`);if(!e.ok)throw new Error(await D(e));const a=await e.json();$.value=a.products,I.value=a.total,f.value=a.offset,_.value=a.limit}catch(t){y(t.message||String(t))}finally{V.value=!1}}async function ge(t){const e=await U(`/api/v1/products/${t}`);if(!e.ok)throw new Error(await D(e));return await e.json()}function ae(){T(),H(),c.value=[],h.value=[],v.value=0,P.value=!1,w.value=null,F(),s.name="",s.dimensions="",s.featuresText="",s.characteristicsText="",s.rawText=""}async function he(){if(T(),!W.value){y("请先选择图片");return}j.value=!0;try{const t=new FormData;t.append("image",W.value.file);const e=s.rawText.trim();e&&t.append("raw_text",e);const a=await U("/api/v1/products/recognize",{method:"POST",body:t});if(!a.ok)throw new Error(await D(a));const i=await a.json();s.name=i.name||"",s.dimensions=i.dimensions||"",s.featuresText=(i.features||[]).join(`
`),s.characteristicsText=(i.characteristics||[]).join(`
`),k.value=i.confidence,x.value={confidence:i.confidence,metadata:i.metadata||{}},N(`AI整理完成（置信度：${Math.round(i.confidence*100)}%），可编辑后保存`)}catch(t){y(t.message||String(t))}finally{j.value=!1}}async function ye(){if(T(),c.value.length===0){y("请先选择图片");return}r.value=!0;try{const t=new FormData;for(const Se of c.value)t.append("images",Se.file);t.append("primary_index",String(v.value));const e=s.name.trim();e&&t.append("name",e),s.dimensions.trim()&&t.append("dimensions",s.dimensions.trim());const a=J(s.featuresText),i=J(s.characteristicsText);a.length&&t.append("features",JSON.stringify(a)),i.length&&t.append("characteristics",JSON.stringify(i)),x.value?(t.append("recognition_mode","prefill"),t.append("recognition_confidence",String(x.value.confidence)),t.append("recognition_metadata_json",JSON.stringify(x.value.metadata))):t.append("recognition_mode","manual");const g=await U("/api/v1/products",{method:"POST",body:t});if(!g.ok)throw new Error(await D(g));const b=await g.json();N(`创建成功（AI：${Math.round((b.recognition_confidence??0)*100)}%），可继续编辑后保存`),w.value=b.id,k.value=b.recognition_confidence??0,x.value=null,H(),c.value=[],v.value=0,h.value=b.images||[],s.name=b.name||"",s.dimensions=b.dimensions||"",s.featuresText=(b.features||[]).join(`
`),s.characteristicsText=(b.characteristics||[]).join(`
`),await S()}catch(t){y(t.message||String(t))}finally{r.value=!1}}async function _e(){if(T(),!!w.value){if(!s.name.trim()){y("产品名称不能为空");return}r.value=!0;try{const t={name:s.name.trim(),dimensions:s.dimensions.trim()||null,features:J(s.featuresText),characteristics:J(s.characteristicsText)},e=await U(`/api/v1/products/${w.value}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(await D(e));const a=await e.json();k.value=a.recognition_confidence,h.value=a.images||h.value,N("已保存修改"),await S()}catch(t){y(t.message||String(t))}finally{r.value=!1}}}async function be(t){T(),r.value=!0;try{const e=await ge(t);w.value=e.id,k.value=e.recognition_confidence??null,H(),c.value=[],v.value=0,h.value=e.images||[],x.value=null,s.name=e.name||"",s.dimensions=e.dimensions||"",s.featuresText=(e.features||[]).join(`
`),s.characteristicsText=(e.characteristics||[]).join(`
`),N("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{r.value=!1}}async function we(t){if(T(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){r.value=!0;try{const e=await U(`/api/v1/products/${t}`,{method:"DELETE"});if(!e.ok&&e.status!==204)throw new Error(await D(e));w.value===t&&ae(),N("已删除产品"),f.value>0&&$.value.length===1&&(f.value=Math.max(0,f.value-_.value)),await S()}catch(e){y(e.message||String(e))}finally{r.value=!1}}}function ke(){f.value=Math.max(0,f.value-_.value),S()}function xe(){f.value+_.value>=I.value||(f.value=f.value+_.value,S())}function Te(){G&&window.clearTimeout(G),G=window.setTimeout(()=>{f.value=0,S()},250)}return Pe(async()=>{try{const t=await De();z.value=!!(t!=null&&t.is_admin)}catch{z.value=!1}await S()}),(t,e)=>(l(),o("div",Ae,[n("div",$e,[n("header",Oe,[e[9]||(e[9]=ne('<div class="header-left" data-v-0a019234><a href="/" class="btn btn-secondary" style="text-decoration:none;" data-v-0a019234><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0a019234><path d="M19 12H5M12 19l-7-7 7-7" data-v-0a019234></path></svg> 返回首页 </a><div data-v-0a019234><h1 style="margin:0;text-align:left;" data-v-0a019234>产品库</h1><div class="meta-text" data-v-0a019234>上传产品图片，AI识别后可手动修正</div></div></div>',1)),n("div",Le,[e[6]||(e[6]=n("a",{href:"/video",class:"btn btn-secondary",style:{"text-decoration":"none"}},"视频",-1)),e[7]||(e[7]=n("a",{href:"/image",class:"btn btn-secondary",style:{"text-decoration":"none"}},"图片",-1)),e[8]||(e[8]=n("a",{href:"/storage",class:"btn btn-secondary",style:{"text-decoration":"none"}},"存储",-1)),z.value?(l(),o("a",Ne,"Admin")):d("",!0)])]),O.value?(l(),o("section",Fe,m(O.value),1)):d("",!0),L.value?(l(),o("section",Re,m(L.value),1)):d("",!0),n("section",ze,[n("div",Ve,[n("h2",Be,m(p.value?"编辑产品信息":"上传新产品"),1),n("div",Je,[p.value?(l(),o("button",{key:0,class:"btn btn-secondary btn-sm",type:"button",onClick:ae}," 取消编辑 ")):d("",!0)])]),n("div",He,[n("div",Ge,[e[11]||(e[11]=n("label",null,"产品图片",-1)),n("div",{class:Q(["dropzone",{"is-dragover":P.value,"is-loading":r.value||j.value,"is-disabled":p.value}]),onClick:C(te,["stop"]),onDragenter:C(re,["prevent"]),onDragover:C(ce,["prevent"]),onDragleave:C(ue,["prevent"]),onDrop:C(de,["prevent"])},[n("input",{ref_key:"fileInput",ref:K,type:"file",accept:"image/jpeg,image/png",multiple:"",disabled:p.value,onChange:pe},null,40,We),n("div",Qe,[e[10]||(e[10]=ne('<div class="dropzone-icon" data-v-0a019234><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0a019234><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-0a019234></path><polyline points="17 8 12 3 7 8" data-v-0a019234></polyline><line x1="12" y1="3" x2="12" y2="15" data-v-0a019234></line></svg></div><div data-v-0a019234><div class="dropzone-title" data-v-0a019234>拖拽或点击上传多张产品图</div><div class="dropzone-subtitle" data-v-0a019234>主图用于 AI 识别与列表展示</div></div>',2)),n("div",Xe,[n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:p.value,onClick:C(te,["stop"])}," 选择图片 ",8,qe),c.value.length>0?(l(),o("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:C(ve,["stop"])}," 清空 ")):d("",!0)])])],34),e[12]||(e[12]=n("div",{class:"form-hint"}," 支持 JPG/PNG；可一次上传多张产品图，主图用于 AI 识别（大图会自动压缩用于识别，不影响原图存储） ",-1))]),n("div",Ke,[e[13]||(e[13]=n("label",null,"主图预览",-1)),n("div",Ye,[Y.value?(l(),o("img",{key:0,src:Y.value,alt:"preview",class:"preview-image"},null,8,Ze)):(l(),o("div",et,"未选择图片"))]),k.value!==null?(l(),o("div",tt," AI 置信度："+m(Math.round(k.value*100))+"% ",1)):d("",!0)])]),Z.value>0?(l(),o("div",at,[n("span",nt,"已选择 "+m(Z.value)+" 张图片",1),p.value&&c.value.length===0?(l(),o("span",st,"编辑模式下图片不可替换")):d("",!0)])):d("",!0),c.value.length>0?(l(),o("div",it,[(l(!0),o(X,null,q(c.value,(a,i)=>(l(),o("div",{key:a.id,class:Q(["preview-item",{"is-primary":i===v.value}])},[n("img",{src:a.url,alt:`image-${i+1}`,class:"preview-img"},null,8,ot),i===v.value?(l(),o("div",lt,"主图")):d("",!0),n("div",rt,[i!==v.value?(l(),o("button",{key:0,class:"preview-action-btn",type:"button",onClick:g=>fe(i)}," 设为主图 ",8,ct)):d("",!0),n("button",{class:"preview-action-btn danger",type:"button",onClick:g=>me(i)},"移除",8,ut)])],2))),128))])):h.value.length>0?(l(),o("div",dt,[(l(!0),o(X,null,q(h.value,a=>(l(),o("div",{key:a.id,class:Q(["preview-item",{"is-primary":a.is_primary}])},[n("img",{src:a.image_url,alt:a.id,class:"preview-img"},null,8,vt),a.is_primary?(l(),o("div",mt,"主图")):d("",!0)],2))),128))])):d("",!0),n("div",ft,[n("div",pt,[e[14]||(e[14]=n("label",null,"产品名称",-1)),M(n("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.name=a),type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[E,s.name]])]),n("div",gt,[e[15]||(e[15]=n("label",null,"尺寸规格",-1)),M(n("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.dimensions=a),type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[E,s.dimensions]])])]),n("div",ht,[e[16]||(e[16]=n("label",null,"无结构化信息（可选）",-1)),M(n("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.rawText=a),rows:"3",disabled:p.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,yt),[[E,s.rawText]]),e[17]||(e[17]=n("div",{class:"form-hint"}," 提供此信息可帮助AI更准确地识别产品属性 ",-1))]),n("div",_t,[n("div",bt,[e[18]||(e[18]=n("label",null,"功能特征（每行一个）",-1)),M(n("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>s.featuresText=a),rows:"5",placeholder:`例如：
24小时保温
不锈钢内胆`},null,512),[[E,s.featuresText]])]),n("div",wt,[e[19]||(e[19]=n("label",null,"产品特点（每行一个）",-1)),M(n("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>s.characteristicsText=a),rows:"5",placeholder:`例如：
便携
大容量`},null,512),[[E,s.characteristicsText]])])]),n("div",kt,[p.value?d("",!0):(l(),o("button",{key:0,class:"btn btn-secondary",type:"button",disabled:r.value||j.value,onClick:he},m(j.value?"AI整理中...":"AI整理预填"),9,xt)),p.value?(l(),o("button",{key:2,class:"btn btn-primary",type:"button",disabled:r.value,onClick:_e},m(r.value?"保存中...":"保存修改"),9,St)):(l(),o("button",{key:1,class:"btn btn-primary",type:"button",disabled:r.value||j.value,onClick:ye},m(r.value?"保存中...":"保存产品"),9,Tt))])]),n("section",Ct,[n("div",It,[e[20]||(e[20]=n("h2",{style:{margin:"0"}},"我的产品",-1)),n("div",Pt,[M(n("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>B.value=a),type:"text",placeholder:"搜索名称...",style:{width:"260px","max-width":"100%"},onInput:Te},null,544),[[E,B.value]])])]),V.value?(l(),o("div",jt,"加载中...")):(l(),o("div",Dt,[$.value.length===0?(l(),o("div",Ut,"暂无产品")):(l(),o("div",Mt,[(l(!0),o(X,null,q($.value,a=>(l(),o("div",{key:a.id,class:"product-card"},[n("div",Et,[n("img",{src:a.original_image_url,alt:a.name},null,8,At),a.image_count>1?(l(),o("span",$t,m(a.image_count)+" 张",1)):d("",!0)]),n("div",Ot,[n("div",Lt,m(a.name),1),n("div",Nt,[a.dimensions?(l(),o("span",Ft,m(a.dimensions),1)):d("",!0),a.image_count>1?(l(),o("span",Rt,"· "+m(a.image_count)+" 张",1)):d("",!0),a.created_at?(l(),o("span",zt,"· "+m(ie(a.created_at)),1)):d("",!0)]),a.recognition_confidence!==null?(l(),o("div",Vt," AI："+m(Math.round((a.recognition_confidence??0)*100))+"% ",1)):d("",!0),n("div",Bt,[n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:r.value,onClick:i=>be(a.id)}," 编辑 ",8,Jt),n("button",{class:"btn btn-secondary btn-sm danger",type:"button",disabled:r.value,onClick:i=>we(a.id)}," 删除 ",8,Ht)])])]))),128))])),I.value>_.value?(l(),o("div",Gt,[n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:f.value===0||r.value,onClick:ke}," 上一页 ",8,Wt),n("span",Qt," 第 "+m(Math.floor(f.value/_.value)+1)+" / "+m(Math.max(1,Math.ceil(I.value/_.value)))+" 页（"+m(I.value)+" 条） ",1),n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:f.value+_.value>=I.value||r.value,onClick:xe}," 下一页 ",8,Xt)])):d("",!0)]))])])]))}}),Kt=Ue(qt,[["__scopeId","data-v-0a019234"]]);je(Kt).mount("#app");
