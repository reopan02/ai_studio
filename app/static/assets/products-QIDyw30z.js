import{d as Se,r as u,j as Ie,k as F,o as Pe,c as i,a as l,b as s,f as W,e as d,i as je,t as p,l as S,n as X,F as q,m as K,w as U,v as E,g as Me}from"./runtime-dom.esm-bundler-CzCxjph-.js";import{g as De}from"./auth-DhJl3iPe.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                     */function Ee($,R){const r=`; ${document.cookie||""}`.split(`; ${$}=`);return r.length===2&&r.pop().split(";").shift()||null}function $e(){const $=Ee("csrf_token");return $?{"X-CSRF-Token":$}:{}}const Oe={class:"products-page"},Ae={class:"header"},Le={class:"header-actions"},Be={key:0,href:"/admin",class:"btn btn-secondary",style:{"text-decoration":"none"}},Ne={class:"main-container"},Fe={class:"sidebar"},Re={class:"sidebar-section"},Ve={class:"section-header"},He={class:"section-title section-title-lg"},ze={class:"form-group"},Je=["disabled"],We={class:"upload-actions"},Ge=["disabled"],Qe={class:"form-group"},Xe={class:"preview-box"},qe=["src"],Ke={key:1,class:"preview-placeholder"},Ye={key:0,class:"form-hint"},Ze={key:0,class:"image-meta"},et={class:"meta-text"},tt={key:0,class:"meta-text"},at={key:1,class:"image-preview-grid product-image-grid"},st=["src","alt"],nt={key:0,class:"preview-badge"},ot={class:"preview-actions"},it=["onClick"],lt=["onClick"],rt={key:2,class:"image-preview-grid product-image-grid"},ct=["src","alt"],ut={key:0,class:"preview-badge"},dt={class:"form-group"},vt={class:"form-group"},pt={class:"form-group"},ft=["disabled"],mt={class:"form-group"},gt={class:"form-group"},ht={class:"form-actions"},yt=["disabled"],_t=["disabled"],bt=["disabled"],wt={class:"main-content"},kt={class:"content-scroll"},xt={key:0,class:"notice-banner error"},Tt={key:1,class:"notice-banner success"},Ct={class:"content-section"},St={class:"content-header"},It={class:"search-wrapper"},Pt={key:0,class:"loading-state"},jt={key:1},Mt={key:0,class:"empty-state"},Dt={key:1,class:"products-grid"},Ut={class:"product-thumb"},Et=["src","alt"],$t={key:0,class:"image-count-badge"},Ot={class:"product-body"},At={class:"product-title"},Lt={class:"product-meta"},Bt={key:0},Nt={key:1},Ft={key:2},Rt={key:0,class:"product-meta"},Vt={class:"product-actions"},Ht=["disabled","onClick"],zt=["disabled","onClick"],Jt={key:2,class:"pagination"},Wt=["disabled"],Gt={class:"meta-text"},Qt=["disabled"],Xt=Se({__name:"products-page",setup($){const R=u(!1),O=u([]),V=u(!1),r=u(!1),A=u(""),L=u(""),f=u(0),_=u(20),I=u(0),H=u("");let G=null;const Y=u(null),P=u(!1),c=u([]),h=u([]),v=u(0),w=u(null),k=u(null),j=u(!1),x=u(null),n=Ie({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),m=F(()=>!!w.value),Q=F(()=>c.value[v.value]??null),ne=F(()=>h.value.find(t=>t.is_primary)??h.value[0]??null),Z=F(()=>{var t,e;return((t=Q.value)==null?void 0:t.url)||((e=ne.value)==null?void 0:e.image_url)||null}),ee=F(()=>c.value.length>0?c.value.length:h.value.length);function T(){A.value="",L.value=""}function y(t){A.value=t,L.value=""}function B(t){L.value=t,A.value=""}function oe(t){try{return new Date(t).toLocaleString()}catch{return t}}function z(t){return t.split(`
`).map(e=>e.trim()).filter(Boolean)}function N(){k.value=null,x.value=null}function J(){for(const t of c.value)t.url.startsWith("blob:")&&URL.revokeObjectURL(t.url)}function ie(){return globalThis.crypto&&"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function le(t){const e=t.type.toLowerCase();if(e==="image/jpeg"||e==="image/png")return!0;const a=t.name.toLowerCase();return a.endsWith(".jpg")||a.endsWith(".jpeg")||a.endsWith(".png")}function te(t){if(m.value){y("编辑模式下无法更换图片");return}const e=Array.from(t);if(e.length===0)return;T();let a=0;for(const o of e){if(!le(o)){a+=1;continue}const g=URL.createObjectURL(o);c.value.push({id:ie(),file:o,url:g})}c.value.length>0&&(v.value=Math.min(v.value,c.value.length-1),w.value=null,h.value=[],N()),a>0&&y("仅支持 JPG/PNG 图片")}function ae(){var t;m.value||(t=Y.value)==null||t.click()}function re(){m.value||(P.value=!0)}function ce(){m.value||(P.value=!0)}function ue(){P.value=!1}function de(t){var e;m.value||(P.value=!1,(e=t.dataTransfer)!=null&&e.files&&te(t.dataTransfer.files))}function ve(){J(),c.value=[],v.value=0,N()}function pe(t){var a;const[e]=c.value.splice(t,1);(a=e==null?void 0:e.url)!=null&&a.startsWith("blob:")&&URL.revokeObjectURL(e.url),c.value.length===0||t===v.value?v.value=0:t<v.value&&(v.value-=1),N()}function fe(t){t<0||t>=c.value.length||(v.value=t,N())}function me(t){const e=t.target;e.files&&(te(e.files),e.value="")}async function M(t){const e=await t.text();try{const a=JSON.parse(e),o=(a==null?void 0:a.detail)??(a==null?void 0:a.error)??(a==null?void 0:a.message)??e;if(typeof o=="string")return o;if(o&&typeof o=="object"){const g=o==null?void 0:o.message;return typeof g=="string"?g:JSON.stringify(o)}return String(o||`HTTP ${t.status}`)}catch{return e||`HTTP ${t.status}`}}async function D(t,e={}){const a=(e.method||"GET").toUpperCase(),o=new Headers(e.headers||{});if(!["GET","HEAD","OPTIONS"].includes(a))for(const[g,b]of Object.entries($e()))o.set(g,b);return fetch(t,{...e,headers:o,credentials:"include"})}async function C(){V.value=!0;try{const t=new URLSearchParams;t.set("offset",String(f.value)),t.set("limit",String(_.value)),H.value.trim()&&t.set("name",H.value.trim());const e=await D(`/api/v1/products?${t.toString()}`);if(!e.ok)throw new Error(await M(e));const a=await e.json();O.value=a.products,I.value=a.total,f.value=a.offset,_.value=a.limit}catch(t){y(t.message||String(t))}finally{V.value=!1}}async function ge(t){const e=await D(`/api/v1/products/${t}`);if(!e.ok)throw new Error(await M(e));return await e.json()}function se(){T(),J(),c.value=[],h.value=[],v.value=0,P.value=!1,w.value=null,N(),n.name="",n.dimensions="",n.featuresText="",n.characteristicsText="",n.rawText=""}async function he(){if(T(),!Q.value){y("请先选择图片");return}j.value=!0;try{const t=new FormData;t.append("image",Q.value.file);const e=n.rawText.trim();e&&t.append("raw_text",e);const a=await D("/api/v1/products/recognize",{method:"POST",body:t});if(!a.ok)throw new Error(await M(a));const o=await a.json();n.name=o.name||"",n.dimensions=o.dimensions||"",n.featuresText=(o.features||[]).join(`
`),n.characteristicsText=(o.characteristics||[]).join(`
`),k.value=o.confidence,x.value={confidence:o.confidence,metadata:o.metadata||{}},B(`AI整理完成（置信度：${Math.round(o.confidence*100)}%），可编辑后保存`)}catch(t){y(t.message||String(t))}finally{j.value=!1}}async function ye(){if(T(),c.value.length===0){y("请先选择图片");return}r.value=!0;try{const t=new FormData;for(const Ce of c.value)t.append("images",Ce.file);t.append("primary_index",String(v.value));const e=n.name.trim();e&&t.append("name",e),n.dimensions.trim()&&t.append("dimensions",n.dimensions.trim());const a=z(n.featuresText),o=z(n.characteristicsText);a.length&&t.append("features",JSON.stringify(a)),o.length&&t.append("characteristics",JSON.stringify(o)),x.value?(t.append("recognition_mode","prefill"),t.append("recognition_confidence",String(x.value.confidence)),t.append("recognition_metadata_json",JSON.stringify(x.value.metadata))):t.append("recognition_mode","manual");const g=await D("/api/v1/products",{method:"POST",body:t});if(!g.ok)throw new Error(await M(g));const b=await g.json();B(`创建成功（AI：${Math.round((b.recognition_confidence??0)*100)}%），可继续编辑后保存`),w.value=b.id,k.value=b.recognition_confidence??0,x.value=null,J(),c.value=[],v.value=0,h.value=b.images||[],n.name=b.name||"",n.dimensions=b.dimensions||"",n.featuresText=(b.features||[]).join(`
`),n.characteristicsText=(b.characteristics||[]).join(`
`),await C()}catch(t){y(t.message||String(t))}finally{r.value=!1}}async function _e(){if(T(),!!w.value){if(!n.name.trim()){y("产品名称不能为空");return}r.value=!0;try{const t={name:n.name.trim(),dimensions:n.dimensions.trim()||null,features:z(n.featuresText),characteristics:z(n.characteristicsText)},e=await D(`/api/v1/products/${w.value}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(await M(e));const a=await e.json();k.value=a.recognition_confidence,h.value=a.images||h.value,B("已保存修改"),await C()}catch(t){y(t.message||String(t))}finally{r.value=!1}}}async function be(t){T(),r.value=!0;try{const e=await ge(t);w.value=e.id,k.value=e.recognition_confidence??null,J(),c.value=[],v.value=0,h.value=e.images||[],x.value=null,n.name=e.name||"",n.dimensions=e.dimensions||"",n.featuresText=(e.features||[]).join(`
`),n.characteristicsText=(e.characteristics||[]).join(`
`),B("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{r.value=!1}}async function we(t){if(T(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){r.value=!0;try{const e=await D(`/api/v1/products/${t}`,{method:"DELETE"});if(!e.ok&&e.status!==204)throw new Error(await M(e));w.value===t&&se(),B("已删除产品"),f.value>0&&O.value.length===1&&(f.value=Math.max(0,f.value-_.value)),await C()}catch(e){y(e.message||String(e))}finally{r.value=!1}}}function ke(){f.value=Math.max(0,f.value-_.value),C()}function xe(){f.value+_.value>=I.value||(f.value=f.value+_.value,C())}function Te(){G&&window.clearTimeout(G),G=window.setTimeout(()=>{f.value=0,C()},250)}return Pe(async()=>{try{const t=await De();R.value=!!(t!=null&&t.is_admin)}catch{R.value=!1}await C()}),(t,e)=>(l(),i("div",Oe,[s("header",Ae,[e[7]||(e[7]=W('<div class="logo" data-v-291e5991><div class="logo-icon" data-v-291e5991><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-291e5991><rect x="3" y="3" width="18" height="18" rx="2" data-v-291e5991></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-291e5991></circle><polyline points="21 15 16 10 5 21" data-v-291e5991></polyline></svg></div><span data-v-291e5991>产品库</span></div>',1)),s("div",Le,[e[6]||(e[6]=W('<a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;" data-v-291e5991><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-291e5991><path d="M19 12H5M12 19l-7-7 7-7" data-v-291e5991></path></svg> 返回主页面 </a><a href="/video" class="btn btn-secondary" style="text-decoration:none;" data-v-291e5991>视频生成</a><a href="/image" class="btn btn-secondary" style="text-decoration:none;" data-v-291e5991>图像处理</a><a href="/storage" class="btn btn-secondary" style="text-decoration:none;" data-v-291e5991>存储库</a>',4)),R.value?(l(),i("a",Be,"Admin")):d("",!0)])]),s("div",Ne,[s("aside",Fe,[s("section",Re,[s("div",Ve,[s("div",He,[e[8]||(e[8]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),s("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),s("polyline",{points:"21 15 16 10 5 21"})],-1)),je(" "+p(m.value?"编辑产品":"创建产品"),1)]),m.value?(l(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:se}," 退出编辑 ")):d("",!0)]),e[17]||(e[17]=s("div",{class:"section-subtitle"},"上传产品图片，AI 自动识别结构化信息，支持多图管理",-1)),s("div",ze,[e[10]||(e[10]=s("label",{class:"form-label"},"产品图片",-1)),s("div",{class:X(["upload-area",{"drag-over":P.value,"is-loading":r.value||j.value,"is-disabled":m.value}]),onClick:S(ae,["stop"]),onDragenter:S(re,["prevent"]),onDragover:S(ce,["prevent"]),onDragleave:S(ue,["prevent"]),onDrop:S(de,["prevent"])},[s("input",{ref_key:"fileInput",ref:Y,type:"file",accept:"image/jpeg,image/png",multiple:"",disabled:m.value,onChange:me},null,40,Je),e[9]||(e[9]=W('<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-291e5991><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-291e5991></path><polyline points="17 8 12 3 7 8" data-v-291e5991></polyline><line x1="12" y1="3" x2="12" y2="15" data-v-291e5991></line></svg><p class="upload-text" data-v-291e5991><strong data-v-291e5991>拖拽或点击上传多张产品图</strong></p><p class="upload-hint" data-v-291e5991>主图用于 AI 识别与列表展示</p>',3))],34),s("div",We,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:m.value,onClick:S(ae,["stop"])}," 选择图片 ",8,Ge),c.value.length>0?(l(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:S(ve,["stop"])}," 清空 ")):d("",!0)])]),s("div",Qe,[e[11]||(e[11]=s("label",{class:"form-label"},"主图预览",-1)),s("div",Xe,[Z.value?(l(),i("img",{key:0,src:Z.value,alt:"preview",class:"preview-image"},null,8,qe)):(l(),i("div",Ke,"未选择图片"))]),k.value!==null?(l(),i("div",Ye," AI 置信度："+p(Math.round(k.value*100))+"% ",1)):d("",!0)]),ee.value>0?(l(),i("div",Ze,[s("span",et,"已选择 "+p(ee.value)+" 张图片",1),m.value&&c.value.length===0?(l(),i("span",tt,"编辑模式下图片不可替换")):d("",!0)])):d("",!0),c.value.length>0?(l(),i("div",at,[(l(!0),i(q,null,K(c.value,(a,o)=>(l(),i("div",{key:a.id,class:X(["preview-item",{"is-primary":o===v.value}])},[s("img",{src:a.url,alt:`image-${o+1}`,class:"preview-img"},null,8,st),o===v.value?(l(),i("div",nt,"主图")):d("",!0),s("div",ot,[o!==v.value?(l(),i("button",{key:0,class:"preview-action-btn",type:"button",onClick:g=>fe(o)}," 设为主图 ",8,it)):d("",!0),s("button",{class:"preview-action-btn danger",type:"button",onClick:g=>pe(o)},"移除",8,lt)])],2))),128))])):h.value.length>0?(l(),i("div",rt,[(l(!0),i(q,null,K(h.value,a=>(l(),i("div",{key:a.id,class:X(["preview-item",{"is-primary":a.is_primary}])},[s("img",{src:a.image_url,alt:a.id,class:"preview-img"},null,8,ct),a.is_primary?(l(),i("div",ut,"主图")):d("",!0)],2))),128))])):d("",!0),s("div",dt,[e[12]||(e[12]=s("label",{class:"form-label"},"产品名称",-1)),U(s("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>n.name=a),class:"form-input",type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[E,n.name]])]),s("div",vt,[e[13]||(e[13]=s("label",{class:"form-label"},"尺寸规格",-1)),U(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>n.dimensions=a),class:"form-input",type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[E,n.dimensions]])]),s("div",pt,[e[14]||(e[14]=s("label",{class:"form-label"},"无结构化信息（可选）",-1)),U(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>n.rawText=a),rows:"3",class:"form-input",disabled:m.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,ft),[[E,n.rawText]])]),s("div",mt,[e[15]||(e[15]=s("label",{class:"form-label"},"功能特征（每行一个）",-1)),U(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>n.featuresText=a),rows:"4",class:"form-input"},null,512),[[E,n.featuresText]])]),s("div",gt,[e[16]||(e[16]=s("label",{class:"form-label"},"产品特点（每行一个）",-1)),U(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>n.characteristicsText=a),rows:"4",class:"form-input",placeholder:`例如：
便携
大容量`},null,512),[[E,n.characteristicsText]])]),s("div",ht,[m.value?d("",!0):(l(),i("button",{key:0,class:"btn btn-secondary",type:"button",disabled:r.value||j.value,onClick:he},p(j.value?"AI整理中...":"AI整理预填"),9,yt)),m.value?(l(),i("button",{key:2,class:"btn btn-primary",type:"button",disabled:r.value,onClick:_e},p(r.value?"保存中...":"保存修改"),9,bt)):(l(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:r.value||j.value,onClick:ye},p(r.value?"保存中...":"保存产品"),9,_t))])])]),s("main",wt,[s("div",kt,[A.value?(l(),i("section",xt,p(A.value),1)):d("",!0),L.value?(l(),i("section",Tt,p(L.value),1)):d("",!0),s("section",Ct,[s("div",St,[e[19]||(e[19]=W('<div class="section-title section-title-lg" data-v-291e5991><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-291e5991><path d="M3 3h7v7H3z" data-v-291e5991></path><path d="M14 3h7v7h-7z" data-v-291e5991></path><path d="M3 14h7v7H3z" data-v-291e5991></path><path d="M14 14h7v7h-7z" data-v-291e5991></path></svg> 产品列表 </div>',1)),s("div",It,[e[18]||(e[18]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("circle",{cx:"11",cy:"11",r:"8"}),s("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),U(s("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>H.value=a),class:"form-input",type:"text",placeholder:"搜索产品名称...",onInput:Te},null,544),[[E,H.value]])])]),V.value?(l(),i("div",Pt,"加载中...")):(l(),i("div",jt,[O.value.length===0?(l(),i("div",Mt,"暂无产品")):(l(),i("div",Dt,[(l(!0),i(q,null,K(O.value,a=>(l(),i("div",{key:a.id,class:"product-card"},[s("div",Ut,[s("img",{src:a.original_image_url,alt:a.name},null,8,Et),a.image_count>1?(l(),i("span",$t,p(a.image_count)+" 张",1)):d("",!0)]),s("div",Ot,[s("div",At,p(a.name),1),s("div",Lt,[a.dimensions?(l(),i("span",Bt,p(a.dimensions),1)):d("",!0),a.image_count>1?(l(),i("span",Nt,"· "+p(a.image_count)+" 张",1)):d("",!0),a.created_at?(l(),i("span",Ft,"· "+p(oe(a.created_at)),1)):d("",!0)]),a.recognition_confidence!==null?(l(),i("div",Rt," AI："+p(Math.round((a.recognition_confidence??0)*100))+"% ",1)):d("",!0),s("div",Vt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:r.value,onClick:o=>be(a.id)}," 编辑 ",8,Ht),s("button",{class:"btn btn-ghost btn-sm danger",type:"button",disabled:r.value,onClick:o=>we(a.id)}," 删除 ",8,zt)])])]))),128))])),I.value>_.value?(l(),i("div",Jt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:f.value===0||r.value,onClick:ke}," 上一页 ",8,Wt),s("span",Gt," 第 "+p(Math.floor(f.value/_.value)+1)+" / "+p(Math.max(1,Math.ceil(I.value/_.value)))+" 页（"+p(I.value)+" 条） ",1),s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:f.value+_.value>=I.value||r.value,onClick:xe}," 下一页 ",8,Qt)])):d("",!0)]))])])])])]))}}),qt=Ue(Xt,[["__scopeId","data-v-291e5991"]]);Me(qt).mount("#app");
