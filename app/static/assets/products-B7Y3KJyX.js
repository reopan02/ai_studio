import{d as Ne,r as c,q as Re,c as J,o as qe,a as i,b as r,g as ne,e as s,f as u,i as ze,t as p,u as E,n as oe,F as ie,p as re,w as V,l as F,s as C,x as Z,y as He,j as Je,k as We}from"./supabase-Dkl3gFRn.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                     */const Qe={class:"products-page"},Ke={class:"main-container"},Xe={class:"sidebar"},Ye={class:"sidebar-section"},Ze={class:"section-header"},et={class:"section-title section-title-lg"},tt={class:"form-group"},at=["disabled"],st={class:"upload-actions"},nt=["disabled"],ot={class:"form-group"},it={class:"preview-box"},rt=["src"],lt={key:1,class:"preview-placeholder"},dt={key:0,class:"form-hint"},ct={key:0,class:"image-meta"},ut={class:"meta-text"},vt={key:0,class:"meta-text"},mt={key:1,class:"image-preview-grid product-image-grid"},ft=["src","alt"],pt={key:0,class:"preview-badge"},gt={class:"preview-actions"},ht=["onClick"],_t=["onClick"],yt={key:2,class:"image-preview-grid product-image-grid"},bt=["src","alt"],wt={key:0,class:"preview-badge"},kt={class:"form-group"},xt={class:"form-group"},Tt={class:"form-group"},Ct=["disabled"],It={class:"form-group"},St={class:"form-group"},Mt={class:"form-actions"},Pt=["disabled"],Ut=["disabled"],Dt=["disabled"],jt={class:"main-content"},Et={class:"content-scroll"},Ot={key:0,class:"notice-banner error"},$t={key:1,class:"notice-banner success"},Bt={class:"content-section"},At={class:"content-header"},Lt={class:"search-wrapper"},Vt={key:0,class:"loading-state"},Ft={key:1},Nt={key:0,class:"empty-state"},Rt={key:1,class:"products-grid"},qt={class:"product-thumb"},zt=["src","alt"],Ht={key:0,class:"image-count-badge"},Jt={class:"product-body"},Wt={class:"product-title"},Gt={class:"product-meta"},Qt={key:0},Kt={key:1},Xt={key:2},Yt={key:0,class:"product-meta"},Zt={class:"product-actions"},ea=["disabled","onClick"],ta=["disabled","onClick"],aa={key:2,class:"pagination"},sa=["disabled"],na={class:"meta-text"},oa=["disabled"],ia=Ne({__name:"products-page",setup(da){const W=c([]),ee=c(!1),d=c(!1),N=c(""),R=c(""),g=c(0),w=c(20),O=c(0),te=c("");let ae=null;const le=c(null),$=c(!1),l=c([]),_=c([]),v=c(0),k=c(null),M=c(null),B=c(!1),A=c(null),o=Re({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),h=J(()=>!!k.value),se=J(()=>l.value[v.value]??null),be=J(()=>_.value.find(a=>a.is_primary)??_.value[0]??null),de=J(()=>{var a,e;return((a=se.value)==null?void 0:a.url)||((e=be.value)==null?void 0:e.image_url)||null}),ce=J(()=>l.value.length>0?l.value.length:_.value.length);function P(){N.value="",R.value=""}function y(a){N.value=a,R.value=""}function q(a){R.value=a,N.value=""}function we(a){try{return new Date(a).toLocaleString()}catch{return a}}function G(a){return a.split(`
`).map(e=>e.trim()).filter(Boolean)}function z(){M.value=null,A.value=null}function Q(){for(const a of l.value)a.url.startsWith("blob:")&&URL.revokeObjectURL(a.url)}function ke(){return globalThis.crypto&&"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function xe(a){const e=a.type.toLowerCase();if(e==="image/jpeg"||e==="image/png")return!0;const t=a.name.toLowerCase();return t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png")}function ue(a){if(h.value){y("编辑模式下无法更换图片");return}const e=Array.from(a);if(e.length===0)return;P();let t=0;for(const n of e){if(!xe(n)){t+=1;continue}const m=URL.createObjectURL(n);l.value.push({id:ke(),file:n,url:m})}l.value.length>0&&(v.value=Math.min(v.value,l.value.length-1),k.value=null,_.value=[],z()),t>0&&y("仅支持 JPG/PNG 图片")}function ve(){var a;h.value||(a=le.value)==null||a.click()}function Te(){h.value||($.value=!0)}function Ce(){h.value||($.value=!0)}function Ie(){$.value=!1}function Se(a){var e;h.value||($.value=!1,(e=a.dataTransfer)!=null&&e.files&&ue(a.dataTransfer.files))}function Me(){Q(),l.value=[],v.value=0,z()}function Pe(a){var t;const[e]=l.value.splice(a,1);(t=e==null?void 0:e.url)!=null&&t.startsWith("blob:")&&URL.revokeObjectURL(e.url),l.value.length===0||a===v.value?v.value=0:a<v.value&&(v.value-=1),z()}function Ue(a){a<0||a>=l.value.length||(v.value=a,z())}function De(a){const e=a.target;e.files&&(ue(e.files),e.value="")}async function me(a){const e=await a.text();try{const t=JSON.parse(e),n=(t==null?void 0:t.detail)??(t==null?void 0:t.error)??(t==null?void 0:t.message)??e;if(typeof n=="string")return n;if(n&&typeof n=="object"){const m=n==null?void 0:n.message;return typeof m=="string"?m:JSON.stringify(n)}return String(n||`HTTP ${a.status}`)}catch{return e||`HTTP ${a.status}`}}async function U(){ee.value=!0;try{const a=g.value,e=g.value+w.value-1,t=te.value.trim();let n=C.from("products").select("id,user_id,name,dimensions,original_image_url,recognition_confidence,created_at,updated_at",{count:"exact"}).order("created_at",{ascending:!1}).range(a,e);t&&(n=n.ilike("name",`%${t}%`));const{data:m,error:f,count:x}=await n;if(f)throw f;const D=m||[],L=D.map(b=>b.id),T=new Map;if(L.length){const{data:b,error:H}=await C.from("product_images").select("id,product_id").in("product_id",L);if(H)throw H;for(const K of b||[]){const j=K.product_id;T.set(j,(T.get(j)||0)+1)}}W.value=D.map(b=>({...b,image_count:T.get(b.id)||1})),O.value=x||0}catch(a){y(a.message||String(a))}finally{ee.value=!1}}async function fe(a){const{data:e,error:t}=await C.from("products").select("*").eq("id",a).single();if(t)throw t;const{data:n,error:m}=await C.from("product_images").select("id,image_url,is_primary,created_at,updated_at").eq("product_id",a).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(m)throw m;const f=n||[];return{...e,images:f,image_count:f.length||1}}function pe(){P(),Q(),l.value=[],_.value=[],v.value=0,$.value=!1,k.value=null,z(),o.name="",o.dimensions="",o.featuresText="",o.characteristicsText="",o.rawText=""}async function je(){if(P(),!se.value){y("请先选择图片");return}B.value=!0;try{const a=new FormData;a.append("image",se.value.file);const e=o.rawText.trim();e&&a.append("raw_text",e);const t=await Z("/api/v1/products/recognize",{method:"POST",body:a});if(!t.ok)throw new Error(await me(t));const n=await t.json();o.name=n.name||"",o.dimensions=n.dimensions||"",o.featuresText=(n.features||[]).join(`
`),o.characteristicsText=(n.characteristics||[]).join(`
`),M.value=n.confidence,A.value={confidence:n.confidence,metadata:n.metadata||{}},q(`AI整理完成（置信度：${Math.round(n.confidence*100)}%），可编辑后保存`)}catch(a){y(a.message||String(a))}finally{B.value=!1}}async function Ee(){var e,t,n,m;if(P(),l.value.length===0){y("请先选择图片");return}d.value=!0;let a=[];try{const f=await He();if(!f)throw new Error("Not authenticated");const x=globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,D=new FormData;D.append("product_id",x),D.append("primary_index",String(v.value));for(const S of l.value)D.append("images",S.file);const L=await Z("/api/v1/uploads/products",{method:"POST",body:D});if(!L.ok)throw new Error(await me(L));const T=await L.json();a=(T.images||[]).map(S=>S.image_url);const b=((e=T.images.find(S=>S.is_primary))==null?void 0:e.image_url)||((t=T.images[0])==null?void 0:t.image_url)||"";if(!b)throw new Error("Upload failed");const H=o.name.trim()||"未命名产品",K=o.dimensions.trim()||null,j=G(o.featuresText),X=G(o.characteristicsText),ge=((n=A.value)==null?void 0:n.confidence)??null,he=((m=A.value)==null?void 0:m.metadata)??null,{error:_e}=await C.from("products").insert({id:x,user_id:f,name:H,dimensions:K,features:j.length?j:null,characteristics:X.length?X:null,original_image_url:b,recognition_confidence:ge,recognition_metadata:he,updated_at:null});if(_e)throw _e;const Fe=T.images.map(S=>({product_id:x,user_id:f,image_url:S.image_url,is_primary:S.is_primary})),{data:Y,error:ye}=await C.from("product_images").insert(Fe).select("id,image_url,is_primary,created_at,updated_at");if(ye)throw ye;const I={id:x,user_id:f,name:H,dimensions:K,original_image_url:b,recognition_confidence:ge,image_count:(Y==null?void 0:Y.length)||T.images.length||1,created_at:new Date().toISOString(),updated_at:null,features:j.length?j:null,characteristics:X.length?X:null,recognition_metadata:he,images:Y||[]};q(`创建成功（AI：${Math.round((I.recognition_confidence??0)*100)}%），可继续编辑后保存`),k.value=I.id,M.value=I.recognition_confidence??0,A.value=null,Q(),l.value=[],v.value=0,_.value=I.images||[],o.name=I.name||"",o.dimensions=I.dimensions||"",o.featuresText=(I.features||[]).join(`
`),o.characteristicsText=(I.characteristics||[]).join(`
`),await U()}catch(f){if(a.length)for(const x of a)try{await Z("/api/v1/uploads/products/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_url:x})})}catch{}y(f.message||String(f))}finally{d.value=!1}}async function Oe(){if(P(),!!k.value){if(!o.name.trim()){y("产品名称不能为空");return}d.value=!0;try{const a={name:o.name.trim(),dimensions:o.dimensions.trim()||null,features:G(o.featuresText),characteristics:G(o.characteristicsText),updated_at:new Date().toISOString()},{error:e}=await C.from("products").update(a).eq("id",k.value);if(e)throw e;const t=await fe(k.value);M.value=t.recognition_confidence,_.value=t.images||_.value,q("已保存修改"),await U()}catch(a){y(a.message||String(a))}finally{d.value=!1}}}async function $e(a){P(),d.value=!0;try{const e=await fe(a);k.value=e.id,M.value=e.recognition_confidence??null,Q(),l.value=[],v.value=0,_.value=e.images||[],A.value=null,o.name=e.name||"",o.dimensions=e.dimensions||"",o.featuresText=(e.features||[]).join(`
`),o.characteristicsText=(e.characteristics||[]).join(`
`),q("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{d.value=!1}}async function Be(a){if(P(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){d.value=!0;try{const{data:e,error:t}=await C.from("product_images").select("image_url").eq("product_id",a);if(t)throw t;const n=(e||[]).map(f=>f.image_url).filter(Boolean),{error:m}=await C.from("products").delete().eq("id",a);if(m)throw m;for(const f of n)try{await Z("/api/v1/uploads/products/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_url:f})})}catch{}k.value===a&&pe(),q("已删除产品"),g.value>0&&W.value.length===1&&(g.value=Math.max(0,g.value-w.value)),await U()}catch(e){y(e.message||String(e))}finally{d.value=!1}}}function Ae(){g.value=Math.max(0,g.value-w.value),U()}function Le(){g.value+w.value>=O.value||(g.value=g.value+w.value,U())}function Ve(){ae&&window.clearTimeout(ae),ae=window.setTimeout(()=>{g.value=0,U()},250)}return qe(async()=>{await U()}),(a,e)=>(r(),i("div",Qe,[e[18]||(e[18]=ne('<header class="header" data-v-f8e1d32d><div class="logo" data-v-f8e1d32d><div class="logo-icon" data-v-f8e1d32d><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-f8e1d32d><rect x="3" y="3" width="18" height="18" rx="2" data-v-f8e1d32d></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-f8e1d32d></circle><polyline points="21 15 16 10 5 21" data-v-f8e1d32d></polyline></svg></div><span data-v-f8e1d32d>产品库</span></div><div class="header-actions" data-v-f8e1d32d><a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;" data-v-f8e1d32d><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f8e1d32d><path d="M19 12H5M12 19l-7-7 7-7" data-v-f8e1d32d></path></svg> 返回主页面 </a><a href="/video" class="btn btn-secondary" style="text-decoration:none;" data-v-f8e1d32d>视频生成</a><a href="/image" class="btn btn-secondary" style="text-decoration:none;" data-v-f8e1d32d>图像处理</a><a href="/storage" class="btn btn-secondary" style="text-decoration:none;" data-v-f8e1d32d>存储库</a></div></header>',1)),s("div",Ke,[s("aside",Xe,[s("section",Ye,[s("div",Ze,[s("div",et,[e[6]||(e[6]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),s("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),s("polyline",{points:"21 15 16 10 5 21"})],-1)),ze(" "+p(h.value?"编辑产品":"创建产品"),1)]),h.value?(r(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:pe}," 退出编辑 ")):u("",!0)]),e[15]||(e[15]=s("div",{class:"section-subtitle"},"上传产品图片，AI 自动识别结构化信息，支持多图管理",-1)),s("div",tt,[e[8]||(e[8]=s("label",{class:"form-label"},"产品图片",-1)),s("div",{class:oe(["upload-area",{"drag-over":$.value,"is-loading":d.value||B.value,"is-disabled":h.value}]),onClick:E(ve,["stop"]),onDragenter:E(Te,["prevent"]),onDragover:E(Ce,["prevent"]),onDragleave:E(Ie,["prevent"]),onDrop:E(Se,["prevent"])},[s("input",{ref_key:"fileInput",ref:le,type:"file",accept:"image/jpeg,image/png",multiple:"",disabled:h.value,onChange:De},null,40,at),e[7]||(e[7]=ne('<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f8e1d32d><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-f8e1d32d></path><polyline points="17 8 12 3 7 8" data-v-f8e1d32d></polyline><line x1="12" y1="3" x2="12" y2="15" data-v-f8e1d32d></line></svg><p class="upload-text" data-v-f8e1d32d><strong data-v-f8e1d32d>拖拽或点击上传多张产品图</strong></p><p class="upload-hint" data-v-f8e1d32d>主图用于 AI 识别与列表展示</p>',3))],34),s("div",st,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:h.value,onClick:E(ve,["stop"])}," 选择图片 ",8,nt),l.value.length>0?(r(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:E(Me,["stop"])}," 清空 ")):u("",!0)])]),s("div",ot,[e[9]||(e[9]=s("label",{class:"form-label"},"主图预览",-1)),s("div",it,[de.value?(r(),i("img",{key:0,src:de.value,alt:"preview",class:"preview-image"},null,8,rt)):(r(),i("div",lt,"未选择图片"))]),M.value!==null?(r(),i("div",dt," AI 置信度："+p(Math.round(M.value*100))+"% ",1)):u("",!0)]),ce.value>0?(r(),i("div",ct,[s("span",ut,"已选择 "+p(ce.value)+" 张图片",1),h.value&&l.value.length===0?(r(),i("span",vt,"编辑模式下图片不可替换")):u("",!0)])):u("",!0),l.value.length>0?(r(),i("div",mt,[(r(!0),i(ie,null,re(l.value,(t,n)=>(r(),i("div",{key:t.id,class:oe(["preview-item",{"is-primary":n===v.value}])},[s("img",{src:t.url,alt:`image-${n+1}`,class:"preview-img"},null,8,ft),n===v.value?(r(),i("div",pt,"主图")):u("",!0),s("div",gt,[n!==v.value?(r(),i("button",{key:0,class:"preview-action-btn",type:"button",onClick:m=>Ue(n)}," 设为主图 ",8,ht)):u("",!0),s("button",{class:"preview-action-btn danger",type:"button",onClick:m=>Pe(n)},"移除",8,_t)])],2))),128))])):_.value.length>0?(r(),i("div",yt,[(r(!0),i(ie,null,re(_.value,t=>(r(),i("div",{key:t.id,class:oe(["preview-item",{"is-primary":t.is_primary}])},[s("img",{src:t.image_url,alt:t.id,class:"preview-img"},null,8,bt),t.is_primary?(r(),i("div",wt,"主图")):u("",!0)],2))),128))])):u("",!0),s("div",kt,[e[10]||(e[10]=s("label",{class:"form-label"},"产品名称",-1)),V(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>o.name=t),class:"form-input",type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[F,o.name]])]),s("div",xt,[e[11]||(e[11]=s("label",{class:"form-label"},"尺寸规格",-1)),V(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>o.dimensions=t),class:"form-input",type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[F,o.dimensions]])]),s("div",Tt,[e[12]||(e[12]=s("label",{class:"form-label"},"无结构化信息（可选）",-1)),V(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=t=>o.rawText=t),rows:"3",class:"form-input",disabled:h.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,Ct),[[F,o.rawText]])]),s("div",It,[e[13]||(e[13]=s("label",{class:"form-label"},"功能特征（每行一个）",-1)),V(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>o.featuresText=t),rows:"4",class:"form-input"},null,512),[[F,o.featuresText]])]),s("div",St,[e[14]||(e[14]=s("label",{class:"form-label"},"产品特点（每行一个）",-1)),V(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=t=>o.characteristicsText=t),rows:"4",class:"form-input",placeholder:`例如：
便携
大容量`},null,512),[[F,o.characteristicsText]])]),s("div",Mt,[h.value?u("",!0):(r(),i("button",{key:0,class:"btn btn-secondary",type:"button",disabled:d.value||B.value,onClick:je},p(B.value?"AI整理中...":"AI整理预填"),9,Pt)),h.value?(r(),i("button",{key:2,class:"btn btn-primary",type:"button",disabled:d.value,onClick:Oe},p(d.value?"保存中...":"保存修改"),9,Dt)):(r(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:d.value||B.value,onClick:Ee},p(d.value?"保存中...":"保存产品"),9,Ut))])])]),s("main",jt,[s("div",Et,[N.value?(r(),i("section",Ot,p(N.value),1)):u("",!0),R.value?(r(),i("section",$t,p(R.value),1)):u("",!0),s("section",Bt,[s("div",At,[e[17]||(e[17]=ne('<div class="section-title section-title-lg" data-v-f8e1d32d><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f8e1d32d><path d="M3 3h7v7H3z" data-v-f8e1d32d></path><path d="M14 3h7v7h-7z" data-v-f8e1d32d></path><path d="M3 14h7v7H3z" data-v-f8e1d32d></path><path d="M14 14h7v7h-7z" data-v-f8e1d32d></path></svg> 产品列表 </div>',1)),s("div",Lt,[e[16]||(e[16]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("circle",{cx:"11",cy:"11",r:"8"}),s("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),V(s("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>te.value=t),class:"form-input",type:"text",placeholder:"搜索产品名称...",onInput:Ve},null,544),[[F,te.value]])])]),ee.value?(r(),i("div",Vt,"加载中...")):(r(),i("div",Ft,[W.value.length===0?(r(),i("div",Nt,"暂无产品")):(r(),i("div",Rt,[(r(!0),i(ie,null,re(W.value,t=>(r(),i("div",{key:t.id,class:"product-card"},[s("div",qt,[s("img",{src:t.original_image_url,alt:t.name},null,8,zt),t.image_count>1?(r(),i("span",Ht,p(t.image_count)+" 张",1)):u("",!0)]),s("div",Jt,[s("div",Wt,p(t.name),1),s("div",Gt,[t.dimensions?(r(),i("span",Qt,p(t.dimensions),1)):u("",!0),t.image_count>1?(r(),i("span",Kt,"· "+p(t.image_count)+" 张",1)):u("",!0),t.created_at?(r(),i("span",Xt,"· "+p(we(t.created_at)),1)):u("",!0)]),t.recognition_confidence!==null?(r(),i("div",Yt," AI："+p(Math.round((t.recognition_confidence??0)*100))+"% ",1)):u("",!0),s("div",Zt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:d.value,onClick:n=>$e(t.id)}," 编辑 ",8,ea),s("button",{class:"btn btn-ghost btn-sm danger",type:"button",disabled:d.value,onClick:n=>Be(t.id)}," 删除 ",8,ta)])])]))),128))])),O.value>w.value?(r(),i("div",aa,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:g.value===0||d.value,onClick:Ae}," 上一页 ",8,sa),s("span",na," 第 "+p(Math.floor(g.value/w.value)+1)+" / "+p(Math.max(1,Math.ceil(O.value/w.value)))+" 页（"+p(O.value)+" 条） ",1),s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:g.value+w.value>=O.value||d.value,onClick:Le}," 下一页 ",8,oa)])):u("",!0)]))])])])])]))}}),ra=Ge(ia,[["__scopeId","data-v-f8e1d32d"]]);async function la(){await Je(),We(ra).mount("#app")}la();
