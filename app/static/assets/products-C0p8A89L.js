import{d as ee,r as c,j as te,k as ae,o as ne,c as i,a as l,b as n,e as m,f as se,t as u,w as j,v as E,F as oe,l as ie,g as le}from"./runtime-dom.esm-bundler-8m2sFMtS.js";import{g as re}from"./auth-DhJl3iPe.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                   */function de(M,N){const r=`; ${document.cookie||""}`.split(`; ${M}=`);return r.length===2&&r.pop().split(";").shift()||null}function ue(){const M=de("csrf_token");return M?{"X-CSRF-Token":M}:{}}const ve={class:"products-page"},fe={class:"container"},me={class:"products-header"},pe={class:"header-actions"},ge={key:0,href:"/admin",class:"btn btn-secondary",style:{"text-decoration":"none"}},be={key:0,class:"card error-banner",style:{"margin-bottom":"18px"}},he={key:1,class:"card success-banner",style:{"margin-bottom":"18px"}},ye={class:"card"},_e={class:"card-title-row"},we={style:{margin:"0"}},xe={class:"card-actions"},ke={class:"form-grid",style:{"margin-top":"16px"}},Te={class:"form-group"},Se=["disabled"],Pe={class:"form-group"},Ce={class:"preview-box"},je=["src"],Ee={key:1,class:"preview-placeholder"},Me={key:0,class:"form-hint"},Ue={class:"form-grid",style:{"margin-top":"8px"}},Ae={class:"form-group"},Ie={class:"form-group"},Oe={class:"form-group",style:{"margin-top":"8px"}},$e=["disabled"],Ne={class:"form-grid",style:{"margin-top":"8px"}},De={class:"form-group"},Fe={class:"form-group"},Le={class:"form-actions"},Ve=["disabled"],Be=["disabled"],Je=["disabled"],Re={class:"card"},He={class:"card-title-row"},Ge={class:"card-actions"},ze={key:0,class:"loading"},Qe={key:1},We={key:0,class:"empty-state"},Xe={key:1,class:"products-grid"},qe={class:"product-thumb"},Ke=["src","alt"],Ye={class:"product-body"},Ze={class:"product-title"},et={class:"product-meta"},tt={key:0},at={key:1},nt={key:0,class:"product-meta"},st={class:"product-actions"},ot=["disabled","onClick"],it=["disabled","onClick"],lt={key:2,class:"pagination"},rt=["disabled"],ct={class:"meta-text"},dt=["disabled"],ut=ee({__name:"products-page",setup(M){const N=c(!1),U=c([]),D=c(!1),r=c(!1),A=c(""),I=c(""),d=c(0),v=c(20),T=c(0),F=c("");let B=null;const p=c(null),b=c(null),h=c(null),y=c(null),O=c(!1),w=c(null),s=te({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),S=ae(()=>!!h.value);function x(){A.value="",I.value=""}function g(t){A.value=t,I.value=""}function $(t){I.value=t,A.value=""}function R(t){try{return new Date(t).toLocaleString()}catch{return t}}function L(t){return t.split(`
`).map(e=>e.trim()).filter(Boolean)}function V(){p.value&&p.value.startsWith("blob:")&&URL.revokeObjectURL(p.value)}async function P(t){const e=await t.text();try{const a=JSON.parse(e),o=(a==null?void 0:a.detail)??(a==null?void 0:a.error)??(a==null?void 0:a.message)??e;if(typeof o=="string")return o;if(o&&typeof o=="object"){const _=o==null?void 0:o.message;return typeof _=="string"?_:JSON.stringify(o)}return String(o||`HTTP ${t.status}`)}catch{return e||`HTTP ${t.status}`}}async function C(t,e={}){const a=(e.method||"GET").toUpperCase(),o=new Headers(e.headers||{});if(!["GET","HEAD","OPTIONS"].includes(a))for(const[_,f]of Object.entries(ue()))o.set(_,f);return fetch(t,{...e,headers:o,credentials:"include"})}async function k(){D.value=!0;try{const t=new URLSearchParams;t.set("offset",String(d.value)),t.set("limit",String(v.value)),F.value.trim()&&t.set("name",F.value.trim());const e=await C(`/api/v1/products?${t.toString()}`);if(!e.ok)throw new Error(await P(e));const a=await e.json();U.value=a.products,T.value=a.total,d.value=a.offset,v.value=a.limit}catch(t){g(t.message||String(t))}finally{D.value=!1}}async function H(t){const e=await C(`/api/v1/products/${t}`);if(!e.ok)throw new Error(await P(e));return await e.json()}function J(){x(),V(),p.value=null,b.value=null,h.value=null,y.value=null,w.value=null,s.name="",s.dimensions="",s.featuresText="",s.characteristicsText="",s.rawText=""}function G(t){var o;const a=(o=t.target.files)==null?void 0:o[0];a&&(x(),b.value=a,h.value=null,y.value=null,w.value=null,V(),p.value=URL.createObjectURL(a))}async function z(){if(x(),!b.value){g("请先选择图片");return}O.value=!0;try{const t=new FormData;t.append("image",b.value);const e=s.rawText.trim();e&&t.append("raw_text",e);const a=await C("/api/v1/products/recognize",{method:"POST",body:t});if(!a.ok)throw new Error(await P(a));const o=await a.json();s.name=o.name||"",s.dimensions=o.dimensions||"",s.featuresText=(o.features||[]).join(`
`),s.characteristicsText=(o.characteristics||[]).join(`
`),y.value=o.confidence,w.value={confidence:o.confidence,metadata:o.metadata||{}},$(`AI整理完成（置信度：${Math.round(o.confidence*100)}%），可编辑后保存`)}catch(t){g(t.message||String(t))}finally{O.value=!1}}async function Q(){if(x(),!b.value){g("请先选择图片");return}r.value=!0;try{const t=new FormData;t.append("image",b.value);const e=s.name.trim();e&&t.append("name",e),s.dimensions.trim()&&t.append("dimensions",s.dimensions.trim());const a=L(s.featuresText),o=L(s.characteristicsText);a.length&&t.append("features",JSON.stringify(a)),o.length&&t.append("characteristics",JSON.stringify(o)),w.value?(t.append("recognition_mode","prefill"),t.append("recognition_confidence",String(w.value.confidence)),t.append("recognition_metadata_json",JSON.stringify(w.value.metadata))):t.append("recognition_mode","manual");const _=await C("/api/v1/products",{method:"POST",body:t});if(!_.ok)throw new Error(await P(_));const f=await _.json();$(`创建成功（AI：${Math.round((f.recognition_confidence??0)*100)}%），可继续编辑后保存`),h.value=f.id,y.value=f.recognition_confidence??0,w.value=null,V(),p.value=f.original_image_url,b.value=null,s.name=f.name||"",s.dimensions=f.dimensions||"",s.featuresText=(f.features||[]).join(`
`),s.characteristicsText=(f.characteristics||[]).join(`
`),await k()}catch(t){g(t.message||String(t))}finally{r.value=!1}}async function W(){if(x(),!!h.value){if(!s.name.trim()){g("产品名称不能为空");return}r.value=!0;try{const t={name:s.name.trim(),dimensions:s.dimensions.trim()||null,features:L(s.featuresText),characteristics:L(s.characteristicsText)},e=await C(`/api/v1/products/${h.value}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(await P(e));const a=await e.json();y.value=a.recognition_confidence,$("已保存修改"),await k()}catch(t){g(t.message||String(t))}finally{r.value=!1}}}async function X(t){x(),r.value=!0;try{const e=await H(t);h.value=e.id,y.value=e.recognition_confidence??null,V(),p.value=e.original_image_url,b.value=null,s.name=e.name||"",s.dimensions=e.dimensions||"",s.featuresText=(e.features||[]).join(`
`),s.characteristicsText=(e.characteristics||[]).join(`
`),$("已加载产品信息，可编辑后保存")}catch(e){g(e.message||String(e))}finally{r.value=!1}}async function q(t){if(x(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){r.value=!0;try{const e=await C(`/api/v1/products/${t}`,{method:"DELETE"});if(!e.ok&&e.status!==204)throw new Error(await P(e));h.value===t&&J(),$("已删除产品"),d.value>0&&U.value.length===1&&(d.value=Math.max(0,d.value-v.value)),await k()}catch(e){g(e.message||String(e))}finally{r.value=!1}}}function K(){d.value=Math.max(0,d.value-v.value),k()}function Y(){d.value+v.value>=T.value||(d.value=d.value+v.value,k())}function Z(){B&&window.clearTimeout(B),B=window.setTimeout(()=>{d.value=0,k()},250)}return ne(async()=>{try{const t=await re();N.value=!!(t!=null&&t.is_admin)}catch{N.value=!1}await k()}),(t,e)=>(l(),i("div",ve,[n("div",fe,[n("header",me,[e[9]||(e[9]=se('<div class="header-left" data-v-fabb8e9b><a href="/" class="btn btn-secondary" style="text-decoration:none;" data-v-fabb8e9b><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-fabb8e9b><path d="M19 12H5M12 19l-7-7 7-7" data-v-fabb8e9b></path></svg> 返回首页 </a><div data-v-fabb8e9b><h1 style="margin:0;text-align:left;" data-v-fabb8e9b>产品库</h1><div class="meta-text" data-v-fabb8e9b>上传产品图片，AI识别后可手动修正</div></div></div>',1)),n("div",pe,[e[6]||(e[6]=n("a",{href:"/video",class:"btn btn-secondary",style:{"text-decoration":"none"}},"视频",-1)),e[7]||(e[7]=n("a",{href:"/image",class:"btn btn-secondary",style:{"text-decoration":"none"}},"图片",-1)),e[8]||(e[8]=n("a",{href:"/storage",class:"btn btn-secondary",style:{"text-decoration":"none"}},"存储",-1)),N.value?(l(),i("a",ge,"Admin")):m("",!0)])]),A.value?(l(),i("section",be,u(A.value),1)):m("",!0),I.value?(l(),i("section",he,u(I.value),1)):m("",!0),n("section",ye,[n("div",_e,[n("h2",we,u(S.value?"编辑产品信息":"上传新产品"),1),n("div",xe,[S.value?(l(),i("button",{key:0,class:"btn btn-secondary btn-sm",type:"button",onClick:J}," 取消编辑 ")):m("",!0)])]),n("div",ke,[n("div",Te,[e[10]||(e[10]=n("label",null,"产品图片",-1)),n("input",{type:"file",accept:"image/jpeg,image/png",disabled:S.value,onChange:G},null,40,Se),e[11]||(e[11]=n("div",{class:"form-hint"}," 支持 JPG/PNG；上传后服务端会进行 AI 识别（大图会自动压缩用于识别，不影响原图存储） ",-1))]),n("div",Pe,[e[12]||(e[12]=n("label",null,"图片预览",-1)),n("div",Ce,[p.value?(l(),i("img",{key:0,src:p.value,alt:"preview",class:"preview-image"},null,8,je)):(l(),i("div",Ee,"未选择图片"))]),y.value!==null?(l(),i("div",Me," AI 置信度："+u(Math.round(y.value*100))+"% ",1)):m("",!0)])]),n("div",Ue,[n("div",Ae,[e[13]||(e[13]=n("label",null,"产品名称",-1)),j(n("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.name=a),type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[E,s.name]])]),n("div",Ie,[e[14]||(e[14]=n("label",null,"尺寸规格",-1)),j(n("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.dimensions=a),type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[E,s.dimensions]])])]),n("div",Oe,[e[15]||(e[15]=n("label",null,"无结构化信息（可选）",-1)),j(n("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.rawText=a),rows:"3",disabled:S.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,$e),[[E,s.rawText]]),e[16]||(e[16]=n("div",{class:"form-hint"}," 提供此信息可帮助AI更准确地识别产品属性 ",-1))]),n("div",Ne,[n("div",De,[e[17]||(e[17]=n("label",null,"功能特征（每行一个）",-1)),j(n("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>s.featuresText=a),rows:"5",placeholder:`例如：
24小时保温
不锈钢内胆`},null,512),[[E,s.featuresText]])]),n("div",Fe,[e[18]||(e[18]=n("label",null,"产品特点（每行一个）",-1)),j(n("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>s.characteristicsText=a),rows:"5",placeholder:`例如：
便携
大容量`},null,512),[[E,s.characteristicsText]])])]),n("div",Le,[S.value?m("",!0):(l(),i("button",{key:0,class:"btn btn-secondary",type:"button",disabled:r.value||O.value,onClick:z},u(O.value?"AI整理中...":"AI整理预填"),9,Ve)),S.value?(l(),i("button",{key:2,class:"btn btn-primary",type:"button",disabled:r.value,onClick:W},u(r.value?"保存中...":"保存修改"),9,Je)):(l(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:r.value||O.value,onClick:Q},u(r.value?"保存中...":"保存产品"),9,Be))])]),n("section",Re,[n("div",He,[e[19]||(e[19]=n("h2",{style:{margin:"0"}},"我的产品",-1)),n("div",Ge,[j(n("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>F.value=a),type:"text",placeholder:"搜索名称...",style:{width:"260px","max-width":"100%"},onInput:Z},null,544),[[E,F.value]])])]),D.value?(l(),i("div",ze,"加载中...")):(l(),i("div",Qe,[U.value.length===0?(l(),i("div",We,"暂无产品")):(l(),i("div",Xe,[(l(!0),i(oe,null,ie(U.value,a=>(l(),i("div",{key:a.id,class:"product-card"},[n("div",qe,[n("img",{src:a.original_image_url,alt:a.name},null,8,Ke)]),n("div",Ye,[n("div",Ze,u(a.name),1),n("div",et,[a.dimensions?(l(),i("span",tt,u(a.dimensions),1)):m("",!0),a.created_at?(l(),i("span",at,"· "+u(R(a.created_at)),1)):m("",!0)]),a.recognition_confidence!==null?(l(),i("div",nt," AI："+u(Math.round((a.recognition_confidence??0)*100))+"% ",1)):m("",!0),n("div",st,[n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:r.value,onClick:o=>X(a.id)}," 编辑 ",8,ot),n("button",{class:"btn btn-secondary btn-sm danger",type:"button",disabled:r.value,onClick:o=>q(a.id)}," 删除 ",8,it)])])]))),128))])),T.value>v.value?(l(),i("div",lt,[n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:d.value===0||r.value,onClick:K}," 上一页 ",8,rt),n("span",ct," 第 "+u(Math.floor(d.value/v.value)+1)+" / "+u(Math.max(1,Math.ceil(T.value/v.value)))+" 页（"+u(T.value)+" 条） ",1),n("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:d.value+v.value>=T.value||r.value,onClick:Y}," 下一页 ",8,dt)])):m("",!0)]))])])]))}}),vt=ce(ut,[["__scopeId","data-v-fabb8e9b"]]);le(vt).mount("#app");
