import{s as T,x as ce,y as de}from"./supabase-B0pzQ9CJ.js";const x={apiKey:"global_api_key",baseUrl:"global_base_url"},A="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200" viewBox="0 0 320 200"><rect width="320" height="200" fill="#111827"/><rect x="52" y="40" width="216" height="120" rx="12" fill="none" stroke="#9CA3AF" stroke-width="6"/><path d="M76 142l54-64 44 52 30-36 70 84H76z" fill="#374151"/><circle cx="116" cy="82" r="10" fill="#6B7280"/><line x1="92" y1="62" x2="228" y2="138" stroke="#9CA3AF" stroke-width="6"/><line x1="228" y1="62" x2="92" y2="138" stroke="#9CA3AF" stroke-width="6"/></svg>');function me(e){return String(e||"").trim().replace(/^bearer\s+/i,"").trim()}function ee(e,t){e&&e.querySelectorAll(t).forEach(i=>{i.addEventListener("error",()=>{i.dataset.fallbackApplied||(i.dataset.fallbackApplied="true",i.alt="Image unavailable",i.src=A)},{once:!0})})}function ge(e){const t=String(e||"").trim();if(!t)return null;let i;try{i=new URL(t)}catch{throw new Error("Base URL is not a valid URL")}if(i.protocol!=="https:")throw new Error("Base URL must use HTTPS");if(!i.hostname)throw new Error("Base URL is missing host (e.g. https://api.example.com)");return i.origin}function te(e,t,i,a){const r=Number.parseInt(String(e??""),10);return Number.isFinite(r)?Math.min(i,Math.max(t,r)):a}async function $(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const i=await e.text();try{return JSON.parse(i)}catch{return i}}function ue(e,t){if(typeof e=="string")return e;if(!e||typeof e!="object")return t;const i=e.detail??e.error??e.message;if(typeof i=="string")return i;try{return JSON.stringify(i??e)}catch{return t}}function ye(e){const t=[];if(!e||typeof e!="object")return t;const i=e.data;if(Array.isArray(i))for(const a of i)!a||typeof a!="object"||(typeof a.url=="string"&&a.url?t.push(a.url):typeof a.b64_json=="string"&&a.b64_json?t.push(`data:image/png;base64,${a.b64_json}`):typeof a.image_url=="string"&&a.image_url?t.push(a.image_url):typeof a.imageUrl=="string"&&a.imageUrl&&t.push(a.imageUrl));return t.length===0&&(typeof e.url=="string"&&e.url?t.push(e.url):typeof e.b64_json=="string"&&e.b64_json?t.push(`data:image/png;base64,${e.b64_json}`):typeof e.image_url=="string"&&e.image_url?t.push(e.image_url):typeof e.imageUrl=="string"&&e.imageUrl&&t.push(e.imageUrl)),t}const o={config:{apiKey:localStorage.getItem(x.apiKey)||localStorage.getItem("video_api_key")||localStorage.getItem("apiKey")||"",baseUrl:localStorage.getItem(x.baseUrl)||localStorage.getItem("video_base_url")||localStorage.getItem("baseUrl")||""},images:[],currentImageIndex:-1,prompt:"",promptHistory:(()=>{try{return JSON.parse(localStorage.getItem("promptHistory")||"[]")}catch{return localStorage.removeItem("promptHistory"),[]}})(),generationHistory:(()=>{try{return JSON.parse(localStorage.getItem("generationHistory")||"[]")}catch{return localStorage.removeItem("generationHistory"),[]}})(),inlineHistoryCollapsed:localStorage.getItem("inlineHistoryCollapsed")==="true",inlineHistoryLimit:6,inlineHistoryShowAll:!1,editingHistoryIndex:-1,isGenerating:!1,currentZoom:100,canvasZoom:100,canvasHistory:[],canvasHistoryIndex:-1,originalImage:null,originalWidth:0,originalHeight:0,displayScale:1},n={modelSelect:document.getElementById("modelSelect"),modelSearch:document.getElementById("modelSearch"),aspectRatio:document.getElementById("aspectRatio"),imageSize:document.getElementById("imageSize"),batchCount:document.getElementById("batchCount"),uploadArea:document.getElementById("uploadArea"),fileInput:document.getElementById("fileInput"),imagePreviewGrid:document.getElementById("imagePreviewGrid"),editMaskBtn:document.getElementById("editMaskBtn"),maskModalOverlay:document.getElementById("maskModalOverlay"),closeMaskModal:document.getElementById("closeMaskModal"),cancelMaskBtn:document.getElementById("cancelMaskBtn"),canvasContainer:document.getElementById("canvasContainer"),canvasWrapper:document.getElementById("canvasWrapper"),maskCanvas:document.getElementById("maskCanvas"),brushSize:document.getElementById("brushSize"),brushSizeLabel:document.getElementById("brushSizeLabel"),brushColor:document.getElementById("brushColor"),undoBtn:document.getElementById("undoBtn"),redoBtn:document.getElementById("redoBtn"),clearCanvasBtn:document.getElementById("clearCanvasBtn"),saveMaskBtn:document.getElementById("saveMaskBtn"),resetMaskBtn:document.getElementById("resetMaskBtn"),canvasZoomInBtn:document.getElementById("canvasZoomInBtn"),canvasZoomOutBtn:document.getElementById("canvasZoomOutBtn"),canvasZoomResetBtn:document.getElementById("canvasZoomResetBtn"),canvasZoomLevel:document.getElementById("canvasZoomLevel"),promptInput:document.getElementById("promptInput"),charCount:document.getElementById("charCount"),showPromptHistory:document.getElementById("showPromptHistory"),promptHistoryDropdown:document.getElementById("promptHistoryDropdown"),imagePreviewOverlay:document.getElementById("imagePreviewOverlay"),imagePreviewImg:document.getElementById("imagePreviewImg"),imagePreviewInfo:document.getElementById("imagePreviewInfo"),closeImagePreview:document.getElementById("closeImagePreview"),resultArea:document.getElementById("resultArea"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultImage:document.getElementById("resultImage"),generateBtn:document.getElementById("generateBtn"),downloadBtn:document.getElementById("downloadBtn"),shareBtn:document.getElementById("shareBtn"),fullscreenBtn:document.getElementById("fullscreenBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomLevel:document.getElementById("zoomLevel"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),historyList:document.getElementById("historyList"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),inlineHistoryShowMore:document.getElementById("inlineHistoryShowMore"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),editPromptModalOverlay:document.getElementById("editPromptModalOverlay"),editPromptTextarea:document.getElementById("editPromptTextarea"),closeEditPromptModal:document.getElementById("closeEditPromptModal"),cancelEditPromptBtn:document.getElementById("cancelEditPromptBtn"),saveEditPromptBtn:document.getElementById("saveEditPromptBtn"),imageZoomOverlay:document.getElementById("imageZoomOverlay"),zoomImage:document.getElementById("zoomImage"),closeZoomBtn:document.getElementById("closeZoomBtn"),toastContainer:document.getElementById("toastContainer")};let y=null,m=null,p=null,S=!1,O="brush",L=0,k=0;function l(e,t,i){const a=document.createElement("div");a.className=`toast ${e}`;const r={success:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',error:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'};a.innerHTML=`
        ${r[e]}
        <div class="toast-content">
            <div class="toast-title">${t}</div>
            ${i?`<div class="toast-message">${i}</div>`:""}
        </div>
        <button class="toast-close">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    `,n.toastContainer.appendChild(a),a.querySelector(".toast-close").addEventListener("click",()=>{a.remove()}),setTimeout(()=>{a.remove()},5e3)}function I(e,t){n.statusDot.className="status-dot "+e,n.statusText.textContent=t}function ne(e){return new Intl.DateTimeFormat("zh-CN",{hour:"2-digit",minute:"2-digit"}).format(e)}function pe(e){return new Intl.DateTimeFormat("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function ve(){o.config.apiKey=localStorage.getItem(x.apiKey)||localStorage.getItem("video_api_key")||"",o.config.baseUrl=localStorage.getItem(x.baseUrl)||localStorage.getItem("video_base_url")||"",o.config.apiKey||o.config.baseUrl?I("connected","Configured"):I("","Ready")}function _(e){Array.from(e).forEach(t=>{if(!t.type.startsWith("image/")){l("error","Invalid file type","Please upload an image file");return}if(t.size>10*1024*1024){l("error","File too large","Maximum file size is 10MB");return}const i=new FileReader;i.onload=a=>{o.images.push({id:Date.now()+Math.random(),name:t.name,originalData:a.target.result,data:a.target.result,hasMask:!1}),v(),o.images.length===1&&oe(0)},i.readAsDataURL(t)})}function v(){n.imagePreviewGrid.innerHTML=o.images.map((e,t)=>`
        <div class="image-preview-item ${t===o.currentImageIndex?"active":""}" data-index="${t}">
            <img src="${e.data}" alt="${e.name}">
            <button class="remove-btn" data-index="${t}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            ${e.hasMask?'<span class="edit-indicator">Mask</span>':""}
        </div>
    `).join(""),n.imagePreviewGrid.querySelectorAll(".image-preview-item").forEach(e=>{e.addEventListener("click",t=>{t.target.closest(".remove-btn")||oe(parseInt(e.dataset.index))})}),n.imagePreviewGrid.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),fe(parseInt(e.dataset.index))})}),he()}function he(){n.editMaskBtn.disabled=o.images.length===0||o.currentImageIndex<0}function oe(e){o.currentImageIndex=e,v()}function fe(e){o.images.splice(e,1),o.currentImageIndex>=o.images.length&&(o.currentImageIndex=o.images.length-1),v()}function Ie(){if(o.currentImageIndex<0||!o.images[o.currentImageIndex]){l("warning","No image selected","Please select an image first");return}n.maskModalOverlay.classList.add("show"),setTimeout(()=>{R()},100)}function h(){n.maskModalOverlay.classList.remove("show")}function R(){if(o.currentImageIndex<0||!o.images[o.currentImageIndex])return;o.canvasZoom=100,C();const e=new Image;e.onload=()=>{o.originalWidth=e.width,o.originalHeight=e.height,o.originalImage=e,m=document.createElement("canvas"),m.width=e.width,m.height=e.height,p=m.getContext("2d"),p.drawImage(e,0,0);const t=n.canvasContainer.clientWidth-40,i=n.canvasContainer.clientHeight-40||500;let a=e.width,r=e.height;const c=t/e.width,d=i/e.height;o.displayScale=Math.min(c,d,1),a=Math.floor(e.width*o.displayScale),r=Math.floor(e.height*o.displayScale);const s=n.maskCanvas;s.width=a,s.height=r,s.style.width=a+"px",s.style.height=r+"px",y=s.getContext("2d"),y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.drawImage(e,0,0,a,r),o.canvasHistory=[{display:s.toDataURL(),fullRes:m.toDataURL()}],o.canvasHistoryIndex=0},e.src=o.images[o.currentImageIndex].data}function ie(e){const t=n.maskCanvas.getBoundingClientRect(),i=n.maskCanvas.width/t.width,a=n.maskCanvas.height/t.height;return{x:(e.clientX-t.left)*i,y:(e.clientY-t.top)*a}}function G(e){if(!y||!p)return;S=!0;const t=ie(e);L=t.x,k=t.y}function N(e){if(!S||!y||!p)return;const t=ie(e),i=t.x,a=t.y,r=parseInt(n.brushSize.value),c=n.brushColor.value;q(y,L,k,i,a,r,c,O==="eraser");const d=L/o.displayScale,s=k/o.displayScale,M=i/o.displayScale,g=a/o.displayScale,B=r/o.displayScale;q(p,d,s,M,g,B,c,O==="eraser"),L=i,k=a}function q(e,t,i,a,r,c,d,s){e.beginPath(),e.moveTo(t,i),e.lineTo(a,r),e.strokeStyle=d,e.lineWidth=c,e.lineCap="round",e.lineJoin="round",s?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over",e.stroke(),e.globalCompositeOperation="source-over"}function D(){S&&(S=!1,we(),o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].hasMask=!0,v()))}function we(){!n.maskCanvas||!m||(o.canvasHistoryIndex++,o.canvasHistory=o.canvasHistory.slice(0,o.canvasHistoryIndex),o.canvasHistory.push({display:n.maskCanvas.toDataURL(),fullRes:m.toDataURL()}),o.canvasHistory.length>50&&(o.canvasHistory.shift(),o.canvasHistoryIndex--))}function F(){o.canvasHistoryIndex>0&&(o.canvasHistoryIndex--,ae())}function j(){o.canvasHistoryIndex<o.canvasHistory.length-1&&(o.canvasHistoryIndex++,ae())}function ae(){const e=o.canvasHistory[o.canvasHistoryIndex];if(!e)return;const t=new Image;t.onload=()=>{y.clearRect(0,0,n.maskCanvas.width,n.maskCanvas.height),y.drawImage(t,0,0)},t.src=e.display;const i=new Image;i.onload=()=>{p.clearRect(0,0,m.width,m.height),p.drawImage(i,0,0)},i.src=e.fullRes}function Ee(){o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].data=o.images[o.currentImageIndex].originalData,o.images[o.currentImageIndex].hasMask=!1,R(),v())}function K(){if(!m||o.currentImageIndex<0){l("warning","No mask to save","Please draw on the image first");return}const e=m.toDataURL("image/png");o.images[o.currentImageIndex].data=e,o.images[o.currentImageIndex].hasMask=!0,saveToDrawingHistory(e),v(),h(),l("success","Mask saved","The mask has been applied to the image")}function Be(){o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].data=o.images[o.currentImageIndex].originalData,o.images[o.currentImageIndex].hasMask=!1,R(),v(),l("success","Mask reset","Image restored to original"))}function C(){n.canvasZoomLevel.textContent=`${o.canvasZoom}%`,n.canvasWrapper.style.transform=`scale(${o.canvasZoom/100})`}function Y(){o.canvasZoom<300&&(o.canvasZoom+=25,C())}function X(){o.canvasZoom>50&&(o.canvasZoom-=25,C())}function He(){o.canvasZoom=100,C()}async function Le(){const{data:e}=await T.auth.getSession();return e.session?!0:(window.location.href="/login?next=/image",!1)}async function re(){try{const{data:e,error:t}=await T.from("user_images").select("id,title,model,prompt,image_url,created_at").order("created_at",{ascending:!1}).limit(50);if(t)throw t;const i=e||[]}catch(e){console.error("Failed to load images from repository:",e),l("error","Load failed",e.message||"Failed to load images from repository")}}function J(){n.imagePreviewOverlay.classList.remove("show"),setTimeout(()=>{n.imagePreviewImg.src=""},300)}function w(){const e=n.promptInput.value.length;n.charCount.textContent=e}function ke(e){if(e.trim()){o.promptHistory=o.promptHistory.filter(t=>t.text!==e),o.promptHistory.unshift({text:e,time:new Date().toISOString()}),o.promptHistory=o.promptHistory.slice(0,20);try{localStorage.setItem("promptHistory",JSON.stringify(o.promptHistory))}catch(t){console.warn("Failed to persist prompt history:",t)}}}function se(){if(o.promptHistory.length===0){n.promptHistoryDropdown.innerHTML='<p style="padding: 12px; text-align: center; color: var(--text-muted);">No history yet</p>';return}n.promptHistoryDropdown.innerHTML=o.promptHistory.map((e,t)=>`
	                <div class="prompt-history-item" data-index="${t}">
	                    <span class="prompt-text">${e.text}</span>
	                    <div class="prompt-history-actions">
	                        <span class="prompt-time">${ne(new Date(e.time))}</span>
	                        <button class="prompt-history-delete" data-index="${t}" title="Delete">
	                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M18 6L6 18M6 6l12 12"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `).join(""),n.promptHistoryDropdown.querySelectorAll(".prompt-history-item").forEach(e=>{e.addEventListener("click",t=>{t.target.closest(".prompt-history-delete")||(n.promptInput.value=o.promptHistory[parseInt(e.dataset.index)].text,w(),n.promptHistoryDropdown.classList.remove("show"))})}),n.promptHistoryDropdown.querySelectorAll(".prompt-history-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),xe(parseInt(e.dataset.index))})})}function xe(e){if(!(Number.isNaN(e)||e<0||e>=o.promptHistory.length)){o.promptHistory.splice(e,1);try{localStorage.setItem("promptHistory",JSON.stringify(o.promptHistory))}catch(t){console.warn("Failed to persist prompt history:",t)}se(),l("success","Deleted","Prompt history item removed")}}function Se(e,t){o.generationHistory.unshift({prompt:e,imageUrl:t,model:n.modelSelect.value,time:new Date().toISOString()}),o.generationHistory=o.generationHistory.slice(0,50);try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(i){console.warn("Failed to persist generation history:",i)}b(),E()}function b(){if(o.generationHistory.length===0){n.historyList.innerHTML='<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>';return}n.historyList.innerHTML=o.generationHistory.map((e,t)=>`
	                <div class="history-item" data-index="${t}">
	                    <img class="history-item-image" src="${e.imageUrl}" alt="Generated" loading="lazy" decoding="async">
	                    <div class="history-item-content">
	                        <div class="history-item-prompt">${e.prompt}</div>
	                        <div class="history-item-meta">${e.model} - ${ne(new Date(e.time))}</div>
	                    </div>
	                    <button class="history-item-delete" data-index="${t}" title="Delete">
	                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M18 6L6 18M6 6l12 12"/>
	                        </svg>
	                    </button>
	                </div>
	            `).join(""),n.historyList.querySelectorAll(".history-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".history-item-delete"))return;const i=o.generationHistory[parseInt(e.dataset.index)];Z(i.imageUrl),n.promptInput.value=i.prompt,w()})}),n.historyList.querySelectorAll(".history-item-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),Oe(parseInt(e.dataset.index))})}),ee(n.historyList,".history-item-image")}function E(){const e=o.generationHistory,t=e.length;if(n.inlineHistoryCount.textContent=t,o.inlineHistoryCollapsed?n.inlineHistorySection.classList.add("collapsed"):n.inlineHistorySection.classList.remove("collapsed"),t===0){n.inlineHistoryGrid.innerHTML='<p class="inline-history-empty">No generation history yet. Create your first image!</p>',n.inlineHistoryShowMore.style.display="none";return}const i=o.inlineHistoryShowAll?t:Math.min(o.inlineHistoryLimit,t),a=e.slice(0,i);n.inlineHistoryGrid.innerHTML=a.map((r,c)=>{const d=r.prompt.length>100?r.prompt.substring(0,100)+"...":r.prompt,s=pe(new Date(r.time));return`
            <div class="inline-history-item" data-index="${c}">
                <div class="inline-history-item-actions">
                    <button class="inline-history-action-btn load" data-index="${c}" title="Load prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn edit" data-index="${c}" title="Edit prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn delete" data-index="${c}" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
                <img class="inline-history-item-image" src="${r.imageUrl}" alt="Generated" loading="lazy">
                <div class="inline-history-item-info">
                    <div class="inline-history-item-prompt" title="${r.prompt.replace(/"/g,"&quot;")}">${d}</div>
                    <div class="inline-history-item-meta">
                        <span>${r.model}</span>
                        <span>•</span>
                        <span>${s}</span>
                    </div>
                </div>
            </div>
        `}).join(""),t>o.inlineHistoryLimit&&!o.inlineHistoryShowAll?(n.inlineHistoryShowMore.style.display="flex",n.showMoreHistoryBtn.textContent=`Show more (${t-i} more)`):o.inlineHistoryShowAll&&t>o.inlineHistoryLimit?(n.inlineHistoryShowMore.style.display="flex",n.showMoreHistoryBtn.textContent="Show less"):n.inlineHistoryShowMore.style.display="none",Ce(),ee(n.inlineHistoryGrid,".inline-history-item-image")}function Ce(){n.inlineHistoryGrid.querySelectorAll(".inline-history-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".inline-history-action-btn"))return;const i=parseInt(e.dataset.index);W(i)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.load").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);W(i)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.edit").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);Me(i)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);le(i)})})}function W(e){const t=o.generationHistory[e];t&&(Z(t.imageUrl),n.promptInput.value=t.prompt,w(),l("success","Loaded","Prompt and image loaded from history"))}function le(e){if(confirm("Delete this generation from history?")){o.generationHistory.splice(e,1);try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(t){console.warn("Failed to persist generation history:",t)}E(),b(),l("success","Deleted","Generation removed from history")}}function be(e,t){if(!(e<0||e>=o.generationHistory.length)){o.generationHistory[e].prompt=t;try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(i){console.warn("Failed to persist generation history:",i)}E(),b(),l("success","Updated","Prompt has been updated")}}function Me(e){const t=o.generationHistory[e];t&&(o.editingHistoryIndex=e,n.editPromptTextarea.value=t.prompt,n.editPromptModalOverlay.classList.add("show"),n.editPromptTextarea.focus())}function f(){n.editPromptModalOverlay.classList.remove("show"),o.editingHistoryIndex=-1,n.editPromptTextarea.value=""}function Pe(){if(o.editingHistoryIndex<0)return;const e=n.editPromptTextarea.value.trim();if(!e){l("error","Invalid","Prompt cannot be empty");return}be(o.editingHistoryIndex,e),f()}function De(){o.inlineHistoryCollapsed=!o.inlineHistoryCollapsed,localStorage.setItem("inlineHistoryCollapsed",o.inlineHistoryCollapsed.toString()),o.inlineHistoryCollapsed?n.inlineHistorySection.classList.add("collapsed"):n.inlineHistorySection.classList.remove("collapsed")}function Ae(){o.inlineHistoryShowAll=!o.inlineHistoryShowAll,E()}function Oe(e){le(e)}async function V(){var i;const e=n.promptInput.value.trim(),t=te((i=n.batchCount)==null?void 0:i.value,1,10,1);if(n.batchCount&&(n.batchCount.value=String(t)),!e){l("error","Prompt required","Please enter a prompt");return}if(!(t>=6&&!confirm(`将并发生成 ${t} 张图片，确认继续？`))){o.isGenerating=!0,n.generateBtn.disabled=!0,n.resultPlaceholder.style.display="none",n.resultContainer.style.display="none",n.loadingState.style.display="block",I("generating","Generating...");try{const a=new FormData;a.append("model",n.modelSelect.value),a.append("prompt",e),a.append("n",String(t)),a.append("response_format","url"),n.aspectRatio.value&&a.append("aspect_ratio",n.aspectRatio.value),n.imageSize.value&&a.append("image_size",n.imageSize.value);for(const u of o.images){const H=u.data,P=await(await fetch(H)).blob();a.append("image",P,u.name||"image.png")}const r=me(o.config.apiKey),c=ge(o.config.baseUrl),d=await ce("/api/v1/images/edits",{method:"POST",headers:{...r?{"X-API-Key":r}:{},...c?{"X-Base-Url":c}:{}},body:a});if(!d.ok){const u=await $(d);if(d.status===401){window.location.href="/login?next=/image";return}throw new Error(ue(u,`Request failed (HTTP ${d.status})`))}const s=await $(d),M=s&&typeof s=="object"&&s.response?s.response:s,g=ye(M);if(!g.length)throw new Error("No image URL in response");Z(g[0]),ke(e);for(let u=g.length-1;u>=0;u-=1)Se(e,g[u]);l("success",g.length>1?"Images generated":"Image generated",g.length>1?`Generated ${g.length} images successfully`:"Your image has been created successfully");const B=await de();if(B){const u=g.map((U,P)=>({user_id:B,title:null,model:n.modelSelect.value||"unknown",prompt:e,status:"completed",image_url:U,metadata:{source:"image-editor",aspect_ratio:n.aspectRatio.value||null,image_size:n.imageSize.value||null,index:P},request:s&&typeof s=="object"&&s.request?s.request:null,response:s&&typeof s=="object"&&s.response?s.response:s})),{error:H}=await T.from("user_images").insert(u);H&&console.warn("Failed to save images to repository:",H)}re()}catch(a){console.error("Generation error:",a),l("error","Generation failed",a.message),n.loadingState.style.display="none",n.resultPlaceholder.style.display="block",I("error","Error")}finally{o.isGenerating=!1,n.generateBtn.disabled=!1}}}function Z(e){n.loadingState.style.display="none",n.resultPlaceholder.style.display="none",n.resultContainer.style.display="block",n.resultImage.src=e,o.currentZoom=100,z(),I("connected","Complete")}function z(){n.zoomLevel.textContent=`${o.currentZoom}%`,n.resultImage.style.transform=`scale(${o.currentZoom/100})`}function Te(){o.currentZoom<200&&(o.currentZoom+=25,z())}function Re(){o.currentZoom>25&&(o.currentZoom-=25,z())}function Ze(){const e=n.resultImage.src;if(!e)return;const t=document.createElement("a");t.href=e,t.download=`generated-${Date.now()}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t),l("success","Download started","Image is being downloaded")}function ze(){const e=n.resultImage.src;e&&(navigator.share?navigator.share({title:"Generated Image",text:n.promptInput.value,url:e}).catch(()=>{}):navigator.clipboard.writeText(e).then(()=>{l("success","Link copied","Image URL copied to clipboard")}))}function Ue(){const e=n.resultImage.src;e&&(n.zoomImage.src=e,n.imageZoomOverlay.classList.add("show"))}function $e(){const e=n.modelSearch.value.toLowerCase(),t=n.modelSelect.options;for(let i=0;i<t.length;i++){const a=t[i],r=a.textContent.toLowerCase();a.style.display=r.includes(e)?"":"none"}}function _e(){document.querySelectorAll(".collapsible-header").forEach(e=>{const t=e.dataset.target,i=t?document.getElementById(t):null;i&&(t==="configContent"&&(e.classList.add("collapsed"),i.classList.add("collapsed")),e.addEventListener("click",()=>{const a=e.classList.toggle("collapsed");i.classList.toggle("collapsed",a)}))})}function Ge(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.target),i=t.type==="password";t.type=i?"text":"password",e.innerHTML=i?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'})})}function Ne(){var e;n.fileInput.addEventListener("change",t=>_(t.target.files)),n.uploadArea.addEventListener("dragover",t=>{t.preventDefault(),n.uploadArea.classList.add("drag-over")}),n.uploadArea.addEventListener("dragleave",()=>{n.uploadArea.classList.remove("drag-over")}),n.uploadArea.addEventListener("drop",t=>{t.preventDefault(),n.uploadArea.classList.remove("drag-over"),_(t.dataTransfer.files)}),n.editMaskBtn.addEventListener("click",Ie),n.closeMaskModal.addEventListener("click",h),n.cancelMaskBtn.addEventListener("click",h),n.maskModalOverlay.addEventListener("click",t=>{t.target===n.maskModalOverlay&&h()}),n.closeImagePreview.addEventListener("click",J),n.imagePreviewOverlay.addEventListener("click",t=>{t.target===n.imagePreviewOverlay&&J()}),n.maskCanvas.addEventListener("mousedown",G),n.maskCanvas.addEventListener("mousemove",N),n.maskCanvas.addEventListener("mouseup",D),n.maskCanvas.addEventListener("mouseout",D),n.maskCanvas.addEventListener("touchstart",t=>{t.preventDefault();const i=t.touches[0];G({clientX:i.clientX,clientY:i.clientY})}),n.maskCanvas.addEventListener("touchmove",t=>{t.preventDefault();const i=t.touches[0];N({clientX:i.clientX,clientY:i.clientY})}),n.maskCanvas.addEventListener("touchend",D),document.querySelectorAll("[data-tool]").forEach(t=>{t.addEventListener("click",()=>{O=t.dataset.tool,document.querySelectorAll("[data-tool]").forEach(i=>i.classList.remove("active")),t.classList.add("active")})}),n.brushSize.addEventListener("input",()=>{n.brushSizeLabel.textContent=n.brushSize.value+"px"}),n.undoBtn.addEventListener("click",F),n.redoBtn.addEventListener("click",j),n.clearCanvasBtn.addEventListener("click",Ee),n.saveMaskBtn.addEventListener("click",K),n.resetMaskBtn.addEventListener("click",Be),n.canvasZoomInBtn.addEventListener("click",Y),n.canvasZoomOutBtn.addEventListener("click",X),n.canvasZoomResetBtn.addEventListener("click",He),n.promptInput.addEventListener("input",w),n.showPromptHistory.addEventListener("click",()=>{se(),n.promptHistoryDropdown.classList.toggle("show")}),document.addEventListener("click",t=>{t.target.closest(".main-prompt-section")||n.promptHistoryDropdown.classList.remove("show")}),n.modelSearch.addEventListener("input",$e),(e=n.batchCount)==null||e.addEventListener("change",()=>{const t=te(n.batchCount.value,1,10,1);n.batchCount.value=String(t)}),n.generateBtn.addEventListener("click",V),n.zoomInBtn.addEventListener("click",Te),n.zoomOutBtn.addEventListener("click",Re),n.downloadBtn.addEventListener("click",Ze),n.shareBtn.addEventListener("click",ze),n.fullscreenBtn.addEventListener("click",Ue),n.resultImage.addEventListener("error",()=>{(n.resultImage.getAttribute("src")||"")!==A&&(n.resultImage.alt="Image unavailable",n.resultImage.src=A)}),n.closeZoomBtn.addEventListener("click",()=>{n.imageZoomOverlay.classList.remove("show")}),n.imageZoomOverlay.addEventListener("click",t=>{t.target===n.imageZoomOverlay&&n.imageZoomOverlay.classList.remove("show")}),n.historyBtn.addEventListener("click",()=>{n.historyPanel.classList.toggle("show")}),n.closeHistoryBtn.addEventListener("click",()=>{n.historyPanel.classList.remove("show")}),n.inlineHistoryToggle.addEventListener("click",De),n.showMoreHistoryBtn.addEventListener("click",Ae),n.closeEditPromptModal.addEventListener("click",f),n.cancelEditPromptBtn.addEventListener("click",f),n.saveEditPromptBtn.addEventListener("click",Pe),n.editPromptModalOverlay.addEventListener("click",t=>{t.target===n.editPromptModalOverlay&&f()}),document.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&(t.key==="z"?(t.preventDefault(),t.shiftKey?j():F()):t.key==="Enter"?(t.preventDefault(),V()):t.key==="s"&&(t.preventDefault(),K())),t.key==="Escape"&&(h(),f(),n.imageZoomOverlay.classList.remove("show"),n.historyPanel.classList.remove("show"))}),n.canvasContainer.addEventListener("wheel",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.deltaY<0?Y():X())})}function Q(){ve(),_e(),Ge(),Ne(),b(),E(),w(),Le().then(e=>{e&&re()})}document.readyState!=="loading"?Q():document.addEventListener("DOMContentLoaded",Q);
