import{d as Se,q as ue,r as u,c as V,o as Be,z as Ue,A as de,a as i,b as n,g as D,e as t,f as p,w as E,B as Y,l as ce,F as G,p as X,n as N,t as d,i as ve,u as pe,s as L,x as Me,y as $e,j as Pe,k as ze}from"./supabase-yVp6g-J3.js";/* empty css                        */function je(R){return`${(R==null?void 0:R.trim())||"商品"}，生成单张2x2四宫格白底商品图，四个角度：正面、45度侧面、背面、俯视。纯白背景，柔和棚拍光，产品居中，无道具无文字无水印，边距一致。`}const Ke={class:"toolbox-page"},Ae={class:"main-container"},Ve={class:"sidebar"},De={class:"sidebar-section"},Ee={class:"form-group",style:{"margin-top":"16px"}},Le={class:"form-group"},Re={class:"form-group"},qe={class:"sidebar-section"},Te={class:"search-wrapper"},Fe={key:0,class:"product-list"},He=["onClick"],Oe=["src","alt"],Ge={class:"product-info"},Xe={class:"product-name"},Ne={class:"product-meta"},Ze={key:1,class:"product-list-empty"},Je={key:2,class:"product-list-loading"},Qe={key:3,class:"pagination"},We=["disabled"],Ye={class:"page-info"},et=["disabled"],tt={key:0,class:"sidebar-section"},st={class:"section-title"},ot={key:0,class:"image-grid"},it=["onClick"],nt=["src"],lt={key:0,class:"image-check"},at={key:1,class:"image-primary"},rt={key:1,class:"no-images"},ut={class:"main-content"},dt={class:"content-panel"},ct={class:"panel-header"},vt={key:0,class:"panel-hint"},pt={class:"preview-panel"},gt={class:"preview-card"},mt={class:"preview-card-header"},ft=["disabled"],ht={class:"preview-card-body"},bt={key:0},yt={key:1,class:"preview-placeholder"},_t={class:"result-area",style:{"margin-top":"20px"}},wt={key:0,class:"result-placeholder"},kt={key:1,class:"loading-state"},xt={key:2,class:"result-container"},Ct=["src"],It={class:"result-actions"},St={key:0,class:"result-grid"},Bt=["onClick"],Ut=["src","alt"],Mt={class:"result-thumb-index"},$t={class:"generate-section"},Pt=["disabled"],zt={key:0,class:"spinner-small"},jt={key:1,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Kt={key:0,class:"generate-hint"},At={class:"lightbox-body"},Vt=["src"],Dt={class:"lightbox-footer"},Et={key:0,class:"lightbox-nav"},Lt={class:"lightbox-index"},Rt={class:"lightbox-actions"},qt={class:"toast-container"},Z=10,Tt=Se({__name:"toolbox-page",setup(R){const P=ue({apiKey:"",baseUrl:""}),a=ue({model:"gemini-3-pro-image-preview",aspectRatio:"",imageSize:"1K",n:1}),q=u([]),T=u(!1),F=u(""),w=u(1),J=u(0),f=u(null),y=u([]),c=u([]),h=u(!1),S=u(""),g=u([]),M=u(""),H=u([]),z=u(!1),k=u(0),Q=V(()=>Math.ceil(J.value/Z)),B=V(()=>f.value?je(f.value.name||""):""),ee=V(()=>!!(f.value&&c.value.length>0)),te=V(()=>h.value?"正在生成多视图...":f.value?c.value.length===0?"请选择至少一张参考图片":"":"请先选择产品"),se=V(()=>{const o=g.value;if(!o.length)return"";const e=Math.min(o.length-1,Math.max(0,k.value));return o[e]||""});function ge(o){return String(o||"").trim().replace(/^bearer\s+/i,"").trim()}function me(o){return String(o||"").trim()||null}function W(o){if(!o||typeof o!="object")return[];const e=[];if(Array.isArray(o.data))for(const s of o.data)!s||typeof s!="object"||(typeof s.url=="string"&&s.url?e.push(s.url):typeof s.b64_json=="string"&&s.b64_json?e.push(`data:image/png;base64,${s.b64_json}`):typeof s.image_url=="string"&&s.image_url?e.push(s.image_url):typeof s.imageUrl=="string"&&s.imageUrl&&e.push(s.imageUrl));return typeof o.url=="string"&&o.url&&e.push(o.url),typeof o.b64_json=="string"&&o.b64_json&&e.push(`data:image/png;base64,${o.b64_json}`),typeof o.image_url=="string"&&o.image_url&&e.push(o.image_url),typeof o.imageUrl=="string"&&o.imageUrl&&e.push(o.imageUrl),Array.from(new Set(e))}function fe(){P.apiKey=localStorage.getItem("global_api_key")||localStorage.getItem("video_api_key")||"",P.baseUrl=localStorage.getItem("global_base_url")||localStorage.getItem("video_base_url")||""}async function O(){T.value=!0;try{const o=(w.value-1)*Z,e=o+Z-1;let s=L.from("products").select("id,name,dimensions,original_image_url,created_at",{count:"exact"}).order("created_at",{ascending:!1}).range(o,e);F.value&&(s=s.ilike("name",`%${F.value}%`));const{data:r,error:m,count:x}=await s;if(m)throw m;const l=r||[],U=l.map(C=>C.id),_=new Map;if(U.length){const{data:C,error:v}=await L.from("product_images").select("id,product_id,image_url,is_primary").in("product_id",U);if(v)throw v;for(const b of C||[]){const I=b.product_id,K={id:b.id,image_url:b.image_url,is_primary:!!b.is_primary},A=_.get(I)||[];A.push(K),_.set(I,A)}}q.value=l.map(C=>{const v=_.get(C.id)||[];return{...C,images:v,image_count:v.length||1}}),J.value=x||0}catch{j("加载产品列表失败","error")}finally{T.value=!1}}function he(){w.value=1,O()}function be(){w.value>1&&(w.value--,O())}function ye(){w.value<Q.value&&(w.value++,O())}function _e(o){if(o.images&&o.images.length>0){const e=o.images.find(s=>s.is_primary);return e?e.image_url:o.images[0].image_url}return o.original_image_url||"/static/placeholder.png"}async function we(o){f.value=o;try{const{data:e,error:s}=await L.from("products").select("*").eq("id",o.id).single();if(s)throw s;const{data:r,error:m}=await L.from("product_images").select("id,image_url,is_primary").eq("product_id",o.id).order("is_primary",{ascending:!1});if(m)throw m;y.value=r||[];const x=e.original_image_url;y.value.length===0&&x&&(y.value=[{id:e.id,image_url:x,is_primary:!0}]);const l=y.value.find(U=>U.is_primary);l?c.value=[l.id]:y.value.length>0?c.value=[y.value[0].id]:c.value=[]}catch{j("加载产品详情失败","error")}}function ke(o){const e=c.value.indexOf(o);e===-1?c.value.push(o):c.value.splice(e,1)}async function xe(){if(B.value)try{await navigator.clipboard.writeText(B.value),j("提示词已复制","success")}catch{j("复制失败","error")}}async function oe(){if(!(!ee.value||h.value)){h.value=!0,M.value="",$();try{const o=Math.min(10,Math.max(1,Math.floor(Number(a.n)||1)));if(a.n=o,o>=6&&!confirm(`将并发生成 ${o} 张四宫格图片，确认继续？`)){h.value=!1;return}const e=new FormData;e.append("prompt",B.value),e.append("model",a.model),e.append("n",String(o)),e.append("response_format","url"),a.aspectRatio&&e.append("aspect_ratio",a.aspectRatio),a.imageSize&&e.append("image_size",a.imageSize);for(const v of c.value){const b=y.value.find(I=>I.id===v);if(b)try{const K=await(await fetch(b.image_url)).blob();e.append("image",K,`ref-${v}.jpg`)}catch{console.warn("Failed to fetch reference image:",b.image_url)}}const s={},r=ge(P.apiKey);r&&(s["X-API-Key"]=r);const m=me(P.baseUrl);m&&(s["X-Base-Url"]=m);const x=await Me("/api/v1/images/edits",{method:"POST",headers:s,body:e});if(!x.ok){const v=await x.json().catch(()=>({}));throw new Error(v.detail||`HTTP ${x.status}`)}const l=await x.json(),U=l&&typeof l=="object"&&l.response?l.response:l,_=W(U).length?W(U):W(l);if(_.length)g.value=_,S.value=_[0]||"";else throw new Error("Invalid response format");j(_.length>1?`多视图生成成功（${_.length}张）`:"多视图生成成功","success");const C=await $e();if(C){const v=_.map((I,K)=>{var A,re;return{user_id:C,title:(A=f.value)!=null&&A.name?`多视图 - ${f.value.name}`:null,model:a.model,prompt:B.value,status:"completed",image_url:I,metadata:{source:"toolbox-multiview",product_id:((re=f.value)==null?void 0:re.id)||null,selected_images:c.value,aspect_ratio:a.aspectRatio||null,image_size:a.imageSize||null,index:K},request:l&&typeof l=="object"&&l.request?l.request:null,response:l&&typeof l=="object"&&l.response?l.response:l}}),{error:b}=await L.from("user_images").insert(v);b&&console.warn("Failed to save images to repository:",b)}}catch(o){M.value=o.message||"生成失败，请重试"}finally{h.value=!1}}}function ie(o){const e=o||S.value;if(!e)return;const s=document.createElement("a");s.href=e,s.download=`multiview-${Date.now()}.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}function Ce(o){const e=g.value;if(!e.length)return;const s=o?e.indexOf(o):-1;k.value=s>=0?s:0,z.value=!0}function $(){z.value=!1}function ne(){const o=g.value.length;o<=1||(k.value=(k.value-1+o)%o)}function le(){const o=g.value.length;o<=1||(k.value=(k.value+1)%o)}function ae(o){if(z.value){if(o.key==="Escape"){o.preventDefault(),$();return}if(o.key==="ArrowLeft"){o.preventDefault(),ne();return}o.key==="ArrowRight"&&(o.preventDefault(),le())}}let Ie=0;function j(o,e="info"){const s=Ie++;H.value.push({id:s,message:o,type:e}),setTimeout(()=>{const r=H.value.findIndex(m=>m.id===s);r!==-1&&H.value.splice(r,1)},3e3)}return Be(()=>{fe(),O(),document.addEventListener("keydown",ae)}),Ue(()=>{document.removeEventListener("keydown",ae)}),de(z,o=>{document.body.style.overflow=o?"hidden":""}),de(g,o=>{if(!o.length){$();return}k.value>=o.length&&(k.value=0)}),(o,e)=>(n(),i("div",Ke,[e[37]||(e[37]=D('<header class="header"><div class="logo"><div class="logo-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="8" width="18" height="13" rx="2"></rect><path d="M9 8V6a3 3 0 0 1 6 0v2"></path><path d="M3 12h18"></path></svg></div><span>工具箱</span></div><div class="header-actions"><a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg> 返回主页面 </a></div></header>',1)),t("div",Ae,[t("aside",Ve,[t("section",De,[e[19]||(e[19]=D('<div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> 模型设置 </div>',1)),E(t("select",{class:"form-select","onUpdate:modelValue":e[0]||(e[0]=s=>a.model=s)},[...e[12]||(e[12]=[t("option",{value:"gemini-3-pro-image-preview"},"gemini-3-pro-image-preview (推荐)",-1),t("option",{value:"gemini-2.5-flash-image"},"gemini-2.5-flash-image (快速)",-1)])],512),[[Y,a.model]]),t("div",Ee,[e[14]||(e[14]=t("label",{class:"form-label"},"Aspect Ratio",-1)),E(t("select",{class:"form-select","onUpdate:modelValue":e[1]||(e[1]=s=>a.aspectRatio=s)},[...e[13]||(e[13]=[D('<option value="">Auto</option><option value="1:1">1:1 (Square)</option><option value="16:9">16:9 (Landscape)</option><option value="9:16">9:16 (Portrait)</option><option value="4:3">4:3</option><option value="3:4">3:4</option><option value="3:2">3:2</option><option value="2:3">2:3</option><option value="4:5">4:5</option><option value="5:4">5:4</option>',10)])],512),[[Y,a.aspectRatio]])]),t("div",Le,[e[16]||(e[16]=t("label",{class:"form-label"},"Image Size",-1)),E(t("select",{class:"form-select","onUpdate:modelValue":e[2]||(e[2]=s=>a.imageSize=s)},[...e[15]||(e[15]=[t("option",{value:""},"Default",-1),t("option",{value:"1K"},"1K",-1),t("option",{value:"2K"},"2K",-1),t("option",{value:"4K"},"4K",-1)])],512),[[Y,a.imageSize]])]),t("div",Re,[e[17]||(e[17]=t("label",{class:"form-label"},"并发数量",-1)),E(t("input",{class:"form-input",type:"number",min:"1",max:"10","onUpdate:modelValue":e[3]||(e[3]=s=>a.n=s)},null,512),[[ce,a.n,void 0,{number:!0}]]),e[18]||(e[18]=t("div",{class:"form-hint"},"一次生成多张四宫格图片（1-10）",-1))])]),t("section",qe,[e[25]||(e[25]=D('<div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"></path><path d="M9 2v5"></path><path d="M15 2v5"></path><path d="M2 9h20"></path></svg> 选择产品 </div>',1)),t("div",Te,[e[20]||(e[20]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("circle",{cx:"11",cy:"11",r:"8"}),t("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),E(t("input",{type:"text",class:"form-input","onUpdate:modelValue":e[4]||(e[4]=s=>F.value=s),placeholder:"搜索产品...",onInput:he},null,544),[[ce,F.value]])]),!T.value&&q.value.length>0?(n(),i("div",Fe,[(n(!0),i(G,null,X(q.value,s=>{var r;return n(),i("div",{key:s.id,class:N(["product-item",{selected:((r=f.value)==null?void 0:r.id)===s.id}]),onClick:m=>we(s)},[t("img",{src:_e(s),alt:s.name,class:"product-thumb"},null,8,Oe),t("div",Ge,[t("div",Xe,d(s.name||"未命名产品"),1),t("div",Ne,d(s.dimensions||""),1)])],10,He)}),128))])):!T.value&&q.value.length===0?(n(),i("div",Ze,[...e[21]||(e[21]=[t("p",null,"暂无产品",-1),t("a",{href:"/products",class:"btn btn-secondary btn-sm"},"前往产品库",-1)])])):(n(),i("div",Je,[...e[22]||(e[22]=[t("div",{class:"spinner-small"},null,-1),t("span",null,"加载中...",-1)])])),J.value>Z?(n(),i("div",Qe,[t("button",{class:"btn btn-ghost btn-sm",disabled:w.value<=1,onClick:be},[...e[23]||(e[23]=[t("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"15 18 9 12 15 6"})],-1)])],8,We),t("span",Ye,d(w.value)+" / "+d(Q.value),1),t("button",{class:"btn btn-ghost btn-sm",disabled:w.value>=Q.value,onClick:ye},[...e[24]||(e[24]=[t("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"9 18 15 12 9 6"})],-1)])],8,et)])):p("",!0)]),f.value?(n(),i("section",tt,[t("div",st,[e[26]||(e[26]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),t("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t("polyline",{points:"21 15 16 10 5 21"})],-1)),ve(" 参考图片 ("+d(c.value.length)+"/"+d(y.value.length)+") ",1)]),y.value.length>0?(n(),i("div",ot,[(n(!0),i(G,null,X(y.value,s=>(n(),i("div",{key:s.id,class:N(["image-item",{selected:c.value.includes(s.id)}]),onClick:r=>ke(s.id)},[t("img",{src:s.image_url,alt:"Product image"},null,8,nt),c.value.includes(s.id)?(n(),i("div",lt,[...e[27]||(e[27]=[t("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"white","stroke-width":"3"},[t("polyline",{points:"20 6 9 17 4 12"})],-1)])])):p("",!0),s.is_primary?(n(),i("div",at,"主图")):p("",!0)],10,it))),128))])):(n(),i("div",rt,[...e[28]||(e[28]=[t("p",null,"该产品暂无图片",-1)])]))])):p("",!0)]),t("main",ut,[t("section",dt,[t("div",ct,[e[29]||(e[29]=t("div",{class:"panel-title"},[t("span",{class:"step-indicator"},"多"),t("div",null,[t("h3",null,"多视图生成"),t("p",{class:"panel-subtitle"},"生成白底四宫格多角度商品图")])],-1)),f.value?p("",!0):(n(),i("span",vt,"请先从左侧选择产品"))]),t("div",pt,[t("div",gt,[t("div",mt,[e[30]||(e[30]=t("h4",null,"提示词预览",-1)),t("button",{class:"btn btn-ghost btn-sm",onClick:xe,disabled:!B.value}," 复制 ",8,ft)]),t("div",ht,[B.value?(n(),i("p",bt,d(B.value),1)):(n(),i("p",yt,"选择产品后自动生成提示词"))])])]),t("div",_t,[!h.value&&g.value.length===0?(n(),i("div",wt,[...e[31]||(e[31]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[t("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),t("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t("polyline",{points:"21 15 16 10 5 21"})],-1),t("h3",null,"准备生成",-1),t("p",null,"选择产品与参考图后点击生成。",-1)])])):p("",!0),h.value?(n(),i("div",kt,[...e[32]||(e[32]=[t("div",{class:"spinner"},null,-1),t("p",null,"正在生成多视图...",-1)])])):p("",!0),g.value.length&&!h.value?(n(),i("div",xt,[t("img",{src:S.value,alt:"Generated grid",class:"result-image",onClick:e[5]||(e[5]=s=>Ce(S.value))},null,8,Ct),t("div",It,[t("button",{class:"btn btn-secondary",type:"button",onClick:e[6]||(e[6]=s=>ie(S.value))}," 下载 "),t("button",{class:"btn btn-primary",type:"button",onClick:oe}," 重新生成 ")]),g.value.length>1?(n(),i("div",St,[(n(!0),i(G,null,X(g.value,(s,r)=>(n(),i("button",{key:`${s}-${r}`,class:N(["result-thumb",{active:s===S.value}]),type:"button",onClick:m=>S.value=s},[t("img",{src:s,alt:`Generated ${r+1}`,loading:"lazy",decoding:"async"},null,8,Ut),t("span",Mt,d(r+1),1)],10,Bt))),128))])):p("",!0)])):p("",!0)]),t("div",$t,[t("button",{class:"generate-btn",disabled:!ee.value||h.value,"data-test":"generate-button",onClick:oe},[h.value?(n(),i("div",zt)):(n(),i("svg",jt,[...e[33]||(e[33]=[t("polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2"},null,-1)])])),ve(" "+d(h.value?"生成中...":"生成多视图"),1)],8,Pt),te.value?(n(),i("div",Kt,d(te.value),1)):p("",!0)])])])]),z.value?(n(),i("div",{key:0,class:"lightbox-overlay",onClick:$},[t("div",{class:"lightbox-content",onClick:e[8]||(e[8]=pe(()=>{},["stop"]))},[t("div",{class:"lightbox-header"},[e[35]||(e[35]=t("div",{class:"lightbox-title"},"放大预览",-1)),t("button",{class:"btn btn-ghost btn-icon",type:"button",onClick:$,"aria-label":"Close preview"},[...e[34]||(e[34]=[t("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),t("div",At,[t("img",{src:se.value,alt:"Full size preview"},null,8,Vt)]),t("div",Dt,[g.value.length>1?(n(),i("div",Et,[t("button",{class:"btn btn-secondary btn-sm",type:"button",onClick:ne},"上一张"),t("span",Lt,d(k.value+1)+" / "+d(g.value.length),1),t("button",{class:"btn btn-secondary btn-sm",type:"button",onClick:le},"下一张")])):p("",!0),t("div",Rt,[t("button",{class:"btn btn-secondary btn-sm",type:"button",onClick:e[7]||(e[7]=s=>ie(se.value))},"下载"),t("button",{class:"btn btn-ghost btn-sm",type:"button",onClick:$},"关闭")])])])])):p("",!0),t("div",qt,[(n(!0),i(G,null,X(H.value,s=>(n(),i("div",{key:s.id,class:N(["toast",s.type])},d(s.message),3))),128))]),M.value?(n(),i("div",{key:1,class:"error-overlay",onClick:e[11]||(e[11]=s=>M.value="")},[t("div",{class:"error-modal",onClick:e[10]||(e[10]=pe(()=>{},["stop"]))},[e[36]||(e[36]=D('<div class="error-header"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><h3>生成失败</h3></div>',1)),t("p",null,d(M.value),1),t("button",{class:"btn btn-primary",onClick:e[9]||(e[9]=s=>M.value="")},"确定")])])):p("",!0)]))}});async function Ft(){await Pe(),ze(Tt).mount("#app")}Ft();
