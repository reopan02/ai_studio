import{s as T,I as ee,J as te,x as me,y as ge}from"./supabase-CeaWPiiH.js";const x={apiKey:"global_api_key",baseUrl:"global_base_url"},A="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200" viewBox="0 0 320 200"><rect width="320" height="200" fill="#111827"/><rect x="52" y="40" width="216" height="120" rx="12" fill="none" stroke="#9CA3AF" stroke-width="6"/><path d="M76 142l54-64 44 52 30-36 70 84H76z" fill="#374151"/><circle cx="116" cy="82" r="10" fill="#6B7280"/><line x1="92" y1="62" x2="228" y2="138" stroke="#9CA3AF" stroke-width="6"/><line x1="228" y1="62" x2="92" y2="138" stroke="#9CA3AF" stroke-width="6"/></svg>');function ue(e){return String(e||"").trim().replace(/^bearer\s+/i,"").trim()}function ne(e,t){e&&e.querySelectorAll(t).forEach(a=>{a.addEventListener("error",()=>{a.dataset.fallbackApplied||(a.dataset.fallbackApplied="true",a.alt="Image unavailable",a.src=A)},{once:!0})})}function ye(e){const t=String(e||"").trim();if(!t)return null;let a;try{a=new URL(t)}catch{throw new Error("Base URL is not a valid URL")}if(a.protocol!=="https:")throw new Error("Base URL must use HTTPS");if(!a.hostname)throw new Error("Base URL is missing host (e.g. https://api.example.com)");return a.origin}function oe(e,t,a,i){const r=Number.parseInt(String(e??""),10);return Number.isFinite(r)?Math.min(a,Math.max(t,r)):i}async function $(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const a=await e.text();try{return JSON.parse(a)}catch{return a}}function pe(e,t){if(typeof e=="string")return e;if(!e||typeof e!="object")return t;const a=e.detail??e.error??e.message;if(typeof a=="string")return a;try{return JSON.stringify(a??e)}catch{return t}}function ve(e){const t=[];if(!e||typeof e!="object")return t;const a=e.data;if(Array.isArray(a))for(const i of a)!i||typeof i!="object"||(typeof i.url=="string"&&i.url?t.push(i.url):typeof i.b64_json=="string"&&i.b64_json?t.push(`data:image/png;base64,${i.b64_json}`):typeof i.image_url=="string"&&i.image_url?t.push(i.image_url):typeof i.imageUrl=="string"&&i.imageUrl&&t.push(i.imageUrl));return t.length===0&&(typeof e.url=="string"&&e.url?t.push(e.url):typeof e.b64_json=="string"&&e.b64_json?t.push(`data:image/png;base64,${e.b64_json}`):typeof e.image_url=="string"&&e.image_url?t.push(e.image_url):typeof e.imageUrl=="string"&&e.imageUrl&&t.push(e.imageUrl)),t}const o={config:{apiKey:localStorage.getItem(x.apiKey)||localStorage.getItem("video_api_key")||localStorage.getItem("apiKey")||"",baseUrl:localStorage.getItem(x.baseUrl)||localStorage.getItem("video_base_url")||localStorage.getItem("baseUrl")||""},images:[],currentImageIndex:-1,prompt:"",promptHistory:(()=>{try{return JSON.parse(localStorage.getItem("promptHistory")||"[]")}catch{return localStorage.removeItem("promptHistory"),[]}})(),generationHistory:(()=>{try{return JSON.parse(localStorage.getItem("generationHistory")||"[]")}catch{return localStorage.removeItem("generationHistory"),[]}})(),inlineHistoryCollapsed:localStorage.getItem("inlineHistoryCollapsed")==="true",inlineHistoryLimit:6,inlineHistoryShowAll:!1,editingHistoryIndex:-1,isGenerating:!1,currentZoom:100,canvasZoom:100,canvasHistory:[],canvasHistoryIndex:-1,originalImage:null,originalWidth:0,originalHeight:0,displayScale:1},n={modelSelect:document.getElementById("modelSelect"),modelSearch:document.getElementById("modelSearch"),aspectRatio:document.getElementById("aspectRatio"),imageSize:document.getElementById("imageSize"),batchCount:document.getElementById("batchCount"),uploadArea:document.getElementById("uploadArea"),fileInput:document.getElementById("fileInput"),imagePreviewGrid:document.getElementById("imagePreviewGrid"),editMaskBtn:document.getElementById("editMaskBtn"),maskModalOverlay:document.getElementById("maskModalOverlay"),closeMaskModal:document.getElementById("closeMaskModal"),cancelMaskBtn:document.getElementById("cancelMaskBtn"),canvasContainer:document.getElementById("canvasContainer"),canvasWrapper:document.getElementById("canvasWrapper"),maskCanvas:document.getElementById("maskCanvas"),brushSize:document.getElementById("brushSize"),brushSizeLabel:document.getElementById("brushSizeLabel"),brushColor:document.getElementById("brushColor"),undoBtn:document.getElementById("undoBtn"),redoBtn:document.getElementById("redoBtn"),clearCanvasBtn:document.getElementById("clearCanvasBtn"),saveMaskBtn:document.getElementById("saveMaskBtn"),resetMaskBtn:document.getElementById("resetMaskBtn"),canvasZoomInBtn:document.getElementById("canvasZoomInBtn"),canvasZoomOutBtn:document.getElementById("canvasZoomOutBtn"),canvasZoomResetBtn:document.getElementById("canvasZoomResetBtn"),canvasZoomLevel:document.getElementById("canvasZoomLevel"),promptInput:document.getElementById("promptInput"),charCount:document.getElementById("charCount"),showPromptHistory:document.getElementById("showPromptHistory"),promptHistoryDropdown:document.getElementById("promptHistoryDropdown"),imagePreviewOverlay:document.getElementById("imagePreviewOverlay"),imagePreviewImg:document.getElementById("imagePreviewImg"),imagePreviewInfo:document.getElementById("imagePreviewInfo"),closeImagePreview:document.getElementById("closeImagePreview"),resultArea:document.getElementById("resultArea"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultImage:document.getElementById("resultImage"),generateBtn:document.getElementById("generateBtn"),downloadBtn:document.getElementById("downloadBtn"),shareBtn:document.getElementById("shareBtn"),fullscreenBtn:document.getElementById("fullscreenBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomLevel:document.getElementById("zoomLevel"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),historyList:document.getElementById("historyList"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),inlineHistoryShowMore:document.getElementById("inlineHistoryShowMore"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),editPromptModalOverlay:document.getElementById("editPromptModalOverlay"),editPromptTextarea:document.getElementById("editPromptTextarea"),closeEditPromptModal:document.getElementById("closeEditPromptModal"),cancelEditPromptBtn:document.getElementById("cancelEditPromptBtn"),saveEditPromptBtn:document.getElementById("saveEditPromptBtn"),imageZoomOverlay:document.getElementById("imageZoomOverlay"),zoomImage:document.getElementById("zoomImage"),closeZoomBtn:document.getElementById("closeZoomBtn"),toastContainer:document.getElementById("toastContainer")};let y=null,m=null,p=null,S=!1,O="brush",L=0,k=0;function l(e,t,a){const i=document.createElement("div");i.className=`toast ${e}`;const r={success:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',error:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'};i.innerHTML=`
        ${r[e]}
        <div class="toast-content">
            <div class="toast-title">${t}</div>
            ${a?`<div class="toast-message">${a}</div>`:""}
        </div>
        <button class="toast-close">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    `,n.toastContainer.appendChild(i),i.querySelector(".toast-close").addEventListener("click",()=>{i.remove()}),setTimeout(()=>{i.remove()},5e3)}function w(e,t){n.statusDot.className="status-dot "+e,n.statusText.textContent=t}function ae(e){return new Intl.DateTimeFormat("zh-CN",{hour:"2-digit",minute:"2-digit"}).format(e)}function he(e){return new Intl.DateTimeFormat("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function fe(){o.config.apiKey=localStorage.getItem(x.apiKey)||localStorage.getItem("video_api_key")||"",o.config.baseUrl=localStorage.getItem(x.baseUrl)||localStorage.getItem("video_base_url")||"",o.config.apiKey||o.config.baseUrl?w("connected","Configured"):w("","Ready")}function _(e){Array.from(e).forEach(t=>{if(!t.type.startsWith("image/")){l("error","Invalid file type","Please upload an image file");return}if(t.size>10*1024*1024){l("error","File too large","Maximum file size is 10MB");return}const a=new FileReader;a.onload=i=>{o.images.push({id:Date.now()+Math.random(),name:t.name,originalData:i.target.result,data:i.target.result,hasMask:!1}),v(),o.images.length===1&&ie(0)},a.readAsDataURL(t)})}function v(){n.imagePreviewGrid.innerHTML=o.images.map((e,t)=>`
        <div class="image-preview-item ${t===o.currentImageIndex?"active":""}" data-index="${t}">
            <img src="${e.data}" alt="${e.name}">
            <button class="remove-btn" data-index="${t}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            ${e.hasMask?'<span class="edit-indicator">Mask</span>':""}
        </div>
    `).join(""),n.imagePreviewGrid.querySelectorAll(".image-preview-item").forEach(e=>{e.addEventListener("click",t=>{t.target.closest(".remove-btn")||ie(parseInt(e.dataset.index))})}),n.imagePreviewGrid.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),we(parseInt(e.dataset.index))})}),Ie()}function Ie(){n.editMaskBtn.disabled=o.images.length===0||o.currentImageIndex<0}function ie(e){o.currentImageIndex=e,v()}function we(e){o.images.splice(e,1),o.currentImageIndex>=o.images.length&&(o.currentImageIndex=o.images.length-1),v()}function Ee(){if(o.currentImageIndex<0||!o.images[o.currentImageIndex]){l("warning","No image selected","Please select an image first");return}n.maskModalOverlay.classList.add("show"),setTimeout(()=>{R()},100)}function f(){n.maskModalOverlay.classList.remove("show")}function R(){if(o.currentImageIndex<0||!o.images[o.currentImageIndex])return;o.canvasZoom=100,C();const e=new Image;e.onload=()=>{o.originalWidth=e.width,o.originalHeight=e.height,o.originalImage=e,m=document.createElement("canvas"),m.width=e.width,m.height=e.height,p=m.getContext("2d"),p.drawImage(e,0,0);const t=n.canvasContainer.clientWidth-40,a=n.canvasContainer.clientHeight-40||500;let i=e.width,r=e.height;const c=t/e.width,d=a/e.height;o.displayScale=Math.min(c,d,1),i=Math.floor(e.width*o.displayScale),r=Math.floor(e.height*o.displayScale);const s=n.maskCanvas;s.width=i,s.height=r,s.style.width=i+"px",s.style.height=r+"px",y=s.getContext("2d"),y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.drawImage(e,0,0,i,r),o.canvasHistory=[{display:s.toDataURL(),fullRes:m.toDataURL()}],o.canvasHistoryIndex=0},e.src=o.images[o.currentImageIndex].data}function re(e){const t=n.maskCanvas.getBoundingClientRect(),a=n.maskCanvas.width/t.width,i=n.maskCanvas.height/t.height;return{x:(e.clientX-t.left)*a,y:(e.clientY-t.top)*i}}function G(e){if(!y||!p)return;S=!0;const t=re(e);L=t.x,k=t.y}function N(e){if(!S||!y||!p)return;const t=re(e),a=t.x,i=t.y,r=parseInt(n.brushSize.value),c=n.brushColor.value;q(y,L,k,a,i,r,c,O==="eraser");const d=L/o.displayScale,s=k/o.displayScale,M=a/o.displayScale,g=i/o.displayScale,H=r/o.displayScale;q(p,d,s,M,g,H,c,O==="eraser"),L=a,k=i}function q(e,t,a,i,r,c,d,s){e.beginPath(),e.moveTo(t,a),e.lineTo(i,r),e.strokeStyle=d,e.lineWidth=c,e.lineCap="round",e.lineJoin="round",s?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over",e.stroke(),e.globalCompositeOperation="source-over"}function D(){S&&(S=!1,Be(),o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].hasMask=!0,v()))}function Be(){!n.maskCanvas||!m||(o.canvasHistoryIndex++,o.canvasHistory=o.canvasHistory.slice(0,o.canvasHistoryIndex),o.canvasHistory.push({display:n.maskCanvas.toDataURL(),fullRes:m.toDataURL()}),o.canvasHistory.length>50&&(o.canvasHistory.shift(),o.canvasHistoryIndex--))}function F(){o.canvasHistoryIndex>0&&(o.canvasHistoryIndex--,se())}function j(){o.canvasHistoryIndex<o.canvasHistory.length-1&&(o.canvasHistoryIndex++,se())}function se(){const e=o.canvasHistory[o.canvasHistoryIndex];if(!e)return;const t=new Image;t.onload=()=>{y.clearRect(0,0,n.maskCanvas.width,n.maskCanvas.height),y.drawImage(t,0,0)},t.src=e.display;const a=new Image;a.onload=()=>{p.clearRect(0,0,m.width,m.height),p.drawImage(a,0,0)},a.src=e.fullRes}function He(){o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].data=o.images[o.currentImageIndex].originalData,o.images[o.currentImageIndex].hasMask=!1,R(),v())}function K(){if(!m||o.currentImageIndex<0){l("warning","No mask to save","Please draw on the image first");return}const e=m.toDataURL("image/png");o.images[o.currentImageIndex].data=e,o.images[o.currentImageIndex].hasMask=!0,saveToDrawingHistory(e),v(),f(),l("success","Mask saved","The mask has been applied to the image")}function Le(){o.currentImageIndex>=0&&o.images[o.currentImageIndex]&&(o.images[o.currentImageIndex].data=o.images[o.currentImageIndex].originalData,o.images[o.currentImageIndex].hasMask=!1,R(),v(),l("success","Mask reset","Image restored to original"))}function C(){n.canvasZoomLevel.textContent=`${o.canvasZoom}%`,n.canvasWrapper.style.transform=`scale(${o.canvasZoom/100})`}function Y(){o.canvasZoom<300&&(o.canvasZoom+=25,C())}function J(){o.canvasZoom>50&&(o.canvasZoom-=25,C())}function ke(){o.canvasZoom=100,C()}async function xe(){const{data:e}=await T.auth.getSession();return e.session?!0:(window.location.href="/login?next=/image",!1)}async function le(){try{const{data:e,error:t}=await ee(()=>T.from("user_images").select("id,title,model,prompt,image_url,created_at").order("created_at",{ascending:!1}).limit(50));if(t)throw t;const a=e||[]}catch(e){console.error("Failed to load images from repository:",e),l("error","Load failed",te(e))}}function X(){n.imagePreviewOverlay.classList.remove("show"),setTimeout(()=>{n.imagePreviewImg.src=""},300)}function E(){const e=n.promptInput.value.length;n.charCount.textContent=e}function Se(e){if(e.trim()){o.promptHistory=o.promptHistory.filter(t=>t.text!==e),o.promptHistory.unshift({text:e,time:new Date().toISOString()}),o.promptHistory=o.promptHistory.slice(0,20);try{localStorage.setItem("promptHistory",JSON.stringify(o.promptHistory))}catch(t){console.warn("Failed to persist prompt history:",t)}}}function ce(){if(o.promptHistory.length===0){n.promptHistoryDropdown.innerHTML='<p style="padding: 12px; text-align: center; color: var(--text-muted);">No history yet</p>';return}n.promptHistoryDropdown.innerHTML=o.promptHistory.map((e,t)=>`
	                <div class="prompt-history-item" data-index="${t}">
	                    <span class="prompt-text">${e.text}</span>
	                    <div class="prompt-history-actions">
	                        <span class="prompt-time">${ae(new Date(e.time))}</span>
	                        <button class="prompt-history-delete" data-index="${t}" title="Delete">
	                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M18 6L6 18M6 6l12 12"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `).join(""),n.promptHistoryDropdown.querySelectorAll(".prompt-history-item").forEach(e=>{e.addEventListener("click",t=>{t.target.closest(".prompt-history-delete")||(n.promptInput.value=o.promptHistory[parseInt(e.dataset.index)].text,E(),n.promptHistoryDropdown.classList.remove("show"))})}),n.promptHistoryDropdown.querySelectorAll(".prompt-history-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),Ce(parseInt(e.dataset.index))})})}function Ce(e){if(!(Number.isNaN(e)||e<0||e>=o.promptHistory.length)){o.promptHistory.splice(e,1);try{localStorage.setItem("promptHistory",JSON.stringify(o.promptHistory))}catch(t){console.warn("Failed to persist prompt history:",t)}ce(),l("success","Deleted","Prompt history item removed")}}function be(e,t){o.generationHistory.unshift({prompt:e,imageUrl:t,model:n.modelSelect.value,time:new Date().toISOString()}),o.generationHistory=o.generationHistory.slice(0,50);try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(a){console.warn("Failed to persist generation history:",a)}b(),B()}function b(){if(o.generationHistory.length===0){n.historyList.innerHTML='<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>';return}n.historyList.innerHTML=o.generationHistory.map((e,t)=>`
	                <div class="history-item" data-index="${t}">
	                    <img class="history-item-image" src="${e.imageUrl}" alt="Generated" loading="lazy" decoding="async">
	                    <div class="history-item-content">
	                        <div class="history-item-prompt">${e.prompt}</div>
	                        <div class="history-item-meta">${e.model} - ${ae(new Date(e.time))}</div>
	                    </div>
	                    <button class="history-item-delete" data-index="${t}" title="Delete">
	                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M18 6L6 18M6 6l12 12"/>
	                        </svg>
	                    </button>
	                </div>
	            `).join(""),n.historyList.querySelectorAll(".history-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".history-item-delete"))return;const a=o.generationHistory[parseInt(e.dataset.index)];Z(a.imageUrl),n.promptInput.value=a.prompt,E()})}),n.historyList.querySelectorAll(".history-item-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),Re(parseInt(e.dataset.index))})}),ne(n.historyList,".history-item-image")}function B(){const e=o.generationHistory,t=e.length;if(n.inlineHistoryCount.textContent=t,o.inlineHistoryCollapsed?n.inlineHistorySection.classList.add("collapsed"):n.inlineHistorySection.classList.remove("collapsed"),t===0){n.inlineHistoryGrid.innerHTML='<p class="inline-history-empty">No generation history yet. Create your first image!</p>',n.inlineHistoryShowMore.style.display="none";return}const a=o.inlineHistoryShowAll?t:Math.min(o.inlineHistoryLimit,t),i=e.slice(0,a);n.inlineHistoryGrid.innerHTML=i.map((r,c)=>{const d=r.prompt.length>100?r.prompt.substring(0,100)+"...":r.prompt,s=he(new Date(r.time));return`
            <div class="inline-history-item" data-index="${c}">
                <div class="inline-history-item-actions">
                    <button class="inline-history-action-btn load" data-index="${c}" title="Load prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn edit" data-index="${c}" title="Edit prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn delete" data-index="${c}" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
                <img class="inline-history-item-image" src="${r.imageUrl}" alt="Generated" loading="lazy">
                <div class="inline-history-item-info">
                    <div class="inline-history-item-prompt" title="${r.prompt.replace(/"/g,"&quot;")}">${d}</div>
                    <div class="inline-history-item-meta">
                        <span>${r.model}</span>
                        <span>•</span>
                        <span>${s}</span>
                    </div>
                </div>
            </div>
        `}).join(""),t>o.inlineHistoryLimit&&!o.inlineHistoryShowAll?(n.inlineHistoryShowMore.style.display="flex",n.showMoreHistoryBtn.textContent=`Show more (${t-a} more)`):o.inlineHistoryShowAll&&t>o.inlineHistoryLimit?(n.inlineHistoryShowMore.style.display="flex",n.showMoreHistoryBtn.textContent="Show less"):n.inlineHistoryShowMore.style.display="none",Me(),ne(n.inlineHistoryGrid,".inline-history-item-image")}function Me(){n.inlineHistoryGrid.querySelectorAll(".inline-history-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".inline-history-action-btn"))return;const a=parseInt(e.dataset.index);W(a)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.load").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=parseInt(e.dataset.index);W(a)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.edit").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=parseInt(e.dataset.index);De(a)})}),n.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const a=parseInt(e.dataset.index);de(a)})})}function W(e){const t=o.generationHistory[e];t&&(Z(t.imageUrl),n.promptInput.value=t.prompt,E(),l("success","Loaded","Prompt and image loaded from history"))}function de(e){if(confirm("Delete this generation from history?")){o.generationHistory.splice(e,1);try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(t){console.warn("Failed to persist generation history:",t)}B(),b(),l("success","Deleted","Generation removed from history")}}function Pe(e,t){if(!(e<0||e>=o.generationHistory.length)){o.generationHistory[e].prompt=t;try{localStorage.setItem("generationHistory",JSON.stringify(o.generationHistory))}catch(a){console.warn("Failed to persist generation history:",a)}B(),b(),l("success","Updated","Prompt has been updated")}}function De(e){const t=o.generationHistory[e];t&&(o.editingHistoryIndex=e,n.editPromptTextarea.value=t.prompt,n.editPromptModalOverlay.classList.add("show"),n.editPromptTextarea.focus())}function I(){n.editPromptModalOverlay.classList.remove("show"),o.editingHistoryIndex=-1,n.editPromptTextarea.value=""}function Ae(){if(o.editingHistoryIndex<0)return;const e=n.editPromptTextarea.value.trim();if(!e){l("error","Invalid","Prompt cannot be empty");return}Pe(o.editingHistoryIndex,e),I()}function Oe(){o.inlineHistoryCollapsed=!o.inlineHistoryCollapsed,localStorage.setItem("inlineHistoryCollapsed",o.inlineHistoryCollapsed.toString()),o.inlineHistoryCollapsed?n.inlineHistorySection.classList.add("collapsed"):n.inlineHistorySection.classList.remove("collapsed")}function Te(){o.inlineHistoryShowAll=!o.inlineHistoryShowAll,B()}function Re(e){de(e)}async function V(){var a;const e=n.promptInput.value.trim(),t=oe((a=n.batchCount)==null?void 0:a.value,1,10,1);if(n.batchCount&&(n.batchCount.value=String(t)),!e){l("error","Prompt required","Please enter a prompt");return}if(!(t>=6&&!confirm(`将并发生成 ${t} 张图片，确认继续？`))){o.isGenerating=!0,n.generateBtn.disabled=!0,n.resultPlaceholder.style.display="none",n.resultContainer.style.display="none",n.loadingState.style.display="block",w("generating","Generating...");try{const i=new FormData;i.append("model",n.modelSelect.value),i.append("prompt",e),i.append("n",String(t)),i.append("response_format","url"),n.aspectRatio.value&&i.append("aspect_ratio",n.aspectRatio.value),n.imageSize.value&&i.append("image_size",n.imageSize.value);for(const u of o.images){const h=u.data,P=await(await fetch(h)).blob();i.append("image",P,u.name||"image.png")}const r=ue(o.config.apiKey),c=ye(o.config.baseUrl),d=await me("/api/v1/images/edits",{method:"POST",headers:{...r?{"X-API-Key":r}:{},...c?{"X-Base-Url":c}:{}},body:i});if(!d.ok){const u=await $(d);if(d.status===401){window.location.href="/login?next=/image";return}throw new Error(pe(u,`Request failed (HTTP ${d.status})`))}const s=await $(d),M=s&&typeof s=="object"&&s.response?s.response:s,g=ve(M);if(!g.length)throw new Error("No image URL in response");Z(g[0]),Se(e);for(let u=g.length-1;u>=0;u-=1)be(e,g[u]);l("success",g.length>1?"Images generated":"Image generated",g.length>1?`Generated ${g.length} images successfully`:"Your image has been created successfully");const H=await ge();if(H){const u=g.map((U,P)=>({user_id:H,title:null,model:n.modelSelect.value||"unknown",prompt:e,status:"completed",image_url:U,metadata:{source:"image-editor",aspect_ratio:n.aspectRatio.value||null,image_size:n.imageSize.value||null,index:P},request:s&&typeof s=="object"&&s.request?s.request:null,response:s&&typeof s=="object"&&s.response?s.response:s})),{error:h}=await ee(()=>T.from("user_images").insert(u));h&&(console.warn("Failed to save images to repository:",h),l("error","Database Error",te(h)))}le()}catch(i){console.error("Generation error:",i),l("error","Generation failed",i.message),n.loadingState.style.display="none",n.resultPlaceholder.style.display="block",w("error","Error")}finally{o.isGenerating=!1,n.generateBtn.disabled=!1}}}function Z(e){n.loadingState.style.display="none",n.resultPlaceholder.style.display="none",n.resultContainer.style.display="block",n.resultImage.src=e,o.currentZoom=100,z(),w("connected","Complete")}function z(){n.zoomLevel.textContent=`${o.currentZoom}%`,n.resultImage.style.transform=`scale(${o.currentZoom/100})`}function Ze(){o.currentZoom<200&&(o.currentZoom+=25,z())}function ze(){o.currentZoom>25&&(o.currentZoom-=25,z())}function Ue(){const e=n.resultImage.src;if(!e)return;const t=document.createElement("a");t.href=e,t.download=`generated-${Date.now()}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t),l("success","Download started","Image is being downloaded")}function $e(){const e=n.resultImage.src;e&&(navigator.share?navigator.share({title:"Generated Image",text:n.promptInput.value,url:e}).catch(()=>{}):navigator.clipboard.writeText(e).then(()=>{l("success","Link copied","Image URL copied to clipboard")}))}function _e(){const e=n.resultImage.src;e&&(n.zoomImage.src=e,n.imageZoomOverlay.classList.add("show"))}function Ge(){const e=n.modelSearch.value.toLowerCase(),t=n.modelSelect.options;for(let a=0;a<t.length;a++){const i=t[a],r=i.textContent.toLowerCase();i.style.display=r.includes(e)?"":"none"}}function Ne(){document.querySelectorAll(".collapsible-header").forEach(e=>{const t=e.dataset.target,a=t?document.getElementById(t):null;a&&(t==="configContent"&&(e.classList.add("collapsed"),a.classList.add("collapsed")),e.addEventListener("click",()=>{const i=e.classList.toggle("collapsed");a.classList.toggle("collapsed",i)}))})}function qe(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.target),a=t.type==="password";t.type=a?"text":"password",e.innerHTML=a?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'})})}function Fe(){var e;n.fileInput.addEventListener("change",t=>_(t.target.files)),n.uploadArea.addEventListener("dragover",t=>{t.preventDefault(),n.uploadArea.classList.add("drag-over")}),n.uploadArea.addEventListener("dragleave",()=>{n.uploadArea.classList.remove("drag-over")}),n.uploadArea.addEventListener("drop",t=>{t.preventDefault(),n.uploadArea.classList.remove("drag-over"),_(t.dataTransfer.files)}),n.editMaskBtn.addEventListener("click",Ee),n.closeMaskModal.addEventListener("click",f),n.cancelMaskBtn.addEventListener("click",f),n.maskModalOverlay.addEventListener("click",t=>{t.target===n.maskModalOverlay&&f()}),n.closeImagePreview.addEventListener("click",X),n.imagePreviewOverlay.addEventListener("click",t=>{t.target===n.imagePreviewOverlay&&X()}),n.maskCanvas.addEventListener("mousedown",G),n.maskCanvas.addEventListener("mousemove",N),n.maskCanvas.addEventListener("mouseup",D),n.maskCanvas.addEventListener("mouseout",D),n.maskCanvas.addEventListener("touchstart",t=>{t.preventDefault();const a=t.touches[0];G({clientX:a.clientX,clientY:a.clientY})}),n.maskCanvas.addEventListener("touchmove",t=>{t.preventDefault();const a=t.touches[0];N({clientX:a.clientX,clientY:a.clientY})}),n.maskCanvas.addEventListener("touchend",D),document.querySelectorAll("[data-tool]").forEach(t=>{t.addEventListener("click",()=>{O=t.dataset.tool,document.querySelectorAll("[data-tool]").forEach(a=>a.classList.remove("active")),t.classList.add("active")})}),n.brushSize.addEventListener("input",()=>{n.brushSizeLabel.textContent=n.brushSize.value+"px"}),n.undoBtn.addEventListener("click",F),n.redoBtn.addEventListener("click",j),n.clearCanvasBtn.addEventListener("click",He),n.saveMaskBtn.addEventListener("click",K),n.resetMaskBtn.addEventListener("click",Le),n.canvasZoomInBtn.addEventListener("click",Y),n.canvasZoomOutBtn.addEventListener("click",J),n.canvasZoomResetBtn.addEventListener("click",ke),n.promptInput.addEventListener("input",E),n.showPromptHistory.addEventListener("click",()=>{ce(),n.promptHistoryDropdown.classList.toggle("show")}),document.addEventListener("click",t=>{t.target.closest(".main-prompt-section")||n.promptHistoryDropdown.classList.remove("show")}),n.modelSearch.addEventListener("input",Ge),(e=n.batchCount)==null||e.addEventListener("change",()=>{const t=oe(n.batchCount.value,1,10,1);n.batchCount.value=String(t)}),n.generateBtn.addEventListener("click",V),n.zoomInBtn.addEventListener("click",Ze),n.zoomOutBtn.addEventListener("click",ze),n.downloadBtn.addEventListener("click",Ue),n.shareBtn.addEventListener("click",$e),n.fullscreenBtn.addEventListener("click",_e),n.resultImage.addEventListener("error",()=>{(n.resultImage.getAttribute("src")||"")!==A&&(n.resultImage.alt="Image unavailable",n.resultImage.src=A)}),n.closeZoomBtn.addEventListener("click",()=>{n.imageZoomOverlay.classList.remove("show")}),n.imageZoomOverlay.addEventListener("click",t=>{t.target===n.imageZoomOverlay&&n.imageZoomOverlay.classList.remove("show")}),n.historyBtn.addEventListener("click",()=>{n.historyPanel.classList.toggle("show")}),n.closeHistoryBtn.addEventListener("click",()=>{n.historyPanel.classList.remove("show")}),n.inlineHistoryToggle.addEventListener("click",Oe),n.showMoreHistoryBtn.addEventListener("click",Te),n.closeEditPromptModal.addEventListener("click",I),n.cancelEditPromptBtn.addEventListener("click",I),n.saveEditPromptBtn.addEventListener("click",Ae),n.editPromptModalOverlay.addEventListener("click",t=>{t.target===n.editPromptModalOverlay&&I()}),document.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&(t.key==="z"?(t.preventDefault(),t.shiftKey?j():F()):t.key==="Enter"?(t.preventDefault(),V()):t.key==="s"&&(t.preventDefault(),K())),t.key==="Escape"&&(f(),I(),n.imageZoomOverlay.classList.remove("show"),n.historyPanel.classList.remove("show"))}),n.canvasContainer.addEventListener("wheel",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.deltaY<0?Y():J())})}function Q(){fe(),Ne(),qe(),Fe(),b(),B(),E(),xe().then(e=>{e&&le()})}document.readyState!=="loading"?Q():document.addEventListener("DOMContentLoaded",Q);
