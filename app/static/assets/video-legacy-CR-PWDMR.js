import{s as oe,y as Et}from"./supabase-Cqce9izT.js";(function(){var Xe,Ye,Ze,ke,et;const o={apiKey:document.getElementById("apiKey"),baseUrl:document.getElementById("baseUrl"),toggleApiKey:document.getElementById("toggleApiKey"),modelSelect:document.getElementById("modelSelect"),promptInput:document.getElementById("promptInput"),taskNameInput:document.getElementById("taskNameInput"),batchCount:document.getElementById("batchCount"),sora2Params:document.getElementById("sora2Params"),soraVariant:document.getElementById("soraVariant"),soraSeconds:document.getElementById("soraSeconds"),soraSize:document.getElementById("soraSize"),soraInputReference:document.getElementById("soraInputReference"),soraImages:document.getElementById("soraImages"),soraDropzone:document.getElementById("soraDropzone"),soraPickFiles:document.getElementById("soraPickFiles"),soraClearImages:document.getElementById("soraClearImages"),soraImageCount:document.getElementById("soraImageCount"),soraImagePreview:document.getElementById("soraImagePreview"),soraImageSourceInput:document.getElementById("soraImageSourceInput"),soraAddImageSources:document.getElementById("soraAddImageSources"),soraUploadFeedback:document.getElementById("soraUploadFeedback"),soraUploadText:document.getElementById("soraUploadText"),soraUploadProgress:document.getElementById("soraUploadProgress"),soraUploadMeta:document.getElementById("soraUploadMeta"),promptImages:document.getElementById("promptImages"),promptDropzone:document.getElementById("promptDropzone"),promptPickFiles:document.getElementById("promptPickFiles"),promptUploadFeedback:document.getElementById("promptUploadFeedback"),promptUploadText:document.getElementById("promptUploadText"),promptUploadProgress:document.getElementById("promptUploadProgress"),promptUploadMeta:document.getElementById("promptUploadMeta"),promptImagePreviewWrap:document.getElementById("promptImagePreviewWrap"),promptImageCount:document.getElementById("promptImageCount"),promptImagePreview:document.getElementById("promptImagePreview"),promptClearImages:document.getElementById("promptClearImages"),notifyHook:document.getElementById("notifyHook"),generateBtn:document.getElementById("generateBtn"),statusContainer:document.getElementById("statusContainer"),statusContent:document.getElementById("statusContent"),taskSummary:document.getElementById("taskSummary"),clearCompletedBtn:document.getElementById("clearCompletedBtn"),taskList:document.getElementById("taskList"),taskListFooter:document.getElementById("taskListFooter"),loadMoreTasksBtn:document.getElementById("loadMoreTasksBtn"),imageModal:document.getElementById("imageModal"),modalBackdrop:document.getElementById("modalBackdrop"),modalClose:document.getElementById("modalClose"),modalImage:document.getElementById("modalImage"),modalValue:document.getElementById("modalValue"),modalCopy:document.getElementById("modalCopy"),modalSave:document.getElementById("modalSave"),toastContainer:document.getElementById("toastContainer"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),saveConfigBtn:document.getElementById("saveConfigBtn"),resetConfigBtn:document.getElementById("resetConfigBtn"),charCount:document.getElementById("charCount"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultVideo:document.getElementById("resultVideo"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText")},I={submitDebounceMs:120,confirmBatchThreshold:6,maxBatchCount:20,renderPageSize:20,maxTasks:200,cleanupAfterMs:600*1e3,pollIntervalMs:4e3,pollJitterMs:600,maxPollErrors:3,createConcurrency:4,pollConcurrency:8,saveConcurrency:2,maxLogsPerTask:200,imageCompressThresholdBytes:5*1024*1024,imageMaxDimension:2048},E={items:[],editingId:null,readingCount:0},p={byLocalId:new Map,order:[],renderLimit:I.renderPageSize,nextIndex:1,lastSubmitAt:0,createQueue:k(I.createConcurrency),pollQueue:k(I.pollConcurrency),saveQueue:k(I.saveConcurrency)};o.apiKey.value=localStorage.getItem("video_api_key")||"";const we=o.baseUrl.value||"https://api.gpt-best.com",tt=localStorage.getItem("video_base_url")||we;try{o.baseUrl.value=O(tt)}catch{o.baseUrl.value=we,localStorage.removeItem("video_base_url")}const re=localStorage.getItem("video_model");re&&Array.from(o.modelSelect.options).some(e=>e.value===re)&&(o.modelSelect.value=re);const se=localStorage.getItem("video_sora_variant");se&&Array.from(o.soraVariant.options).some(e=>e.value===se)&&(o.soraVariant.value=se);const ie=localStorage.getItem("video_sora_seconds");ie&&o.soraSeconds&&Array.from(o.soraSeconds.options).some(e=>e.value===ie)&&(o.soraSeconds.value=ie);const ae=localStorage.getItem("video_sora_size");ae&&o.soraSize&&Array.from(o.soraSize.options).some(e=>e.value===ae)&&(o.soraSize.value=ae);const Ce=localStorage.getItem("video_batch_count");if(Ce){const e=Number.parseInt(Ce,10);Number.isFinite(e)&&e>=1&&e<=I.maxBatchCount&&(o.batchCount.value=String(e))}nt();function nt(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const n=e.getAttribute("data-target")||"",t=n?document.getElementById(n):null;t&&(t.type=t.type==="password"?"text":"password")})})}if(o.apiKey.addEventListener("change",()=>localStorage.setItem("video_api_key",o.apiKey.value)),o.baseUrl.addEventListener("change",()=>{try{const e=O(o.baseUrl.value);o.baseUrl.value=e,localStorage.setItem("video_base_url",e)}catch(e){b(`错误: ${e.message}`,"error"),localStorage.removeItem("video_base_url"),o.baseUrl.focus()}}),o.modelSelect.addEventListener("change",()=>{localStorage.setItem("video_model",o.modelSelect.value),_e()}),o.soraVariant&&o.soraVariant.addEventListener("change",()=>{localStorage.setItem("video_sora_variant",o.soraVariant.value),Ne()}),o.soraSeconds&&o.soraSeconds.addEventListener("change",()=>{localStorage.setItem("video_sora_seconds",o.soraSeconds.value)}),o.soraSize&&o.soraSize.addEventListener("change",()=>{localStorage.setItem("video_sora_size",o.soraSize.value)}),o.batchCount.addEventListener("change",()=>{const e=Number.parseInt(String(o.batchCount.value||"1"),10);if(Number.isFinite(e)){const n=Math.min(I.maxBatchCount,Math.max(1,e));o.batchCount.value=String(n),localStorage.setItem("video_batch_count",String(n))}}),o.soraPickFiles&&o.soraImages&&(o.soraPickFiles.addEventListener("click",()=>o.soraImages.click()),o.soraImages.addEventListener("change",async()=>{const e=o.soraImages.files?Array.from(o.soraImages.files):[];await Q(e,{source:"sora"}),o.soraImages.value=""})),o.promptPickFiles&&o.promptImages&&(o.promptPickFiles.addEventListener("click",()=>o.promptImages.click()),o.promptImages.addEventListener("change",async()=>{const e=o.promptImages.files?Array.from(o.promptImages.files):[];await Q(e,{source:"prompt"}),o.promptImages.value=""})),o.soraClearImages&&o.soraClearImages.addEventListener("click",()=>{E.items=[],$(),b("已清空参考图片","info")}),o.promptClearImages&&o.promptClearImages.addEventListener("click",()=>{E.items=[],$(),b("已清空参考图片","info")}),o.soraAddImageSources&&o.soraImageSourceInput&&(o.soraAddImageSources.addEventListener("click",()=>{const e=o.soraImageSourceInput.value,n=de(e);n>0&&(o.soraImageSourceInput.value="",$(),b(`已添加 ${n} 个图片来源`,"success"))}),o.soraImageSourceInput.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),o.soraAddImageSources.click())})),st(),it(),(Xe=o.generateBtn)==null||Xe.addEventListener("click",Je),(Ye=o.clearCompletedBtn)==null||Ye.addEventListener("click",()=>{pt(),q(),h("已清理已完成任务","info")}),(Ze=o.loadMoreTasksBtn)==null||Ze.addEventListener("click",()=>{p.renderLimit+=I.renderPageSize,q()}),o.historyBtn&&o.historyBtn.addEventListener("click",()=>{var e;(e=o.historyPanel)==null||e.classList.add("open"),document.body.classList.add("panel-open")}),o.closeHistoryBtn&&o.closeHistoryBtn.addEventListener("click",()=>{var e;(e=o.historyPanel)==null||e.classList.remove("open"),document.body.classList.remove("panel-open")}),(ke=o.historyPanel)==null||ke.addEventListener("click",e=>{e.target===o.historyPanel&&(o.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"))}),document.querySelectorAll(".collapsible-header").forEach(e=>{const n=e.dataset.target,t=document.getElementById(n);if(!t)return;const r=localStorage.getItem(`collapsed_${n}`);(r===null?n==="configContent":r==="true")&&(e.classList.add("collapsed"),t.classList.add("collapsed")),e.addEventListener("click",()=>{const s=e.classList.toggle("collapsed");t.classList.toggle("collapsed",s),localStorage.setItem(`collapsed_${n}`,String(s))})}),o.saveConfigBtn&&o.saveConfigBtn.addEventListener("click",()=>{localStorage.setItem("video_api_key",o.apiKey.value);try{const e=O(o.baseUrl.value);localStorage.setItem("video_base_url",e),o.baseUrl.value=e}catch(e){b(`Base URL 错误: ${e.message}`,"error")}h("配置已保存","success")}),o.resetConfigBtn&&o.resetConfigBtn.addEventListener("click",()=>{confirm("确定要重置配置吗？这将清除保存的 API Key 和 Base URL。")&&(localStorage.removeItem("video_api_key"),localStorage.removeItem("video_base_url"),o.apiKey.value="",o.baseUrl.value="https://api.gpt-best.com",h("配置已重置","info"))}),o.promptInput&&o.charCount){const e=()=>{o.charCount.textContent=`${o.promptInput.value.length} 字符`};o.promptInput.addEventListener("input",e),e()}o.inlineHistoryToggle&&o.inlineHistoryContent&&(localStorage.getItem("inlineHistoryCollapsed")==="true"&&((et=o.inlineHistorySection)==null||et.classList.add("collapsed")),o.inlineHistoryToggle.addEventListener("click",()=>{var t;const n=(t=o.inlineHistorySection)==null?void 0:t.classList.toggle("collapsed");localStorage.setItem("inlineHistoryCollapsed",String(n))})),document.addEventListener("keydown",e=>{var n;if(e.key==="Escape"){(n=o.historyPanel)!=null&&n.classList.contains("open")&&(o.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"),e.preventDefault());const t=document.getElementById("editPromptModalOverlay");t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.preventDefault())}(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&document.activeElement===o.promptInput&&(e.preventDefault(),Je())});const _={items:[],displayLimit:6,loading:!1};async function V(){if(!_.loading){_.loading=!0;try{const{data:e,error:n}=await oe.from("user_videos").select("id,title,model,prompt,video_url,created_at").order("created_at",{ascending:!1}).limit(50);if(n)throw n;_.items=Array.isArray(e)?e:[],Be()}catch(e){b(`加载历史记录失败: ${e.message}`,"error")}finally{_.loading=!1}}}function Be(){if(!o.inlineHistoryGrid||!o.inlineHistoryCount)return;const e=_.items;if(o.inlineHistoryCount.textContent=e.length,e.length===0){o.inlineHistoryGrid.innerHTML='<div class="inline-history-empty">暂无生成记录</div>',o.showMoreHistoryBtn&&(o.showMoreHistoryBtn.style.display="none");return}const n=e.slice(0,_.displayLimit);o.inlineHistoryGrid.innerHTML="",n.forEach(t=>{var g;const r=document.createElement("div");r.className="inline-history-item",r.dataset.id=t.id;const i=document.createElement("div");if(i.className="inline-history-thumb",t.video_url||t.thumbnail_url){const v=document.createElement("video");v.src=t.video_url||"",v.muted=!0,v.loop=!0,v.playsInline=!0,v.preload="metadata",i.appendChild(v),r.addEventListener("mouseenter",()=>v.play().catch(()=>{})),r.addEventListener("mouseleave",()=>{v.pause(),v.currentTime=0})}else i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';const l=document.createElement("div");l.className="inline-history-info";const s=document.createElement("div");s.className="inline-history-prompt",s.textContent=(t.prompt||"无提示词").slice(0,60)+(((g=t.prompt)==null?void 0:g.length)>60?"...":""),s.title=t.prompt||"";const a=document.createElement("div");a.className="inline-history-meta";const c=t.model||"unknown",m=t.created_at?new Date(t.created_at).toLocaleDateString():"";a.textContent=`${c} · ${m}`,l.appendChild(s),l.appendChild(a);const u=document.createElement("div");u.className="inline-history-actions";const f=document.createElement("button");f.className="inline-history-btn",f.title="加载",f.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',f.addEventListener("click",v=>{v.stopPropagation(),Le(t)});const y=document.createElement("button");y.className="inline-history-btn",y.title="编辑提示词",y.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',y.addEventListener("click",v=>{v.stopPropagation(),ot(t)});const d=document.createElement("button");d.className="inline-history-btn danger",d.title="删除",d.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',d.addEventListener("click",v=>{v.stopPropagation(),rt(t.id)}),u.appendChild(f),u.appendChild(y),u.appendChild(d),r.appendChild(i),r.appendChild(l),r.appendChild(u),r.addEventListener("click",()=>Le(t)),o.inlineHistoryGrid.appendChild(r)}),o.showMoreHistoryBtn&&(o.showMoreHistoryBtn.style.display=e.length>_.displayLimit?"":"none")}function Le(e){var n,t;e.prompt&&(o.promptInput.value=e.prompt,o.charCount&&(o.charCount.textContent=`${e.prompt.length} 字符`)),e.video_url&&o.resultContainer&&o.resultVideo&&((n=o.resultPlaceholder)==null||n.classList.add("hidden"),(t=o.loadingState)==null||t.classList.add("hidden"),o.resultContainer.classList.remove("hidden"),o.resultVideo.src=e.video_url),h("已加载历史记录","success")}function ot(e){const n=document.getElementById("editPromptModalOverlay"),t=document.getElementById("editPromptTextarea"),r=document.getElementById("saveEditPromptBtn"),i=document.getElementById("cancelEditPromptBtn");if(!n||!t)return;t.value=e.prompt||"",n.classList.remove("hidden"),t.focus();const l=async()=>{const m=t.value.trim();if(!m){h("提示词不能为空","error");return}try{const{error:u}=await oe.from("user_videos").update({prompt:m,updated_at:new Date().toISOString()}).eq("id",e.id);if(u)throw u;n.classList.add("hidden"),h("提示词已更新","success"),V()}catch(u){h(`更新失败: ${u.message}`,"error")}},s=()=>{n.classList.add("hidden")},a=r.cloneNode(!0),c=i.cloneNode(!0);r.parentNode.replaceChild(a,r),i.parentNode.replaceChild(c,i),a.addEventListener("click",l),c.addEventListener("click",s)}async function rt(e){if(confirm("确定要删除这条记录吗？"))try{const{error:n}=await oe.from("user_videos").delete().eq("id",e);if(n)throw n;h("已删除","success"),V()}catch(n){h(`删除失败: ${n.message}`,"error")}}o.showMoreHistoryBtn&&o.showMoreHistoryBtn.addEventListener("click",()=>{_.displayLimit+=6,Be()});function K(e){if(!(!o.statusDot||!o.statusText))switch(o.statusDot.className="status-dot",e){case"ready":o.statusDot.classList.add("ready"),o.statusText.textContent="就绪";break;case"generating":o.statusDot.classList.add("generating"),o.statusText.textContent="生成中...";break;case"error":o.statusDot.classList.add("error"),o.statusText.textContent="错误";break;default:o.statusText.textContent=e}}function Te(e){if(!(!o.resultPlaceholder||!o.loadingState||!o.resultContainer)){if(!e){o.resultPlaceholder.classList.remove("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.add("hidden"),K("ready");return}if(e.status==="completed"&&e.videoUrl)o.resultPlaceholder.classList.add("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.remove("hidden"),o.resultVideo&&(o.resultVideo.src=e.videoUrl),K("ready");else if(["pending","processing","queued"].includes(e.status)){o.resultPlaceholder.classList.add("hidden"),o.loadingState.classList.remove("hidden"),o.resultContainer.classList.add("hidden");const n=typeof e.progress=="number"?e.progress:0,t=Math.min(100,Math.max(0,n)),r=t>0?t:e.status==="queued"?1:2;o.progressFill&&(o.progressFill.style.width=`${r}%`),o.progressText&&(o.progressText.textContent=`${r}%`),K("generating")}else e.status==="failed"&&(o.resultPlaceholder.classList.remove("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.add("hidden"),K("error"))}}V(),K("ready");const xe=document.getElementById("downloadBtn"),Me=document.getElementById("shareBtn"),Ue=document.getElementById("fullscreenBtn"),$e=document.getElementById("showPromptHistory"),Pe=document.getElementById("closeEditPromptModal");xe&&xe.addEventListener("click",()=>{var t;const e=(t=o.resultVideo)==null?void 0:t.src;if(!e){h("没有可下载的视频","warning");return}const n=document.createElement("a");n.href=e,n.download=`video_${Date.now()}.mp4`,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n),h("开始下载视频","success")}),Me&&Me.addEventListener("click",async()=>{var n;const e=(n=o.resultVideo)==null?void 0:n.src;if(!e){h("没有可分享的视频","warning");return}if(navigator.share)try{await navigator.share({title:"Generated Video",url:e})}catch(t){t.name!=="AbortError"&&(J(e),h("链接已复制到剪贴板","success"))}else J(e),h("链接已复制到剪贴板","success")}),Ue&&Ue.addEventListener("click",()=>{const e=o.resultVideo;e&&(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}),$e&&$e.addEventListener("click",()=>{o.inlineHistorySection&&(o.inlineHistorySection.classList.remove("collapsed"),o.inlineHistorySection.scrollIntoView({behavior:"smooth",block:"start"}))}),Pe&&Pe.addEventListener("click",()=>{const e=document.getElementById("editPromptModalOverlay");e&&e.classList.add("hidden")}),o.taskList.addEventListener("click",e=>{const n=e.target instanceof Element?e.target:null;if(!n)return;const t=n.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const r=t.getAttribute("data-action")||"",i=t.closest("[data-local-id]"),l=i==null?void 0:i.getAttribute("data-local-id");if(l){if(r==="cancel"){gt(l);return}if(r==="retry"){ft(l);return}if(r==="copy-url"){const s=p.byLocalId.get(l),a=(s==null?void 0:s.videoUrl)||"";a&&(J(a),h("已复制视频链接","success"));return}if(r==="save"){const s=p.byLocalId.get(l);s&&te(s,{manual:!0});return}}}),_e(),$(),q();const F={message:"",type:"",at:0};function b(e,n="info"){const t=String(e||""),r=String(n||"info");console[r==="error"?"error":r==="warning"?"warn":"log"](`[${r}] ${t}`);const l=r==="error"?"error":r==="warning"?"warning":r==="success"?"success":"info",s=Date.now();t&&(F.message!==t||F.type!==l||s-F.at>1200)&&(F.message=t,F.type=l,F.at=s,h(t,l))}function h(e,n="info",t={}){const r=Number.parseInt(String(t.durationMs??2800),10),i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`t-${Date.now()}-${Math.random().toString(16).slice(2)}`,l=document.createElement("div");l.className=`toast toast-${n}`,l.setAttribute("data-toast-id",i),l.textContent=String(e||""),o.toastContainer.appendChild(l),requestAnimationFrame(()=>{l.classList.add("show")});const s=()=>{l.classList.remove("show"),l.classList.add("hide"),setTimeout(()=>l.remove(),220)};setTimeout(s,Number.isFinite(r)?r:2800),l.addEventListener("click",s)}function _e(){const n=o.modelSelect.value==="sora2";o.sora2Params.classList.toggle("hidden",!n),n&&Ne()}function Ne(){if(o.modelSelect.value!=="sora2")return;const n=o.soraVariant.value==="sora-2-pro";if(!o.soraSize)return;const t=new Set(n?["1280x720","720x1280","1024x1792","1792x1024"]:["1280x720","720x1280"]);for(const i of Array.from(o.soraSize.options))i.disabled=!t.has(i.value);const r=String(o.soraSize.value||"").trim();if(!t.has(r)){const i=t.has("720x1280")?"720x1280":Array.from(t)[0];o.soraSize.value=i,localStorage.setItem("video_sora_size",i)}}function st(){const e="drag-over";[{zone:o.soraDropzone,input:o.soraImages,source:"sora"},{zone:o.promptDropzone,input:o.promptImages,source:"prompt"}].filter(t=>t.zone&&t.input).forEach(({zone:t,input:r,source:i})=>{const l=s=>{const a=s.relatedTarget;a instanceof Node&&t.contains(a)||t.classList.remove(e)};t.addEventListener("dragenter",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragleave",s=>{s.preventDefault(),s.stopPropagation(),l(s)}),t.addEventListener("drop",async s=>{var c;s.preventDefault(),s.stopPropagation(),t.classList.remove(e);const a=(c=s.dataTransfer)!=null&&c.files?Array.from(s.dataTransfer.files):[];await Q(a,{source:i})}),t.addEventListener("paste",async s=>{var m;const c=((m=s.clipboardData)!=null&&m.items?Array.from(s.clipboardData.items):[]).filter(u=>u.kind==="file").map(u=>u.getAsFile()).filter(Boolean);c.length&&(s.preventDefault(),await Q(c,{source:i}))}),t.addEventListener("click",s=>{const a=s.target;a instanceof HTMLElement&&a.closest("button")||r.click()})})}function it(){const e=()=>me();o.modalBackdrop.addEventListener("click",e),o.modalClose.addEventListener("click",e),document.addEventListener("keydown",n=>{n.key==="Escape"&&!o.imageModal.classList.contains("hidden")&&e()}),o.modalCopy.addEventListener("click",async()=>{const n=String(o.modalValue.value||"");try{await navigator.clipboard.writeText(n),b("已复制到剪贴板","success")}catch{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),b("已复制到剪贴板","success")}}),o.modalSave.addEventListener("click",()=>{const n=E.editingId;if(!n)return;const t=String(o.modalValue.value||"").trim();if(!t){b("错误: 图片内容不能为空","error");return}if(!le(t)){b("错误: 仅支持 http/https URL 或 data:image/...base64","error");return}const r=E.items.find(i=>i.id===n);r&&(r.value=t,r.kind=t.startsWith("data:image")?"data":"url",$(),me(),b("已更新图片内容","success"))})}function at(e){return new Promise((n,t)=>{const r=new FileReader;r.onload=()=>n(String(r.result||"")),r.onerror=()=>t(r.error||new Error("读取文件失败")),r.readAsDataURL(e)})}function De(e){return String(e||"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean)}function le(e){const n=String(e||"").trim();if(!n)return!1;if(n.startsWith("data:image"))return!0;try{const t=new URL(n);return["http:","https:"].includes(t.protocol)}catch{return!1}}function O(e){const n=String(e||"").trim();if(!n)throw new Error("请输入 Base URL");let t;try{t=new URL(n)}catch{throw new Error("Base URL 不是合法的 URL")}if(t.protocol!=="https:")throw new Error("Base URL 必须使用 HTTPS 协议");if(!t.hostname)throw new Error("Base URL 缺少 host，例如 https://api.example.com");const r=t.origin;return(t.pathname!=="/"||t.search||t.hash)&&b(`提示: Base URL 包含路径/参数，已自动使用 origin: ${r}`,"warning"),r}function lt(e){const n=t=>encodeURIComponent(String(t||""));switch(e){case"sora2":return{createPath:"/v1/videos",createBodyType:"multipart",statusPath:t=>`/v1/videos/${n(t)}`,contentPath:t=>`/v1/videos/${n(t)}/content`};case"veo":return{createPath:"/v1/video/veo/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/veo/tasks/${n(t)}`};case"seedance":return{createPath:"/v1/video/seedance/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/seedance/tasks/${n(t)}`};case"newmodel":return{createPath:"/v1/video/newmodel/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/newmodel/tasks/${n(t)}`};default:throw new Error(`不支持的模型: ${e}`)}}function ce(e,n=!1){const r={Authorization:`Bearer ${He(e)}`};return n&&(r["Content-Type"]="application/json"),r}function He(e){return String(e||"").trim().replace(/^bearer\\s+/i,"").trim()}async function W(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const t=await e.text();try{return JSON.parse(t)}catch{return t}}function G(e){const n=Number(e||0);if(!Number.isFinite(n)||n<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,i=n;for(;i>=1024&&r<t.length-1;)i/=1024,r+=1;const l=r===0?0:r===1?1:2;return`${i.toFixed(l)} ${t[r]}`}function Re(e){const n=e==="prompt"?"prompt":"sora";return{zone:n==="prompt"?o.promptDropzone:o.soraDropzone,pickBtn:n==="prompt"?o.promptPickFiles:o.soraPickFiles,clearBtn:n==="prompt"?null:o.soraClearImages,textEl:n==="prompt"?o.promptUploadText:o.soraUploadText,progressEl:n==="prompt"?o.promptUploadProgress:o.soraUploadProgress,metaEl:n==="prompt"?o.promptUploadMeta:o.soraUploadMeta}}function M(e,{isProcessing:n,state:t,text:r,progress:i,meta:l}={}){const s=Re(e);if(s.zone&&(typeof n=="boolean"&&s.zone.classList.toggle("is-processing",n),t==="success"||t==="error"?(s.zone.classList.toggle("is-success",t==="success"),s.zone.classList.toggle("is-error",t==="error")):t==="clear"&&(s.zone.classList.remove("is-success"),s.zone.classList.remove("is-error")),s.textEl&&typeof r=="string"&&(s.textEl.textContent=r),s.metaEl&&typeof l=="string"&&(s.metaEl.textContent=l),s.progressEl&&typeof i=="number")){const a=Math.min(100,Math.max(0,i));s.progressEl.style.width=`${a}%`}}function ze(e,n){const t=Re(e);t.zone&&(t.zone.classList.toggle("is-loading",n),t.pickBtn&&(t.pickBtn.disabled=n),t.clearBtn&&(t.clearBtn.disabled=n||E.items.length===0),e!=="prompt"&&(o.soraAddImageSources.disabled=n))}async function ct(e,n={}){const t=Number(n.thresholdBytes??I.imageCompressThresholdBytes),r=Number(n.maxDimension??I.imageMaxDimension);if(!e||!Number.isFinite(e.size)||e.size<=t)return{file:e,compressed:!1,originalBytes:(e==null?void 0:e.size)||0,outputBytes:(e==null?void 0:e.size)||0};const l=await(async()=>{if(globalThis.createImageBitmap)return await globalThis.createImageBitmap(e);const s=URL.createObjectURL(e);try{const a=new Image;return a.decoding="async",a.src=s,await new Promise((c,m)=>{a.onload=c,a.onerror=()=>m(new Error("图片解码失败"))}),a}finally{URL.revokeObjectURL(s)}})();try{const s=l.width||l.naturalWidth||0,a=l.height||l.naturalHeight||0;if(!s||!a)return{file:e,compressed:!1,originalBytes:e.size,outputBytes:e.size};const c=document.createElement("canvas"),m=c.getContext("2d",{alpha:!0});if(!m)throw new Error("Canvas 初始化失败");let u=1;const f=Math.max(s,a);Number.isFinite(r)&&r>0&&f>r&&(u=r/f);let y=Math.max(1,Math.round(s*u)),d=Math.max(1,Math.round(a*u));c.width=y,c.height=d;const g=(T,L)=>new Promise(w=>{c.toBlob(j=>w(j),T,L)}),v=()=>{m.clearRect(0,0,c.width,c.height),m.drawImage(l,0,0,c.width,c.height)};v();const B=e.size;let z=null,N=1/0,D=.84,A="image/jpeg";for(let T=0;T<4;T+=1){const L=await g(A,D);if(!L)break;const w=L.size||0;if(w>0&&w<N&&(z=L,N=w),w>0&&w<=t)break;D=Math.max(.58,D-.12),y=Math.max(1,Math.round(y*.92)),d=Math.max(1,Math.round(d*.92)),c.width=y,c.height=d,v()}if(!z||N>=B)return{file:e,compressed:!1,originalBytes:B,outputBytes:B};const H=new File([z],e.name.replace(/\.\w+$/,"")+".jpg",{type:A,lastModified:Date.now()});return{file:H,compressed:!0,originalBytes:B,outputBytes:H.size}}finally{typeof(l==null?void 0:l.close)=="function"&&l.close()}}async function Q(e,n={}){const t=n.source==="prompt"?"prompt":"sora",r=(e||[]).filter(i=>{if(!i)return!1;if(String(i.type||"").startsWith("image/"))return!0;const s=String(i.name||"");return/\.(png|jpe?g|webp|gif|bmp|svg|ico|tiff?)$/i.test(s)});if(r.length===0){e&&e.length&&b("未检测到可用的图片文件","warning");return}E.readingCount+=r.length,ze(t,!0),M(t,{isProcessing:!0,state:"clear",text:"处理中…",progress:0,meta:""});try{const i=r.length;let l=0;for(let s=0;s<i;s+=1){const a=r[s];M(t,{text:a.size>I.imageCompressThresholdBytes?"压缩中…":"读取中…",meta:`${s+1}/${i} · ${a.name} · ${G(a.size)}`,progress:Math.round(l/i*100)});let c=a;if(a.size>I.imageCompressThresholdBytes){const f=a.size,y=await ct(a,{thresholdBytes:I.imageCompressThresholdBytes,maxDimension:I.imageMaxDimension});c=y.file,y.compressed?M(t,{text:"压缩完成，读取中…",meta:`${s+1}/${i} · ${a.name} · ${G(f)} → ${G(c.size)}`}):M(t,{text:"读取中…",meta:`${s+1}/${i} · ${a.name} · ${G(f)}`})}const m=await at(c),u=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;E.items.push({id:u,kind:"data",value:m,name:(c==null?void 0:c.name)||(a==null?void 0:a.name)||"image",size:(c==null?void 0:c.size)||(a==null?void 0:a.size)||0}),l+=1,M(t,{progress:Math.round(l/i*100)})}$(),M(t,{state:"success",text:`已添加 ${r.length} 张图片`,meta:`${r.length} 张 · ${E.items.length} 张总计`,progress:100}),b(`已添加 ${r.length} 张图片（已转 Base64）`,"success"),setTimeout(()=>{M(t,{isProcessing:!1})},900),setTimeout(()=>{M(t,{state:"clear"})},1600)}catch(i){M(t,{state:"error",text:"添加失败",meta:String((i==null?void 0:i.message)||i||""),progress:0}),setTimeout(()=>M(t,{isProcessing:!1}),1400),b(`添加图片失败: ${i.message||i}`,"error")}finally{E.readingCount=Math.max(0,E.readingCount-r.length),ze(t,E.readingCount>0),$()}}function de(e){const n=De(e);let t=0;for(const r of n){if(!le(r)){b(`跳过无效图片来源: ${r.slice(0,80)}${r.length>80?"…":""}`,"warning");continue}const i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;E.items.push({id:i,kind:r.startsWith("data:image")?"data":"url",value:r,name:r.startsWith("data:image")?"base64":"url",size:0}),t+=1}return t}function $(){const e=E.items.length,n=o.promptImageCount||o.soraImageCount,t=o.promptClearImages||o.soraClearImages,r=o.promptImagePreviewWrap||null,i=o.promptImagePreview||o.soraImagePreview;if(n&&(n.textContent=`${e} 张图片`),t&&(t.disabled=E.readingCount>0||e===0),r&&r.classList.toggle("hidden",e===0),!i||(i.innerHTML="",e===0))return;const s=`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">
                <rect width="200" height="150" rx="12" fill="#F5F5F7"/>
                <path d="M62 96l16-18 16 18 22-26 22 26" fill="none" stroke="#86868b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="78" cy="58" r="10" fill="#d1d1d6"/>
                <text x="100" y="128" font-family="system-ui, -apple-system" font-size="12" fill="#86868b" text-anchor="middle">Preview unavailable</text>
            </svg>`)}`;for(const a of E.items){const c=document.createElement("div");c.className="preview-item",c.dataset.id=a.id;const m=document.createElement("img");m.className="preview-img",m.loading="lazy",m.alt=a.name||"image",m.src=a.value,m.addEventListener("click",()=>Ae(a.id)),m.onerror=()=>{m.src=s,m.classList.add("is-fallback")};const u=document.createElement("div");u.className="preview-actions";const f=document.createElement("button");f.type="button",f.className="preview-btn",f.textContent="编辑",f.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),Ae(a.id)});const y=document.createElement("button");y.type="button",y.className="preview-btn danger",y.textContent="移除",y.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),E.items=E.items.filter(v=>v.id!==a.id),$(),b("已移除图片","info")}),u.appendChild(f),u.appendChild(y);const d=document.createElement("div");d.className="preview-caption",d.textContent=a.kind==="url"?"URL":"Base64",c.appendChild(m),c.appendChild(u),c.appendChild(d),i.appendChild(c)}}function Ae(e){const n=E.items.find(t=>t.id===e);n&&(E.editingId=e,o.modalImage.src=n.value,o.modalValue.value=n.value,o.imageModal.classList.remove("hidden"),document.body.classList.add("modal-open"),o.modalValue.focus())}function me(){E.editingId=null,o.imageModal.classList.add("hidden"),document.body.classList.remove("modal-open"),o.modalImage.src="",o.modalValue.value=""}function J(e){var r;const n=String(e||"");if(!n)return;if((r=navigator.clipboard)!=null&&r.writeText){navigator.clipboard.writeText(n).catch(()=>{});return}const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove()}function Fe(e,n,t,r){const i=Number.parseInt(String(e??""),10);return Number.isFinite(i)?Math.min(t,Math.max(n,i)):r}function ue(e){const n=Number(e);return!Number.isFinite(n)||n<=0?null:n<1e10?Math.round(n*1e3):Math.round(n)}function dt(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return Math.min(100,Math.max(0,Math.round(e)));const t=String(e).trim().match(/(\d+(?:\.\d+)?)/),r=t?Number.parseFloat(t[1]):0;return Number.isFinite(r)?Math.min(100,Math.max(0,Math.round(r))):0}function mt(e){const n=String(e||"").trim().toLowerCase();return n?["success","succeeded","ok","completed","done","finished","finish"].includes(n)?"completed":["fail","failed","error","timeout"].includes(n)?"failed":["cancelled","canceled","cancel"].includes(n)?"cancelled":["processing","running","executing","in_progress","in-progress","working"].includes(n)?"processing":(["queued","pending","waiting","created","init","initializing"].includes(n),"pending"):"pending"}function X(e){return{queued:"排队中",pending:"等待",processing:"处理中",completed:"成功",failed:"失败",cancelled:"已取消"}[e]||"等待"}function C(e){return["completed","failed","cancelled"].includes(String(e||""))}function Ve(e){var r,i,l,s,a;const n=[e==null?void 0:e.video_url,e==null?void 0:e.videoUrl,e==null?void 0:e.url,(r=e==null?void 0:e.data)==null?void 0:r.video_url,(i=e==null?void 0:e.data)==null?void 0:i.videoUrl,(l=e==null?void 0:e.data)==null?void 0:l.url,(s=e==null?void 0:e.data)==null?void 0:s.output];for(const c of n)if(typeof c=="string"&&/^https?:\/\//i.test(c.trim()))return c.trim();const t=(a=e==null?void 0:e.data)==null?void 0:a.output;if(t&&typeof t=="object"){const c=[t.url,t.video_url,t.videoUrl];for(const m of c)if(typeof m=="string"&&/^https?:\/\//i.test(m.trim()))return m.trim()}return null}function Y(e){if(typeof e!="string")return!1;const n=e.trim();return/^https?:\/\//i.test(n)}function pe(e){return{taskId:(e==null?void 0:e.task_id)||(e==null?void 0:e.taskId)||(e==null?void 0:e.id)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,rawStatus:(e==null?void 0:e.status)||null,status:mt(e==null?void 0:e.status),progress:dt((e==null?void 0:e.progress)??(e==null?void 0:e.process)),failReason:(e==null?void 0:e.fail_reason)||(e==null?void 0:e.failReason)||(e==null?void 0:e.error)||(e==null?void 0:e.detail)||"",submitTimeMs:ue((e==null?void 0:e.created_at)??(e==null?void 0:e.submit_time)),startTimeMs:ue((e==null?void 0:e.started_at)??(e==null?void 0:e.start_time)),finishTimeMs:ue((e==null?void 0:e.completed_at)??(e==null?void 0:e.finish_time)),cost:typeof(e==null?void 0:e.cost)=="number"?e.cost:null,videoUrl:Ve(e)}}async function Ke(e){var l;if(!(e!=null&&e.taskId))throw new Error("缺少 video_id");if(!((l=e==null?void 0:e.apiSpec)!=null&&l.contentPath))throw new Error("该任务不支持 content 获取");const n=`${e.baseUrl}${e.apiSpec.contentPath(e.taskId)}`,t=await fetch(n,{headers:ce(e.apiKey,!1),signal:e.controller.signal});if((t.headers.get("content-type")||"").includes("application/json")){const s=await W(t);if(!t.ok){const c=(s==null?void 0:s.detail)||(s==null?void 0:s.error)||(typeof s=="string"?s:null);throw new Error(c||`获取内容失败（HTTP ${t.status}）`)}const a=Ve(s);if(a)return a;throw new Error("content 响应未包含可用的视频链接")}if(!t.ok){const s=await W(t),a=(s==null?void 0:s.detail)||(s==null?void 0:s.error)||(typeof s=="string"?s:null);throw new Error(a||`获取内容失败（HTTP ${t.status}）`)}const i=await t.blob();return URL.createObjectURL(i)}function Z(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return"—"}}function qe(e){const n=Math.max(0,Math.floor(e/1e3)),t=n%60,r=Math.floor(n/60)%60,i=Math.floor(n/3600),l=s=>String(s).padStart(2,"0");return i>0?`${i}:${l(r)}:${l(t)}`:`${l(r)}:${l(t)}`}function k(e=4){let n=0;const t=[],r=()=>{for(;n<e&&t.length>0;){const s=t.shift();!s||s.aborted||(s.started=!0,n+=1,Promise.resolve().then(()=>s.fn()).then(s.resolve,s.reject).finally(()=>{var a;n-=1,(a=s.cleanup)==null||a.call(s),r()}))}};return{enqueue:(s,a={})=>{const c=a.signal;return new Promise((m,u)=>{const f={fn:s,resolve:m,reject:u,signal:c,started:!1,aborted:!1,cleanup:null};if(c!=null&&c.aborted){u(new DOMException("Aborted","AbortError"));return}const y=()=>{if(f.started)return;f.aborted=!0;const d=t.indexOf(f);d>=0&&t.splice(d,1),u(new DOMException("Aborted","AbortError")),r()};c&&(c.addEventListener("abort",y,{once:!0}),f.cleanup=()=>c.removeEventListener("abort",y)),t.push(f),r()})},stats:()=>({active:n,pending:t.length,concurrency:e})}}function je(e,n){var r,i,l,s;const t=String(n||"").trim();if(e==="sora2"){const a=o.soraVariant.value,c=String(((r=o.soraSeconds)==null?void 0:r.value)||"4").trim(),m=String(((i=o.soraSize)==null?void 0:i.value)||"720x1280").trim();if(!new Set(["4","8","12"]).has(c))throw new Error("seconds 可选值为 4 / 8 / 12");const f=a==="sora-2-pro";if(!new Set(f?["1280x720","720x1280","1024x1792","1792x1024"]:["1280x720","720x1280"]).has(m))throw new Error(f?"size 可选值为 1280x720 / 720x1280 / 1024x1792 / 1792x1024":"size 对于 sora-2 仅支持 1280x720 / 720x1280");const d=((s=(l=o.soraInputReference)==null?void 0:l.files)==null?void 0:s[0])||null;if(d&&!String(d.type||"").startsWith("image/"))throw new Error("input_reference 必须是图片文件（jpeg/png/webp）");const g={model:a,prompt:t,seconds:c,size:m},v=`${a} · ${m} · ${c}s${d?" · ref=1":""}`;return{payload:g,metaSummary:v,inputReference:d}}return{payload:{model:e,prompt:t},metaSummary:e}}function Oe(e){const n=document.createElement("div");n.className="task-wrapper",n.setAttribute("data-local-id",e.localId);const t=document.createElement("div");t.className="task-mini-preview hidden";const r=document.createElement("video");r.className="task-mini-video",r.muted=!0,r.loop=!0,r.playsInline=!0,r.controls=!0;const i=document.createElement("div");i.className="task-mini-preview-actions";const l=document.createElement("button");l.className="task-mini-btn",l.title="复制视频链接",l.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',l.onclick=It=>{It.preventDefault(),J(e.videoUrl),h("链接已复制","success")};const s=document.createElement("a");s.className="task-mini-btn",s.title="下载视频",s.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',s.target="_blank",i.appendChild(l),i.appendChild(s),t.appendChild(r),t.appendChild(i);const a=document.createElement("details");a.className="task-item";const c=document.createElement("summary");c.className="task-summary";const m=document.createElement("div");m.className="task-main";const u=document.createElement("div");u.className="task-title";const f=document.createElement("div");f.className="task-name",f.textContent=e.name;const y=document.createElement("div");y.className="task-meta",y.textContent=e.metaSummary||"",u.appendChild(f),u.appendChild(y);const d=document.createElement("div");d.className="task-id",d.textContent="ID: -",m.appendChild(u),m.appendChild(d);const g=document.createElement("div");g.className="task-right";const v=document.createElement("span");v.className="badge badge-pending",v.textContent="等待";const B=document.createElement("div");B.className="task-progress";const z=document.createElement("div");z.className="task-progress-bar";const N=document.createElement("div");N.className="task-progress-fill",N.style.width="0%",z.appendChild(N);const D=document.createElement("div");D.className="task-progress-text",D.textContent="0%",B.appendChild(z),B.appendChild(D);const A=document.createElement("div");A.className="task-time",A.textContent="—";const H=document.createElement("div");H.className="task-actions";const T=document.createElement("button");T.type="button",T.className="btn btn-secondary btn-sm",T.setAttribute("data-action","save"),T.textContent="保存到存储库";const L=document.createElement("button");L.type="button",L.className="btn btn-secondary btn-sm",L.setAttribute("data-action","retry"),L.textContent="重试";const w=document.createElement("button");w.type="button",w.className="btn btn-secondary btn-sm",w.setAttribute("data-action","cancel"),w.textContent="取消",H.appendChild(T),H.appendChild(L),H.appendChild(w),g.appendChild(v),g.appendChild(B),g.appendChild(A),g.appendChild(H),c.appendChild(m),c.appendChild(g);const j=document.createElement("div");j.className="task-details";const ge=document.createElement("div");ge.className="task-info";const x=document.createElement("div");x.className="task-info-grid";const fe=document.createElement("div");fe.className="task-info-line";const he=document.createElement("div");he.className="task-info-line";const ye=document.createElement("div");ye.className="task-info-line";const ve=document.createElement("div");ve.className="task-info-line";const Ie=document.createElement("div");Ie.className="task-info-line";const Ee=document.createElement("div");Ee.className="task-info-line";const ne=document.createElement("div");ne.className="task-info-line",ne.textContent="存储库: —";const be=document.createElement("div");be.className="task-error hidden";const Se=document.createElement("div");return Se.className="task-error hidden",x.appendChild(fe),x.appendChild(he),x.appendChild(ye),x.appendChild(ve),x.appendChild(Ie),x.appendChild(Ee),x.appendChild(ne),x.appendChild(be),x.appendChild(Se),ge.appendChild(x),j.appendChild(ge),a.appendChild(c),a.appendChild(j),n.appendChild(t),n.appendChild(a),e.dom={root:n,badge:v,fill:N,progressText:D,idEl:d,timeEl:A,metaEl:y,nameEl:f,saveBtn:T,retryBtn:L,cancelBtn:w,platformEl:fe,actionEl:he,submitEl:ye,startEl:ve,finishEl:Ie,costEl:Ee,repoStatusEl:ne,repoErrorEl:be,errorEl:Se,miniPreview:t,miniVideo:r,miniDlBtn:s},a.addEventListener("toggle",()=>{P(e)}),n}function P(e){if(!e.dom)return;const n=e.status==="processing"?"processing":e.status==="completed"?"completed":e.status==="failed"?"failed":e.status==="cancelled"?"cancelled":"pending";e.dom.badge.className=`badge badge-${n}`,e.dom.badge.textContent=X(e.status),e.dom.progressText.textContent=`${e.progress}%`,e.dom.fill.style.width=`${e.progress}%`,e.dom.idEl.textContent=`ID: ${e.taskId||"-"}`,We(e),e.dom.platformEl.textContent=`平台: ${e.platform||"—"}`,e.dom.actionEl.textContent=`动作: ${e.action||"—"}`,e.dom.submitEl.textContent=`提交: ${Z(e.submitTimeMs)}`,e.dom.startEl.textContent=`开始: ${Z(e.startTimeMs)}`,e.dom.finishEl.textContent=`完成: ${Z(e.finishTimeMs)}`,e.dom.costEl.textContent=e.cost!=null?`花费: ${e.cost}`:"花费: —";const t=e.repoSave||{status:"idle",errorMessage:""};let r="—";e.status==="completed"&&(e.videoUrl?t.status==="saved"?r="已保存":t.status==="saving"?r="保存中...":t.status==="failed"?r="保存失败":r="待保存":r="缺少视频链接"),e.dom.repoStatusEl.textContent=`存储库: ${r}`,t.status==="failed"&&String(t.errorMessage||"").trim()?(e.dom.repoErrorEl.classList.remove("hidden"),e.dom.repoErrorEl.textContent=`保存失败: ${String(t.errorMessage).trim()}`):(e.dom.repoErrorEl.classList.add("hidden"),e.dom.repoErrorEl.textContent="");const i=String(e.failReason||"").trim();i?(e.dom.errorEl.classList.remove("hidden"),e.dom.errorEl.textContent=`错误: ${i}`):(e.dom.errorEl.classList.add("hidden"),e.dom.errorEl.textContent="");const l=!C(e.status)&&!e.controller.signal.aborted;e.dom.cancelBtn.disabled=!l;const s=C(e.status)&&e.status!=="completed";e.dom.retryBtn.style.display=s?"":"none";const a=e.status==="completed"&&!!e.videoUrl;if(e.dom.saveBtn.style.display=a?"":"none",a?t.status==="saved"?(e.dom.saveBtn.textContent="已保存",e.dom.saveBtn.disabled=!0):t.status==="saving"?(e.dom.saveBtn.textContent="保存中...",e.dom.saveBtn.disabled=!0):t.status==="failed"?(e.dom.saveBtn.textContent="重试保存",e.dom.saveBtn.disabled=!1):(e.dom.saveBtn.textContent="保存到存储库",e.dom.saveBtn.disabled=!1):e.dom.saveBtn.disabled=!0,e.videoUrl){if(e.dom.miniPreview.classList.remove("hidden"),e.dom.miniVideo.getAttribute("src")!==e.videoUrl){e.dom.miniVideo.src=e.videoUrl,e.dom.miniDlBtn.href=e.videoUrl;try{const u=new URL(e.videoUrl).pathname.split("/").pop();e.dom.miniDlBtn.download=u||`video_${e.taskId}.mp4`}catch{e.dom.miniDlBtn.download=`video_${e.taskId}.mp4`}}}else e.dom.miniPreview.classList.add("hidden"),e.dom.miniVideo.getAttribute("src")&&(e.dom.miniVideo.removeAttribute("src"),e.dom.miniVideo.load())}function We(e){var l;if(!((l=e==null?void 0:e.dom)!=null&&l.timeEl))return;const n=Date.now(),t=e.startTimeMs||e.submitTimeMs||e.createdAt||n,i=(e.finishTimeMs||(C(e.status)?e.updatedAt:null)||n)-t;e.dom.timeEl.textContent=`耗时 ${qe(i)}`}function Ge(){const e=p.order.length;let n=0,t=0,r=0,i=0;for(const l of p.order){const s=p.byLocalId.get(l);s&&(s.status==="processing"?n+=1:s.status==="completed"?t+=1:s.status==="failed"?r+=1:s.status==="cancelled"&&(i+=1))}o.taskSummary.textContent=`${e} 个任务 · 处理中 ${n} · 成功 ${t} · 失败 ${r} · 取消 ${i}`}function q(){Ge();const e=p.order.length;o.statusContainer&&o.statusContainer.classList.toggle("hidden",e>0);const n=p.order.slice(0,p.renderLimit);o.taskList.innerHTML="";for(const t of n){const r=p.byLocalId.get(t);r&&(r.dom||Oe(r),P(r),o.taskList.appendChild(r.dom.root))}o.taskListFooter&&o.taskListFooter.classList.toggle("hidden",e<=p.renderLimit)}function S(e,n,t="info"){const r=typeof e=="string"?p.byLocalId.get(e):e;if(!r)return;const i={time:new Date().toLocaleTimeString(),type:t,message:String(n||"")};Array.isArray(r.logs)||(r.logs=[]),r.logs.push(i),r.logs.length>I.maxLogsPerTask*3&&r.logs.splice(0,r.logs.length-I.maxLogsPerTask*2),P(r)}function U(e,n,t={}){const r=String(n||"").trim();if(!r)return;const i=e.status;if(e.status=r,e.updatedAt=Date.now(),Object.assign(e,t),i!==r&&S(e,`状态更新: ${X(i)} -> ${X(r)}`,"info"),P(e),Ge(),r==="completed"&&i!=="completed"&&setTimeout(()=>{typeof V=="function"&&V()},1500),p.order.length>0){const l=p.order[0],s=p.byLocalId.get(l);s&&s.localId===e.localId&&typeof Te=="function"&&Te(e)}}function ut(){if(p.order.length<=I.maxTasks)return;const e=p.order.slice().reverse().filter(n=>{const t=p.byLocalId.get(n);return t&&C(t.status)});for(;p.order.length>I.maxTasks&&e.length>0;)ee(e.shift());for(;p.order.length>I.maxTasks;)ee(p.order[p.order.length-1])}function ee(e){var r;const n=String(e||""),t=p.byLocalId.get(n);if(t){if(t.cleanupTimer&&clearTimeout(t.cleanupTimer),t.pollTimer&&clearTimeout(t.pollTimer),!t.controller.signal.aborted&&!C(t.status))try{t.controller.abort()}catch{}if(typeof t.videoUrl=="string"&&t.videoUrl.startsWith("blob:"))try{URL.revokeObjectURL(t.videoUrl)}catch{}p.byLocalId.delete(n),p.order=p.order.filter(i=>i!==n),(r=t.dom)!=null&&r.root&&t.dom.root.parentElement&&t.dom.root.remove()}}function pt(){const e=p.order.slice();for(const n of e){const t=p.byLocalId.get(n);t&&C(t.status)&&ee(n)}}function R(e){e.cleanupTimer&&clearTimeout(e.cleanupTimer),e.cleanupTimer=setTimeout(()=>{ee(e.localId),q()},I.cleanupAfterMs)}function gt(e){const n=p.byLocalId.get(String(e||""));if(n&&!C(n.status)){S(n,"用户取消任务（停止轮询）","warning");try{n.controller.abort()}catch{}n.pollTimer&&clearTimeout(n.pollTimer),n.finishTimeMs=n.finishTimeMs||Date.now(),U(n,"cancelled"),R(n),h(`已取消：${n.name}`,"info")}}function ft(e){const n=p.byLocalId.get(String(e||""));if(!n||!n.request)return;const t=`${n.request.name||n.name}（重试）`;Qe({...n.request,name:t})}async function ht(e){if(!e.taskId)return;const n=`${e.baseUrl}${e.apiSpec.statusPath(e.taskId)}`,t=await fetch(n,{headers:ce(e.apiKey,!1),signal:e.controller.signal}),r=await W(t);if(!t.ok){const i=(r==null?void 0:r.detail)||(r==null?void 0:r.error)||(typeof r=="string"?r:null);throw new Error(i||`轮询失败（HTTP ${t.status}）`)}return r}function yt(e){var a,c,m,u,f,y,d,g;const n=String((e==null?void 0:e.videoUrl)||"").trim();if(!n)throw new Error("缺少视频链接");if(!Y(n))throw new Error("视频链接必须是 http/https URL");const t=((c=(a=e==null?void 0:e.request)==null?void 0:a.payload)==null?void 0:c.prompt)??((m=e==null?void 0:e.payload)==null?void 0:m.prompt)??((u=e==null?void 0:e.request)==null?void 0:u.prompt)??"",r=((y=(f=e==null?void 0:e.request)==null?void 0:f.payload)==null?void 0:y.model)??((d=e==null?void 0:e.payload)==null?void 0:d.model)??((g=e==null?void 0:e.request)==null?void 0:g.model)??(e==null?void 0:e.platform)??(e==null?void 0:e.modelKey)??"unknown",i=String(t||"").trim()||"No prompt",l=String(r||"").trim()||"unknown",s={provider_task_id:(e==null?void 0:e.taskId)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,cost:(e==null?void 0:e.cost)??null};return{title:(e==null?void 0:e.name)||(e!=null&&e.taskId?`Task ${e.taskId}`:"未命名任务"),model:l,prompt:i,video_url:n,status:"completed",metadata:s}}async function te(e,{manual:n=!1}={}){const t=e;if(!t)return;const r=t.repoSave||{status:"idle",savedVideoId:null};if(r.status==="saving"){n&&h("正在保存...","info",{durationMs:1800});return}if(r.status==="saved"){n&&h("已保存到存储库","success",{durationMs:1800});return}if(t.status!=="completed"){n&&h("仅支持保存已完成的任务","warning");return}let i;try{i=yt(t)}catch(s){const a=String((s==null?void 0:s.message)||s||"保存数据无效");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:null},P(t),b(`保存失败: ${a}`,"error");return}t.repoSave={status:"saving",errorMessage:"",savedVideoId:r.savedVideoId||null,payload:i},P(t),S(t,"开始保存到存储库","info");const l=async()=>{try{const s=await Et();if(!s){window.location.href="/login?next=/video";return}const a={user_id:s,title:i.title,model:i.model,prompt:i.prompt,status:i.status,video_url:i.video_url,metadata:i.metadata,request:{modelKey:t.modelKey||null,baseUrl:t.baseUrl||null,payload:t.payload||null},response:{task_id:t.taskId||null,status:t.status,progress:t.progress,video_url:t.videoUrl||null,platform:t.platform||null,action:t.action||null,cost:t.cost??null}},{data:c,error:m}=await oe.from("user_videos").insert(a).select("id").single();if(m)throw m;const u=(c==null?void 0:c.id)||null;t.repoSave={status:"saved",errorMessage:"",savedVideoId:u,payload:i},P(t),S(t,"已保存到存储库","success"),h(`已保存到存储库：${t.name||t.taskId||""}`.trim(),"success",{durationMs:2200})}catch(s){const a=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:i},P(t),S(t,`保存失败: ${a}`,"error"),h(`保存失败：${a}`,"error");return}};p.saveQueue.enqueue(l).catch(s=>{const a=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:i},P(t),S(t,`保存失败: ${a}`,"error"),b(`保存失败: ${a}`,"error")})}function vt(e){if(!e.taskId||e.controller.signal.aborted)return;e.pollTimer&&clearTimeout(e.pollTimer);const n=async()=>{var t;if(!e.controller.signal.aborted&&!C(e.status))try{const r=await p.pollQueue.enqueue(()=>ht(e),{signal:e.controller.signal});e.pollErrorCount=0;const i=pe(r);let l=i.status;i.videoUrl&&i.progress>=100&&!["failed","cancelled"].includes(l)&&(l="completed");const s=e.status;if(i.taskId&&(e.taskId=String(i.taskId)),e.platform=i.platform||e.platform,e.action=i.action||e.action,e.progress=i.progress,e.failReason=i.failReason||e.failReason,e.submitTimeMs=i.submitTimeMs||e.submitTimeMs,e.startTimeMs=i.startTimeMs||e.startTimeMs,e.finishTimeMs=i.finishTimeMs||e.finishTimeMs,e.cost=i.cost!=null?i.cost:e.cost,e.videoUrl=i.videoUrl||e.videoUrl,e.updatedAt=Date.now(),U(e,l),s!==e.status&&C(e.status)){const a=e.status==="completed"?"任务成功":e.status==="failed"?"任务失败":"任务已取消";S(e,a,e.status==="completed"?"success":e.status==="failed"?"error":"warning"),e.status==="completed"&&e.videoUrl&&Y(e.videoUrl)&&te(e)}if(e.status==="completed"&&e.videoUrl,e.status==="completed"&&!e.videoUrl&&((t=e.apiSpec)!=null&&t.contentPath)){S(e,"视频生成完成，正在获取视频内容…","info");try{const a=await p.pollQueue.enqueue(()=>Ke(e),{signal:e.controller.signal});U(e,"completed",{videoUrl:a}),e.videoUrl&&Y(e.videoUrl)&&te(e)}catch(a){S(e,`获取视频内容失败: ${(a==null?void 0:a.message)||a}`,"warning")}}if(C(e.status)){e.status==="completed"&&e.videoUrl?h(`完成：${e.name}`,"success"):e.status==="failed"&&h(`失败：${e.name}`,"error"),R(e);return}}catch(r){if((r==null?void 0:r.name)==="AbortError")return;if(e.pollErrorCount+=1,S(e,`轮询错误(${e.pollErrorCount}/${I.maxPollErrors}): ${r.message||r}`,"warning"),e.pollErrorCount>=I.maxPollErrors){e.failReason=e.failReason||String(r.message||r),U(e,"failed"),R(e),h(`轮询失败：${e.name}`,"error");return}}finally{const r=I.pollIntervalMs+Math.floor(Math.random()*I.pollJitterMs);e.pollTimer=setTimeout(n,r)}};e.pollTimer=setTimeout(n,1e3)}function Qe(e){const n=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,t={localId:n,name:e.name,modelKey:e.modelKey,metaSummary:e.metaSummary,baseUrl:e.baseUrl,apiKey:e.apiKey,apiSpec:e.apiSpec,payload:e.payload,inputReferenceFile:e.inputReferenceFile||null,request:e,status:"queued",progress:0,taskId:null,platform:null,action:null,failReason:"",videoUrl:null,createdAt:Date.now(),updatedAt:Date.now(),submitTimeMs:null,startTimeMs:null,finishTimeMs:null,cost:null,logs:[],pollTimer:null,pollErrorCount:0,cleanupTimer:null,controller:new AbortController,dom:null};p.byLocalId.set(n,t),p.order.unshift(n),ut(),Oe(t),S(t,"已加入队列","info"),q();const r=p.createQueue.enqueue(async()=>{var m,u,f,y,d;U(t,"pending");const i=((m=t.apiSpec)==null?void 0:m.createBodyType)||"json",l=ce(t.apiKey,i==="json");let s;if(i==="multipart"){const g=new FormData;g.append("prompt",String(((u=t.payload)==null?void 0:u.prompt)??"")),g.append("model",String(((f=t.payload)==null?void 0:f.model)??"")),g.append("seconds",String(((y=t.payload)==null?void 0:y.seconds)??"4")),g.append("size",String(((d=t.payload)==null?void 0:d.size)??"720x1280")),t.inputReferenceFile&&g.append("input_reference",t.inputReferenceFile,t.inputReferenceFile.name||"input_reference"),s=g}else s=JSON.stringify(t.payload);const a=await fetch(`${t.baseUrl}${t.apiSpec.createPath}`,{method:"POST",headers:l,body:s,signal:t.controller.signal}),c=await W(a);if(!a.ok){const g=(c==null?void 0:c.detail)||(c==null?void 0:c.error)||(typeof c=="string"?c:null);throw new Error(g||`请求失败（HTTP ${a.status}）`)}return c},{signal:t.controller.signal});return t.createPromise=r,r.then(async i=>{var a;const l=pe(i);let s=l.status;if(l.videoUrl&&l.progress>=100&&!["failed","cancelled"].includes(s)&&(s="completed"),t.taskId=l.taskId?String(l.taskId):t.taskId,t.platform=l.platform||t.platform,t.action=l.action||t.action,t.progress=l.progress,t.failReason=l.failReason||"",t.submitTimeMs=l.submitTimeMs||t.submitTimeMs,t.startTimeMs=l.startTimeMs||t.startTimeMs,t.finishTimeMs=l.finishTimeMs||t.finishTimeMs,t.cost=l.cost!=null?l.cost:t.cost,t.videoUrl=l.videoUrl||t.videoUrl,!t.taskId){t.failReason=t.failReason||"响应缺少 task_id",U(t,"failed"),R(t),h(`创建失败：${t.name}`,"error");return}if(U(t,s),S(t,`任务创建成功: ${t.taskId}`,"success"),h(`已提交：${t.name}`,"success",{durationMs:1800}),t.status==="completed"&&!t.videoUrl&&((a=t.apiSpec)!=null&&a.contentPath)){S(t,"视频生成完成，正在获取视频内容…","info");try{const c=await p.pollQueue.enqueue(()=>Ke(t),{signal:t.controller.signal});U(t,"completed",{videoUrl:c})}catch(c){S(t,`获取视频内容失败: ${(c==null?void 0:c.message)||c}`,"warning")}}if(t.status==="completed"&&t.videoUrl&&Y(t.videoUrl)&&te(t),C(t.status)){R(t);return}vt(t)}).catch(i=>{if((i==null?void 0:i.name)==="AbortError"){U(t,"cancelled"),R(t);return}t.failReason=String((i==null?void 0:i.message)||i),U(t,"failed"),S(t,`创建失败: ${t.failReason}`,"error"),R(t),h(`创建失败：${t.name}`,"error")}),t}function Je(){const e=Date.now();if(e-p.lastSubmitAt<I.submitDebounceMs)return;p.lastSubmitAt=e;const n=[["apiKey",o.apiKey],["baseUrl",o.baseUrl],["promptInput",o.promptInput],["modelSelect",o.modelSelect],["batchCount",o.batchCount],["taskNameInput",o.taskNameInput]];for(const[d,g]of n)if(!g){h(`页面缺少必要表单字段：${d}`,"error");return}const t=He(o.apiKey.value);if(!t){h("请先输入 API Key","error"),o.apiKey.focus();return}let r;try{r=O(o.baseUrl.value)}catch(d){h(d.message||"Base URL 无效","error"),o.baseUrl.focus();return}const i=o.promptInput.value.trim();if(!i){h("请输入提示词","error"),o.promptInput.focus();return}const l=o.modelSelect.value;let s;try{s=lt(l)}catch(d){h(d.message||"模型不支持","error");return}if(l==="sora2"&&E.readingCount>0){h("图片读取中，请稍候…","warning");return}if(l==="sora2"){const d=o.soraImageSourceInput?String(o.soraImageSourceInput.value||"").trim():"";d&&de(d)>0&&(o.soraImageSourceInput&&(o.soraImageSourceInput.value=""),$())}let a;try{a=je(l,i)}catch(d){h(d.message||"参数有误","error");return}const c=Fe(o.batchCount.value,1,I.maxBatchCount,1);if(c>=I.confirmBatchThreshold&&!confirm(`将提交 ${c} 个任务，确认继续？`))return;const u=String(o.taskNameInput.value||"").trim()||i.slice(0,18)||"任务",f=Array.from({length:c},(d,g)=>{const v=c>1?` #${g+1}`:"";return{name:`${u}${v}`,modelKey:l,metaSummary:a.metaSummary,baseUrl:r,apiKey:t,apiSpec:s,payload:a.payload,inputReferenceFile:l==="sora2"&&a.inputReference||null}});h(`已加入队列：${c} 个任务`,"success");const y=f.map(d=>{const g=Qe({...d,request:null});return g.request={name:d.name,modelKey:d.modelKey,metaSummary:d.metaSummary,baseUrl:d.baseUrl,apiKey:d.apiKey,apiSpec:d.apiSpec,payload:d.payload},g});Promise.allSettled(y.map(d=>d.createPromise)).then(d=>{const g=d.filter(B=>B.status==="fulfilled").length,v=d.length-g;d.length>1&&h(`创建结果：成功 ${g}，失败 ${v}`,v?"warning":"success",{durationMs:3600})}).catch(()=>{})}setInterval(()=>{const e=p.order.slice(0,p.renderLimit);for(const n of e){const t=p.byLocalId.get(n);t&&We(t)}},1e3)})();
