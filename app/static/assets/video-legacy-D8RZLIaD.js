import{s as te,y as It}from"./supabase-D9QiUJ8o.js";document.addEventListener("DOMContentLoaded",()=>{var je,Ge,Qe,Je,Xe;const n={apiKey:document.getElementById("apiKey"),baseUrl:document.getElementById("baseUrl"),toggleApiKey:document.getElementById("toggleApiKey"),modelSelect:document.getElementById("modelSelect"),promptInput:document.getElementById("promptInput"),taskNameInput:document.getElementById("taskNameInput"),batchCount:document.getElementById("batchCount"),sora2Params:document.getElementById("sora2Params"),soraVariant:document.getElementById("soraVariant"),aspectRatio:document.getElementById("aspectRatio"),duration:document.getElementById("duration"),soraHd:document.getElementById("soraHd"),soraWatermark:document.getElementById("soraWatermark"),soraPrivate:document.getElementById("soraPrivate"),soraImages:document.getElementById("soraImages"),soraDropzone:document.getElementById("soraDropzone"),soraPickFiles:document.getElementById("soraPickFiles"),soraClearImages:document.getElementById("soraClearImages"),soraImageCount:document.getElementById("soraImageCount"),soraImagePreview:document.getElementById("soraImagePreview"),soraImageSourceInput:document.getElementById("soraImageSourceInput"),soraAddImageSources:document.getElementById("soraAddImageSources"),soraUploadFeedback:document.getElementById("soraUploadFeedback"),soraUploadText:document.getElementById("soraUploadText"),soraUploadProgress:document.getElementById("soraUploadProgress"),soraUploadMeta:document.getElementById("soraUploadMeta"),promptImages:document.getElementById("promptImages"),promptDropzone:document.getElementById("promptDropzone"),promptPickFiles:document.getElementById("promptPickFiles"),promptUploadFeedback:document.getElementById("promptUploadFeedback"),promptUploadText:document.getElementById("promptUploadText"),promptUploadProgress:document.getElementById("promptUploadProgress"),promptUploadMeta:document.getElementById("promptUploadMeta"),promptImagePreviewWrap:document.getElementById("promptImagePreviewWrap"),promptImageCount:document.getElementById("promptImageCount"),promptImagePreview:document.getElementById("promptImagePreview"),promptClearImages:document.getElementById("promptClearImages"),notifyHook:document.getElementById("notifyHook"),generateBtn:document.getElementById("generateBtn"),statusContainer:document.getElementById("statusContainer"),statusContent:document.getElementById("statusContent"),taskSummary:document.getElementById("taskSummary"),clearCompletedBtn:document.getElementById("clearCompletedBtn"),taskList:document.getElementById("taskList"),taskListFooter:document.getElementById("taskListFooter"),loadMoreTasksBtn:document.getElementById("loadMoreTasksBtn"),imageModal:document.getElementById("imageModal"),modalBackdrop:document.getElementById("modalBackdrop"),modalClose:document.getElementById("modalClose"),modalImage:document.getElementById("modalImage"),modalValue:document.getElementById("modalValue"),modalCopy:document.getElementById("modalCopy"),modalSave:document.getElementById("modalSave"),toastContainer:document.getElementById("toastContainer"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),saveConfigBtn:document.getElementById("saveConfigBtn"),resetConfigBtn:document.getElementById("resetConfigBtn"),charCount:document.getElementById("charCount"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultVideo:document.getElementById("resultVideo"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText")},I={submitDebounceMs:120,confirmBatchThreshold:6,maxBatchCount:20,renderPageSize:20,maxTasks:200,cleanupAfterMs:600*1e3,pollIntervalMs:4e3,pollJitterMs:600,maxPollErrors:3,createConcurrency:4,pollConcurrency:8,saveConcurrency:2,maxLogsPerTask:200,imageCompressThresholdBytes:5*1024*1024,imageMaxDimension:2048},E={items:[],editingId:null,readingCount:0},p={byLocalId:new Map,order:[],renderLimit:I.renderPageSize,nextIndex:1,lastSubmitAt:0,createQueue:Y(I.createConcurrency),pollQueue:Y(I.pollConcurrency),saveQueue:Y(I.saveConcurrency)};n.apiKey.value=localStorage.getItem("video_api_key")||"";const be=n.baseUrl.value||"https://api.gpt-best.com",Ye=localStorage.getItem("video_base_url")||be;try{n.baseUrl.value=k(Ye)}catch{n.baseUrl.value=be,localStorage.removeItem("video_base_url")}const oe=localStorage.getItem("video_model");oe&&Array.from(n.modelSelect.options).some(e=>e.value===oe)&&(n.modelSelect.value=oe);const ne=localStorage.getItem("video_sora_variant");ne&&Array.from(n.soraVariant.options).some(e=>e.value===ne)&&(n.soraVariant.value=ne);const re=localStorage.getItem("video_aspect_ratio");re&&Array.from(n.aspectRatio.options).some(e=>e.value===re)&&(n.aspectRatio.value=re);const se=localStorage.getItem("video_duration");se&&Array.from(n.duration.options).some(e=>e.value===se)&&(n.duration.value=se);const Ce=localStorage.getItem("video_batch_count");if(Ce){const e=Number.parseInt(Ce,10);Number.isFinite(e)&&e>=1&&e<=I.maxBatchCount&&(n.batchCount.value=String(e))}Ze();function Ze(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-target")||"",t=o?document.getElementById(o):null;t&&(t.type=t.type==="password"?"text":"password")})})}if(n.apiKey.addEventListener("change",()=>localStorage.setItem("video_api_key",n.apiKey.value)),n.baseUrl.addEventListener("change",()=>{try{const e=k(n.baseUrl.value);n.baseUrl.value=e,localStorage.setItem("video_base_url",e)}catch(e){b(`错误: ${e.message}`,"error"),localStorage.removeItem("video_base_url"),n.baseUrl.focus()}}),n.modelSelect.addEventListener("change",()=>{localStorage.setItem("video_model",n.modelSelect.value),$e()}),n.soraVariant.addEventListener("change",()=>{localStorage.setItem("video_sora_variant",n.soraVariant.value),W()}),n.aspectRatio.addEventListener("change",()=>{localStorage.setItem("video_aspect_ratio",n.aspectRatio.value)}),n.duration.addEventListener("change",()=>{localStorage.setItem("video_duration",n.duration.value),W()}),n.soraHd.addEventListener("change",W),n.batchCount.addEventListener("change",()=>{const e=Number.parseInt(String(n.batchCount.value||"1"),10);if(Number.isFinite(e)){const o=Math.min(I.maxBatchCount,Math.max(1,e));n.batchCount.value=String(o),localStorage.setItem("video_batch_count",String(o))}}),n.soraPickFiles&&n.soraImages&&(n.soraPickFiles.addEventListener("click",()=>n.soraImages.click()),n.soraImages.addEventListener("change",async()=>{const e=n.soraImages.files?Array.from(n.soraImages.files):[];await G(e,{source:"sora"}),n.soraImages.value=""})),n.promptPickFiles&&n.promptImages&&(n.promptPickFiles.addEventListener("click",()=>n.promptImages.click()),n.promptImages.addEventListener("change",async()=>{const e=n.promptImages.files?Array.from(n.promptImages.files):[];await G(e,{source:"prompt"}),n.promptImages.value=""})),n.soraClearImages&&n.soraClearImages.addEventListener("click",()=>{E.items=[],U(),b("已清空参考图片","info")}),n.promptClearImages&&n.promptClearImages.addEventListener("click",()=>{E.items=[],U(),b("已清空参考图片","info")}),n.soraAddImageSources&&n.soraImageSourceInput&&(n.soraAddImageSources.addEventListener("click",()=>{const e=n.soraImageSourceInput.value,o=ae(e);o>0&&(n.soraImageSourceInput.value="",U(),b(`已添加 ${o} 个图片来源`,"success"))}),n.soraImageSourceInput.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),n.soraAddImageSources.click())})),ot(),nt(),(je=n.generateBtn)==null||je.addEventListener("click",ke),(Ge=n.clearCompletedBtn)==null||Ge.addEventListener("click",()=>{ut(),q(),g("已清理已完成任务","info")}),(Qe=n.loadMoreTasksBtn)==null||Qe.addEventListener("click",()=>{p.renderLimit+=I.renderPageSize,q()}),n.historyBtn&&n.historyBtn.addEventListener("click",()=>{var e;(e=n.historyPanel)==null||e.classList.add("open"),document.body.classList.add("panel-open")}),n.closeHistoryBtn&&n.closeHistoryBtn.addEventListener("click",()=>{var e;(e=n.historyPanel)==null||e.classList.remove("open"),document.body.classList.remove("panel-open")}),(Je=n.historyPanel)==null||Je.addEventListener("click",e=>{e.target===n.historyPanel&&(n.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"))}),document.querySelectorAll(".collapsible-header").forEach(e=>{const o=e.dataset.target,t=document.getElementById(o);if(!t)return;const r=localStorage.getItem(`collapsed_${o}`);(r===null?o==="configContent":r==="true")&&(e.classList.add("collapsed"),t.classList.add("collapsed")),e.addEventListener("click",()=>{const s=e.classList.toggle("collapsed");t.classList.toggle("collapsed",s),localStorage.setItem(`collapsed_${o}`,String(s))})}),n.saveConfigBtn&&n.saveConfigBtn.addEventListener("click",()=>{localStorage.setItem("video_api_key",n.apiKey.value);try{const e=k(n.baseUrl.value);localStorage.setItem("video_base_url",e),n.baseUrl.value=e}catch(e){b(`Base URL 错误: ${e.message}`,"error")}g("配置已保存","success")}),n.resetConfigBtn&&n.resetConfigBtn.addEventListener("click",()=>{confirm("确定要重置配置吗？这将清除保存的 API Key 和 Base URL。")&&(localStorage.removeItem("video_api_key"),localStorage.removeItem("video_base_url"),n.apiKey.value="",n.baseUrl.value="https://api.gpt-best.com",g("配置已重置","info"))}),n.promptInput&&n.charCount){const e=()=>{n.charCount.textContent=`${n.promptInput.value.length} 字符`};n.promptInput.addEventListener("input",e),e()}n.inlineHistoryToggle&&n.inlineHistoryContent&&(localStorage.getItem("inlineHistoryCollapsed")==="true"&&((Xe=n.inlineHistorySection)==null||Xe.classList.add("collapsed")),n.inlineHistoryToggle.addEventListener("click",()=>{var t;const o=(t=n.inlineHistorySection)==null?void 0:t.classList.toggle("collapsed");localStorage.setItem("inlineHistoryCollapsed",String(o))})),document.addEventListener("keydown",e=>{var o;if(e.key==="Escape"){(o=n.historyPanel)!=null&&o.classList.contains("open")&&(n.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"),e.preventDefault());const t=document.getElementById("editPromptModalOverlay");t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.preventDefault())}(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&document.activeElement===n.promptInput&&(e.preventDefault(),ke())});const P={items:[],displayLimit:6,loading:!1};async function z(){if(!P.loading){P.loading=!0;try{const{data:e,error:o}=await te.from("user_videos").select("id,title,model,prompt,video_url,created_at").order("created_at",{ascending:!1}).limit(50);if(o)throw o;P.items=Array.isArray(e)?e:[],we()}catch(e){b(`加载历史记录失败: ${e.message}`,"error")}finally{P.loading=!1}}}function we(){if(!n.inlineHistoryGrid||!n.inlineHistoryCount)return;const e=P.items;if(n.inlineHistoryCount.textContent=e.length,e.length===0){n.inlineHistoryGrid.innerHTML='<div class="inline-history-empty">暂无生成记录</div>',n.showMoreHistoryBtn&&(n.showMoreHistoryBtn.style.display="none");return}const o=e.slice(0,P.displayLimit);n.inlineHistoryGrid.innerHTML="",o.forEach(t=>{var v;const r=document.createElement("div");r.className="inline-history-item",r.dataset.id=t.id;const i=document.createElement("div");if(i.className="inline-history-thumb",t.video_url||t.thumbnail_url){const y=document.createElement("video");y.src=t.video_url||"",y.muted=!0,y.loop=!0,y.playsInline=!0,y.preload="metadata",i.appendChild(y),r.addEventListener("mouseenter",()=>y.play().catch(()=>{})),r.addEventListener("mouseleave",()=>{y.pause(),y.currentTime=0})}else i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';const a=document.createElement("div");a.className="inline-history-info";const s=document.createElement("div");s.className="inline-history-prompt",s.textContent=(t.prompt||"无提示词").slice(0,60)+(((v=t.prompt)==null?void 0:v.length)>60?"...":""),s.title=t.prompt||"";const l=document.createElement("div");l.className="inline-history-meta";const c=t.model||"unknown",m=t.created_at?new Date(t.created_at).toLocaleDateString():"";l.textContent=`${c} · ${m}`,a.appendChild(s),a.appendChild(l);const u=document.createElement("div");u.className="inline-history-actions";const f=document.createElement("button");f.className="inline-history-btn",f.title="加载",f.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',f.addEventListener("click",y=>{y.stopPropagation(),Se(t)});const h=document.createElement("button");h.className="inline-history-btn",h.title="编辑提示词",h.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',h.addEventListener("click",y=>{y.stopPropagation(),et(t)});const d=document.createElement("button");d.className="inline-history-btn danger",d.title="删除",d.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',d.addEventListener("click",y=>{y.stopPropagation(),tt(t.id)}),u.appendChild(f),u.appendChild(h),u.appendChild(d),r.appendChild(i),r.appendChild(a),r.appendChild(u),r.addEventListener("click",()=>Se(t)),n.inlineHistoryGrid.appendChild(r)}),n.showMoreHistoryBtn&&(n.showMoreHistoryBtn.style.display=e.length>P.displayLimit?"":"none")}function Se(e){var o,t;e.prompt&&(n.promptInput.value=e.prompt,n.charCount&&(n.charCount.textContent=`${e.prompt.length} 字符`)),e.video_url&&n.resultContainer&&n.resultVideo&&((o=n.resultPlaceholder)==null||o.classList.add("hidden"),(t=n.loadingState)==null||t.classList.add("hidden"),n.resultContainer.classList.remove("hidden"),n.resultVideo.src=e.video_url),g("已加载历史记录","success")}function et(e){const o=document.getElementById("editPromptModalOverlay"),t=document.getElementById("editPromptTextarea"),r=document.getElementById("saveEditPromptBtn"),i=document.getElementById("cancelEditPromptBtn");if(!o||!t)return;t.value=e.prompt||"",o.classList.remove("hidden"),t.focus();const a=async()=>{const m=t.value.trim();if(!m){g("提示词不能为空","error");return}try{const{error:u}=await te.from("user_videos").update({prompt:m,updated_at:new Date().toISOString()}).eq("id",e.id);if(u)throw u;o.classList.add("hidden"),g("提示词已更新","success"),z()}catch(u){g(`更新失败: ${u.message}`,"error")}},s=()=>{o.classList.add("hidden")},l=r.cloneNode(!0),c=i.cloneNode(!0);r.parentNode.replaceChild(l,r),i.parentNode.replaceChild(c,i),l.addEventListener("click",a),c.addEventListener("click",s)}async function tt(e){if(confirm("确定要删除这条记录吗？"))try{const{error:o}=await te.from("user_videos").delete().eq("id",e);if(o)throw o;g("已删除","success"),z()}catch(o){g(`删除失败: ${o.message}`,"error")}}n.showMoreHistoryBtn&&n.showMoreHistoryBtn.addEventListener("click",()=>{P.displayLimit+=6,we()});function K(e){if(!(!n.statusDot||!n.statusText))switch(n.statusDot.className="status-dot",e){case"ready":n.statusDot.classList.add("ready"),n.statusText.textContent="就绪";break;case"generating":n.statusDot.classList.add("generating"),n.statusText.textContent="生成中...";break;case"error":n.statusDot.classList.add("error"),n.statusText.textContent="错误";break;default:n.statusText.textContent=e}}function Be(e){if(!(!n.resultPlaceholder||!n.loadingState||!n.resultContainer)){if(!e){n.resultPlaceholder.classList.remove("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.add("hidden"),K("ready");return}if(e.status==="completed"&&e.videoUrl)n.resultPlaceholder.classList.add("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.remove("hidden"),n.resultVideo&&(n.resultVideo.src=e.videoUrl),K("ready");else if(["pending","processing","queued"].includes(e.status)){n.resultPlaceholder.classList.add("hidden"),n.loadingState.classList.remove("hidden"),n.resultContainer.classList.add("hidden");const o=typeof e.progress=="number"?e.progress:0,t=Math.min(100,Math.max(0,o)),r=t>0?t:e.status==="queued"?1:2;n.progressFill&&(n.progressFill.style.width=`${r}%`),n.progressText&&(n.progressText.textContent=`${r}%`),K("generating")}else e.status==="failed"&&(n.resultPlaceholder.classList.remove("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.add("hidden"),K("error"))}}z(),K("ready");const Le=document.getElementById("downloadBtn"),Te=document.getElementById("shareBtn"),Me=document.getElementById("fullscreenBtn"),xe=document.getElementById("showPromptHistory"),Ue=document.getElementById("closeEditPromptModal");Le&&Le.addEventListener("click",()=>{var t;const e=(t=n.resultVideo)==null?void 0:t.src;if(!e){g("没有可下载的视频","warning");return}const o=document.createElement("a");o.href=e,o.download=`video_${Date.now()}.mp4`,o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o),g("开始下载视频","success")}),Te&&Te.addEventListener("click",async()=>{var o;const e=(o=n.resultVideo)==null?void 0:o.src;if(!e){g("没有可分享的视频","warning");return}if(navigator.share)try{await navigator.share({title:"Generated Video",url:e})}catch(t){t.name!=="AbortError"&&(Q(e),g("链接已复制到剪贴板","success"))}else Q(e),g("链接已复制到剪贴板","success")}),Me&&Me.addEventListener("click",()=>{const e=n.resultVideo;e&&(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}),xe&&xe.addEventListener("click",()=>{n.inlineHistorySection&&(n.inlineHistorySection.classList.remove("collapsed"),n.inlineHistorySection.scrollIntoView({behavior:"smooth",block:"start"}))}),Ue&&Ue.addEventListener("click",()=>{const e=document.getElementById("editPromptModalOverlay");e&&e.classList.add("hidden")}),n.taskList.addEventListener("click",e=>{const o=e.target instanceof Element?e.target:null;if(!o)return;const t=o.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const r=t.getAttribute("data-action")||"",i=t.closest("[data-local-id]"),a=i==null?void 0:i.getAttribute("data-local-id");if(a){if(r==="cancel"){pt(a);return}if(r==="retry"){gt(a);return}if(r==="copy-url"){const s=p.byLocalId.get(a),l=(s==null?void 0:s.videoUrl)||"";l&&(Q(l),g("已复制视频链接","success"));return}if(r==="save"){const s=p.byLocalId.get(a);s&&me(s,{manual:!0});return}}}),$e(),U(),q();const V={message:"",type:"",at:0};function b(e,o="info"){const t=String(e||""),r=String(o||"info");console[r==="error"?"error":r==="warning"?"warn":"log"](`[${r}] ${t}`);const a=r==="error"?"error":r==="warning"?"warning":r==="success"?"success":"info",s=Date.now();t&&(V.message!==t||V.type!==a||s-V.at>1200)&&(V.message=t,V.type=a,V.at=s,g(t,a))}function g(e,o="info",t={}){const r=Number.parseInt(String(t.durationMs??2800),10),i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`t-${Date.now()}-${Math.random().toString(16).slice(2)}`,a=document.createElement("div");a.className=`toast toast-${o}`,a.setAttribute("data-toast-id",i),a.textContent=String(e||""),n.toastContainer.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")});const s=()=>{a.classList.remove("show"),a.classList.add("hide"),setTimeout(()=>a.remove(),220)};setTimeout(s,Number.isFinite(r)?r:2800),a.addEventListener("click",s)}function $e(){const o=n.modelSelect.value==="sora2";n.sora2Params.classList.toggle("hidden",!o),o&&W()}function W(){if(n.modelSelect.value!=="sora2")return;const e=n.soraVariant.value,o=Number.parseInt(n.duration.value,10),t=e==="sora-2-pro",r=t,i=t&&o!==25;for(const a of Array.from(n.duration.options))a.value==="25"&&(a.disabled=!r);!r&&o===25&&(n.duration.value="15"),n.soraHd.disabled=!i,i||(n.soraHd.checked=!1)}function ot(){const e="drag-over";[{zone:n.soraDropzone,input:n.soraImages,source:"sora"},{zone:n.promptDropzone,input:n.promptImages,source:"prompt"}].filter(t=>t.zone&&t.input).forEach(({zone:t,input:r,source:i})=>{const a=s=>{const l=s.relatedTarget;l instanceof Node&&t.contains(l)||t.classList.remove(e)};t.addEventListener("dragenter",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragleave",s=>{s.preventDefault(),s.stopPropagation(),a(s)}),t.addEventListener("drop",async s=>{var c;s.preventDefault(),s.stopPropagation(),t.classList.remove(e);const l=(c=s.dataTransfer)!=null&&c.files?Array.from(s.dataTransfer.files):[];await G(l,{source:i})}),t.addEventListener("paste",async s=>{var m;const c=((m=s.clipboardData)!=null&&m.items?Array.from(s.clipboardData.items):[]).filter(u=>u.kind==="file").map(u=>u.getAsFile()).filter(Boolean);c.length&&(s.preventDefault(),await G(c,{source:i}))}),t.addEventListener("click",s=>{const l=s.target;l instanceof HTMLElement&&l.closest("button")||r.click()})})}function nt(){const e=()=>le();n.modalBackdrop.addEventListener("click",e),n.modalClose.addEventListener("click",e),document.addEventListener("keydown",o=>{o.key==="Escape"&&!n.imageModal.classList.contains("hidden")&&e()}),n.modalCopy.addEventListener("click",async()=>{const o=String(n.modalValue.value||"");try{await navigator.clipboard.writeText(o),b("已复制到剪贴板","success")}catch{const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),b("已复制到剪贴板","success")}}),n.modalSave.addEventListener("click",()=>{const o=E.editingId;if(!o)return;const t=String(n.modalValue.value||"").trim();if(!t){b("错误: 图片内容不能为空","error");return}if(!ie(t)){b("错误: 仅支持 http/https URL 或 data:image/...base64","error");return}const r=E.items.find(i=>i.id===o);r&&(r.value=t,r.kind=t.startsWith("data:image")?"data":"url",U(),le(),b("已更新图片内容","success"))})}function rt(e){return new Promise((o,t)=>{const r=new FileReader;r.onload=()=>o(String(r.result||"")),r.onerror=()=>t(r.error||new Error("读取文件失败")),r.readAsDataURL(e)})}function Pe(e){return String(e||"").split(/\r?\n/).map(o=>o.trim()).filter(Boolean)}function ie(e){const o=String(e||"").trim();if(!o)return!1;if(o.startsWith("data:image"))return!0;try{const t=new URL(o);return["http:","https:"].includes(t.protocol)}catch{return!1}}function st(e){if(!e)return null;const o=e.trim();if(!o)return null;let t;try{t=new URL(o)}catch{throw new Error("notify_hook 必须是合法的 URL")}if(!["http:","https:"].includes(t.protocol))throw new Error("notify_hook 必须是 http/https URL");return t.toString()}function k(e){const o=String(e||"").trim();if(!o)throw new Error("请输入 Base URL");let t;try{t=new URL(o)}catch{throw new Error("Base URL 不是合法的 URL")}if(t.protocol!=="https:")throw new Error("Base URL 必须使用 HTTPS 协议");if(!t.hostname)throw new Error("Base URL 缺少 host，例如 https://api.example.com");const r=t.origin;return(t.pathname!=="/"||t.search||t.hash)&&b(`提示: Base URL 包含路径/参数，已自动使用 origin: ${r}`,"warning"),r}function it(e){const o=t=>encodeURIComponent(String(t||""));switch(e){case"sora2":return{createPath:"/v2/videos/generations",statusPath:t=>`/v2/videos/generations/${o(t)}`};case"veo":return{createPath:"/v1/video/veo/text-to-video",statusPath:t=>`/v1/video/veo/tasks/${o(t)}`};case"seedance":return{createPath:"/v1/video/seedance/text-to-video",statusPath:t=>`/v1/video/seedance/tasks/${o(t)}`};case"newmodel":return{createPath:"/v1/video/newmodel/text-to-video",statusPath:t=>`/v1/video/newmodel/tasks/${o(t)}`};default:throw new Error(`不支持的模型: ${e}`)}}function Ne(e,o=!1){const r={Authorization:`Bearer ${_e(e)}`};return o&&(r["Content-Type"]="application/json"),r}function _e(e){return String(e||"").trim().replace(/^bearer\\s+/i,"").trim()}async function De(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const t=await e.text();try{return JSON.parse(t)}catch{return t}}function j(e){const o=Number(e||0);if(!Number.isFinite(o)||o<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,i=o;for(;i>=1024&&r<t.length-1;)i/=1024,r+=1;const a=r===0?0:r===1?1:2;return`${i.toFixed(a)} ${t[r]}`}function He(e){const o=e==="prompt"?"prompt":"sora";return{zone:o==="prompt"?n.promptDropzone:n.soraDropzone,pickBtn:o==="prompt"?n.promptPickFiles:n.soraPickFiles,clearBtn:o==="prompt"?null:n.soraClearImages,textEl:o==="prompt"?n.promptUploadText:n.soraUploadText,progressEl:o==="prompt"?n.promptUploadProgress:n.soraUploadProgress,metaEl:o==="prompt"?n.promptUploadMeta:n.soraUploadMeta}}function x(e,{isProcessing:o,state:t,text:r,progress:i,meta:a}={}){const s=He(e);if(s.zone&&(typeof o=="boolean"&&s.zone.classList.toggle("is-processing",o),t==="success"||t==="error"?(s.zone.classList.toggle("is-success",t==="success"),s.zone.classList.toggle("is-error",t==="error")):t==="clear"&&(s.zone.classList.remove("is-success"),s.zone.classList.remove("is-error")),s.textEl&&typeof r=="string"&&(s.textEl.textContent=r),s.metaEl&&typeof a=="string"&&(s.metaEl.textContent=a),s.progressEl&&typeof i=="number")){const l=Math.min(100,Math.max(0,i));s.progressEl.style.width=`${l}%`}}function Ae(e,o){const t=He(e);t.zone&&(t.zone.classList.toggle("is-loading",o),t.pickBtn&&(t.pickBtn.disabled=o),t.clearBtn&&(t.clearBtn.disabled=o||E.items.length===0),e!=="prompt"&&(n.soraAddImageSources.disabled=o))}async function at(e,o={}){const t=Number(o.thresholdBytes??I.imageCompressThresholdBytes),r=Number(o.maxDimension??I.imageMaxDimension);if(!e||!Number.isFinite(e.size)||e.size<=t)return{file:e,compressed:!1,originalBytes:(e==null?void 0:e.size)||0,outputBytes:(e==null?void 0:e.size)||0};const a=await(async()=>{if(globalThis.createImageBitmap)return await globalThis.createImageBitmap(e);const s=URL.createObjectURL(e);try{const l=new Image;return l.decoding="async",l.src=s,await new Promise((c,m)=>{l.onload=c,l.onerror=()=>m(new Error("图片解码失败"))}),l}finally{URL.revokeObjectURL(s)}})();try{const s=a.width||a.naturalWidth||0,l=a.height||a.naturalHeight||0;if(!s||!l)return{file:e,compressed:!1,originalBytes:e.size,outputBytes:e.size};const c=document.createElement("canvas"),m=c.getContext("2d",{alpha:!0});if(!m)throw new Error("Canvas 初始化失败");let u=1;const f=Math.max(s,l);Number.isFinite(r)&&r>0&&f>r&&(u=r/f);let h=Math.max(1,Math.round(s*u)),d=Math.max(1,Math.round(l*u));c.width=h,c.height=d;const v=(T,B)=>new Promise(C=>{c.toBlob(O=>C(O),T,B)}),y=()=>{m.clearRect(0,0,c.width,c.height),m.drawImage(a,0,0,c.width,c.height)};y();const S=e.size;let R=null,_=1/0,D=.84,F="image/jpeg";for(let T=0;T<4;T+=1){const B=await v(F,D);if(!B)break;const C=B.size||0;if(C>0&&C<_&&(R=B,_=C),C>0&&C<=t)break;D=Math.max(.58,D-.12),h=Math.max(1,Math.round(h*.92)),d=Math.max(1,Math.round(d*.92)),c.width=h,c.height=d,y()}if(!R||_>=S)return{file:e,compressed:!1,originalBytes:S,outputBytes:S};const H=new File([R],e.name.replace(/\.\w+$/,"")+".jpg",{type:F,lastModified:Date.now()});return{file:H,compressed:!0,originalBytes:S,outputBytes:H.size}}finally{typeof(a==null?void 0:a.close)=="function"&&a.close()}}async function G(e,o={}){const t=o.source==="prompt"?"prompt":"sora",r=(e||[]).filter(i=>{if(!i)return!1;if(String(i.type||"").startsWith("image/"))return!0;const s=String(i.name||"");return/\.(png|jpe?g|webp|gif|bmp|svg|ico|tiff?)$/i.test(s)});if(r.length===0){e&&e.length&&b("未检测到可用的图片文件","warning");return}E.readingCount+=r.length,Ae(t,!0),x(t,{isProcessing:!0,state:"clear",text:"处理中…",progress:0,meta:""});try{const i=r.length;let a=0;for(let s=0;s<i;s+=1){const l=r[s];x(t,{text:l.size>I.imageCompressThresholdBytes?"压缩中…":"读取中…",meta:`${s+1}/${i} · ${l.name} · ${j(l.size)}`,progress:Math.round(a/i*100)});let c=l;if(l.size>I.imageCompressThresholdBytes){const f=l.size,h=await at(l,{thresholdBytes:I.imageCompressThresholdBytes,maxDimension:I.imageMaxDimension});c=h.file,h.compressed?x(t,{text:"压缩完成，读取中…",meta:`${s+1}/${i} · ${l.name} · ${j(f)} → ${j(c.size)}`}):x(t,{text:"读取中…",meta:`${s+1}/${i} · ${l.name} · ${j(f)}`})}const m=await rt(c),u=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;E.items.push({id:u,kind:"data",value:m,name:(c==null?void 0:c.name)||(l==null?void 0:l.name)||"image",size:(c==null?void 0:c.size)||(l==null?void 0:l.size)||0}),a+=1,x(t,{progress:Math.round(a/i*100)})}U(),x(t,{state:"success",text:`已添加 ${r.length} 张图片`,meta:`${r.length} 张 · ${E.items.length} 张总计`,progress:100}),b(`已添加 ${r.length} 张图片（已转 Base64）`,"success"),setTimeout(()=>{x(t,{isProcessing:!1})},900),setTimeout(()=>{x(t,{state:"clear"})},1600)}catch(i){x(t,{state:"error",text:"添加失败",meta:String((i==null?void 0:i.message)||i||""),progress:0}),setTimeout(()=>x(t,{isProcessing:!1}),1400),b(`添加图片失败: ${i.message||i}`,"error")}finally{E.readingCount=Math.max(0,E.readingCount-r.length),Ae(t,E.readingCount>0),U()}}function ae(e){const o=Pe(e);let t=0;for(const r of o){if(!ie(r)){b(`跳过无效图片来源: ${r.slice(0,80)}${r.length>80?"…":""}`,"warning");continue}const i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;E.items.push({id:i,kind:r.startsWith("data:image")?"data":"url",value:r,name:r.startsWith("data:image")?"base64":"url",size:0}),t+=1}return t}function U(){const e=E.items.length,o=n.promptImageCount||n.soraImageCount,t=n.promptClearImages||n.soraClearImages,r=n.promptImagePreviewWrap||null,i=n.promptImagePreview||n.soraImagePreview;if(o&&(o.textContent=`${e} 张图片`),t&&(t.disabled=E.readingCount>0||e===0),r&&r.classList.toggle("hidden",e===0),!i||(i.innerHTML="",e===0))return;const s=`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">
                <rect width="200" height="150" rx="12" fill="#F5F5F7"/>
                <path d="M62 96l16-18 16 18 22-26 22 26" fill="none" stroke="#86868b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="78" cy="58" r="10" fill="#d1d1d6"/>
                <text x="100" y="128" font-family="system-ui, -apple-system" font-size="12" fill="#86868b" text-anchor="middle">Preview unavailable</text>
            </svg>`)}`;for(const l of E.items){const c=document.createElement("div");c.className="preview-item",c.dataset.id=l.id;const m=document.createElement("img");m.className="preview-img",m.loading="lazy",m.alt=l.name||"image",m.src=l.value,m.addEventListener("click",()=>Re(l.id)),m.onerror=()=>{m.src=s,m.classList.add("is-fallback")};const u=document.createElement("div");u.className="preview-actions";const f=document.createElement("button");f.type="button",f.className="preview-btn",f.textContent="编辑",f.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),Re(l.id)});const h=document.createElement("button");h.type="button",h.className="preview-btn danger",h.textContent="移除",h.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),E.items=E.items.filter(y=>y.id!==l.id),U(),b("已移除图片","info")}),u.appendChild(f),u.appendChild(h);const d=document.createElement("div");d.className="preview-caption",d.textContent=l.kind==="url"?"URL":"Base64",c.appendChild(m),c.appendChild(u),c.appendChild(d),i.appendChild(c)}}function Re(e){const o=E.items.find(t=>t.id===e);o&&(E.editingId=e,n.modalImage.src=o.value,n.modalValue.value=o.value,n.imageModal.classList.remove("hidden"),document.body.classList.add("modal-open"),n.modalValue.focus())}function le(){E.editingId=null,n.imageModal.classList.add("hidden"),document.body.classList.remove("modal-open"),n.modalImage.src="",n.modalValue.value=""}function Q(e){var r;const o=String(e||"");if(!o)return;if((r=navigator.clipboard)!=null&&r.writeText){navigator.clipboard.writeText(o).catch(()=>{});return}const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove()}function Fe(e,o,t,r){const i=Number.parseInt(String(e??""),10);return Number.isFinite(i)?Math.min(t,Math.max(o,i)):r}function ce(e){const o=Number(e);return!Number.isFinite(o)||o<=0?null:o<1e10?Math.round(o*1e3):Math.round(o)}function lt(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return Math.min(100,Math.max(0,Math.round(e)));const t=String(e).trim().match(/(\d+(?:\.\d+)?)/),r=t?Number.parseFloat(t[1]):0;return Number.isFinite(r)?Math.min(100,Math.max(0,Math.round(r))):0}function ct(e){const o=String(e||"").trim().toLowerCase();return o?["success","succeeded","ok","completed","done","finished","finish"].includes(o)?"completed":["fail","failed","error","timeout"].includes(o)?"failed":["cancelled","canceled","cancel"].includes(o)?"cancelled":["processing","running","executing","in_progress","in-progress","working"].includes(o)?"processing":(["queued","pending","waiting","created","init","initializing"].includes(o),"pending"):"pending"}function J(e){return{queued:"排队中",pending:"等待",processing:"处理中",completed:"成功",failed:"失败",cancelled:"已取消"}[e]||"等待"}function w(e){return["completed","failed","cancelled"].includes(String(e||""))}function dt(e){var r,i,a,s,l;const o=[e==null?void 0:e.video_url,e==null?void 0:e.videoUrl,e==null?void 0:e.url,(r=e==null?void 0:e.data)==null?void 0:r.video_url,(i=e==null?void 0:e.data)==null?void 0:i.videoUrl,(a=e==null?void 0:e.data)==null?void 0:a.url,(s=e==null?void 0:e.data)==null?void 0:s.output];for(const c of o)if(typeof c=="string"&&/^https?:\/\//i.test(c.trim()))return c.trim();const t=(l=e==null?void 0:e.data)==null?void 0:l.output;if(t&&typeof t=="object"){const c=[t.url,t.video_url,t.videoUrl];for(const m of c)if(typeof m=="string"&&/^https?:\/\//i.test(m.trim()))return m.trim()}return null}function de(e){return{taskId:(e==null?void 0:e.task_id)||(e==null?void 0:e.taskId)||(e==null?void 0:e.id)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,rawStatus:(e==null?void 0:e.status)||null,status:ct(e==null?void 0:e.status),progress:lt(e==null?void 0:e.progress),failReason:(e==null?void 0:e.fail_reason)||(e==null?void 0:e.failReason)||(e==null?void 0:e.error)||(e==null?void 0:e.detail)||"",submitTimeMs:ce(e==null?void 0:e.submit_time),startTimeMs:ce(e==null?void 0:e.start_time),finishTimeMs:ce(e==null?void 0:e.finish_time),cost:typeof(e==null?void 0:e.cost)=="number"?e.cost:null,videoUrl:dt(e)}}function X(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return"—"}}function Ve(e){const o=Math.max(0,Math.floor(e/1e3)),t=o%60,r=Math.floor(o/60)%60,i=Math.floor(o/3600),a=s=>String(s).padStart(2,"0");return i>0?`${i}:${a(r)}:${a(t)}`:`${a(r)}:${a(t)}`}function Y(e=4){let o=0;const t=[],r=()=>{for(;o<e&&t.length>0;){const s=t.shift();!s||s.aborted||(s.started=!0,o+=1,Promise.resolve().then(()=>s.fn()).then(s.resolve,s.reject).finally(()=>{var l;o-=1,(l=s.cleanup)==null||l.call(s),r()}))}};return{enqueue:(s,l={})=>{const c=l.signal;return new Promise((m,u)=>{const f={fn:s,resolve:m,reject:u,signal:c,started:!1,aborted:!1,cleanup:null};if(c!=null&&c.aborted){u(new DOMException("Aborted","AbortError"));return}const h=()=>{if(f.started)return;f.aborted=!0;const d=t.indexOf(f);d>=0&&t.splice(d,1),u(new DOMException("Aborted","AbortError")),r()};c&&(c.addEventListener("abort",h,{once:!0}),f.cleanup=()=>c.removeEventListener("abort",h)),t.push(f),r()})},stats:()=>({active:o,pending:t.length,concurrency:e})}}function ze(e,o){const t=String(o||"").trim();if(e==="sora2"){const r=n.soraVariant.value,i=n.aspectRatio.value,a=Number.parseInt(n.duration.value,10),s=!!n.soraWatermark.checked,l=!!n.soraPrivate.checked,c=!!n.soraHd.checked,m=r==="sora-2-pro";if(!m&&c)throw new Error("sora-2 不支持 HD，请切换到 sora-2-pro");if(!m&&a===25)throw new Error("sora-2 不支持 25 秒，请切换到 sora-2-pro");if(a===25&&c)throw new Error("duration=25 时 hd 不生效，请关闭 HD 或选择 10/15 秒");const u=st(n.notifyHook?n.notifyHook.value:""),f=E.items.map(v=>v.value).filter(Boolean),h={model:r,prompt:t,aspect_ratio:i,duration:a,hd:c,watermark:s,private:l,...u?{notify_hook:u}:{},...f.length?{images:f}:{}},d=`${r} · ${i} · ${a}s · images=${f.length}`;return{payload:h,metaSummary:d}}return{payload:{model:e,prompt:t},metaSummary:e}}function Ke(e){const o=document.createElement("div");o.className="task-wrapper",o.setAttribute("data-local-id",e.localId);const t=document.createElement("div");t.className="task-mini-preview hidden";const r=document.createElement("video");r.className="task-mini-video",r.muted=!0,r.loop=!0,r.playsInline=!0,r.controls=!0;const i=document.createElement("div");i.className="task-mini-preview-actions";const a=document.createElement("button");a.className="task-mini-btn",a.title="复制视频链接",a.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',a.onclick=yt=>{yt.preventDefault(),Q(e.videoUrl),g("链接已复制","success")};const s=document.createElement("a");s.className="task-mini-btn",s.title="下载视频",s.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',s.target="_blank",i.appendChild(a),i.appendChild(s),t.appendChild(r),t.appendChild(i);const l=document.createElement("details");l.className="task-item";const c=document.createElement("summary");c.className="task-summary";const m=document.createElement("div");m.className="task-main";const u=document.createElement("div");u.className="task-title";const f=document.createElement("div");f.className="task-name",f.textContent=e.name;const h=document.createElement("div");h.className="task-meta",h.textContent=e.metaSummary||"",u.appendChild(f),u.appendChild(h);const d=document.createElement("div");d.className="task-id",d.textContent="ID: -",m.appendChild(u),m.appendChild(d);const v=document.createElement("div");v.className="task-right";const y=document.createElement("span");y.className="badge badge-pending",y.textContent="等待";const S=document.createElement("div");S.className="task-progress";const R=document.createElement("div");R.className="task-progress-bar";const _=document.createElement("div");_.className="task-progress-fill",_.style.width="0%",R.appendChild(_);const D=document.createElement("div");D.className="task-progress-text",D.textContent="0%",S.appendChild(R),S.appendChild(D);const F=document.createElement("div");F.className="task-time",F.textContent="—";const H=document.createElement("div");H.className="task-actions";const T=document.createElement("button");T.type="button",T.className="btn btn-secondary btn-sm",T.setAttribute("data-action","save"),T.textContent="保存到存储库";const B=document.createElement("button");B.type="button",B.className="btn btn-secondary btn-sm",B.setAttribute("data-action","retry"),B.textContent="重试";const C=document.createElement("button");C.type="button",C.className="btn btn-secondary btn-sm",C.setAttribute("data-action","cancel"),C.textContent="取消",H.appendChild(T),H.appendChild(B),H.appendChild(C),v.appendChild(y),v.appendChild(S),v.appendChild(F),v.appendChild(H),c.appendChild(m),c.appendChild(v);const O=document.createElement("div");O.className="task-details";const ue=document.createElement("div");ue.className="task-info";const M=document.createElement("div");M.className="task-info-grid";const pe=document.createElement("div");pe.className="task-info-line";const ge=document.createElement("div");ge.className="task-info-line";const fe=document.createElement("div");fe.className="task-info-line";const he=document.createElement("div");he.className="task-info-line";const ve=document.createElement("div");ve.className="task-info-line";const ye=document.createElement("div");ye.className="task-info-line";const ee=document.createElement("div");ee.className="task-info-line",ee.textContent="存储库: —";const Ie=document.createElement("div");Ie.className="task-error hidden";const Ee=document.createElement("div");return Ee.className="task-error hidden",M.appendChild(pe),M.appendChild(ge),M.appendChild(fe),M.appendChild(he),M.appendChild(ve),M.appendChild(ye),M.appendChild(ee),M.appendChild(Ie),M.appendChild(Ee),ue.appendChild(M),O.appendChild(ue),l.appendChild(c),l.appendChild(O),o.appendChild(t),o.appendChild(l),e.dom={root:o,badge:y,fill:_,progressText:D,idEl:d,timeEl:F,metaEl:h,nameEl:f,saveBtn:T,retryBtn:B,cancelBtn:C,platformEl:pe,actionEl:ge,submitEl:fe,startEl:he,finishEl:ve,costEl:ye,repoStatusEl:ee,repoErrorEl:Ie,errorEl:Ee,miniPreview:t,miniVideo:r,miniDlBtn:s},l.addEventListener("toggle",()=>{$(e)}),o}function $(e){if(!e.dom)return;const o=e.status==="processing"?"processing":e.status==="completed"?"completed":e.status==="failed"?"failed":e.status==="cancelled"?"cancelled":"pending";e.dom.badge.className=`badge badge-${o}`,e.dom.badge.textContent=J(e.status),e.dom.progressText.textContent=`${e.progress}%`,e.dom.fill.style.width=`${e.progress}%`,e.dom.idEl.textContent=`ID: ${e.taskId||"-"}`,qe(e),e.dom.platformEl.textContent=`平台: ${e.platform||"—"}`,e.dom.actionEl.textContent=`动作: ${e.action||"—"}`,e.dom.submitEl.textContent=`提交: ${X(e.submitTimeMs)}`,e.dom.startEl.textContent=`开始: ${X(e.startTimeMs)}`,e.dom.finishEl.textContent=`完成: ${X(e.finishTimeMs)}`,e.dom.costEl.textContent=e.cost!=null?`花费: ${e.cost}`:"花费: —";const t=e.repoSave||{status:"idle",errorMessage:""};let r="—";e.status==="completed"&&(e.videoUrl?t.status==="saved"?r="已保存":t.status==="saving"?r="保存中...":t.status==="failed"?r="保存失败":r="待保存":r="缺少视频链接"),e.dom.repoStatusEl.textContent=`存储库: ${r}`,t.status==="failed"&&String(t.errorMessage||"").trim()?(e.dom.repoErrorEl.classList.remove("hidden"),e.dom.repoErrorEl.textContent=`保存失败: ${String(t.errorMessage).trim()}`):(e.dom.repoErrorEl.classList.add("hidden"),e.dom.repoErrorEl.textContent="");const i=String(e.failReason||"").trim();i?(e.dom.errorEl.classList.remove("hidden"),e.dom.errorEl.textContent=`错误: ${i}`):(e.dom.errorEl.classList.add("hidden"),e.dom.errorEl.textContent="");const a=!w(e.status)&&!e.controller.signal.aborted;e.dom.cancelBtn.disabled=!a;const s=w(e.status)&&e.status!=="completed";e.dom.retryBtn.style.display=s?"":"none";const l=e.status==="completed"&&!!e.videoUrl;if(e.dom.saveBtn.style.display=l?"":"none",l?t.status==="saved"?(e.dom.saveBtn.textContent="已保存",e.dom.saveBtn.disabled=!0):t.status==="saving"?(e.dom.saveBtn.textContent="保存中...",e.dom.saveBtn.disabled=!0):t.status==="failed"?(e.dom.saveBtn.textContent="重试保存",e.dom.saveBtn.disabled=!1):(e.dom.saveBtn.textContent="保存到存储库",e.dom.saveBtn.disabled=!1):e.dom.saveBtn.disabled=!0,e.videoUrl){if(e.dom.miniPreview.classList.remove("hidden"),e.dom.miniVideo.getAttribute("src")!==e.videoUrl){e.dom.miniVideo.src=e.videoUrl,e.dom.miniDlBtn.href=e.videoUrl;try{const u=new URL(e.videoUrl).pathname.split("/").pop();e.dom.miniDlBtn.download=u||`video_${e.taskId}.mp4`}catch{e.dom.miniDlBtn.download=`video_${e.taskId}.mp4`}}}else e.dom.miniPreview.classList.add("hidden"),e.dom.miniVideo.getAttribute("src")&&(e.dom.miniVideo.removeAttribute("src"),e.dom.miniVideo.load())}function qe(e){var a;if(!((a=e==null?void 0:e.dom)!=null&&a.timeEl))return;const o=Date.now(),t=e.startTimeMs||e.submitTimeMs||e.createdAt||o,i=(e.finishTimeMs||(w(e.status)?e.updatedAt:null)||o)-t;e.dom.timeEl.textContent=`耗时 ${Ve(i)}`}function Oe(){const e=p.order.length;let o=0,t=0,r=0,i=0;for(const a of p.order){const s=p.byLocalId.get(a);s&&(s.status==="processing"?o+=1:s.status==="completed"?t+=1:s.status==="failed"?r+=1:s.status==="cancelled"&&(i+=1))}n.taskSummary.textContent=`${e} 个任务 · 处理中 ${o} · 成功 ${t} · 失败 ${r} · 取消 ${i}`}function q(){Oe();const e=p.order.length;n.statusContainer&&n.statusContainer.classList.toggle("hidden",e>0);const o=p.order.slice(0,p.renderLimit);n.taskList.innerHTML="";for(const t of o){const r=p.byLocalId.get(t);r&&(r.dom||Ke(r),$(r),n.taskList.appendChild(r.dom.root))}n.taskListFooter&&n.taskListFooter.classList.toggle("hidden",e<=p.renderLimit)}function L(e,o,t="info"){const r=typeof e=="string"?p.byLocalId.get(e):e;if(!r)return;const i={time:new Date().toLocaleTimeString(),type:t,message:String(o||"")};Array.isArray(r.logs)||(r.logs=[]),r.logs.push(i),r.logs.length>I.maxLogsPerTask*3&&r.logs.splice(0,r.logs.length-I.maxLogsPerTask*2),$(r)}function N(e,o,t={}){const r=String(o||"").trim();if(!r)return;const i=e.status;if(e.status=r,e.updatedAt=Date.now(),Object.assign(e,t),i!==r&&L(e,`状态更新: ${J(i)} -> ${J(r)}`,"info"),$(e),Oe(),r==="completed"&&i!=="completed"&&setTimeout(()=>{typeof z=="function"&&z()},1500),p.order.length>0){const a=p.order[0],s=p.byLocalId.get(a);s&&s.localId===e.localId&&typeof Be=="function"&&Be(e)}}function mt(){if(p.order.length<=I.maxTasks)return;const e=p.order.slice().reverse().filter(o=>{const t=p.byLocalId.get(o);return t&&w(t.status)});for(;p.order.length>I.maxTasks&&e.length>0;)Z(e.shift());for(;p.order.length>I.maxTasks;)Z(p.order[p.order.length-1])}function Z(e){var r;const o=String(e||""),t=p.byLocalId.get(o);if(t){if(t.cleanupTimer&&clearTimeout(t.cleanupTimer),t.pollTimer&&clearTimeout(t.pollTimer),!t.controller.signal.aborted&&!w(t.status))try{t.controller.abort()}catch{}p.byLocalId.delete(o),p.order=p.order.filter(i=>i!==o),(r=t.dom)!=null&&r.root&&t.dom.root.parentElement&&t.dom.root.remove()}}function ut(){const e=p.order.slice();for(const o of e){const t=p.byLocalId.get(o);t&&w(t.status)&&Z(o)}}function A(e){e.cleanupTimer&&clearTimeout(e.cleanupTimer),e.cleanupTimer=setTimeout(()=>{Z(e.localId),q()},I.cleanupAfterMs)}function pt(e){const o=p.byLocalId.get(String(e||""));if(o&&!w(o.status)){L(o,"用户取消任务（停止轮询）","warning");try{o.controller.abort()}catch{}o.pollTimer&&clearTimeout(o.pollTimer),o.finishTimeMs=o.finishTimeMs||Date.now(),N(o,"cancelled"),A(o),g(`已取消：${o.name}`,"info")}}function gt(e){const o=p.byLocalId.get(String(e||""));if(!o||!o.request)return;const t=`${o.request.name||o.name}（重试）`;We({...o.request,name:t})}async function ft(e){if(!e.taskId)return;const o=`${e.baseUrl}${e.apiSpec.statusPath(e.taskId)}`,t=await fetch(o,{headers:Ne(e.apiKey,!1),signal:e.controller.signal}),r=await De(t);if(!t.ok){const i=(r==null?void 0:r.detail)||(r==null?void 0:r.error)||(typeof r=="string"?r:null);throw new Error(i||`轮询失败（HTTP ${t.status}）`)}return r}function ht(e){var l,c,m,u,f,h,d,v;const o=String((e==null?void 0:e.videoUrl)||"").trim();if(!o)throw new Error("缺少视频链接");const t=((c=(l=e==null?void 0:e.request)==null?void 0:l.payload)==null?void 0:c.prompt)??((m=e==null?void 0:e.payload)==null?void 0:m.prompt)??((u=e==null?void 0:e.request)==null?void 0:u.prompt)??"",r=((h=(f=e==null?void 0:e.request)==null?void 0:f.payload)==null?void 0:h.model)??((d=e==null?void 0:e.payload)==null?void 0:d.model)??((v=e==null?void 0:e.request)==null?void 0:v.model)??(e==null?void 0:e.platform)??(e==null?void 0:e.modelKey)??"unknown",i=String(t||"").trim()||"No prompt",a=String(r||"").trim()||"unknown",s={provider_task_id:(e==null?void 0:e.taskId)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,cost:(e==null?void 0:e.cost)??null};return{title:(e==null?void 0:e.name)||(e!=null&&e.taskId?`Task ${e.taskId}`:"未命名任务"),model:a,prompt:i,video_url:o,status:"completed",metadata:s}}async function me(e,{manual:o=!1}={}){const t=e;if(!t)return;const r=t.repoSave||{status:"idle",savedVideoId:null};if(r.status==="saving"){o&&g("正在保存...","info",{durationMs:1800});return}if(r.status==="saved"){o&&g("已保存到存储库","success",{durationMs:1800});return}if(t.status!=="completed"){o&&g("仅支持保存已完成的任务","warning");return}let i;try{i=ht(t)}catch(s){const l=String((s==null?void 0:s.message)||s||"保存数据无效");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:null},$(t),b(`保存失败: ${l}`,"error");return}t.repoSave={status:"saving",errorMessage:"",savedVideoId:r.savedVideoId||null,payload:i},$(t),L(t,"开始保存到存储库","info");const a=async()=>{try{const s=await It();if(!s){window.location.href="/login?next=/video";return}const l={user_id:s,title:i.title,model:i.model,prompt:i.prompt,status:i.status,video_url:i.video_url,metadata:i.metadata,request:{modelKey:t.modelKey||null,baseUrl:t.baseUrl||null,payload:t.payload||null},response:{task_id:t.taskId||null,status:t.status,progress:t.progress,video_url:t.videoUrl||null,platform:t.platform||null,action:t.action||null,cost:t.cost??null}},{data:c,error:m}=await te.from("user_videos").insert(l).select("id").single();if(m)throw m;const u=(c==null?void 0:c.id)||null;t.repoSave={status:"saved",errorMessage:"",savedVideoId:u,payload:i},$(t),L(t,"已保存到存储库","success"),g(`已保存到存储库：${t.name||t.taskId||""}`.trim(),"success",{durationMs:2200})}catch(s){const l=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:i},$(t),L(t,`保存失败: ${l}`,"error"),g(`保存失败：${l}`,"error");return}};p.saveQueue.enqueue(a).catch(s=>{const l=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:i},$(t),L(t,`保存失败: ${l}`,"error"),b(`保存失败: ${l}`,"error")})}function vt(e){if(!e.taskId||e.controller.signal.aborted)return;e.pollTimer&&clearTimeout(e.pollTimer);const o=async()=>{if(!e.controller.signal.aborted&&!w(e.status))try{const t=await p.pollQueue.enqueue(()=>ft(e),{signal:e.controller.signal});e.pollErrorCount=0;const r=de(t);let i=r.status;r.videoUrl&&r.progress>=100&&!["failed","cancelled"].includes(i)&&(i="completed");const a=e.status;if(r.taskId&&(e.taskId=String(r.taskId)),e.platform=r.platform||e.platform,e.action=r.action||e.action,e.progress=r.progress,e.failReason=r.failReason||e.failReason,e.submitTimeMs=r.submitTimeMs||e.submitTimeMs,e.startTimeMs=r.startTimeMs||e.startTimeMs,e.finishTimeMs=r.finishTimeMs||e.finishTimeMs,e.cost=r.cost!=null?r.cost:e.cost,e.videoUrl=r.videoUrl||e.videoUrl,e.updatedAt=Date.now(),N(e,i),a!==e.status&&w(e.status)){const s=e.status==="completed"?"任务成功":e.status==="failed"?"任务失败":"任务已取消";L(e,s,e.status==="completed"?"success":e.status==="failed"?"error":"warning"),e.status==="completed"&&e.videoUrl&&me(e)}if(e.status==="completed"&&e.videoUrl,w(e.status)){e.status==="completed"&&e.videoUrl?g(`完成：${e.name}`,"success"):e.status==="failed"&&g(`失败：${e.name}`,"error"),A(e);return}}catch(t){if((t==null?void 0:t.name)==="AbortError")return;if(e.pollErrorCount+=1,L(e,`轮询错误(${e.pollErrorCount}/${I.maxPollErrors}): ${t.message||t}`,"warning"),e.pollErrorCount>=I.maxPollErrors){e.failReason=e.failReason||String(t.message||t),N(e,"failed"),A(e),g(`轮询失败：${e.name}`,"error");return}}finally{const t=I.pollIntervalMs+Math.floor(Math.random()*I.pollJitterMs);e.pollTimer=setTimeout(o,t)}};e.pollTimer=setTimeout(o,1e3)}function We(e){const o=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,t={localId:o,name:e.name,modelKey:e.modelKey,metaSummary:e.metaSummary,baseUrl:e.baseUrl,apiKey:e.apiKey,apiSpec:e.apiSpec,payload:e.payload,request:e,status:"queued",progress:0,taskId:null,platform:null,action:null,failReason:"",videoUrl:null,createdAt:Date.now(),updatedAt:Date.now(),submitTimeMs:null,startTimeMs:null,finishTimeMs:null,cost:null,logs:[],pollTimer:null,pollErrorCount:0,cleanupTimer:null,controller:new AbortController,dom:null};p.byLocalId.set(o,t),p.order.unshift(o),mt(),Ke(t),L(t,"已加入队列","info"),q();const r=p.createQueue.enqueue(async()=>{N(t,"pending");const i=await fetch(`${t.baseUrl}${t.apiSpec.createPath}`,{method:"POST",headers:Ne(t.apiKey,!0),body:JSON.stringify(t.payload),signal:t.controller.signal}),a=await De(i);if(!i.ok){const s=(a==null?void 0:a.detail)||(a==null?void 0:a.error)||(typeof a=="string"?a:null);throw new Error(s||`请求失败（HTTP ${i.status}）`)}return a},{signal:t.controller.signal});return t.createPromise=r,r.then(i=>{const a=de(i);let s=a.status;if(a.videoUrl&&a.progress>=100&&!["failed","cancelled"].includes(s)&&(s="completed"),t.taskId=a.taskId?String(a.taskId):t.taskId,t.platform=a.platform||t.platform,t.action=a.action||t.action,t.progress=a.progress,t.failReason=a.failReason||"",t.submitTimeMs=a.submitTimeMs||t.submitTimeMs,t.startTimeMs=a.startTimeMs||t.startTimeMs,t.finishTimeMs=a.finishTimeMs||t.finishTimeMs,t.cost=a.cost!=null?a.cost:t.cost,t.videoUrl=a.videoUrl||t.videoUrl,!t.taskId){t.failReason=t.failReason||"响应缺少 task_id",N(t,"failed"),A(t),g(`创建失败：${t.name}`,"error");return}if(N(t,s),L(t,`任务创建成功: ${t.taskId}`,"success"),g(`已提交：${t.name}`,"success",{durationMs:1800}),t.status==="completed"&&t.videoUrl&&me(t),w(t.status)){A(t);return}vt(t)}).catch(i=>{if((i==null?void 0:i.name)==="AbortError"){N(t,"cancelled"),A(t);return}t.failReason=String((i==null?void 0:i.message)||i),N(t,"failed"),L(t,`创建失败: ${t.failReason}`,"error"),A(t),g(`创建失败：${t.name}`,"error")}),t}function ke(){const e=Date.now();if(e-p.lastSubmitAt<I.submitDebounceMs)return;p.lastSubmitAt=e;const o=[["apiKey",n.apiKey],["baseUrl",n.baseUrl],["promptInput",n.promptInput],["modelSelect",n.modelSelect],["batchCount",n.batchCount],["taskNameInput",n.taskNameInput]];for(const[d,v]of o)if(!v){g(`页面缺少必要表单字段：${d}`,"error");return}const t=_e(n.apiKey.value);if(!t){g("请先输入 API Key","error"),n.apiKey.focus();return}let r;try{r=k(n.baseUrl.value)}catch(d){g(d.message||"Base URL 无效","error"),n.baseUrl.focus();return}const i=n.promptInput.value.trim();if(!i){g("请输入提示词","error"),n.promptInput.focus();return}const a=n.modelSelect.value;let s;try{s=it(a)}catch(d){g(d.message||"模型不支持","error");return}if(a==="sora2"&&E.readingCount>0){g("图片读取中，请稍候…","warning");return}if(a==="sora2"){const d=n.soraImageSourceInput?String(n.soraImageSourceInput.value||"").trim():"";d&&ae(d)>0&&(n.soraImageSourceInput&&(n.soraImageSourceInput.value=""),U())}let l;try{l=ze(a,i)}catch(d){g(d.message||"参数有误","error");return}const c=Fe(n.batchCount.value,1,I.maxBatchCount,1);if(c>=I.confirmBatchThreshold&&!confirm(`将提交 ${c} 个任务，确认继续？`))return;const u=String(n.taskNameInput.value||"").trim()||i.slice(0,18)||"任务",f=Array.from({length:c},(d,v)=>{const y=c>1?` #${v+1}`:"";return{name:`${u}${y}`,modelKey:a,metaSummary:l.metaSummary,baseUrl:r,apiKey:t,apiSpec:s,payload:l.payload}});g(`已加入队列：${c} 个任务`,"success");const h=f.map(d=>{const v=We({...d,request:null});return v.request={name:d.name,modelKey:d.modelKey,metaSummary:d.metaSummary,baseUrl:d.baseUrl,apiKey:d.apiKey,apiSpec:d.apiSpec,payload:d.payload},v});Promise.allSettled(h.map(d=>d.createPromise)).then(d=>{const v=d.filter(S=>S.status==="fulfilled").length,y=d.length-v;d.length>1&&g(`创建结果：成功 ${v}，失败 ${y}`,y?"warning":"success",{durationMs:3600})}).catch(()=>{})}setInterval(()=>{const e=p.order.slice(0,p.renderLimit);for(const o of e){const t=p.byLocalId.get(o);t&&qe(t)}},1e3)});
