(function(){function B(e){const n=`; ${document.cookie||""}`.split(`; ${e}=`);return n.length===2?n.pop().split(";").shift():null}function p(){const e=B("csrf_token");return e?{"X-CSRF-Token":e}:{}}function r(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}async function u(e){const t=await e.text();try{const n=JSON.parse(t);return(n==null?void 0:n.detail)||t}catch{return t}}function m(e){const t=Number(e||0);if(!Number.isFinite(t)||t<=0)return"0 B";const n=["B","KiB","MiB","GiB","TiB"];let d=t,s=0;for(;d>=1024&&s<n.length-1;)d/=1024,s+=1;const l=s===0?0:s<=2?1:2;return`${d.toFixed(l)} ${n[s]}`}function a(e){const t=document.getElementById("errorBanner");if(t){if(!e){t.style.display="none",t.textContent="";return}t.style.display="block",t.textContent=e}}function g(e){return e.status===401?(window.location.href="/login?next=/admin",!1):e.status===403?(window.location.href="/?error=Admin%20access%20required",!1):!0}const i={limit:50,offset:0,lastPageSize:0,selectedUserId:null,selectedUser:null,search:"",isActive:"",isAdmin:""};function h(){const e=new URLSearchParams;return e.set("limit",String(i.limit)),e.set("offset",String(i.offset)),i.search&&e.set("search",i.search),i.isActive!==""&&e.set("is_active",i.isActive),i.isAdmin!==""&&e.set("is_admin",i.isAdmin),e.toString()}async function E(){const e=await fetch("/api/v1/admin/stats",{credentials:"include"});if(!g(e))return;if(!e.ok)throw new Error(await u(e)||"Failed to load stats");const t=await e.json();document.getElementById("statTotalUsers").textContent=String(t.total_user_count??0),document.getElementById("statActiveUsers").textContent=String(t.active_user_count??0),document.getElementById("statStorageUsed").textContent=m(t.total_storage_used_bytes),document.getElementById("statStorageQuota").textContent=m(t.total_storage_quota_bytes),document.getElementById("statVideos").textContent=String(t.total_video_count??0),document.getElementById("statImages").textContent=String(t.total_image_count??0),document.getElementById("statSessions").textContent=String(t.active_session_count??0)}function f(e,t){return`<span class="pill ${t}">${r(e)}</span>`}function v(e){const t=document.getElementById("userTbody");if(t){if(!Array.isArray(e)||e.length===0){t.innerHTML='<tr><td colspan="8" class="meta-text">No users found.</td></tr>';return}t.innerHTML=e.map(n=>{const d=n.is_active?f("Active","pill-green"):f("Inactive","pill-red"),s=n.is_admin?f("Admin","pill-blue"):f("User","pill-gray"),l=`${m(n.storage_used_bytes)} / ${m(n.storage_quota_bytes)}`,o=n.created_at?new Date(n.created_at).toLocaleString():"-",k=n.last_login_at?new Date(n.last_login_at).toLocaleString():"-";return`
                <tr>
                    <td>${r(n.username)}</td>
                    <td>${r(n.email)}</td>
                    <td>${d}</td>
                    <td>${s}</td>
                    <td>${r(l)}</td>
                    <td>${r(o)}</td>
                    <td>${r(k)}</td>
                    <td>
                        <div class="row-actions">
                            <button class="btn btn-secondary btn-sm" type="button" data-action="view" data-user-id="${r(n.id)}">View</button>
                            <button class="btn btn-secondary btn-sm" type="button" data-action="edit" data-user-id="${r(n.id)}">Edit</button>
                            <button class="btn btn-secondary btn-sm" type="button" data-action="delete" data-user-id="${r(n.id)}">Delete</button>
                        </div>
                    </td>
                </tr>
            `}).join("")}}async function c(){const e=await fetch(`/api/v1/admin/users?${h()}`,{credentials:"include"});if(!g(e))return;if(!e.ok)throw new Error(await u(e)||"Failed to load users");const t=await e.json();i.lastPageSize=Array.isArray(t)?t.length:0,v(t),I()}function I(){const e=document.getElementById("pageLabel");e&&(e.textContent=`Page ${Math.floor(i.offset/i.limit)+1}`);const t=document.getElementById("prevPageBtn"),n=document.getElementById("nextPageBtn");t&&(t.disabled=i.offset<=0),n&&(n.disabled=i.lastPageSize<i.limit)}function y(e){const t=document.getElementById("userModal");t&&t.classList.toggle("hidden",!e)}function w(e){const t=document.getElementById("loginAttemptTbody");if(t){if(!Array.isArray(e)||e.length===0){t.innerHTML='<tr><td colspan="4" class="meta-text">No login attempts.</td></tr>';return}t.innerHTML=e.map(n=>{const d=n.created_at?new Date(n.created_at).toLocaleString():"-",s=n.success?f("Success","pill-green"):f("Failed","pill-red"),l=n.failure_reason?r(n.failure_reason):"-",o=n.ip_address?r(n.ip_address):"-";return`<tr><td>${r(d)}</td><td>${s}</td><td>${l}</td><td>${o}</td></tr>`}).join("")}}async function _(e){const t=await fetch(`/api/v1/admin/users/${encodeURIComponent(e)}`,{credentials:"include"});if(!g(t))return null;if(!t.ok)throw new Error(await u(t)||"Failed to load user");return await t.json()}async function b(e){a("");const t=await _(e);t&&(i.selectedUserId=e,i.selectedUser=t,document.getElementById("userModalTitle").textContent=`User: ${t.username}`,document.getElementById("editEmail").value=t.email||"",document.getElementById("editQuota").value=String(t.storage_quota_bytes??0),document.getElementById("editActive").checked=!!t.is_active,document.getElementById("editAdmin").checked=!!t.is_admin,document.getElementById("detailStorage").textContent=`${m(t.storage_used_bytes)} / ${m(t.storage_quota_bytes)}`,document.getElementById("detailVideos").textContent=String(t.total_video_count??0),document.getElementById("detailImages").textContent=String(t.total_image_count??0),document.getElementById("detailSessions").textContent=String(t.active_session_count??0),w(t.recent_login_attempts||[]),y(!0))}async function S(){if(!i.selectedUserId)return;const e={email:String(document.getElementById("editEmail").value||"").trim(),is_active:!!document.getElementById("editActive").checked,is_admin:!!document.getElementById("editAdmin").checked,storage_quota_bytes:Number(document.getElementById("editQuota").value||0)},t=await fetch(`/api/v1/admin/users/${encodeURIComponent(i.selectedUserId)}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json",...p()},body:JSON.stringify(e)});if(g(t)){if(!t.ok)throw new Error(await u(t)||"Failed to update user");y(!1),i.selectedUserId=null,i.selectedUser=null,await c()}}async function A(){if(!i.selectedUserId||!confirm("Delete this user permanently?"))return;const e=await fetch(`/api/v1/admin/users/${encodeURIComponent(i.selectedUserId)}`,{method:"DELETE",credentials:"include",headers:{...p()}});if(g(e)){if(!e.ok)throw new Error(await u(e)||"Failed to delete user");y(!1),i.selectedUserId=null,i.selectedUser=null,await E(),await c()}}function U(e,t){let n=null;return(...d)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...d),t)}}function $(){document.getElementById("refreshBtn").addEventListener("click",async()=>{a("");try{await E(),await c()}catch(t){a((t==null?void 0:t.message)||String(t))}});const e=async()=>{i.offset=0,i.search=String(document.getElementById("searchInput").value||"").trim(),i.isActive=String(document.getElementById("filterActive").value||""),i.isAdmin=String(document.getElementById("filterAdmin").value||""),a("");try{await c()}catch(t){a((t==null?void 0:t.message)||String(t))}};document.getElementById("searchInput").addEventListener("input",U(e,250)),document.getElementById("filterActive").addEventListener("change",e),document.getElementById("filterAdmin").addEventListener("change",e),document.getElementById("prevPageBtn").addEventListener("click",async()=>{i.offset=Math.max(0,i.offset-i.limit),a("");try{await c()}catch(t){a((t==null?void 0:t.message)||String(t))}}),document.getElementById("nextPageBtn").addEventListener("click",async()=>{i.offset+=i.limit,a("");try{await c()}catch(t){a((t==null?void 0:t.message)||String(t))}}),document.getElementById("userTbody").addEventListener("click",async t=>{var l;const n=(l=t.target)==null?void 0:l.closest("button[data-action][data-user-id]");if(!n)return;const d=n.getAttribute("data-action"),s=n.getAttribute("data-user-id");if(s){a("");try{if(d==="delete"){if(!confirm("Delete this user permanently?"))return;const o=await fetch(`/api/v1/admin/users/${encodeURIComponent(s)}`,{method:"DELETE",credentials:"include",headers:{...p()}});if(!g(o))return;if(!o.ok)throw new Error(await u(o)||"Failed to delete user");await E(),await c();return}await b(s)}catch(o){a((o==null?void 0:o.message)||String(o))}}}),document.getElementById("userModalClose").addEventListener("click",()=>y(!1)),document.getElementById("userModalBackdrop").addEventListener("click",()=>y(!1)),document.getElementById("cancelUserBtn").addEventListener("click",()=>y(!1)),document.getElementById("saveUserBtn").addEventListener("click",async()=>{a("");try{await S()}catch(t){a((t==null?void 0:t.message)||String(t))}}),document.getElementById("deleteUserBtn").addEventListener("click",async()=>{a("");try{await A()}catch(t){a((t==null?void 0:t.message)||String(t))}})}async function L(){a("");try{await E(),await c()}catch(e){a((e==null?void 0:e.message)||String(e))}$()}document.addEventListener("DOMContentLoaded",L)})();
