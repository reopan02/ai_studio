const B={apiKey:"global_api_key",baseUrl:"global_base_url"},M="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200" viewBox="0 0 320 200"><rect width="320" height="200" fill="#111827"/><rect x="52" y="40" width="216" height="120" rx="12" fill="none" stroke="#9CA3AF" stroke-width="6"/><path d="M76 142l54-64 44 52 30-36 70 84H76z" fill="#374151"/><circle cx="116" cy="82" r="10" fill="#6B7280"/><line x1="92" y1="62" x2="228" y2="138" stroke="#9CA3AF" stroke-width="6"/><line x1="228" y1="62" x2="92" y2="138" stroke="#9CA3AF" stroke-width="6"/></svg>');function ie(e){return String(e||"").trim().replace(/^bearer\s+/i,"").trim()}function Y(e,o){e&&e.querySelectorAll(o).forEach(i=>{i.addEventListener("error",()=>{i.dataset.fallbackApplied||(i.dataset.fallbackApplied="true",i.alt="Image unavailable",i.src=M)},{once:!0})})}function ae(e){const i=`; ${document.cookie||""}`.split(`; ${e}=`);return i.length===2?i.pop().split(";").shift():null}function re(){const e=ae("csrf_token");return e?{"X-CSRF-Token":e}:{}}function se(e){const o=String(e||"").trim();if(!o)return null;let i;try{i=new URL(o)}catch{throw new Error("Base URL is not a valid URL")}if(i.protocol!=="https:")throw new Error("Base URL must use HTTPS");if(!i.hostname)throw new Error("Base URL is missing host (e.g. https://api.example.com)");return i.origin}async function T(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const i=await e.text();try{return JSON.parse(i)}catch{return i}}function le(e,o){if(typeof e=="string")return e;if(!e||typeof e!="object")return o;const i=e.detail??e.error??e.message;if(typeof i=="string")return i;try{return JSON.stringify(i??e)}catch{return o}}const n={config:{apiKey:localStorage.getItem(B.apiKey)||localStorage.getItem("video_api_key")||localStorage.getItem("apiKey")||"",baseUrl:localStorage.getItem(B.baseUrl)||localStorage.getItem("video_base_url")||localStorage.getItem("baseUrl")||""},images:[],currentImageIndex:-1,prompt:"",promptHistory:(()=>{try{return JSON.parse(localStorage.getItem("promptHistory")||"[]")}catch{return localStorage.removeItem("promptHistory"),[]}})(),generationHistory:(()=>{try{return JSON.parse(localStorage.getItem("generationHistory")||"[]")}catch{return localStorage.removeItem("generationHistory"),[]}})(),inlineHistoryCollapsed:localStorage.getItem("inlineHistoryCollapsed")==="true",inlineHistoryLimit:6,inlineHistoryShowAll:!1,editingHistoryIndex:-1,isGenerating:!1,currentZoom:100,canvasZoom:100,canvasHistory:[],canvasHistoryIndex:-1,originalImage:null,originalWidth:0,originalHeight:0,displayScale:1},t={modelSelect:document.getElementById("modelSelect"),modelSearch:document.getElementById("modelSearch"),aspectRatio:document.getElementById("aspectRatio"),imageSize:document.getElementById("imageSize"),uploadArea:document.getElementById("uploadArea"),fileInput:document.getElementById("fileInput"),imagePreviewGrid:document.getElementById("imagePreviewGrid"),editMaskBtn:document.getElementById("editMaskBtn"),maskModalOverlay:document.getElementById("maskModalOverlay"),closeMaskModal:document.getElementById("closeMaskModal"),cancelMaskBtn:document.getElementById("cancelMaskBtn"),canvasContainer:document.getElementById("canvasContainer"),canvasWrapper:document.getElementById("canvasWrapper"),maskCanvas:document.getElementById("maskCanvas"),brushSize:document.getElementById("brushSize"),brushSizeLabel:document.getElementById("brushSizeLabel"),brushColor:document.getElementById("brushColor"),undoBtn:document.getElementById("undoBtn"),redoBtn:document.getElementById("redoBtn"),clearCanvasBtn:document.getElementById("clearCanvasBtn"),saveMaskBtn:document.getElementById("saveMaskBtn"),resetMaskBtn:document.getElementById("resetMaskBtn"),canvasZoomInBtn:document.getElementById("canvasZoomInBtn"),canvasZoomOutBtn:document.getElementById("canvasZoomOutBtn"),canvasZoomResetBtn:document.getElementById("canvasZoomResetBtn"),canvasZoomLevel:document.getElementById("canvasZoomLevel"),promptInput:document.getElementById("promptInput"),charCount:document.getElementById("charCount"),showPromptHistory:document.getElementById("showPromptHistory"),promptHistoryDropdown:document.getElementById("promptHistoryDropdown"),imagePreviewOverlay:document.getElementById("imagePreviewOverlay"),imagePreviewImg:document.getElementById("imagePreviewImg"),imagePreviewInfo:document.getElementById("imagePreviewInfo"),closeImagePreview:document.getElementById("closeImagePreview"),resultArea:document.getElementById("resultArea"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultImage:document.getElementById("resultImage"),generateBtn:document.getElementById("generateBtn"),downloadBtn:document.getElementById("downloadBtn"),shareBtn:document.getElementById("shareBtn"),fullscreenBtn:document.getElementById("fullscreenBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomLevel:document.getElementById("zoomLevel"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),historyList:document.getElementById("historyList"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),inlineHistoryShowMore:document.getElementById("inlineHistoryShowMore"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),editPromptModalOverlay:document.getElementById("editPromptModalOverlay"),editPromptTextarea:document.getElementById("editPromptTextarea"),closeEditPromptModal:document.getElementById("closeEditPromptModal"),cancelEditPromptBtn:document.getElementById("cancelEditPromptBtn"),saveEditPromptBtn:document.getElementById("saveEditPromptBtn"),imageZoomOverlay:document.getElementById("imageZoomOverlay"),zoomImage:document.getElementById("zoomImage"),closeZoomBtn:document.getElementById("closeZoomBtn"),toastContainer:document.getElementById("toastContainer")};let u=null,m=null,g=null,k=!1,b="brush",E=0,H=0;function d(e,o,i){const a=document.createElement("div");a.className=`toast ${e}`;const r={success:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',error:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'};a.innerHTML=`
        ${r[e]}
        <div class="toast-content">
            <div class="toast-title">${o}</div>
            ${i?`<div class="toast-message">${i}</div>`:""}
        </div>
        <button class="toast-close">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    `,t.toastContainer.appendChild(a),a.querySelector(".toast-close").addEventListener("click",()=>{a.remove()}),setTimeout(()=>{a.remove()},5e3)}function f(e,o){t.statusDot.className="status-dot "+e,t.statusText.textContent=o}function J(e){return new Intl.DateTimeFormat("zh-CN",{hour:"2-digit",minute:"2-digit"}).format(e)}function ce(e){return new Intl.DateTimeFormat("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function de(){n.config.apiKey=localStorage.getItem(B.apiKey)||localStorage.getItem("video_api_key")||"",n.config.baseUrl=localStorage.getItem(B.baseUrl)||localStorage.getItem("video_base_url")||"",n.config.apiKey||n.config.baseUrl?f("connected","Configured"):f("","Ready")}function R(e){Array.from(e).forEach(o=>{if(!o.type.startsWith("image/")){d("error","Invalid file type","Please upload an image file");return}if(o.size>10*1024*1024){d("error","File too large","Maximum file size is 10MB");return}const i=new FileReader;i.onload=a=>{n.images.push({id:Date.now()+Math.random(),name:o.name,originalData:a.target.result,data:a.target.result,hasMask:!1}),y(),n.images.length===1&&W(0)},i.readAsDataURL(o)})}function y(){t.imagePreviewGrid.innerHTML=n.images.map((e,o)=>`
        <div class="image-preview-item ${o===n.currentImageIndex?"active":""}" data-index="${o}">
            <img src="${e.data}" alt="${e.name}">
            <button class="remove-btn" data-index="${o}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            ${e.hasMask?'<span class="edit-indicator">Mask</span>':""}
        </div>
    `).join(""),t.imagePreviewGrid.querySelectorAll(".image-preview-item").forEach(e=>{e.addEventListener("click",o=>{o.target.closest(".remove-btn")||W(parseInt(e.dataset.index))})}),t.imagePreviewGrid.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),ue(parseInt(e.dataset.index))})}),me()}function me(){t.editMaskBtn.disabled=n.images.length===0||n.currentImageIndex<0}function W(e){n.currentImageIndex=e,y()}function ue(e){n.images.splice(e,1),n.currentImageIndex>=n.images.length&&(n.currentImageIndex=n.images.length-1),y()}function ge(){if(n.currentImageIndex<0||!n.images[n.currentImageIndex]){d("warning","No image selected","Please select an image first");return}t.maskModalOverlay.classList.add("show"),setTimeout(()=>{P()},100)}function v(){t.maskModalOverlay.classList.remove("show")}function P(){if(n.currentImageIndex<0||!n.images[n.currentImageIndex])return;n.canvasZoom=100,L();const e=new Image;e.onload=()=>{n.originalWidth=e.width,n.originalHeight=e.height,n.originalImage=e,m=document.createElement("canvas"),m.width=e.width,m.height=e.height,g=m.getContext("2d"),g.drawImage(e,0,0);const o=t.canvasContainer.clientWidth-40,i=t.canvasContainer.clientHeight-40||500;let a=e.width,r=e.height;const c=o/e.width,l=i/e.height;n.displayScale=Math.min(c,l,1),a=Math.floor(e.width*n.displayScale),r=Math.floor(e.height*n.displayScale);const s=t.maskCanvas;s.width=a,s.height=r,s.style.width=a+"px",s.style.height=r+"px",u=s.getContext("2d"),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(e,0,0,a,r),n.canvasHistory=[{display:s.toDataURL(),fullRes:m.toDataURL()}],n.canvasHistoryIndex=0},e.src=n.images[n.currentImageIndex].data}function V(e){const o=t.maskCanvas.getBoundingClientRect(),i=t.maskCanvas.width/o.width,a=t.maskCanvas.height/o.height;return{x:(e.clientX-o.left)*i,y:(e.clientY-o.top)*a}}function Z(e){if(!u||!g)return;k=!0;const o=V(e);E=o.x,H=o.y}function z(e){if(!k||!u||!g)return;const o=V(e),i=o.x,a=o.y,r=parseInt(t.brushSize.value),c=t.brushColor.value;$(u,E,H,i,a,r,c,b==="eraser");const l=E/n.displayScale,s=H/n.displayScale,p=i/n.displayScale,S=a/n.displayScale,O=r/n.displayScale;$(g,l,s,p,S,O,c,b==="eraser"),E=i,H=a}function $(e,o,i,a,r,c,l,s){e.beginPath(),e.moveTo(o,i),e.lineTo(a,r),e.strokeStyle=l,e.lineWidth=c,e.lineCap="round",e.lineJoin="round",s?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over",e.stroke(),e.globalCompositeOperation="source-over"}function C(){k&&(k=!1,ye(),n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].hasMask=!0,y()))}function ye(){!t.maskCanvas||!m||(n.canvasHistoryIndex++,n.canvasHistory=n.canvasHistory.slice(0,n.canvasHistoryIndex),n.canvasHistory.push({display:t.maskCanvas.toDataURL(),fullRes:m.toDataURL()}),n.canvasHistory.length>50&&(n.canvasHistory.shift(),n.canvasHistoryIndex--))}function U(){n.canvasHistoryIndex>0&&(n.canvasHistoryIndex--,Q())}function G(){n.canvasHistoryIndex<n.canvasHistory.length-1&&(n.canvasHistoryIndex++,Q())}function Q(){const e=n.canvasHistory[n.canvasHistoryIndex];if(!e)return;const o=new Image;o.onload=()=>{u.clearRect(0,0,t.maskCanvas.width,t.maskCanvas.height),u.drawImage(o,0,0)},o.src=e.display;const i=new Image;i.onload=()=>{g.clearRect(0,0,m.width,m.height),g.drawImage(i,0,0)},i.src=e.fullRes}function pe(){n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].data=n.images[n.currentImageIndex].originalData,n.images[n.currentImageIndex].hasMask=!1,P(),y())}function _(){if(!m||n.currentImageIndex<0){d("warning","No mask to save","Please draw on the image first");return}const e=m.toDataURL("image/png");n.images[n.currentImageIndex].data=e,n.images[n.currentImageIndex].hasMask=!0,saveToDrawingHistory(e),y(),v(),d("success","Mask saved","The mask has been applied to the image")}function ve(){n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].data=n.images[n.currentImageIndex].originalData,n.images[n.currentImageIndex].hasMask=!1,P(),y(),d("success","Mask reset","Image restored to original"))}function L(){t.canvasZoomLevel.textContent=`${n.canvasZoom}%`,t.canvasWrapper.style.transform=`scale(${n.canvasZoom/100})`}function N(){n.canvasZoom<300&&(n.canvasZoom+=25,L())}function F(){n.canvasZoom>50&&(n.canvasZoom-=25,L())}function he(){n.canvasZoom=100,L()}async function fe(){try{return(await fetch("/api/v1/auth/me",{credentials:"include"})).ok?!0:(window.location.href="/login?next=/image",!1)}catch(e){return console.error("Authentication check failed:",e),window.location.href="/login?next=/image",!1}}async function ee(){try{const e=await fetch("/api/v1/images?limit=50",{credentials:"include"});if(!e.ok){if(e.status===401){window.location.href="/login?next=/image";return}throw new Error("Failed to load images")}const o=await e.json()}catch(e){console.error("Failed to load images from repository:",e),d("error","Load failed",e.message||"Failed to load images from repository")}}function q(){t.imagePreviewOverlay.classList.remove("show"),setTimeout(()=>{t.imagePreviewImg.src=""},300)}function I(){const e=t.promptInput.value.length;t.charCount.textContent=e}function Ie(e){if(e.trim()){n.promptHistory=n.promptHistory.filter(o=>o.text!==e),n.promptHistory.unshift({text:e,time:new Date().toISOString()}),n.promptHistory=n.promptHistory.slice(0,20);try{localStorage.setItem("promptHistory",JSON.stringify(n.promptHistory))}catch(o){console.warn("Failed to persist prompt history:",o)}}}function te(){if(n.promptHistory.length===0){t.promptHistoryDropdown.innerHTML='<p style="padding: 12px; text-align: center; color: var(--text-muted);">No history yet</p>';return}t.promptHistoryDropdown.innerHTML=n.promptHistory.map((e,o)=>`
	                <div class="prompt-history-item" data-index="${o}">
	                    <span class="prompt-text">${e.text}</span>
	                    <div class="prompt-history-actions">
	                        <span class="prompt-time">${J(new Date(e.time))}</span>
	                        <button class="prompt-history-delete" data-index="${o}" title="Delete">
	                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M18 6L6 18M6 6l12 12"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `).join(""),t.promptHistoryDropdown.querySelectorAll(".prompt-history-item").forEach(e=>{e.addEventListener("click",o=>{o.target.closest(".prompt-history-delete")||(t.promptInput.value=n.promptHistory[parseInt(e.dataset.index)].text,I(),t.promptHistoryDropdown.classList.remove("show"))})}),t.promptHistoryDropdown.querySelectorAll(".prompt-history-delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),we(parseInt(e.dataset.index))})})}function we(e){if(!(Number.isNaN(e)||e<0||e>=n.promptHistory.length)){n.promptHistory.splice(e,1);try{localStorage.setItem("promptHistory",JSON.stringify(n.promptHistory))}catch(o){console.warn("Failed to persist prompt history:",o)}te(),d("success","Deleted","Prompt history item removed")}}function Ee(e,o){n.generationHistory.unshift({prompt:e,imageUrl:o,model:t.modelSelect.value,time:new Date().toISOString()}),n.generationHistory=n.generationHistory.slice(0,50);try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(i){console.warn("Failed to persist generation history:",i)}x(),w()}function x(){if(n.generationHistory.length===0){t.historyList.innerHTML='<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>';return}t.historyList.innerHTML=n.generationHistory.map((e,o)=>`
	                <div class="history-item" data-index="${o}">
	                    <img class="history-item-image" src="${e.imageUrl}" alt="Generated" loading="lazy" decoding="async">
	                    <div class="history-item-content">
	                        <div class="history-item-prompt">${e.prompt}</div>
	                        <div class="history-item-meta">${e.model} - ${J(new Date(e.time))}</div>
	                    </div>
	                    <button class="history-item-delete" data-index="${o}" title="Delete">
	                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M18 6L6 18M6 6l12 12"/>
	                        </svg>
	                    </button>
	                </div>
	            `).join(""),t.historyList.querySelectorAll(".history-item").forEach(e=>{e.addEventListener("click",o=>{if(o.target.closest(".history-item-delete"))return;const i=n.generationHistory[parseInt(e.dataset.index)];D(i.imageUrl),t.promptInput.value=i.prompt,I()})}),t.historyList.querySelectorAll(".history-item-delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),Ce(parseInt(e.dataset.index))})}),Y(t.historyList,".history-item-image")}function w(){const e=n.generationHistory,o=e.length;if(t.inlineHistoryCount.textContent=o,n.inlineHistoryCollapsed?t.inlineHistorySection.classList.add("collapsed"):t.inlineHistorySection.classList.remove("collapsed"),o===0){t.inlineHistoryGrid.innerHTML='<p class="inline-history-empty">No generation history yet. Create your first image!</p>',t.inlineHistoryShowMore.style.display="none";return}const i=n.inlineHistoryShowAll?o:Math.min(n.inlineHistoryLimit,o),a=e.slice(0,i);t.inlineHistoryGrid.innerHTML=a.map((r,c)=>{const l=r.prompt.length>100?r.prompt.substring(0,100)+"...":r.prompt,s=ce(new Date(r.time));return`
            <div class="inline-history-item" data-index="${c}">
                <div class="inline-history-item-actions">
                    <button class="inline-history-action-btn load" data-index="${c}" title="Load prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn edit" data-index="${c}" title="Edit prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn delete" data-index="${c}" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
                <img class="inline-history-item-image" src="${r.imageUrl}" alt="Generated" loading="lazy">
                <div class="inline-history-item-info">
                    <div class="inline-history-item-prompt" title="${r.prompt.replace(/"/g,"&quot;")}">${l}</div>
                    <div class="inline-history-item-meta">
                        <span>${r.model}</span>
                        <span>â€¢</span>
                        <span>${s}</span>
                    </div>
                </div>
            </div>
        `}).join(""),o>n.inlineHistoryLimit&&!n.inlineHistoryShowAll?(t.inlineHistoryShowMore.style.display="flex",t.showMoreHistoryBtn.textContent=`Show more (${o-i} more)`):n.inlineHistoryShowAll&&o>n.inlineHistoryLimit?(t.inlineHistoryShowMore.style.display="flex",t.showMoreHistoryBtn.textContent="Show less"):t.inlineHistoryShowMore.style.display="none",He(),Y(t.inlineHistoryGrid,".inline-history-item-image")}function He(){t.inlineHistoryGrid.querySelectorAll(".inline-history-item").forEach(e=>{e.addEventListener("click",o=>{if(o.target.closest(".inline-history-action-btn"))return;const i=parseInt(e.dataset.index);K(i)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.load").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const i=parseInt(e.dataset.index);K(i)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.edit").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const i=parseInt(e.dataset.index);ke(i)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const i=parseInt(e.dataset.index);ne(i)})})}function K(e){const o=n.generationHistory[e];o&&(D(o.imageUrl),t.promptInput.value=o.prompt,I(),d("success","Loaded","Prompt and image loaded from history"))}function ne(e){if(confirm("Delete this generation from history?")){n.generationHistory.splice(e,1);try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(o){console.warn("Failed to persist generation history:",o)}w(),x(),d("success","Deleted","Generation removed from history")}}function Be(e,o){if(!(e<0||e>=n.generationHistory.length)){n.generationHistory[e].prompt=o;try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(i){console.warn("Failed to persist generation history:",i)}w(),x(),d("success","Updated","Prompt has been updated")}}function ke(e){const o=n.generationHistory[e];o&&(n.editingHistoryIndex=e,t.editPromptTextarea.value=o.prompt,t.editPromptModalOverlay.classList.add("show"),t.editPromptTextarea.focus())}function h(){t.editPromptModalOverlay.classList.remove("show"),n.editingHistoryIndex=-1,t.editPromptTextarea.value=""}function Le(){if(n.editingHistoryIndex<0)return;const e=t.editPromptTextarea.value.trim();if(!e){d("error","Invalid","Prompt cannot be empty");return}Be(n.editingHistoryIndex,e),h()}function xe(){n.inlineHistoryCollapsed=!n.inlineHistoryCollapsed,localStorage.setItem("inlineHistoryCollapsed",n.inlineHistoryCollapsed.toString()),n.inlineHistoryCollapsed?t.inlineHistorySection.classList.add("collapsed"):t.inlineHistorySection.classList.remove("collapsed")}function Se(){n.inlineHistoryShowAll=!n.inlineHistoryShowAll,w()}function Ce(e){ne(e)}async function j(){const e=t.promptInput.value.trim();if(!e){d("error","Prompt required","Please enter a prompt");return}n.isGenerating=!0,t.generateBtn.disabled=!0,t.resultPlaceholder.style.display="none",t.resultContainer.style.display="none",t.loadingState.style.display="block",f("generating","Generating...");try{const o=new FormData;o.append("model",t.modelSelect.value),o.append("prompt",e),o.append("response_format","url"),t.aspectRatio.value&&o.append("aspect_ratio",t.aspectRatio.value),t.imageSize.value&&o.append("image_size",t.imageSize.value);for(const p of n.images){const S=p.data,oe=await(await fetch(S)).blob();o.append("image",oe,p.name||"image.png")}const i=ie(n.config.apiKey),a=se(n.config.baseUrl),r=await fetch("/api/v1/images/edits",{method:"POST",credentials:"include",headers:{...re(),...i?{"X-API-Key":i}:{},...a?{"X-Base-Url":a}:{}},body:o});if(!r.ok){const p=await T(r);if(r.status===401){window.location.href="/login?next=/image";return}throw new Error(le(p,`Request failed (HTTP ${r.status})`))}const c=await T(r),l=c&&typeof c=="object"&&c.response?c.response:c;let s=null;if(l.data&&l.data[0]?(s=l.data[0].url||l.data[0].b64_json,l.data[0].b64_json&&!l.data[0].url&&(s=`data:image/png;base64,${l.data[0].b64_json}`)):l.url?s=l.url:l.b64_json&&(s=`data:image/png;base64,${l.b64_json}`),!s)throw new Error("No image URL in response");D(s),Ie(e),Ee(e,s),d("success","Image generated","Your image has been created successfully"),ee()}catch(o){console.error("Generation error:",o),d("error","Generation failed",o.message),t.loadingState.style.display="none",t.resultPlaceholder.style.display="block",f("error","Error")}finally{n.isGenerating=!1,t.generateBtn.disabled=!1}}function D(e){t.loadingState.style.display="none",t.resultPlaceholder.style.display="none",t.resultContainer.style.display="block",t.resultImage.src=e,n.currentZoom=100,A(),f("connected","Complete")}function A(){t.zoomLevel.textContent=`${n.currentZoom}%`,t.resultImage.style.transform=`scale(${n.currentZoom/100})`}function Me(){n.currentZoom<200&&(n.currentZoom+=25,A())}function be(){n.currentZoom>25&&(n.currentZoom-=25,A())}function Pe(){const e=t.resultImage.src;if(!e)return;const o=document.createElement("a");o.href=e,o.download=`generated-${Date.now()}.png`,document.body.appendChild(o),o.click(),document.body.removeChild(o),d("success","Download started","Image is being downloaded")}function De(){const e=t.resultImage.src;e&&(navigator.share?navigator.share({title:"Generated Image",text:t.promptInput.value,url:e}).catch(()=>{}):navigator.clipboard.writeText(e).then(()=>{d("success","Link copied","Image URL copied to clipboard")}))}function Ae(){const e=t.resultImage.src;e&&(t.zoomImage.src=e,t.imageZoomOverlay.classList.add("show"))}function Oe(){const e=t.modelSearch.value.toLowerCase(),o=t.modelSelect.options;for(let i=0;i<o.length;i++){const a=o[i],r=a.textContent.toLowerCase();a.style.display=r.includes(e)?"":"none"}}function Te(){document.querySelectorAll(".collapsible-header").forEach(e=>{const o=e.dataset.target,i=o?document.getElementById(o):null;i&&(o==="configContent"&&(e.classList.add("collapsed"),i.classList.add("collapsed")),e.addEventListener("click",()=>{const a=e.classList.toggle("collapsed");i.classList.toggle("collapsed",a)}))})}function Re(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const o=document.getElementById(e.dataset.target),i=o.type==="password";o.type=i?"text":"password",e.innerHTML=i?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'})})}function Ze(){t.fileInput.addEventListener("change",e=>R(e.target.files)),t.uploadArea.addEventListener("dragover",e=>{e.preventDefault(),t.uploadArea.classList.add("drag-over")}),t.uploadArea.addEventListener("dragleave",()=>{t.uploadArea.classList.remove("drag-over")}),t.uploadArea.addEventListener("drop",e=>{e.preventDefault(),t.uploadArea.classList.remove("drag-over"),R(e.dataTransfer.files)}),t.editMaskBtn.addEventListener("click",ge),t.closeMaskModal.addEventListener("click",v),t.cancelMaskBtn.addEventListener("click",v),t.maskModalOverlay.addEventListener("click",e=>{e.target===t.maskModalOverlay&&v()}),t.closeImagePreview.addEventListener("click",q),t.imagePreviewOverlay.addEventListener("click",e=>{e.target===t.imagePreviewOverlay&&q()}),t.maskCanvas.addEventListener("mousedown",Z),t.maskCanvas.addEventListener("mousemove",z),t.maskCanvas.addEventListener("mouseup",C),t.maskCanvas.addEventListener("mouseout",C),t.maskCanvas.addEventListener("touchstart",e=>{e.preventDefault();const o=e.touches[0];Z({clientX:o.clientX,clientY:o.clientY})}),t.maskCanvas.addEventListener("touchmove",e=>{e.preventDefault();const o=e.touches[0];z({clientX:o.clientX,clientY:o.clientY})}),t.maskCanvas.addEventListener("touchend",C),document.querySelectorAll("[data-tool]").forEach(e=>{e.addEventListener("click",()=>{b=e.dataset.tool,document.querySelectorAll("[data-tool]").forEach(o=>o.classList.remove("active")),e.classList.add("active")})}),t.brushSize.addEventListener("input",()=>{t.brushSizeLabel.textContent=t.brushSize.value+"px"}),t.undoBtn.addEventListener("click",U),t.redoBtn.addEventListener("click",G),t.clearCanvasBtn.addEventListener("click",pe),t.saveMaskBtn.addEventListener("click",_),t.resetMaskBtn.addEventListener("click",ve),t.canvasZoomInBtn.addEventListener("click",N),t.canvasZoomOutBtn.addEventListener("click",F),t.canvasZoomResetBtn.addEventListener("click",he),t.promptInput.addEventListener("input",I),t.showPromptHistory.addEventListener("click",()=>{te(),t.promptHistoryDropdown.classList.toggle("show")}),document.addEventListener("click",e=>{e.target.closest(".main-prompt-section")||t.promptHistoryDropdown.classList.remove("show")}),t.modelSearch.addEventListener("input",Oe),t.generateBtn.addEventListener("click",j),t.zoomInBtn.addEventListener("click",Me),t.zoomOutBtn.addEventListener("click",be),t.downloadBtn.addEventListener("click",Pe),t.shareBtn.addEventListener("click",De),t.fullscreenBtn.addEventListener("click",Ae),t.resultImage.addEventListener("error",()=>{(t.resultImage.getAttribute("src")||"")!==M&&(t.resultImage.alt="Image unavailable",t.resultImage.src=M)}),t.closeZoomBtn.addEventListener("click",()=>{t.imageZoomOverlay.classList.remove("show")}),t.imageZoomOverlay.addEventListener("click",e=>{e.target===t.imageZoomOverlay&&t.imageZoomOverlay.classList.remove("show")}),t.historyBtn.addEventListener("click",()=>{t.historyPanel.classList.toggle("show")}),t.closeHistoryBtn.addEventListener("click",()=>{t.historyPanel.classList.remove("show")}),t.inlineHistoryToggle.addEventListener("click",xe),t.showMoreHistoryBtn.addEventListener("click",Se),t.closeEditPromptModal.addEventListener("click",h),t.cancelEditPromptBtn.addEventListener("click",h),t.saveEditPromptBtn.addEventListener("click",Le),t.editPromptModalOverlay.addEventListener("click",e=>{e.target===t.editPromptModalOverlay&&h()}),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="z"?(e.preventDefault(),e.shiftKey?G():U()):e.key==="Enter"?(e.preventDefault(),j()):e.key==="s"&&(e.preventDefault(),_())),e.key==="Escape"&&(v(),h(),t.imageZoomOverlay.classList.remove("show"),t.historyPanel.classList.remove("show"))}),t.canvasContainer.addEventListener("wheel",e=>{(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.deltaY<0?N():F())})}function X(){de(),Te(),Re(),Ze(),x(),w(),I(),fe().then(e=>{e&&ee()})}document.readyState!=="loading"?X():document.addEventListener("DOMContentLoaded",X);
