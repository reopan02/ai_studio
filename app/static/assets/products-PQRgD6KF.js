import{d as Ce,r as c,m as Se,c as B,o as Ie,a as i,b as l,e as s,g as R,f as u,i as Pe,t as f,p as S,n as q,F as Q,q as K,w as U,k as E,j as je}from"./runtime-dom.esm-bundler-BI5Nxju0.js";import{g as Me}from"./auth-DhJl3iPe.js";import{c as De}from"./csrf-B-6zPzK2.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                     */const Ee={class:"products-page"},Oe={class:"header"},Ae={class:"header-actions"},$e={key:0,href:"/admin",class:"btn btn-secondary",style:{"text-decoration":"none"}},Le={class:"main-container"},Be={class:"sidebar"},Ne={class:"sidebar-section"},Ve={class:"section-header"},Fe={class:"section-title section-title-lg"},He={class:"form-group"},Re=["disabled"],ze={class:"upload-actions"},Je=["disabled"],We={class:"form-group"},Ge={class:"preview-box"},qe=["src"],Qe={key:1,class:"preview-placeholder"},Ke={key:0,class:"form-hint"},Xe={key:0,class:"image-meta"},Ye={class:"meta-text"},Ze={key:0,class:"meta-text"},et={key:1,class:"image-preview-grid product-image-grid"},tt=["src","alt"],at={key:0,class:"preview-badge"},st={class:"preview-actions"},nt=["onClick"],ot=["onClick"],it={key:2,class:"image-preview-grid product-image-grid"},lt=["src","alt"],rt={key:0,class:"preview-badge"},ct={class:"form-group"},ut={class:"form-group"},dt={class:"form-group"},vt=["disabled"],ft={class:"form-group"},pt={class:"form-group"},mt={class:"form-actions"},gt=["disabled"],ht=["disabled"],yt=["disabled"],_t={class:"main-content"},bt={class:"content-scroll"},wt={key:0,class:"notice-banner error"},kt={key:1,class:"notice-banner success"},xt={class:"content-section"},Tt={class:"content-header"},Ct={class:"search-wrapper"},St={key:0,class:"loading-state"},It={key:1},Pt={key:0,class:"empty-state"},jt={key:1,class:"products-grid"},Mt={class:"product-thumb"},Dt=["src","alt"],Ut={key:0,class:"image-count-badge"},Et={class:"product-body"},Ot={class:"product-title"},At={class:"product-meta"},$t={key:0},Lt={key:1},Bt={key:2},Nt={key:0,class:"product-meta"},Vt={class:"product-actions"},Ft=["disabled","onClick"],Ht=["disabled","onClick"],Rt={key:2,class:"pagination"},zt=["disabled"],Jt={class:"meta-text"},Wt=["disabled"],Gt=Ce({__name:"products-page",setup(Qt){const z=c(!1),N=c([]),J=c(!1),d=c(!1),O=c(""),A=c(""),p=c(0),_=c(20),I=c(0),V=c("");let W=null;const X=c(null),P=c(!1),r=c([]),h=c([]),v=c(0),w=c(null),k=c(null),j=c(!1),x=c(null),n=Se({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),m=B(()=>!!w.value),G=B(()=>r.value[v.value]??null),se=B(()=>h.value.find(t=>t.is_primary)??h.value[0]??null),Y=B(()=>{var t,e;return((t=G.value)==null?void 0:t.url)||((e=se.value)==null?void 0:e.image_url)||null}),Z=B(()=>r.value.length>0?r.value.length:h.value.length);function T(){O.value="",A.value=""}function y(t){O.value=t,A.value=""}function $(t){A.value=t,O.value=""}function ne(t){try{return new Date(t).toLocaleString()}catch{return t}}function F(t){return t.split(`
`).map(e=>e.trim()).filter(Boolean)}function L(){k.value=null,x.value=null}function H(){for(const t of r.value)t.url.startsWith("blob:")&&URL.revokeObjectURL(t.url)}function oe(){return globalThis.crypto&&"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function ie(t){const e=t.type.toLowerCase();if(e==="image/jpeg"||e==="image/png")return!0;const a=t.name.toLowerCase();return a.endsWith(".jpg")||a.endsWith(".jpeg")||a.endsWith(".png")}function ee(t){if(m.value){y("编辑模式下无法更换图片");return}const e=Array.from(t);if(e.length===0)return;T();let a=0;for(const o of e){if(!ie(o)){a+=1;continue}const g=URL.createObjectURL(o);r.value.push({id:oe(),file:o,url:g})}r.value.length>0&&(v.value=Math.min(v.value,r.value.length-1),w.value=null,h.value=[],L()),a>0&&y("仅支持 JPG/PNG 图片")}function te(){var t;m.value||(t=X.value)==null||t.click()}function le(){m.value||(P.value=!0)}function re(){m.value||(P.value=!0)}function ce(){P.value=!1}function ue(t){var e;m.value||(P.value=!1,(e=t.dataTransfer)!=null&&e.files&&ee(t.dataTransfer.files))}function de(){H(),r.value=[],v.value=0,L()}function ve(t){var a;const[e]=r.value.splice(t,1);(a=e==null?void 0:e.url)!=null&&a.startsWith("blob:")&&URL.revokeObjectURL(e.url),r.value.length===0||t===v.value?v.value=0:t<v.value&&(v.value-=1),L()}function fe(t){t<0||t>=r.value.length||(v.value=t,L())}function pe(t){const e=t.target;e.files&&(ee(e.files),e.value="")}async function M(t){const e=await t.text();try{const a=JSON.parse(e),o=(a==null?void 0:a.detail)??(a==null?void 0:a.error)??(a==null?void 0:a.message)??e;if(typeof o=="string")return o;if(o&&typeof o=="object"){const g=o==null?void 0:o.message;return typeof g=="string"?g:JSON.stringify(o)}return String(o||`HTTP ${t.status}`)}catch{return e||`HTTP ${t.status}`}}async function D(t,e={}){const a=(e.method||"GET").toUpperCase(),o=new Headers(e.headers||{});if(!["GET","HEAD","OPTIONS"].includes(a))for(const[g,b]of Object.entries(De()))o.set(g,b);return fetch(t,{...e,headers:o,credentials:"include"})}async function C(){J.value=!0;try{const t=new URLSearchParams;t.set("offset",String(p.value)),t.set("limit",String(_.value)),V.value.trim()&&t.set("name",V.value.trim());const e=await D(`/api/v1/products?${t.toString()}`);if(!e.ok)throw new Error(await M(e));const a=await e.json();N.value=a.products,I.value=a.total,p.value=a.offset,_.value=a.limit}catch(t){y(t.message||String(t))}finally{J.value=!1}}async function me(t){const e=await D(`/api/v1/products/${t}`);if(!e.ok)throw new Error(await M(e));return await e.json()}function ae(){T(),H(),r.value=[],h.value=[],v.value=0,P.value=!1,w.value=null,L(),n.name="",n.dimensions="",n.featuresText="",n.characteristicsText="",n.rawText=""}async function ge(){if(T(),!G.value){y("请先选择图片");return}j.value=!0;try{const t=new FormData;t.append("image",G.value.file);const e=n.rawText.trim();e&&t.append("raw_text",e);const a=await D("/api/v1/products/recognize",{method:"POST",body:t});if(!a.ok)throw new Error(await M(a));const o=await a.json();n.name=o.name||"",n.dimensions=o.dimensions||"",n.featuresText=(o.features||[]).join(`
`),n.characteristicsText=(o.characteristics||[]).join(`
`),k.value=o.confidence,x.value={confidence:o.confidence,metadata:o.metadata||{}},$(`AI整理完成（置信度：${Math.round(o.confidence*100)}%），可编辑后保存`)}catch(t){y(t.message||String(t))}finally{j.value=!1}}async function he(){if(T(),r.value.length===0){y("请先选择图片");return}d.value=!0;try{const t=new FormData;for(const Te of r.value)t.append("images",Te.file);t.append("primary_index",String(v.value));const e=n.name.trim();e&&t.append("name",e),n.dimensions.trim()&&t.append("dimensions",n.dimensions.trim());const a=F(n.featuresText),o=F(n.characteristicsText);a.length&&t.append("features",JSON.stringify(a)),o.length&&t.append("characteristics",JSON.stringify(o)),x.value?(t.append("recognition_mode","prefill"),t.append("recognition_confidence",String(x.value.confidence)),t.append("recognition_metadata_json",JSON.stringify(x.value.metadata))):t.append("recognition_mode","manual");const g=await D("/api/v1/products",{method:"POST",body:t});if(!g.ok)throw new Error(await M(g));const b=await g.json();$(`创建成功（AI：${Math.round((b.recognition_confidence??0)*100)}%），可继续编辑后保存`),w.value=b.id,k.value=b.recognition_confidence??0,x.value=null,H(),r.value=[],v.value=0,h.value=b.images||[],n.name=b.name||"",n.dimensions=b.dimensions||"",n.featuresText=(b.features||[]).join(`
`),n.characteristicsText=(b.characteristics||[]).join(`
`),await C()}catch(t){y(t.message||String(t))}finally{d.value=!1}}async function ye(){if(T(),!!w.value){if(!n.name.trim()){y("产品名称不能为空");return}d.value=!0;try{const t={name:n.name.trim(),dimensions:n.dimensions.trim()||null,features:F(n.featuresText),characteristics:F(n.characteristicsText)},e=await D(`/api/v1/products/${w.value}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(await M(e));const a=await e.json();k.value=a.recognition_confidence,h.value=a.images||h.value,$("已保存修改"),await C()}catch(t){y(t.message||String(t))}finally{d.value=!1}}}async function _e(t){T(),d.value=!0;try{const e=await me(t);w.value=e.id,k.value=e.recognition_confidence??null,H(),r.value=[],v.value=0,h.value=e.images||[],x.value=null,n.name=e.name||"",n.dimensions=e.dimensions||"",n.featuresText=(e.features||[]).join(`
`),n.characteristicsText=(e.characteristics||[]).join(`
`),$("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{d.value=!1}}async function be(t){if(T(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){d.value=!0;try{const e=await D(`/api/v1/products/${t}`,{method:"DELETE"});if(!e.ok&&e.status!==204)throw new Error(await M(e));w.value===t&&ae(),$("已删除产品"),p.value>0&&N.value.length===1&&(p.value=Math.max(0,p.value-_.value)),await C()}catch(e){y(e.message||String(e))}finally{d.value=!1}}}function we(){p.value=Math.max(0,p.value-_.value),C()}function ke(){p.value+_.value>=I.value||(p.value=p.value+_.value,C())}function xe(){W&&window.clearTimeout(W),W=window.setTimeout(()=>{p.value=0,C()},250)}return Ie(async()=>{try{const t=await Me();z.value=!!(t!=null&&t.is_admin)}catch{z.value=!1}await C()}),(t,e)=>(l(),i("div",Ee,[s("header",Oe,[e[7]||(e[7]=R('<div class="logo" data-v-f4936fcd><div class="logo-icon" data-v-f4936fcd><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-f4936fcd><rect x="3" y="3" width="18" height="18" rx="2" data-v-f4936fcd></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-f4936fcd></circle><polyline points="21 15 16 10 5 21" data-v-f4936fcd></polyline></svg></div><span data-v-f4936fcd>产品库</span></div>',1)),s("div",Ae,[e[6]||(e[6]=R('<a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;" data-v-f4936fcd><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f4936fcd><path d="M19 12H5M12 19l-7-7 7-7" data-v-f4936fcd></path></svg> 返回主页面 </a><a href="/video" class="btn btn-secondary" style="text-decoration:none;" data-v-f4936fcd>视频生成</a><a href="/image" class="btn btn-secondary" style="text-decoration:none;" data-v-f4936fcd>图像处理</a><a href="/storage" class="btn btn-secondary" style="text-decoration:none;" data-v-f4936fcd>存储库</a>',4)),z.value?(l(),i("a",$e,"Admin")):u("",!0)])]),s("div",Le,[s("aside",Be,[s("section",Ne,[s("div",Ve,[s("div",Fe,[e[8]||(e[8]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),s("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),s("polyline",{points:"21 15 16 10 5 21"})],-1)),Pe(" "+f(m.value?"编辑产品":"创建产品"),1)]),m.value?(l(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:ae}," 退出编辑 ")):u("",!0)]),e[17]||(e[17]=s("div",{class:"section-subtitle"},"上传产品图片，AI 自动识别结构化信息，支持多图管理",-1)),s("div",He,[e[10]||(e[10]=s("label",{class:"form-label"},"产品图片",-1)),s("div",{class:q(["upload-area",{"drag-over":P.value,"is-loading":d.value||j.value,"is-disabled":m.value}]),onClick:S(te,["stop"]),onDragenter:S(le,["prevent"]),onDragover:S(re,["prevent"]),onDragleave:S(ce,["prevent"]),onDrop:S(ue,["prevent"])},[s("input",{ref_key:"fileInput",ref:X,type:"file",accept:"image/jpeg,image/png",multiple:"",disabled:m.value,onChange:pe},null,40,Re),e[9]||(e[9]=R('<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f4936fcd><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-f4936fcd></path><polyline points="17 8 12 3 7 8" data-v-f4936fcd></polyline><line x1="12" y1="3" x2="12" y2="15" data-v-f4936fcd></line></svg><p class="upload-text" data-v-f4936fcd><strong data-v-f4936fcd>拖拽或点击上传多张产品图</strong></p><p class="upload-hint" data-v-f4936fcd>主图用于 AI 识别与列表展示</p>',3))],34),s("div",ze,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:m.value,onClick:S(te,["stop"])}," 选择图片 ",8,Je),r.value.length>0?(l(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:S(de,["stop"])}," 清空 ")):u("",!0)])]),s("div",We,[e[11]||(e[11]=s("label",{class:"form-label"},"主图预览",-1)),s("div",Ge,[Y.value?(l(),i("img",{key:0,src:Y.value,alt:"preview",class:"preview-image"},null,8,qe)):(l(),i("div",Qe,"未选择图片"))]),k.value!==null?(l(),i("div",Ke," AI 置信度："+f(Math.round(k.value*100))+"% ",1)):u("",!0)]),Z.value>0?(l(),i("div",Xe,[s("span",Ye,"已选择 "+f(Z.value)+" 张图片",1),m.value&&r.value.length===0?(l(),i("span",Ze,"编辑模式下图片不可替换")):u("",!0)])):u("",!0),r.value.length>0?(l(),i("div",et,[(l(!0),i(Q,null,K(r.value,(a,o)=>(l(),i("div",{key:a.id,class:q(["preview-item",{"is-primary":o===v.value}])},[s("img",{src:a.url,alt:`image-${o+1}`,class:"preview-img"},null,8,tt),o===v.value?(l(),i("div",at,"主图")):u("",!0),s("div",st,[o!==v.value?(l(),i("button",{key:0,class:"preview-action-btn",type:"button",onClick:g=>fe(o)}," 设为主图 ",8,nt)):u("",!0),s("button",{class:"preview-action-btn danger",type:"button",onClick:g=>ve(o)},"移除",8,ot)])],2))),128))])):h.value.length>0?(l(),i("div",it,[(l(!0),i(Q,null,K(h.value,a=>(l(),i("div",{key:a.id,class:q(["preview-item",{"is-primary":a.is_primary}])},[s("img",{src:a.image_url,alt:a.id,class:"preview-img"},null,8,lt),a.is_primary?(l(),i("div",rt,"主图")):u("",!0)],2))),128))])):u("",!0),s("div",ct,[e[12]||(e[12]=s("label",{class:"form-label"},"产品名称",-1)),U(s("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>n.name=a),class:"form-input",type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[E,n.name]])]),s("div",ut,[e[13]||(e[13]=s("label",{class:"form-label"},"尺寸规格",-1)),U(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>n.dimensions=a),class:"form-input",type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[E,n.dimensions]])]),s("div",dt,[e[14]||(e[14]=s("label",{class:"form-label"},"无结构化信息（可选）",-1)),U(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>n.rawText=a),rows:"3",class:"form-input",disabled:m.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,vt),[[E,n.rawText]])]),s("div",ft,[e[15]||(e[15]=s("label",{class:"form-label"},"功能特征（每行一个）",-1)),U(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>n.featuresText=a),rows:"4",class:"form-input"},null,512),[[E,n.featuresText]])]),s("div",pt,[e[16]||(e[16]=s("label",{class:"form-label"},"产品特点（每行一个）",-1)),U(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>n.characteristicsText=a),rows:"4",class:"form-input",placeholder:`例如：
便携
大容量`},null,512),[[E,n.characteristicsText]])]),s("div",mt,[m.value?u("",!0):(l(),i("button",{key:0,class:"btn btn-secondary",type:"button",disabled:d.value||j.value,onClick:ge},f(j.value?"AI整理中...":"AI整理预填"),9,gt)),m.value?(l(),i("button",{key:2,class:"btn btn-primary",type:"button",disabled:d.value,onClick:ye},f(d.value?"保存中...":"保存修改"),9,yt)):(l(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:d.value||j.value,onClick:he},f(d.value?"保存中...":"保存产品"),9,ht))])])]),s("main",_t,[s("div",bt,[O.value?(l(),i("section",wt,f(O.value),1)):u("",!0),A.value?(l(),i("section",kt,f(A.value),1)):u("",!0),s("section",xt,[s("div",Tt,[e[19]||(e[19]=R('<div class="section-title section-title-lg" data-v-f4936fcd><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f4936fcd><path d="M3 3h7v7H3z" data-v-f4936fcd></path><path d="M14 3h7v7h-7z" data-v-f4936fcd></path><path d="M3 14h7v7H3z" data-v-f4936fcd></path><path d="M14 14h7v7h-7z" data-v-f4936fcd></path></svg> 产品列表 </div>',1)),s("div",Ct,[e[18]||(e[18]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("circle",{cx:"11",cy:"11",r:"8"}),s("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),U(s("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>V.value=a),class:"form-input",type:"text",placeholder:"搜索产品名称...",onInput:xe},null,544),[[E,V.value]])])]),J.value?(l(),i("div",St,"加载中...")):(l(),i("div",It,[N.value.length===0?(l(),i("div",Pt,"暂无产品")):(l(),i("div",jt,[(l(!0),i(Q,null,K(N.value,a=>(l(),i("div",{key:a.id,class:"product-card"},[s("div",Mt,[s("img",{src:a.original_image_url,alt:a.name},null,8,Dt),a.image_count>1?(l(),i("span",Ut,f(a.image_count)+" 张",1)):u("",!0)]),s("div",Et,[s("div",Ot,f(a.name),1),s("div",At,[a.dimensions?(l(),i("span",$t,f(a.dimensions),1)):u("",!0),a.image_count>1?(l(),i("span",Lt,"· "+f(a.image_count)+" 张",1)):u("",!0),a.created_at?(l(),i("span",Bt,"· "+f(ne(a.created_at)),1)):u("",!0)]),a.recognition_confidence!==null?(l(),i("div",Nt," AI："+f(Math.round((a.recognition_confidence??0)*100))+"% ",1)):u("",!0),s("div",Vt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:d.value,onClick:o=>_e(a.id)}," 编辑 ",8,Ft),s("button",{class:"btn btn-ghost btn-sm danger",type:"button",disabled:d.value,onClick:o=>be(a.id)}," 删除 ",8,Ht)])])]))),128))])),I.value>_.value?(l(),i("div",Rt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:p.value===0||d.value,onClick:we}," 上一页 ",8,zt),s("span",Jt," 第 "+f(Math.floor(p.value/_.value)+1)+" / "+f(Math.max(1,Math.ceil(I.value/_.value)))+" 页（"+f(I.value)+" 条） ",1),s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:p.value+_.value>=I.value||d.value,onClick:ke}," 下一页 ",8,Wt)])):u("",!0)]))])])])])]))}}),qt=Ue(Gt,[["__scopeId","data-v-f4936fcd"]]);je(qt).mount("#app");
