import{d as Ct,o as xt,a as Bt,b as St,i as Ye,e as E,j as Lt}from"./runtime-dom.esm-bundler-BMO6sHJC.js";import{g as Tt}from"./auth-DhJl3iPe.js";/* empty css                   */const Mt={class:"video-page"},Pt=Ct({__name:"video-page",setup(n){return xt(async()=>{try{const y=await Tt();if(y!=null&&y.is_admin){const b=document.getElementById("adminLink");b&&(b.style.display="inline-flex")}}catch{}}),(y,b)=>(St(),Bt("div",Mt,[...b[0]||(b[0]=[Ye('<header class="header"><div class="logo"><div class="logo-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><span>Video Generation Studio</span></div><div class="header-actions"><a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg> 返回主页面 </a><button class="btn btn-ghost btn-icon" id="historyBtn" title="History"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></button><a href="/admin" class="btn btn-ghost btn-icon" id="adminLink" title="Admin" style="text-decoration:none;display:none;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1l3 5 5 1-3.5 4.2.8 5.8L12 15l-5.3 2.9.8-5.8L4 7l5-1 3-5z"></path></svg></a><a href="/storage" class="btn btn-ghost btn-icon" title="存储库" style="text-decoration:none;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></a></div></header><div class="main-container"><aside class="sidebar"><section class="sidebar-section config-section"><div class="section-title collapsible-header" data-target="configContent"><span style="display:flex;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"></path><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4"></path></svg> API Configuration </span><svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div><div class="collapsible-content" id="configContent"><div class="config-content-inner"><div class="form-group"><label class="form-label">API Key</label><div class="input-wrapper"><input type="password" class="form-input" id="apiKey" placeholder="Enter your API key" autocomplete="current-password"><button class="toggle-visibility" data-target="apiKey"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div><div class="form-hint">Authorization: Bearer &lt;key&gt;</div></div><div class="form-group"><label class="form-label">Base URL</label><div class="input-wrapper"><input type="password" class="form-input" id="baseUrl" placeholder="https://api.gpt-best.com" value="https://api.gpt-best.com"><button class="toggle-visibility" data-target="baseUrl"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div></div><div class="btn-group" style="margin-top:16px;"><button class="btn btn-primary" id="saveConfigBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save </button><button class="btn btn-secondary" id="resetConfigBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg> Reset </button></div></div></div></section><section class="sidebar-section"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> Model Selection </div><div class="form-group"><label class="form-label">模型</label><select class="form-select" id="modelSelect"><option value="sora2">Sora 2</option><option value="veo">Google Veo</option><option value="seedance">Seedance (即梦)</option><option value="newmodel">New Model</option></select></div><div id="sora2Params" class="model-params"><div class="form-group"><label class="form-label">Sora 版本</label><select class="form-select" id="soraVariant"><option value="sora-2">sora-2</option><option value="sora-2-pro">sora-2-pro</option></select></div></div></section><section class="sidebar-section"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line></svg> Video Parameters </div><div class="form-group"><label class="form-label">画幅比例</label><select class="form-select" id="aspectRatio"><option value="16:9">16:9 (Landscape)</option><option value="9:16">9:16 (Portrait)</option></select></div><div class="form-group"><label class="form-label">时长（秒）</label><select class="form-select" id="duration"><option value="10">10</option><option value="15">15</option><option value="25">25</option></select></div><div class="form-group"><label class="form-label">选项</label><div class="checkbox-group"><label class="checkbox-item"><input id="soraHd" type="checkbox"><span>HD（仅 Pro）</span></label><label class="checkbox-item"><input id="soraWatermark" type="checkbox"><span>水印</span></label><label class="checkbox-item"><input id="soraPrivate" type="checkbox"><span>私有</span></label></div></div><div class="form-group"><label class="form-label">任务名称（可选）</label><input class="form-input" id="taskNameInput" type="text" placeholder="例如：海边日落"></div><div class="form-group"><label class="form-label">并发数量</label><input class="form-input" id="batchCount" type="number" min="1" max="20" value="1"><div class="form-hint">一次可并发提交多个任务</div></div></section></aside><main class="main-content"><div class="result-area" id="resultArea"><div class="result-placeholder" id="resultPlaceholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><polygon points="10 8 16 12 10 16 10 8"></polygon></svg><h3>Ready to Create</h3><p>Configure settings, enter a prompt, and click Generate</p></div><div class="loading-state hidden" id="loadingState"><div class="spinner"></div><p>Generating your video...</p><div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div><span class="progress-text" id="progressText">0%</span></div><div id="resultContainer" class="hidden"><div class="result-video-container"><video id="resultVideo" controls></video></div><div class="result-actions"><button class="btn btn-secondary" id="downloadBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download </button><button class="btn btn-secondary" id="shareBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg> Share </button><button class="btn btn-secondary" id="fullscreenBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg> Fullscreen </button></div></div></div><div class="main-prompt-section"><div class="prompt-input-row"><div class="prompt-input-wrapper"><textarea class="prompt-textarea" id="promptInput" placeholder="描述您想生成的视频内容..."></textarea><div class="prompt-history-dropdown" id="promptHistoryDropdown"></div></div><div class="prompt-upload"><div class="upload-area upload-area-compact" id="promptDropzone"><input id="promptImages" type="file" accept="image/*" multiple><button id="promptPickFiles" type="button" class="upload-trigger upload-trigger-compact"><svg class="upload-icon upload-icon-compact" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p class="upload-text upload-text-compact"><strong>上传参考图</strong></p><p class="upload-hint upload-hint-compact">拖拽 / 粘贴 / 点击</p></button><div class="upload-feedback" id="promptUploadFeedback" aria-live="polite"><div class="upload-feedback-text" id="promptUploadText">处理中…</div><div class="upload-feedback-bar"><div class="upload-feedback-bar-fill" id="promptUploadProgress"></div></div><div class="upload-feedback-meta" id="promptUploadMeta"></div></div></div><div class="prompt-image-preview hidden" id="promptImagePreviewWrap"><div class="image-meta"><span class="meta-text" id="promptImageCount">0 张图片</span><button id="promptClearImages" type="button" class="btn btn-secondary btn-sm">清空</button></div><div class="image-preview-grid" id="promptImagePreview"></div></div></div></div><div class="prompt-footer"><div style="display:flex;align-items:center;gap:16px;"><span class="char-count"><span id="charCount">0</span> characters</span><div class="status-indicator"><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div></div><div style="display:flex;align-items:center;gap:16px;"><button class="prompt-history-btn" id="showPromptHistory"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> History </button><button class="generate-btn-large" id="generateBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span class="btn-text">Generate</span><span class="loader"></span></button></div></div></div><div class="inline-history-section" id="inlineHistorySection"><div class="inline-history-header"><div class="inline-history-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>Generation History</span><span class="inline-history-count" id="inlineHistoryCount">0</span></div><button class="inline-history-toggle" id="inlineHistoryToggle" title="Toggle history"><svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div><div class="inline-history-content" id="inlineHistoryContent"><div class="inline-history-grid" id="inlineHistoryGrid"><p class="inline-history-empty">No generation history yet. Create your first video!</p></div><div class="inline-history-show-more" id="inlineHistoryShowMore" style="display:none;"><button class="btn btn-ghost" id="showMoreHistoryBtn"> Show more <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div></div></div></main></div><div class="history-panel" id="historyPanel"><div class="history-header"><h3>Tasks &amp; History</h3><button class="btn btn-ghost btn-icon" id="closeHistoryBtn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="history-panel-content"><div class="task-toolbar"><span id="taskSummary" class="meta-text">0 个任务</span><button id="clearCompletedBtn" type="button" class="btn btn-secondary btn-sm">清理已完成</button></div><div class="task-list-wrap"><div id="taskList" class="task-list"></div><div id="taskListFooter" class="task-list-footer hidden"><button id="loadMoreTasksBtn" type="button" class="btn btn-secondary btn-sm">加载更多</button></div></div></div></div>',3),E("div",{id:"imageModal",class:"modal hidden",role:"dialog","aria-modal":"true","aria-labelledby":"imageModalTitle"},[E("div",{class:"modal-backdrop",id:"modalBackdrop"}),E("div",{class:"modal-content",role:"document"},[E("div",{class:"modal-header"},[E("h3",{id:"imageModalTitle"},"图片预览"),E("button",{id:"modalClose",class:"btn btn-ghost btn-icon",type:"button","aria-label":"关闭"},[E("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[E("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),E("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])])]),E("div",{class:"modal-body"},[E("div",{class:"modal-image-wrapper"},[E("img",{id:"modalImage",alt:"预览"})]),E("div",{class:"form-group"},[E("label",{class:"form-label",for:"modalValue"},"URL / Base64（可编辑）"),E("textarea",{class:"form-input",id:"modalValue",rows:"4"})])]),E("div",{class:"modal-actions"},[E("button",{id:"modalCopy",type:"button",class:"btn btn-secondary"},"复制"),E("button",{id:"modalSave",type:"button",class:"btn btn-primary"},"保存")])])],-1),Ye('<div class="edit-prompt-modal-overlay hidden" id="editPromptModalOverlay"><div class="edit-prompt-modal"><div class="edit-prompt-modal-header"><h3>Edit Prompt</h3><button class="btn btn-ghost btn-icon" id="closeEditPromptModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="edit-prompt-modal-body"><textarea class="edit-prompt-textarea" id="editPromptTextarea" placeholder="Enter prompt..."></textarea></div><div class="edit-prompt-modal-footer"><button class="btn btn-ghost" id="cancelEditPromptBtn">Cancel</button><button class="btn btn-primary" id="saveEditPromptBtn">Save</button></div></div></div><div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>',2)])]))}});document.addEventListener("DOMContentLoaded",()=>{var Ge,Je,Qe,Xe,Ze;const n={apiKey:document.getElementById("apiKey"),baseUrl:document.getElementById("baseUrl"),toggleApiKey:document.getElementById("toggleApiKey"),modelSelect:document.getElementById("modelSelect"),promptInput:document.getElementById("promptInput"),taskNameInput:document.getElementById("taskNameInput"),batchCount:document.getElementById("batchCount"),sora2Params:document.getElementById("sora2Params"),soraVariant:document.getElementById("soraVariant"),aspectRatio:document.getElementById("aspectRatio"),duration:document.getElementById("duration"),soraHd:document.getElementById("soraHd"),soraWatermark:document.getElementById("soraWatermark"),soraPrivate:document.getElementById("soraPrivate"),soraImages:document.getElementById("soraImages"),soraDropzone:document.getElementById("soraDropzone"),soraPickFiles:document.getElementById("soraPickFiles"),soraClearImages:document.getElementById("soraClearImages"),soraImageCount:document.getElementById("soraImageCount"),soraImagePreview:document.getElementById("soraImagePreview"),soraImageSourceInput:document.getElementById("soraImageSourceInput"),soraAddImageSources:document.getElementById("soraAddImageSources"),soraUploadFeedback:document.getElementById("soraUploadFeedback"),soraUploadText:document.getElementById("soraUploadText"),soraUploadProgress:document.getElementById("soraUploadProgress"),soraUploadMeta:document.getElementById("soraUploadMeta"),promptImages:document.getElementById("promptImages"),promptDropzone:document.getElementById("promptDropzone"),promptPickFiles:document.getElementById("promptPickFiles"),promptUploadFeedback:document.getElementById("promptUploadFeedback"),promptUploadText:document.getElementById("promptUploadText"),promptUploadProgress:document.getElementById("promptUploadProgress"),promptUploadMeta:document.getElementById("promptUploadMeta"),promptImagePreviewWrap:document.getElementById("promptImagePreviewWrap"),promptImageCount:document.getElementById("promptImageCount"),promptImagePreview:document.getElementById("promptImagePreview"),promptClearImages:document.getElementById("promptClearImages"),notifyHook:document.getElementById("notifyHook"),generateBtn:document.getElementById("generateBtn"),statusContainer:document.getElementById("statusContainer"),statusContent:document.getElementById("statusContent"),taskSummary:document.getElementById("taskSummary"),clearCompletedBtn:document.getElementById("clearCompletedBtn"),taskList:document.getElementById("taskList"),taskListFooter:document.getElementById("taskListFooter"),loadMoreTasksBtn:document.getElementById("loadMoreTasksBtn"),imageModal:document.getElementById("imageModal"),modalBackdrop:document.getElementById("modalBackdrop"),modalClose:document.getElementById("modalClose"),modalImage:document.getElementById("modalImage"),modalValue:document.getElementById("modalValue"),modalCopy:document.getElementById("modalCopy"),modalSave:document.getElementById("modalSave"),toastContainer:document.getElementById("toastContainer"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),saveConfigBtn:document.getElementById("saveConfigBtn"),resetConfigBtn:document.getElementById("resetConfigBtn"),charCount:document.getElementById("charCount"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultVideo:document.getElementById("resultVideo"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText")},y={submitDebounceMs:120,confirmBatchThreshold:6,maxBatchCount:20,renderPageSize:20,maxTasks:200,cleanupAfterMs:600*1e3,pollIntervalMs:4e3,pollJitterMs:600,maxPollErrors:3,createConcurrency:4,pollConcurrency:8,saveConcurrency:2,maxLogsPerTask:200,imageCompressThresholdBytes:5*1024*1024,imageMaxDimension:2048},b={items:[],editingId:null,readingCount:0},p={byLocalId:new Map,order:[],renderLimit:y.renderPageSize,nextIndex:1,lastSubmitAt:0,createQueue:ee(y.createConcurrency),pollQueue:ee(y.pollConcurrency),saveQueue:ee(y.saveConcurrency)};n.apiKey.value=localStorage.getItem("video_api_key")||"";const xe=n.baseUrl.value||"https://api.gpt-best.com",et=localStorage.getItem("video_base_url")||xe;try{n.baseUrl.value=j(et)}catch{n.baseUrl.value=xe,localStorage.removeItem("video_base_url")}const ne=localStorage.getItem("video_model");ne&&Array.from(n.modelSelect.options).some(e=>e.value===ne)&&(n.modelSelect.value=ne);const se=localStorage.getItem("video_sora_variant");se&&Array.from(n.soraVariant.options).some(e=>e.value===se)&&(n.soraVariant.value=se);const ie=localStorage.getItem("video_aspect_ratio");ie&&Array.from(n.aspectRatio.options).some(e=>e.value===ie)&&(n.aspectRatio.value=ie);const re=localStorage.getItem("video_duration");re&&Array.from(n.duration.options).some(e=>e.value===re)&&(n.duration.value=re);const Be=localStorage.getItem("video_batch_count");if(Be){const e=Number.parseInt(Be,10);Number.isFinite(e)&&e>=1&&e<=y.maxBatchCount&&(n.batchCount.value=String(e))}tt();function tt(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-target")||"",t=o?document.getElementById(o):null;t&&(t.type=t.type==="password"?"text":"password")})})}if(n.apiKey.addEventListener("change",()=>localStorage.setItem("video_api_key",n.apiKey.value)),n.baseUrl.addEventListener("change",()=>{try{const e=j(n.baseUrl.value);n.baseUrl.value=e,localStorage.setItem("video_base_url",e)}catch(e){I(`错误: ${e.message}`,"error"),localStorage.removeItem("video_base_url"),n.baseUrl.focus()}}),n.modelSelect.addEventListener("change",()=>{localStorage.setItem("video_model",n.modelSelect.value),ke()}),n.soraVariant.addEventListener("change",()=>{localStorage.setItem("video_sora_variant",n.soraVariant.value),W()}),n.aspectRatio.addEventListener("change",()=>{localStorage.setItem("video_aspect_ratio",n.aspectRatio.value)}),n.duration.addEventListener("change",()=>{localStorage.setItem("video_duration",n.duration.value),W()}),n.soraHd.addEventListener("change",W),n.batchCount.addEventListener("change",()=>{const e=Number.parseInt(String(n.batchCount.value||"1"),10);if(Number.isFinite(e)){const o=Math.min(y.maxBatchCount,Math.max(1,e));n.batchCount.value=String(o),localStorage.setItem("video_batch_count",String(o))}}),n.soraPickFiles&&n.soraImages&&(n.soraPickFiles.addEventListener("click",()=>n.soraImages.click()),n.soraImages.addEventListener("change",async()=>{const e=n.soraImages.files?Array.from(n.soraImages.files):[];await Q(e,{source:"sora"}),n.soraImages.value=""})),n.promptPickFiles&&n.promptImages&&(n.promptPickFiles.addEventListener("click",()=>n.promptImages.click()),n.promptImages.addEventListener("change",async()=>{const e=n.promptImages.files?Array.from(n.promptImages.files):[];await Q(e,{source:"prompt"}),n.promptImages.value=""})),n.soraClearImages&&n.soraClearImages.addEventListener("click",()=>{b.items=[],k(),I("已清空参考图片","info")}),n.promptClearImages&&n.promptClearImages.addEventListener("click",()=>{b.items=[],k(),I("已清空参考图片","info")}),n.soraAddImageSources&&n.soraImageSourceInput&&(n.soraAddImageSources.addEventListener("click",()=>{const e=n.soraImageSourceInput.value,o=de(e);o>0&&(n.soraImageSourceInput.value="",k(),I(`已添加 ${o} 个图片来源`,"success"))}),n.soraImageSourceInput.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),n.soraAddImageSources.click())})),st(),it(),(Ge=n.generateBtn)==null||Ge.addEventListener("click",je),(Je=n.clearCompletedBtn)==null||Je.addEventListener("click",()=>{ft(),q(),g("已清理已完成任务","info")}),(Qe=n.loadMoreTasksBtn)==null||Qe.addEventListener("click",()=>{p.renderLimit+=y.renderPageSize,q()}),n.historyBtn&&n.historyBtn.addEventListener("click",()=>{var e;(e=n.historyPanel)==null||e.classList.add("open"),document.body.classList.add("panel-open")}),n.closeHistoryBtn&&n.closeHistoryBtn.addEventListener("click",()=>{var e;(e=n.historyPanel)==null||e.classList.remove("open"),document.body.classList.remove("panel-open")}),(Xe=n.historyPanel)==null||Xe.addEventListener("click",e=>{e.target===n.historyPanel&&(n.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"))}),document.querySelectorAll(".collapsible-header").forEach(e=>{const o=e.dataset.target,t=document.getElementById(o);if(!t)return;const s=localStorage.getItem(`collapsed_${o}`);(s===null?o==="configContent":s==="true")&&(e.classList.add("collapsed"),t.classList.add("collapsed")),e.addEventListener("click",()=>{const i=e.classList.toggle("collapsed");t.classList.toggle("collapsed",i),localStorage.setItem(`collapsed_${o}`,String(i))})}),n.saveConfigBtn&&n.saveConfigBtn.addEventListener("click",()=>{localStorage.setItem("video_api_key",n.apiKey.value);try{const e=j(n.baseUrl.value);localStorage.setItem("video_base_url",e),n.baseUrl.value=e}catch(e){I(`Base URL 错误: ${e.message}`,"error")}g("配置已保存","success")}),n.resetConfigBtn&&n.resetConfigBtn.addEventListener("click",()=>{confirm("确定要重置配置吗？这将清除保存的 API Key 和 Base URL。")&&(localStorage.removeItem("video_api_key"),localStorage.removeItem("video_base_url"),n.apiKey.value="",n.baseUrl.value="https://api.gpt-best.com",g("配置已重置","info"))}),n.promptInput&&n.charCount){const e=()=>{n.charCount.textContent=`${n.promptInput.value.length} 字符`};n.promptInput.addEventListener("input",e),e()}n.inlineHistoryToggle&&n.inlineHistoryContent&&(localStorage.getItem("inlineHistoryCollapsed")==="true"&&((Ze=n.inlineHistorySection)==null||Ze.classList.add("collapsed")),n.inlineHistoryToggle.addEventListener("click",()=>{var t;const o=(t=n.inlineHistorySection)==null?void 0:t.classList.toggle("collapsed");localStorage.setItem("inlineHistoryCollapsed",String(o))})),document.addEventListener("keydown",e=>{var o;if(e.key==="Escape"){(o=n.historyPanel)!=null&&o.classList.contains("open")&&(n.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"),e.preventDefault());const t=document.getElementById("editPromptModalOverlay");t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.preventDefault())}(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&document.activeElement===n.promptInput&&(e.preventDefault(),je())});const U={items:[],displayLimit:6,loading:!1};async function z(){if(!U.loading){U.loading=!0;try{const e=await fetch("/api/v1/videos?limit=50",{credentials:"include",headers:G()});if(!e.ok){if(e.status===401){U.items=[],ae();return}throw new Error(`加载失败 (${e.status})`)}const o=await e.json();U.items=Array.isArray(o)?o:o.items||[],ae()}catch(e){I(`加载历史记录失败: ${e.message}`,"error")}finally{U.loading=!1}}}function ae(){if(!n.inlineHistoryGrid||!n.inlineHistoryCount)return;const e=U.items;if(n.inlineHistoryCount.textContent=e.length,e.length===0){n.inlineHistoryGrid.innerHTML='<div class="inline-history-empty">暂无生成记录</div>',n.showMoreHistoryBtn&&(n.showMoreHistoryBtn.style.display="none");return}const o=e.slice(0,U.displayLimit);n.inlineHistoryGrid.innerHTML="",o.forEach(t=>{var h;const s=document.createElement("div");s.className="inline-history-item",s.dataset.id=t.id;const r=document.createElement("div");if(r.className="inline-history-thumb",t.video_url||t.thumbnail_url){const w=document.createElement("video");w.src=t.video_url||"",w.muted=!0,w.loop=!0,w.playsInline=!0,w.preload="metadata",r.appendChild(w),s.addEventListener("mouseenter",()=>w.play().catch(()=>{})),s.addEventListener("mouseleave",()=>{w.pause(),w.currentTime=0})}else r.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';const a=document.createElement("div");a.className="inline-history-info";const i=document.createElement("div");i.className="inline-history-prompt",i.textContent=(t.prompt||"无提示词").slice(0,60)+(((h=t.prompt)==null?void 0:h.length)>60?"...":""),i.title=t.prompt||"";const l=document.createElement("div");l.className="inline-history-meta";const c=t.model||"unknown",d=t.created_at?new Date(t.created_at).toLocaleDateString():"";l.textContent=`${c} · ${d}`,a.appendChild(i),a.appendChild(l);const u=document.createElement("div");u.className="inline-history-actions";const v=document.createElement("button");v.className="inline-history-btn",v.title="加载",v.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',v.addEventListener("click",w=>{w.stopPropagation(),Se(t)});const f=document.createElement("button");f.className="inline-history-btn",f.title="编辑提示词",f.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',f.addEventListener("click",w=>{w.stopPropagation(),ot(t)});const m=document.createElement("button");m.className="inline-history-btn danger",m.title="删除",m.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',m.addEventListener("click",w=>{w.stopPropagation(),nt(t.id)}),u.appendChild(v),u.appendChild(f),u.appendChild(m),s.appendChild(r),s.appendChild(a),s.appendChild(u),s.addEventListener("click",()=>Se(t)),n.inlineHistoryGrid.appendChild(s)}),n.showMoreHistoryBtn&&(n.showMoreHistoryBtn.style.display=e.length>U.displayLimit?"":"none")}function Se(e){var o,t;e.prompt&&(n.promptInput.value=e.prompt,n.charCount&&(n.charCount.textContent=`${e.prompt.length} 字符`)),e.video_url&&n.resultContainer&&n.resultVideo&&((o=n.resultPlaceholder)==null||o.classList.add("hidden"),(t=n.loadingState)==null||t.classList.add("hidden"),n.resultContainer.classList.remove("hidden"),n.resultVideo.src=e.video_url),g("已加载历史记录","success")}function ot(e){const o=document.getElementById("editPromptModalOverlay"),t=document.getElementById("editPromptTextarea"),s=document.getElementById("saveEditPromptBtn"),r=document.getElementById("cancelEditPromptBtn");if(!o||!t)return;t.value=e.prompt||"",o.classList.remove("hidden"),t.focus();const a=async()=>{const d=t.value.trim();if(!d){g("提示词不能为空","error");return}try{const u=await fetch(`/api/v1/videos/${e.id}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json",...G()},body:JSON.stringify({prompt:d})});if(!u.ok)throw new Error(`更新失败 (${u.status})`);o.classList.add("hidden"),g("提示词已更新","success"),z()}catch(u){g(`更新失败: ${u.message}`,"error")}},i=()=>{o.classList.add("hidden")},l=s.cloneNode(!0),c=r.cloneNode(!0);s.parentNode.replaceChild(l,s),r.parentNode.replaceChild(c,r),l.addEventListener("click",a),c.addEventListener("click",i)}async function nt(e){if(confirm("确定要删除这条记录吗？"))try{const o=await fetch(`/api/v1/videos/${e}`,{method:"DELETE",credentials:"include",headers:G()});if(!o.ok)throw new Error(`删除失败 (${o.status})`);g("已删除","success"),z()}catch(o){g(`删除失败: ${o.message}`,"error")}}n.showMoreHistoryBtn&&n.showMoreHistoryBtn.addEventListener("click",()=>{U.displayLimit+=6,ae()});function K(e){if(!(!n.statusDot||!n.statusText))switch(n.statusDot.className="status-dot",e){case"ready":n.statusDot.classList.add("ready"),n.statusText.textContent="就绪";break;case"generating":n.statusDot.classList.add("generating"),n.statusText.textContent="生成中...";break;case"error":n.statusDot.classList.add("error"),n.statusText.textContent="错误";break;default:n.statusText.textContent=e}}function Le(e){if(!(!n.resultPlaceholder||!n.loadingState||!n.resultContainer)){if(!e){n.resultPlaceholder.classList.remove("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.add("hidden"),K("ready");return}if(e.status==="completed"&&e.videoUrl)n.resultPlaceholder.classList.add("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.remove("hidden"),n.resultVideo&&(n.resultVideo.src=e.videoUrl),K("ready");else if(["pending","processing","queued"].includes(e.status)){n.resultPlaceholder.classList.add("hidden"),n.loadingState.classList.remove("hidden"),n.resultContainer.classList.add("hidden");const o=typeof e.progress=="number"?e.progress:0,t=Math.min(100,Math.max(0,o)),s=t>0?t:e.status==="queued"?1:2;n.progressFill&&(n.progressFill.style.width=`${s}%`),n.progressText&&(n.progressText.textContent=`${s}%`),K("generating")}else e.status==="failed"&&(n.resultPlaceholder.classList.remove("hidden"),n.loadingState.classList.add("hidden"),n.resultContainer.classList.add("hidden"),K("error"))}}z(),K("ready");const Te=document.getElementById("downloadBtn"),Me=document.getElementById("shareBtn"),Pe=document.getElementById("fullscreenBtn"),$e=document.getElementById("showPromptHistory"),Ue=document.getElementById("closeEditPromptModal");Te&&Te.addEventListener("click",()=>{var t;const e=(t=n.resultVideo)==null?void 0:t.src;if(!e){g("没有可下载的视频","warning");return}const o=document.createElement("a");o.href=e,o.download=`video_${Date.now()}.mp4`,o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o),g("开始下载视频","success")}),Me&&Me.addEventListener("click",async()=>{var o;const e=(o=n.resultVideo)==null?void 0:o.src;if(!e){g("没有可分享的视频","warning");return}if(navigator.share)try{await navigator.share({title:"Generated Video",url:e})}catch(t){t.name!=="AbortError"&&(X(e),g("链接已复制到剪贴板","success"))}else X(e),g("链接已复制到剪贴板","success")}),Pe&&Pe.addEventListener("click",()=>{const e=n.resultVideo;e&&(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}),$e&&$e.addEventListener("click",()=>{n.inlineHistorySection&&(n.inlineHistorySection.classList.remove("collapsed"),n.inlineHistorySection.scrollIntoView({behavior:"smooth",block:"start"}))}),Ue&&Ue.addEventListener("click",()=>{const e=document.getElementById("editPromptModalOverlay");e&&e.classList.add("hidden")}),n.taskList.addEventListener("click",e=>{const o=e.target instanceof Element?e.target:null;if(!o)return;const t=o.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const s=t.getAttribute("data-action")||"",r=t.closest("[data-local-id]"),a=r==null?void 0:r.getAttribute("data-local-id");if(a){if(s==="cancel"){ht(a);return}if(s==="retry"){yt(a);return}if(s==="copy-url"){const i=p.byLocalId.get(a),l=(i==null?void 0:i.videoUrl)||"";l&&(X(l),g("已复制视频链接","success"));return}if(s==="save"){const i=p.byLocalId.get(a);i&&ge(i,{manual:!0});return}}}),ke(),k(),q();const V={message:"",type:"",at:0};function I(e,o="info"){const t=String(e||""),s=String(o||"info");console[s==="error"?"error":s==="warning"?"warn":"log"](`[${s}] ${t}`);const a=s==="error"?"error":s==="warning"?"warning":s==="success"?"success":"info",i=Date.now();t&&(V.message!==t||V.type!==a||i-V.at>1200)&&(V.message=t,V.type=a,V.at=i,g(t,a))}function g(e,o="info",t={}){const s=Number.parseInt(String(t.durationMs??2800),10),r=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`t-${Date.now()}-${Math.random().toString(16).slice(2)}`,a=document.createElement("div");a.className=`toast toast-${o}`,a.setAttribute("data-toast-id",r),a.textContent=String(e||""),n.toastContainer.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")});const i=()=>{a.classList.remove("show"),a.classList.add("hide"),setTimeout(()=>a.remove(),220)};setTimeout(i,Number.isFinite(s)?s:2800),a.addEventListener("click",i)}function ke(){const o=n.modelSelect.value==="sora2";n.sora2Params.classList.toggle("hidden",!o),o&&W()}function W(){if(n.modelSelect.value!=="sora2")return;const e=n.soraVariant.value,o=Number.parseInt(n.duration.value,10),t=e==="sora-2-pro",s=t,r=t&&o!==25;for(const a of Array.from(n.duration.options))a.value==="25"&&(a.disabled=!s);!s&&o===25&&(n.duration.value="15"),n.soraHd.disabled=!r,r||(n.soraHd.checked=!1)}function st(){const e="drag-over";[{zone:n.soraDropzone,input:n.soraImages,source:"sora"},{zone:n.promptDropzone,input:n.promptImages,source:"prompt"}].filter(t=>t.zone&&t.input).forEach(({zone:t,input:s,source:r})=>{const a=i=>{const l=i.relatedTarget;l instanceof Node&&t.contains(l)||t.classList.remove(e)};t.addEventListener("dragenter",i=>{i.preventDefault(),i.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragover",i=>{i.preventDefault(),i.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragleave",i=>{i.preventDefault(),i.stopPropagation(),a(i)}),t.addEventListener("drop",async i=>{var c;i.preventDefault(),i.stopPropagation(),t.classList.remove(e);const l=(c=i.dataTransfer)!=null&&c.files?Array.from(i.dataTransfer.files):[];await Q(l,{source:r})}),t.addEventListener("paste",async i=>{var d;const c=((d=i.clipboardData)!=null&&d.items?Array.from(i.clipboardData.items):[]).filter(u=>u.kind==="file").map(u=>u.getAsFile()).filter(Boolean);c.length&&(i.preventDefault(),await Q(c,{source:r}))}),t.addEventListener("click",i=>{const l=i.target;l instanceof HTMLElement&&l.closest("button")||s.click()})})}function it(){const e=()=>me();n.modalBackdrop.addEventListener("click",e),n.modalClose.addEventListener("click",e),document.addEventListener("keydown",o=>{o.key==="Escape"&&!n.imageModal.classList.contains("hidden")&&e()}),n.modalCopy.addEventListener("click",async()=>{const o=String(n.modalValue.value||"");try{await navigator.clipboard.writeText(o),I("已复制到剪贴板","success")}catch{const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),I("已复制到剪贴板","success")}}),n.modalSave.addEventListener("click",()=>{const o=b.editingId;if(!o)return;const t=String(n.modalValue.value||"").trim();if(!t){I("错误: 图片内容不能为空","error");return}if(!le(t)){I("错误: 仅支持 http/https URL 或 data:image/...base64","error");return}const s=b.items.find(r=>r.id===o);s&&(s.value=t,s.kind=t.startsWith("data:image")?"data":"url",k(),me(),I("已更新图片内容","success"))})}function rt(e){return new Promise((o,t)=>{const s=new FileReader;s.onload=()=>o(String(s.result||"")),s.onerror=()=>t(s.error||new Error("读取文件失败")),s.readAsDataURL(e)})}function He(e){return String(e||"").split(/\r?\n/).map(o=>o.trim()).filter(Boolean)}function le(e){const o=String(e||"").trim();if(!o)return!1;if(o.startsWith("data:image"))return!0;try{const t=new URL(o);return["http:","https:"].includes(t.protocol)}catch{return!1}}function at(e){if(!e)return null;const o=e.trim();if(!o)return null;let t;try{t=new URL(o)}catch{throw new Error("notify_hook 必须是合法的 URL")}if(!["http:","https:"].includes(t.protocol))throw new Error("notify_hook 必须是 http/https URL");return t.toString()}function j(e){const o=String(e||"").trim();if(!o)throw new Error("请输入 Base URL");let t;try{t=new URL(o)}catch{throw new Error("Base URL 不是合法的 URL")}if(t.protocol!=="https:")throw new Error("Base URL 必须使用 HTTPS 协议");if(!t.hostname)throw new Error("Base URL 缺少 host，例如 https://api.example.com");const s=t.origin;return(t.pathname!=="/"||t.search||t.hash)&&I(`提示: Base URL 包含路径/参数，已自动使用 origin: ${s}`,"warning"),s}function lt(e){const o=t=>encodeURIComponent(String(t||""));switch(e){case"sora2":return{createPath:"/v2/videos/generations",statusPath:t=>`/v2/videos/generations/${o(t)}`};case"veo":return{createPath:"/v1/video/veo/text-to-video",statusPath:t=>`/v1/video/veo/tasks/${o(t)}`};case"seedance":return{createPath:"/v1/video/seedance/text-to-video",statusPath:t=>`/v1/video/seedance/tasks/${o(t)}`};case"newmodel":return{createPath:"/v1/video/newmodel/text-to-video",statusPath:t=>`/v1/video/newmodel/tasks/${o(t)}`};default:throw new Error(`不支持的模型: ${e}`)}}function Ne(e,o=!1){const s={Authorization:`Bearer ${De(e)}`};return o&&(s["Content-Type"]="application/json"),s}function De(e){return String(e||"").trim().replace(/^bearer\\s+/i,"").trim()}async function ce(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const t=await e.text();try{return JSON.parse(t)}catch{return t}}function ct(e,o){const r=`; ${typeof document<"u"?document.cookie:""}`.split(`; ${e}=`);return r.length===2?r.pop().split(";").shift():null}function G(){const e=ct("csrf_token");return e?{"X-CSRF-Token":e}:{}}function dt(e,o){if(typeof e=="string")return e;if(!e||typeof e!="object")return o;const t=e.detail??e.error??e.message;if(typeof t=="string")return t;if(Array.isArray(t))return t.map(s=>{if(!s||typeof s!="object")return String(s);const r=Array.isArray(s.loc)?s.loc.join("."):"",a=s.msg?String(s.msg):JSON.stringify(s);return r?`${r}: ${a}`:a}).join("; ");try{return JSON.stringify(t)}catch{return o}}function J(e){const o=Number(e||0);if(!Number.isFinite(o)||o<=0)return"0 B";const t=["B","KB","MB","GB"];let s=0,r=o;for(;r>=1024&&s<t.length-1;)r/=1024,s+=1;const a=s===0?0:s===1?1:2;return`${r.toFixed(a)} ${t[s]}`}function _e(e){const o=e==="prompt"?"prompt":"sora";return{zone:o==="prompt"?n.promptDropzone:n.soraDropzone,pickBtn:o==="prompt"?n.promptPickFiles:n.soraPickFiles,clearBtn:o==="prompt"?null:n.soraClearImages,textEl:o==="prompt"?n.promptUploadText:n.soraUploadText,progressEl:o==="prompt"?n.promptUploadProgress:n.soraUploadProgress,metaEl:o==="prompt"?n.promptUploadMeta:n.soraUploadMeta}}function $(e,{isProcessing:o,state:t,text:s,progress:r,meta:a}={}){const i=_e(e);if(i.zone&&(typeof o=="boolean"&&i.zone.classList.toggle("is-processing",o),t==="success"||t==="error"?(i.zone.classList.toggle("is-success",t==="success"),i.zone.classList.toggle("is-error",t==="error")):t==="clear"&&(i.zone.classList.remove("is-success"),i.zone.classList.remove("is-error")),i.textEl&&typeof s=="string"&&(i.textEl.textContent=s),i.metaEl&&typeof a=="string"&&(i.metaEl.textContent=a),i.progressEl&&typeof r=="number")){const l=Math.min(100,Math.max(0,r));i.progressEl.style.width=`${l}%`}}function Ae(e,o){const t=_e(e);t.zone&&(t.zone.classList.toggle("is-loading",o),t.pickBtn&&(t.pickBtn.disabled=o),t.clearBtn&&(t.clearBtn.disabled=o||b.items.length===0),e!=="prompt"&&(n.soraAddImageSources.disabled=o))}async function mt(e,o={}){const t=Number(o.thresholdBytes??y.imageCompressThresholdBytes),s=Number(o.maxDimension??y.imageMaxDimension);if(!e||!Number.isFinite(e.size)||e.size<=t)return{file:e,compressed:!1,originalBytes:(e==null?void 0:e.size)||0,outputBytes:(e==null?void 0:e.size)||0};const a=await(async()=>{if(globalThis.createImageBitmap)return await globalThis.createImageBitmap(e);const i=URL.createObjectURL(e);try{const l=new Image;return l.decoding="async",l.src=i,await new Promise((c,d)=>{l.onload=c,l.onerror=()=>d(new Error("图片解码失败"))}),l}finally{URL.revokeObjectURL(i)}})();try{const i=a.width||a.naturalWidth||0,l=a.height||a.naturalHeight||0;if(!i||!l)return{file:e,compressed:!1,originalBytes:e.size,outputBytes:e.size};const c=document.createElement("canvas"),d=c.getContext("2d",{alpha:!0});if(!d)throw new Error("Canvas 初始化失败");let u=1;const v=Math.max(i,l);Number.isFinite(s)&&s>0&&v>s&&(u=s/v);let f=Math.max(1,Math.round(i*u)),m=Math.max(1,Math.round(l*u));c.width=f,c.height=m;const h=(M,L)=>new Promise(C=>{c.toBlob(O=>C(O),M,L)}),w=()=>{d.clearRect(0,0,c.width,c.height),d.drawImage(a,0,0,c.width,c.height)};w();const S=e.size;let R=null,N=1/0,D=.84,F="image/jpeg";for(let M=0;M<4;M+=1){const L=await h(F,D);if(!L)break;const C=L.size||0;if(C>0&&C<N&&(R=L,N=C),C>0&&C<=t)break;D=Math.max(.58,D-.12),f=Math.max(1,Math.round(f*.92)),m=Math.max(1,Math.round(m*.92)),c.width=f,c.height=m,w()}if(!R||N>=S)return{file:e,compressed:!1,originalBytes:S,outputBytes:S};const _=new File([R],e.name.replace(/\.\w+$/,"")+".jpg",{type:F,lastModified:Date.now()});return{file:_,compressed:!0,originalBytes:S,outputBytes:_.size}}finally{typeof(a==null?void 0:a.close)=="function"&&a.close()}}async function Q(e,o={}){const t=o.source==="prompt"?"prompt":"sora",s=(e||[]).filter(r=>{if(!r)return!1;if(String(r.type||"").startsWith("image/"))return!0;const i=String(r.name||"");return/\.(png|jpe?g|webp|gif|bmp|svg|ico|tiff?)$/i.test(i)});if(s.length===0){e&&e.length&&I("未检测到可用的图片文件","warning");return}b.readingCount+=s.length,Ae(t,!0),$(t,{isProcessing:!0,state:"clear",text:"处理中…",progress:0,meta:""});try{const r=s.length;let a=0;for(let i=0;i<r;i+=1){const l=s[i];$(t,{text:l.size>y.imageCompressThresholdBytes?"压缩中…":"读取中…",meta:`${i+1}/${r} · ${l.name} · ${J(l.size)}`,progress:Math.round(a/r*100)});let c=l;if(l.size>y.imageCompressThresholdBytes){const v=l.size,f=await mt(l,{thresholdBytes:y.imageCompressThresholdBytes,maxDimension:y.imageMaxDimension});c=f.file,f.compressed?$(t,{text:"压缩完成，读取中…",meta:`${i+1}/${r} · ${l.name} · ${J(v)} → ${J(c.size)}`}):$(t,{text:"读取中…",meta:`${i+1}/${r} · ${l.name} · ${J(v)}`})}const d=await rt(c),u=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;b.items.push({id:u,kind:"data",value:d,name:(c==null?void 0:c.name)||(l==null?void 0:l.name)||"image",size:(c==null?void 0:c.size)||(l==null?void 0:l.size)||0}),a+=1,$(t,{progress:Math.round(a/r*100)})}k(),$(t,{state:"success",text:`已添加 ${s.length} 张图片`,meta:`${s.length} 张 · ${b.items.length} 张总计`,progress:100}),I(`已添加 ${s.length} 张图片（已转 Base64）`,"success"),setTimeout(()=>{$(t,{isProcessing:!1})},900),setTimeout(()=>{$(t,{state:"clear"})},1600)}catch(r){$(t,{state:"error",text:"添加失败",meta:String((r==null?void 0:r.message)||r||""),progress:0}),setTimeout(()=>$(t,{isProcessing:!1}),1400),I(`添加图片失败: ${r.message||r}`,"error")}finally{b.readingCount=Math.max(0,b.readingCount-s.length),Ae(t,b.readingCount>0),k()}}function de(e){const o=He(e);let t=0;for(const s of o){if(!le(s)){I(`跳过无效图片来源: ${s.slice(0,80)}${s.length>80?"…":""}`,"warning");continue}const r=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;b.items.push({id:r,kind:s.startsWith("data:image")?"data":"url",value:s,name:s.startsWith("data:image")?"base64":"url",size:0}),t+=1}return t}function k(){const e=b.items.length,o=n.promptImageCount||n.soraImageCount,t=n.promptClearImages||n.soraClearImages,s=n.promptImagePreviewWrap||null,r=n.promptImagePreview||n.soraImagePreview;if(o&&(o.textContent=`${e} 张图片`),t&&(t.disabled=b.readingCount>0||e===0),s&&s.classList.toggle("hidden",e===0),!r||(r.innerHTML="",e===0))return;const i=`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">
                <rect width="200" height="150" rx="12" fill="#F5F5F7"/>
                <path d="M62 96l16-18 16 18 22-26 22 26" fill="none" stroke="#86868b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="78" cy="58" r="10" fill="#d1d1d6"/>
                <text x="100" y="128" font-family="system-ui, -apple-system" font-size="12" fill="#86868b" text-anchor="middle">Preview unavailable</text>
            </svg>`)}`;for(const l of b.items){const c=document.createElement("div");c.className="preview-item",c.dataset.id=l.id;const d=document.createElement("img");d.className="preview-img",d.loading="lazy",d.alt=l.name||"image",d.src=l.value,d.addEventListener("click",()=>Re(l.id)),d.onerror=()=>{d.src=i,d.classList.add("is-fallback")};const u=document.createElement("div");u.className="preview-actions";const v=document.createElement("button");v.type="button",v.className="preview-btn",v.textContent="编辑",v.addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),Re(l.id)});const f=document.createElement("button");f.type="button",f.className="preview-btn danger",f.textContent="移除",f.addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),b.items=b.items.filter(w=>w.id!==l.id),k(),I("已移除图片","info")}),u.appendChild(v),u.appendChild(f);const m=document.createElement("div");m.className="preview-caption",m.textContent=l.kind==="url"?"URL":"Base64",c.appendChild(d),c.appendChild(u),c.appendChild(m),r.appendChild(c)}}function Re(e){const o=b.items.find(t=>t.id===e);o&&(b.editingId=e,n.modalImage.src=o.value,n.modalValue.value=o.value,n.imageModal.classList.remove("hidden"),document.body.classList.add("modal-open"),n.modalValue.focus())}function me(){b.editingId=null,n.imageModal.classList.add("hidden"),document.body.classList.remove("modal-open"),n.modalImage.src="",n.modalValue.value=""}function X(e){var s;const o=String(e||"");if(!o)return;if((s=navigator.clipboard)!=null&&s.writeText){navigator.clipboard.writeText(o).catch(()=>{});return}const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove()}function Fe(e,o,t,s){const r=Number.parseInt(String(e??""),10);return Number.isFinite(r)?Math.min(t,Math.max(o,r)):s}function ue(e){const o=Number(e);return!Number.isFinite(o)||o<=0?null:o<1e10?Math.round(o*1e3):Math.round(o)}function ut(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return Math.min(100,Math.max(0,Math.round(e)));const t=String(e).trim().match(/(\d+(?:\.\d+)?)/),s=t?Number.parseFloat(t[1]):0;return Number.isFinite(s)?Math.min(100,Math.max(0,Math.round(s))):0}function pt(e){const o=String(e||"").trim().toLowerCase();return o?["success","succeeded","ok","completed","done","finished","finish"].includes(o)?"completed":["fail","failed","error","timeout"].includes(o)?"failed":["cancelled","canceled","cancel"].includes(o)?"cancelled":["processing","running","executing","in_progress","in-progress","working"].includes(o)?"processing":(["queued","pending","waiting","created","init","initializing"].includes(o),"pending"):"pending"}function Z(e){return{queued:"排队中",pending:"等待",processing:"处理中",completed:"成功",failed:"失败",cancelled:"已取消"}[e]||"等待"}function B(e){return["completed","failed","cancelled"].includes(String(e||""))}function gt(e){var s,r,a,i,l;const o=[e==null?void 0:e.video_url,e==null?void 0:e.videoUrl,e==null?void 0:e.url,(s=e==null?void 0:e.data)==null?void 0:s.video_url,(r=e==null?void 0:e.data)==null?void 0:r.videoUrl,(a=e==null?void 0:e.data)==null?void 0:a.url,(i=e==null?void 0:e.data)==null?void 0:i.output];for(const c of o)if(typeof c=="string"&&/^https?:\/\//i.test(c.trim()))return c.trim();const t=(l=e==null?void 0:e.data)==null?void 0:l.output;if(t&&typeof t=="object"){const c=[t.url,t.video_url,t.videoUrl];for(const d of c)if(typeof d=="string"&&/^https?:\/\//i.test(d.trim()))return d.trim()}return null}function pe(e){return{taskId:(e==null?void 0:e.task_id)||(e==null?void 0:e.taskId)||(e==null?void 0:e.id)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,rawStatus:(e==null?void 0:e.status)||null,status:pt(e==null?void 0:e.status),progress:ut(e==null?void 0:e.progress),failReason:(e==null?void 0:e.fail_reason)||(e==null?void 0:e.failReason)||(e==null?void 0:e.error)||(e==null?void 0:e.detail)||"",submitTimeMs:ue(e==null?void 0:e.submit_time),startTimeMs:ue(e==null?void 0:e.start_time),finishTimeMs:ue(e==null?void 0:e.finish_time),cost:typeof(e==null?void 0:e.cost)=="number"?e.cost:null,videoUrl:gt(e)}}function Y(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return"—"}}function Ve(e){const o=Math.max(0,Math.floor(e/1e3)),t=o%60,s=Math.floor(o/60)%60,r=Math.floor(o/3600),a=i=>String(i).padStart(2,"0");return r>0?`${r}:${a(s)}:${a(t)}`:`${a(s)}:${a(t)}`}function ee(e=4){let o=0;const t=[],s=()=>{for(;o<e&&t.length>0;){const i=t.shift();!i||i.aborted||(i.started=!0,o+=1,Promise.resolve().then(()=>i.fn()).then(i.resolve,i.reject).finally(()=>{var l;o-=1,(l=i.cleanup)==null||l.call(i),s()}))}};return{enqueue:(i,l={})=>{const c=l.signal;return new Promise((d,u)=>{const v={fn:i,resolve:d,reject:u,signal:c,started:!1,aborted:!1,cleanup:null};if(c!=null&&c.aborted){u(new DOMException("Aborted","AbortError"));return}const f=()=>{if(v.started)return;v.aborted=!0;const m=t.indexOf(v);m>=0&&t.splice(m,1),u(new DOMException("Aborted","AbortError")),s()};c&&(c.addEventListener("abort",f,{once:!0}),v.cleanup=()=>c.removeEventListener("abort",f)),t.push(v),s()})},stats:()=>({active:o,pending:t.length,concurrency:e})}}function ze(e,o){const t=String(o||"").trim();if(e==="sora2"){const s=n.soraVariant.value,r=n.aspectRatio.value,a=Number.parseInt(n.duration.value,10),i=!!n.soraWatermark.checked,l=!!n.soraPrivate.checked,c=!!n.soraHd.checked,d=s==="sora-2-pro";if(!d&&c)throw new Error("sora-2 不支持 HD，请切换到 sora-2-pro");if(!d&&a===25)throw new Error("sora-2 不支持 25 秒，请切换到 sora-2-pro");if(a===25&&c)throw new Error("duration=25 时 hd 不生效，请关闭 HD 或选择 10/15 秒");const u=at(n.notifyHook?n.notifyHook.value:""),v=b.items.map(h=>h.value).filter(Boolean),f={model:s,prompt:t,aspect_ratio:r,duration:a,hd:c,watermark:i,private:l,...u?{notify_hook:u}:{},...v.length?{images:v}:{}},m=`${s} · ${r} · ${a}s · images=${v.length}`;return{payload:f,metaSummary:m}}return{payload:{model:e,prompt:t},metaSummary:e}}function Ke(e){const o=document.createElement("div");o.className="task-wrapper",o.setAttribute("data-local-id",e.localId);const t=document.createElement("div");t.className="task-mini-preview hidden";const s=document.createElement("video");s.className="task-mini-video",s.muted=!0,s.loop=!0,s.playsInline=!0,s.controls=!0;const r=document.createElement("div");r.className="task-mini-preview-actions";const a=document.createElement("button");a.className="task-mini-btn",a.title="复制视频链接",a.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',a.onclick=Et=>{Et.preventDefault(),X(e.videoUrl),g("链接已复制","success")};const i=document.createElement("a");i.className="task-mini-btn",i.title="下载视频",i.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',i.target="_blank",r.appendChild(a),r.appendChild(i),t.appendChild(s),t.appendChild(r);const l=document.createElement("details");l.className="task-item";const c=document.createElement("summary");c.className="task-summary";const d=document.createElement("div");d.className="task-main";const u=document.createElement("div");u.className="task-title";const v=document.createElement("div");v.className="task-name",v.textContent=e.name;const f=document.createElement("div");f.className="task-meta",f.textContent=e.metaSummary||"",u.appendChild(v),u.appendChild(f);const m=document.createElement("div");m.className="task-id",m.textContent="ID: -",d.appendChild(u),d.appendChild(m);const h=document.createElement("div");h.className="task-right";const w=document.createElement("span");w.className="badge badge-pending",w.textContent="等待";const S=document.createElement("div");S.className="task-progress";const R=document.createElement("div");R.className="task-progress-bar";const N=document.createElement("div");N.className="task-progress-fill",N.style.width="0%",R.appendChild(N);const D=document.createElement("div");D.className="task-progress-text",D.textContent="0%",S.appendChild(R),S.appendChild(D);const F=document.createElement("div");F.className="task-time",F.textContent="—";const _=document.createElement("div");_.className="task-actions";const M=document.createElement("button");M.type="button",M.className="btn btn-secondary btn-sm",M.setAttribute("data-action","save"),M.textContent="保存到存储库";const L=document.createElement("button");L.type="button",L.className="btn btn-secondary btn-sm",L.setAttribute("data-action","retry"),L.textContent="重试";const C=document.createElement("button");C.type="button",C.className="btn btn-secondary btn-sm",C.setAttribute("data-action","cancel"),C.textContent="取消",_.appendChild(M),_.appendChild(L),_.appendChild(C),h.appendChild(w),h.appendChild(S),h.appendChild(F),h.appendChild(_),c.appendChild(d),c.appendChild(h);const O=document.createElement("div");O.className="task-details";const ve=document.createElement("div");ve.className="task-info";const P=document.createElement("div");P.className="task-info-grid";const fe=document.createElement("div");fe.className="task-info-line";const he=document.createElement("div");he.className="task-info-line";const ye=document.createElement("div");ye.className="task-info-line";const be=document.createElement("div");be.className="task-info-line";const we=document.createElement("div");we.className="task-info-line";const Ie=document.createElement("div");Ie.className="task-info-line";const oe=document.createElement("div");oe.className="task-info-line",oe.textContent="存储库: —";const Ee=document.createElement("div");Ee.className="task-error hidden";const Ce=document.createElement("div");return Ce.className="task-error hidden",P.appendChild(fe),P.appendChild(he),P.appendChild(ye),P.appendChild(be),P.appendChild(we),P.appendChild(Ie),P.appendChild(oe),P.appendChild(Ee),P.appendChild(Ce),ve.appendChild(P),O.appendChild(ve),l.appendChild(c),l.appendChild(O),o.appendChild(t),o.appendChild(l),e.dom={root:o,badge:w,fill:N,progressText:D,idEl:m,timeEl:F,metaEl:f,nameEl:v,saveBtn:M,retryBtn:L,cancelBtn:C,platformEl:fe,actionEl:he,submitEl:ye,startEl:be,finishEl:we,costEl:Ie,repoStatusEl:oe,repoErrorEl:Ee,errorEl:Ce,miniPreview:t,miniVideo:s,miniDlBtn:i},l.addEventListener("toggle",()=>{T(e)}),o}function T(e){if(!e.dom)return;const o=e.status==="processing"?"processing":e.status==="completed"?"completed":e.status==="failed"?"failed":e.status==="cancelled"?"cancelled":"pending";e.dom.badge.className=`badge badge-${o}`,e.dom.badge.textContent=Z(e.status),e.dom.progressText.textContent=`${e.progress}%`,e.dom.fill.style.width=`${e.progress}%`,e.dom.idEl.textContent=`ID: ${e.taskId||"-"}`,qe(e),e.dom.platformEl.textContent=`平台: ${e.platform||"—"}`,e.dom.actionEl.textContent=`动作: ${e.action||"—"}`,e.dom.submitEl.textContent=`提交: ${Y(e.submitTimeMs)}`,e.dom.startEl.textContent=`开始: ${Y(e.startTimeMs)}`,e.dom.finishEl.textContent=`完成: ${Y(e.finishTimeMs)}`,e.dom.costEl.textContent=e.cost!=null?`花费: ${e.cost}`:"花费: —";const t=e.repoSave||{status:"idle",errorMessage:""};let s="—";e.status==="completed"&&(e.videoUrl?t.status==="saved"?s="已保存":t.status==="saving"?s="保存中...":t.status==="failed"?s="保存失败":s="待保存":s="缺少视频链接"),e.dom.repoStatusEl.textContent=`存储库: ${s}`,t.status==="failed"&&String(t.errorMessage||"").trim()?(e.dom.repoErrorEl.classList.remove("hidden"),e.dom.repoErrorEl.textContent=`保存失败: ${String(t.errorMessage).trim()}`):(e.dom.repoErrorEl.classList.add("hidden"),e.dom.repoErrorEl.textContent="");const r=String(e.failReason||"").trim();r?(e.dom.errorEl.classList.remove("hidden"),e.dom.errorEl.textContent=`错误: ${r}`):(e.dom.errorEl.classList.add("hidden"),e.dom.errorEl.textContent="");const a=!B(e.status)&&!e.controller.signal.aborted;e.dom.cancelBtn.disabled=!a;const i=B(e.status)&&e.status!=="completed";e.dom.retryBtn.style.display=i?"":"none";const l=e.status==="completed"&&!!e.videoUrl;if(e.dom.saveBtn.style.display=l?"":"none",l?t.status==="saved"?(e.dom.saveBtn.textContent="已保存",e.dom.saveBtn.disabled=!0):t.status==="saving"?(e.dom.saveBtn.textContent="保存中...",e.dom.saveBtn.disabled=!0):t.status==="failed"?(e.dom.saveBtn.textContent="重试保存",e.dom.saveBtn.disabled=!1):(e.dom.saveBtn.textContent="保存到存储库",e.dom.saveBtn.disabled=!1):e.dom.saveBtn.disabled=!0,e.videoUrl){if(e.dom.miniPreview.classList.remove("hidden"),e.dom.miniVideo.getAttribute("src")!==e.videoUrl){e.dom.miniVideo.src=e.videoUrl,e.dom.miniDlBtn.href=e.videoUrl;try{const u=new URL(e.videoUrl).pathname.split("/").pop();e.dom.miniDlBtn.download=u||`video_${e.taskId}.mp4`}catch{e.dom.miniDlBtn.download=`video_${e.taskId}.mp4`}}}else e.dom.miniPreview.classList.add("hidden"),e.dom.miniVideo.getAttribute("src")&&(e.dom.miniVideo.removeAttribute("src"),e.dom.miniVideo.load())}function qe(e){var a;if(!((a=e==null?void 0:e.dom)!=null&&a.timeEl))return;const o=Date.now(),t=e.startTimeMs||e.submitTimeMs||e.createdAt||o,r=(e.finishTimeMs||(B(e.status)?e.updatedAt:null)||o)-t;e.dom.timeEl.textContent=`耗时 ${Ve(r)}`}function Oe(){const e=p.order.length;let o=0,t=0,s=0,r=0;for(const a of p.order){const i=p.byLocalId.get(a);i&&(i.status==="processing"?o+=1:i.status==="completed"?t+=1:i.status==="failed"?s+=1:i.status==="cancelled"&&(r+=1))}n.taskSummary.textContent=`${e} 个任务 · 处理中 ${o} · 成功 ${t} · 失败 ${s} · 取消 ${r}`}function q(){Oe();const e=p.order.length;n.statusContainer&&n.statusContainer.classList.toggle("hidden",e>0);const o=p.order.slice(0,p.renderLimit);n.taskList.innerHTML="";for(const t of o){const s=p.byLocalId.get(t);s&&(s.dom||Ke(s),T(s),n.taskList.appendChild(s.dom.root))}n.taskListFooter&&n.taskListFooter.classList.toggle("hidden",e<=p.renderLimit)}function x(e,o,t="info"){const s=typeof e=="string"?p.byLocalId.get(e):e;if(!s)return;const r={time:new Date().toLocaleTimeString(),type:t,message:String(o||"")};Array.isArray(s.logs)||(s.logs=[]),s.logs.push(r),s.logs.length>y.maxLogsPerTask*3&&s.logs.splice(0,s.logs.length-y.maxLogsPerTask*2),T(s)}function H(e,o,t={}){const s=String(o||"").trim();if(!s)return;const r=e.status;if(e.status=s,e.updatedAt=Date.now(),Object.assign(e,t),r!==s&&x(e,`状态更新: ${Z(r)} -> ${Z(s)}`,"info"),T(e),Oe(),s==="completed"&&r!=="completed"&&setTimeout(()=>{typeof z=="function"&&z()},1500),p.order.length>0){const a=p.order[0],i=p.byLocalId.get(a);i&&i.localId===e.localId&&typeof Le=="function"&&Le(e)}}function vt(){if(p.order.length<=y.maxTasks)return;const e=p.order.slice().reverse().filter(o=>{const t=p.byLocalId.get(o);return t&&B(t.status)});for(;p.order.length>y.maxTasks&&e.length>0;)te(e.shift());for(;p.order.length>y.maxTasks;)te(p.order[p.order.length-1])}function te(e){var s;const o=String(e||""),t=p.byLocalId.get(o);if(t){if(t.cleanupTimer&&clearTimeout(t.cleanupTimer),t.pollTimer&&clearTimeout(t.pollTimer),!t.controller.signal.aborted&&!B(t.status))try{t.controller.abort()}catch{}p.byLocalId.delete(o),p.order=p.order.filter(r=>r!==o),(s=t.dom)!=null&&s.root&&t.dom.root.parentElement&&t.dom.root.remove()}}function ft(){const e=p.order.slice();for(const o of e){const t=p.byLocalId.get(o);t&&B(t.status)&&te(o)}}function A(e){e.cleanupTimer&&clearTimeout(e.cleanupTimer),e.cleanupTimer=setTimeout(()=>{te(e.localId),q()},y.cleanupAfterMs)}function ht(e){const o=p.byLocalId.get(String(e||""));if(o&&!B(o.status)){x(o,"用户取消任务（停止轮询）","warning");try{o.controller.abort()}catch{}o.pollTimer&&clearTimeout(o.pollTimer),o.finishTimeMs=o.finishTimeMs||Date.now(),H(o,"cancelled"),A(o),g(`已取消：${o.name}`,"info")}}function yt(e){const o=p.byLocalId.get(String(e||""));if(!o||!o.request)return;const t=`${o.request.name||o.name}（重试）`;We({...o.request,name:t})}async function bt(e){if(!e.taskId)return;const o=`${e.baseUrl}${e.apiSpec.statusPath(e.taskId)}`,t=await fetch(o,{headers:Ne(e.apiKey,!1),signal:e.controller.signal}),s=await ce(t);if(!t.ok){const r=(s==null?void 0:s.detail)||(s==null?void 0:s.error)||(typeof s=="string"?s:null);throw new Error(r||`轮询失败（HTTP ${t.status}）`)}return s}function wt(e){var l,c,d,u,v,f,m,h;const o=String((e==null?void 0:e.videoUrl)||"").trim();if(!o)throw new Error("缺少视频链接");const t=((c=(l=e==null?void 0:e.request)==null?void 0:l.payload)==null?void 0:c.prompt)??((d=e==null?void 0:e.payload)==null?void 0:d.prompt)??((u=e==null?void 0:e.request)==null?void 0:u.prompt)??"",s=((f=(v=e==null?void 0:e.request)==null?void 0:v.payload)==null?void 0:f.model)??((m=e==null?void 0:e.payload)==null?void 0:m.model)??((h=e==null?void 0:e.request)==null?void 0:h.model)??(e==null?void 0:e.platform)??(e==null?void 0:e.modelKey)??"unknown",r=String(t||"").trim()||"No prompt",a=String(s||"").trim()||"unknown",i={provider_task_id:(e==null?void 0:e.taskId)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,cost:(e==null?void 0:e.cost)??null};return{title:(e==null?void 0:e.name)||(e!=null&&e.taskId?`Task ${e.taskId}`:"未命名任务"),model:a,prompt:r,video_url:o,status:"completed",metadata:i}}async function ge(e,{manual:o=!1}={}){const t=e;if(!t)return;const s=t.repoSave||{status:"idle",savedVideoId:null};if(s.status==="saving"){o&&g("正在保存...","info",{durationMs:1800});return}if(s.status==="saved"){o&&g("已保存到存储库","success",{durationMs:1800});return}if(t.status!=="completed"){o&&g("仅支持保存已完成的任务","warning");return}let r;try{r=wt(t)}catch(i){const l=String((i==null?void 0:i.message)||i||"保存数据无效");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:null},T(t),I(`保存失败: ${l}`,"error");return}t.repoSave={status:"saving",errorMessage:"",savedVideoId:s.savedVideoId||null,payload:r},T(t),x(t,"开始保存到存储库","info");const a=async()=>{let i;try{i=await fetch("/api/v1/videos",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...G()},body:JSON.stringify(r)})}catch(d){const u=String((d==null?void 0:d.message)||d||"网络错误");t.repoSave={status:"failed",errorMessage:u,savedVideoId:null,payload:r},T(t),x(t,`保存失败: ${u}`,"error"),g(`保存失败：${u}`,"error");return}if(i.status===401){const d="登录已过期，请重新登录后再保存";t.repoSave={status:"failed",errorMessage:d,savedVideoId:null,payload:r},T(t),x(t,`保存失败: ${d}`,"warning"),g(d,"warning"),window.location.href="/login?next=/video";return}const l=await ce(i);if(!i.ok){let d=dt(l,`保存失败（HTTP ${i.status}）`);i.status===403&&d.toLowerCase().includes("csrf")&&(d=`${d}（请刷新页面后重试）`),t.repoSave={status:"failed",errorMessage:d,savedVideoId:null,payload:r},T(t),x(t,`保存失败: ${d}`,"error"),g(`保存失败：${d}`,"error",{durationMs:5200});return}const c=(l==null?void 0:l.id)||null;t.repoSave={status:"saved",errorMessage:"",savedVideoId:c,payload:r},T(t),x(t,"已保存到存储库","success"),g(`已保存到存储库：${t.name||t.taskId||""}`.trim(),"success",{durationMs:2200})};p.saveQueue.enqueue(a).catch(i=>{const l=String((i==null?void 0:i.message)||i||"保存失败");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:r},T(t),x(t,`保存失败: ${l}`,"error"),I(`保存失败: ${l}`,"error")})}function It(e){if(!e.taskId||e.controller.signal.aborted)return;e.pollTimer&&clearTimeout(e.pollTimer);const o=async()=>{if(!e.controller.signal.aborted&&!B(e.status))try{const t=await p.pollQueue.enqueue(()=>bt(e),{signal:e.controller.signal});e.pollErrorCount=0;const s=pe(t);let r=s.status;s.videoUrl&&s.progress>=100&&!["failed","cancelled"].includes(r)&&(r="completed");const a=e.status;if(s.taskId&&(e.taskId=String(s.taskId)),e.platform=s.platform||e.platform,e.action=s.action||e.action,e.progress=s.progress,e.failReason=s.failReason||e.failReason,e.submitTimeMs=s.submitTimeMs||e.submitTimeMs,e.startTimeMs=s.startTimeMs||e.startTimeMs,e.finishTimeMs=s.finishTimeMs||e.finishTimeMs,e.cost=s.cost!=null?s.cost:e.cost,e.videoUrl=s.videoUrl||e.videoUrl,e.updatedAt=Date.now(),H(e,r),a!==e.status&&B(e.status)){const i=e.status==="completed"?"任务成功":e.status==="failed"?"任务失败":"任务已取消";x(e,i,e.status==="completed"?"success":e.status==="failed"?"error":"warning"),e.status==="completed"&&e.videoUrl&&ge(e)}if(e.status==="completed"&&e.videoUrl,B(e.status)){e.status==="completed"&&e.videoUrl?g(`完成：${e.name}`,"success"):e.status==="failed"&&g(`失败：${e.name}`,"error"),A(e);return}}catch(t){if((t==null?void 0:t.name)==="AbortError")return;if(e.pollErrorCount+=1,x(e,`轮询错误(${e.pollErrorCount}/${y.maxPollErrors}): ${t.message||t}`,"warning"),e.pollErrorCount>=y.maxPollErrors){e.failReason=e.failReason||String(t.message||t),H(e,"failed"),A(e),g(`轮询失败：${e.name}`,"error");return}}finally{const t=y.pollIntervalMs+Math.floor(Math.random()*y.pollJitterMs);e.pollTimer=setTimeout(o,t)}};e.pollTimer=setTimeout(o,1e3)}function We(e){const o=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,t={localId:o,name:e.name,modelKey:e.modelKey,metaSummary:e.metaSummary,baseUrl:e.baseUrl,apiKey:e.apiKey,apiSpec:e.apiSpec,payload:e.payload,request:e,status:"queued",progress:0,taskId:null,platform:null,action:null,failReason:"",videoUrl:null,createdAt:Date.now(),updatedAt:Date.now(),submitTimeMs:null,startTimeMs:null,finishTimeMs:null,cost:null,logs:[],pollTimer:null,pollErrorCount:0,cleanupTimer:null,controller:new AbortController,dom:null};p.byLocalId.set(o,t),p.order.unshift(o),vt(),Ke(t),x(t,"已加入队列","info"),q();const s=p.createQueue.enqueue(async()=>{H(t,"pending");const r=await fetch(`${t.baseUrl}${t.apiSpec.createPath}`,{method:"POST",headers:Ne(t.apiKey,!0),body:JSON.stringify(t.payload),signal:t.controller.signal}),a=await ce(r);if(!r.ok){const i=(a==null?void 0:a.detail)||(a==null?void 0:a.error)||(typeof a=="string"?a:null);throw new Error(i||`请求失败（HTTP ${r.status}）`)}return a},{signal:t.controller.signal});return t.createPromise=s,s.then(r=>{const a=pe(r);let i=a.status;if(a.videoUrl&&a.progress>=100&&!["failed","cancelled"].includes(i)&&(i="completed"),t.taskId=a.taskId?String(a.taskId):t.taskId,t.platform=a.platform||t.platform,t.action=a.action||t.action,t.progress=a.progress,t.failReason=a.failReason||"",t.submitTimeMs=a.submitTimeMs||t.submitTimeMs,t.startTimeMs=a.startTimeMs||t.startTimeMs,t.finishTimeMs=a.finishTimeMs||t.finishTimeMs,t.cost=a.cost!=null?a.cost:t.cost,t.videoUrl=a.videoUrl||t.videoUrl,!t.taskId){t.failReason=t.failReason||"响应缺少 task_id",H(t,"failed"),A(t),g(`创建失败：${t.name}`,"error");return}if(H(t,i),x(t,`任务创建成功: ${t.taskId}`,"success"),g(`已提交：${t.name}`,"success",{durationMs:1800}),t.status==="completed"&&t.videoUrl&&ge(t),B(t.status)){A(t);return}It(t)}).catch(r=>{if((r==null?void 0:r.name)==="AbortError"){H(t,"cancelled"),A(t);return}t.failReason=String((r==null?void 0:r.message)||r),H(t,"failed"),x(t,`创建失败: ${t.failReason}`,"error"),A(t),g(`创建失败：${t.name}`,"error")}),t}function je(){const e=Date.now();if(e-p.lastSubmitAt<y.submitDebounceMs)return;p.lastSubmitAt=e;const o=[["apiKey",n.apiKey],["baseUrl",n.baseUrl],["promptInput",n.promptInput],["modelSelect",n.modelSelect],["batchCount",n.batchCount],["taskNameInput",n.taskNameInput]];for(const[m,h]of o)if(!h){g(`页面缺少必要表单字段：${m}`,"error");return}const t=De(n.apiKey.value);if(!t){g("请先输入 API Key","error"),n.apiKey.focus();return}let s;try{s=j(n.baseUrl.value)}catch(m){g(m.message||"Base URL 无效","error"),n.baseUrl.focus();return}const r=n.promptInput.value.trim();if(!r){g("请输入提示词","error"),n.promptInput.focus();return}const a=n.modelSelect.value;let i;try{i=lt(a)}catch(m){g(m.message||"模型不支持","error");return}if(a==="sora2"&&b.readingCount>0){g("图片读取中，请稍候…","warning");return}if(a==="sora2"){const m=n.soraImageSourceInput?String(n.soraImageSourceInput.value||"").trim():"";m&&de(m)>0&&(n.soraImageSourceInput&&(n.soraImageSourceInput.value=""),k())}let l;try{l=ze(a,r)}catch(m){g(m.message||"参数有误","error");return}const c=Fe(n.batchCount.value,1,y.maxBatchCount,1);if(c>=y.confirmBatchThreshold&&!confirm(`将提交 ${c} 个任务，确认继续？`))return;const u=String(n.taskNameInput.value||"").trim()||r.slice(0,18)||"任务",v=Array.from({length:c},(m,h)=>{const w=c>1?` #${h+1}`:"";return{name:`${u}${w}`,modelKey:a,metaSummary:l.metaSummary,baseUrl:s,apiKey:t,apiSpec:i,payload:l.payload}});g(`已加入队列：${c} 个任务`,"success");const f=v.map(m=>{const h=We({...m,request:null});return h.request={name:m.name,modelKey:m.modelKey,metaSummary:m.metaSummary,baseUrl:m.baseUrl,apiKey:m.apiKey,apiSpec:m.apiSpec,payload:m.payload},h});Promise.allSettled(f.map(m=>m.createPromise)).then(m=>{const h=m.filter(S=>S.status==="fulfilled").length,w=m.length-h;m.length>1&&g(`创建结果：成功 ${h}，失败 ${w}`,w?"warning":"success",{durationMs:3600})}).catch(()=>{})}setInterval(()=>{const e=p.order.slice(0,p.renderLimit);for(const o of e){const t=p.byLocalId.get(o);t&&qe(t)}},1e3)});Lt(Pt).mount("#app");
