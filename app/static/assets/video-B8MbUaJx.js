import{d as Tt,o as Mt,a as Pt,b as $t,g as tt,e as E,j as Ut}from"./runtime-dom.esm-bundler-D9CM_geE.js";import{g as Ht}from"./auth-DhJl3iPe.js";/* empty css                   */const Nt={class:"video-page"},kt=Tt({__name:"video-page",setup(s){return Mt(async()=>{try{const y=await Ht();if(y!=null&&y.is_admin){const b=document.getElementById("adminLink");b&&(b.style.display="inline-flex")}}catch{}}),(y,b)=>($t(),Pt("div",Nt,[...b[0]||(b[0]=[tt('<header class="header"><div class="logo"><div class="logo-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><span>Video Generation Studio</span></div><div class="header-actions"><a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg> 返回主页面 </a><button class="btn btn-ghost btn-icon" id="historyBtn" title="History"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></button><a href="/admin" class="btn btn-ghost btn-icon" id="adminLink" title="Admin" style="text-decoration:none;display:none;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1l3 5 5 1-3.5 4.2.8 5.8L12 15l-5.3 2.9.8-5.8L4 7l5-1 3-5z"></path></svg></a><a href="/storage" class="btn btn-ghost btn-icon" title="存储库" style="text-decoration:none;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></a></div></header><div class="main-container"><aside class="sidebar"><section class="sidebar-section"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> Model Selection </div><div class="form-group"><label class="form-label">模型</label><select class="form-select" id="modelSelect"><option value="sora2">Sora 2</option><option value="veo">Google Veo</option><option value="seedance">Seedance (即梦)</option><option value="newmodel">New Model</option></select></div><div id="sora2Params" class="model-params"><div class="form-group"><label class="form-label">Sora 版本</label><select class="form-select" id="soraVariant"><option value="sora-2">sora-2</option><option value="sora-2-pro">sora-2-pro</option></select></div></div></section><section class="sidebar-section"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line></svg> Video Parameters </div><div class="form-group"><label class="form-label">画幅比例</label><select class="form-select" id="aspectRatio"><option value="16:9">16:9 (Landscape)</option><option value="9:16">9:16 (Portrait)</option></select></div><div class="form-group"><label class="form-label">时长（秒）</label><select class="form-select" id="duration"><option value="10">10</option><option value="15">15</option><option value="25">25</option></select></div><div class="form-group"><label class="form-label">选项</label><div class="checkbox-group"><label class="checkbox-item"><input id="soraHd" type="checkbox"><span>HD（仅 Pro）</span></label><label class="checkbox-item"><input id="soraWatermark" type="checkbox"><span>水印</span></label><label class="checkbox-item"><input id="soraPrivate" type="checkbox"><span>私有</span></label></div></div><div class="form-group"><label class="form-label">任务名称（可选）</label><input class="form-input" id="taskNameInput" type="text" placeholder="例如：海边日落"></div><div class="form-group"><label class="form-label">并发数量</label><input class="form-input" id="batchCount" type="number" min="1" max="20" value="1"><div class="form-hint">一次可并发提交多个任务</div></div></section></aside><main class="main-content"><div class="result-area" id="resultArea"><div class="result-placeholder" id="resultPlaceholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><polygon points="10 8 16 12 10 16 10 8"></polygon></svg><h3>Ready to Create</h3><p>Configure settings, enter a prompt, and click Generate</p></div><div class="loading-state hidden" id="loadingState"><div class="spinner"></div><p>Generating your video...</p><div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div><span class="progress-text" id="progressText">0%</span></div><div id="resultContainer" class="hidden"><div class="result-video-container"><video id="resultVideo" controls></video></div><div class="result-actions"><button class="btn btn-secondary" id="downloadBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download </button><button class="btn btn-secondary" id="shareBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg> Share </button><button class="btn btn-secondary" id="fullscreenBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg> Fullscreen </button></div></div></div><div class="main-prompt-section"><div class="prompt-input-row"><div class="prompt-input-wrapper"><textarea class="prompt-textarea" id="promptInput" placeholder="描述您想生成的视频内容..."></textarea><div class="prompt-history-dropdown" id="promptHistoryDropdown"></div></div><div class="prompt-upload"><div class="upload-area upload-area-compact" id="promptDropzone"><input id="promptImages" type="file" accept="image/*" multiple><button id="promptPickFiles" type="button" class="upload-trigger upload-trigger-compact"><svg class="upload-icon upload-icon-compact" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p class="upload-text upload-text-compact"><strong>上传参考图</strong></p><p class="upload-hint upload-hint-compact">拖拽 / 粘贴 / 点击</p></button><div class="upload-feedback" id="promptUploadFeedback" aria-live="polite"><div class="upload-feedback-text" id="promptUploadText">处理中…</div><div class="upload-feedback-bar"><div class="upload-feedback-bar-fill" id="promptUploadProgress"></div></div><div class="upload-feedback-meta" id="promptUploadMeta"></div></div></div><div class="prompt-image-preview hidden" id="promptImagePreviewWrap"><div class="image-meta"><span class="meta-text" id="promptImageCount">0 张图片</span><button id="promptClearImages" type="button" class="btn btn-secondary btn-sm">清空</button></div><div class="image-preview-grid" id="promptImagePreview"></div></div></div></div><div class="prompt-footer"><div style="display:flex;align-items:center;gap:16px;"><span class="char-count"><span id="charCount">0</span> characters</span><div class="status-indicator"><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div></div><div style="display:flex;align-items:center;gap:16px;"><button class="prompt-history-btn" id="showPromptHistory"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> History </button><button class="generate-btn-large" id="generateBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span class="btn-text">Generate</span><span class="loader"></span></button></div></div></div><div class="inline-history-section" id="inlineHistorySection"><div class="inline-history-header"><div class="inline-history-title"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>Generation History</span><span class="inline-history-count" id="inlineHistoryCount">0</span></div><button class="inline-history-toggle" id="inlineHistoryToggle" title="Toggle history"><svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div><div class="inline-history-content" id="inlineHistoryContent"><div class="inline-history-grid" id="inlineHistoryGrid"><p class="inline-history-empty">No generation history yet. Create your first video!</p></div><div class="inline-history-show-more" id="inlineHistoryShowMore" style="display:none;"><button class="btn btn-ghost" id="showMoreHistoryBtn"> Show more <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button></div></div></div></main></div><div class="history-panel" id="historyPanel"><div class="history-header"><h3>Tasks &amp; History</h3><button class="btn btn-ghost btn-icon" id="closeHistoryBtn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="history-panel-content"><div class="task-toolbar"><span id="taskSummary" class="meta-text">0 个任务</span><button id="clearCompletedBtn" type="button" class="btn btn-secondary btn-sm">清理已完成</button></div><div class="task-list-wrap"><div id="taskList" class="task-list"></div><div id="taskListFooter" class="task-list-footer hidden"><button id="loadMoreTasksBtn" type="button" class="btn btn-secondary btn-sm">加载更多</button></div></div></div></div>',3),E("div",{id:"imageModal",class:"modal hidden",role:"dialog","aria-modal":"true","aria-labelledby":"imageModalTitle"},[E("div",{class:"modal-backdrop",id:"modalBackdrop"}),E("div",{class:"modal-content",role:"document"},[E("div",{class:"modal-header"},[E("h3",{id:"imageModalTitle"},"图片预览"),E("button",{id:"modalClose",class:"btn btn-ghost btn-icon",type:"button","aria-label":"关闭"},[E("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[E("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),E("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])])]),E("div",{class:"modal-body"},[E("div",{class:"modal-image-wrapper"},[E("img",{id:"modalImage",alt:"预览"})]),E("div",{class:"form-group"},[E("label",{class:"form-label",for:"modalValue"},"URL / Base64（可编辑）"),E("textarea",{class:"form-input",id:"modalValue",rows:"4"})])]),E("div",{class:"modal-actions"},[E("button",{id:"modalCopy",type:"button",class:"btn btn-secondary"},"复制"),E("button",{id:"modalSave",type:"button",class:"btn btn-primary"},"保存")])])],-1),tt('<div class="edit-prompt-modal-overlay hidden" id="editPromptModalOverlay"><div class="edit-prompt-modal"><div class="edit-prompt-modal-header"><h3>Edit Prompt</h3><button class="btn btn-ghost btn-icon" id="closeEditPromptModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="edit-prompt-modal-body"><textarea class="edit-prompt-textarea" id="editPromptTextarea" placeholder="Enter prompt..."></textarea></div><div class="edit-prompt-modal-footer"><button class="btn btn-ghost" id="cancelEditPromptBtn">Cancel</button><button class="btn btn-primary" id="saveEditPromptBtn">Save</button></div></div></div><div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>',2)])]))}});document.addEventListener("DOMContentLoaded",()=>{var Qe,Ye,Xe,Ze,et;const s={modelSelect:document.getElementById("modelSelect"),promptInput:document.getElementById("promptInput"),taskNameInput:document.getElementById("taskNameInput"),batchCount:document.getElementById("batchCount"),sora2Params:document.getElementById("sora2Params"),soraVariant:document.getElementById("soraVariant"),aspectRatio:document.getElementById("aspectRatio"),duration:document.getElementById("duration"),soraHd:document.getElementById("soraHd"),soraWatermark:document.getElementById("soraWatermark"),soraPrivate:document.getElementById("soraPrivate"),soraImages:document.getElementById("soraImages"),soraDropzone:document.getElementById("soraDropzone"),soraPickFiles:document.getElementById("soraPickFiles"),soraClearImages:document.getElementById("soraClearImages"),soraImageCount:document.getElementById("soraImageCount"),soraImagePreview:document.getElementById("soraImagePreview"),soraImageSourceInput:document.getElementById("soraImageSourceInput"),soraAddImageSources:document.getElementById("soraAddImageSources"),soraUploadFeedback:document.getElementById("soraUploadFeedback"),soraUploadText:document.getElementById("soraUploadText"),soraUploadProgress:document.getElementById("soraUploadProgress"),soraUploadMeta:document.getElementById("soraUploadMeta"),promptImages:document.getElementById("promptImages"),promptDropzone:document.getElementById("promptDropzone"),promptPickFiles:document.getElementById("promptPickFiles"),promptUploadFeedback:document.getElementById("promptUploadFeedback"),promptUploadText:document.getElementById("promptUploadText"),promptUploadProgress:document.getElementById("promptUploadProgress"),promptUploadMeta:document.getElementById("promptUploadMeta"),promptImagePreviewWrap:document.getElementById("promptImagePreviewWrap"),promptImageCount:document.getElementById("promptImageCount"),promptImagePreview:document.getElementById("promptImagePreview"),promptClearImages:document.getElementById("promptClearImages"),notifyHook:document.getElementById("notifyHook"),generateBtn:document.getElementById("generateBtn"),statusContainer:document.getElementById("statusContainer"),statusContent:document.getElementById("statusContent"),taskSummary:document.getElementById("taskSummary"),clearCompletedBtn:document.getElementById("clearCompletedBtn"),taskList:document.getElementById("taskList"),taskListFooter:document.getElementById("taskListFooter"),loadMoreTasksBtn:document.getElementById("loadMoreTasksBtn"),imageModal:document.getElementById("imageModal"),modalBackdrop:document.getElementById("modalBackdrop"),modalClose:document.getElementById("modalClose"),modalImage:document.getElementById("modalImage"),modalValue:document.getElementById("modalValue"),modalCopy:document.getElementById("modalCopy"),modalSave:document.getElementById("modalSave"),toastContainer:document.getElementById("toastContainer"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),charCount:document.getElementById("charCount"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultVideo:document.getElementById("resultVideo"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText")},y={submitDebounceMs:120,confirmBatchThreshold:6,maxBatchCount:20,renderPageSize:20,maxTasks:200,cleanupAfterMs:600*1e3,pollIntervalMs:4e3,pollJitterMs:600,maxPollErrors:3,createConcurrency:4,pollConcurrency:8,saveConcurrency:2,maxLogsPerTask:200,imageCompressThresholdBytes:5*1024*1024,imageMaxDimension:2048},b={items:[],editingId:null,readingCount:0},p={byLocalId:new Map,order:[],renderLimit:y.renderPageSize,nextIndex:1,lastSubmitAt:0,createQueue:ee(y.createConcurrency),pollQueue:ee(y.pollConcurrency),saveQueue:ee(y.saveConcurrency)},xe={apiKey:"global_api_key",baseUrl:"global_base_url"},S={apiKey:"",baseUrl:""};function Se(){return{apiKey:localStorage.getItem(xe.apiKey)||localStorage.getItem("video_api_key")||localStorage.getItem("apiKey")||"",baseUrl:localStorage.getItem(xe.baseUrl)||localStorage.getItem("video_base_url")||localStorage.getItem("baseUrl")||""}}async function ot(){try{const e=await fetch("/api/v1/provider-config",{credentials:"include"});if(!e.ok)return{apiKey:"",baseUrl:""};const o=await e.json();return{apiKey:String((o==null?void 0:o.api_key)||""),baseUrl:String((o==null?void 0:o.base_url)||"")}}catch(e){return console.warn("[config] Failed to load env defaults",e),{apiKey:"",baseUrl:""}}}async function nt(){const e=Se();if(S.apiKey=e.apiKey,S.baseUrl=e.baseUrl,!S.apiKey||!S.baseUrl){const o=await ot();!S.apiKey&&o.apiKey&&(S.apiKey=o.apiKey),!S.baseUrl&&o.baseUrl&&(S.baseUrl=o.baseUrl)}}let Be=nt();async function st(){Be&&await Be;const e=Se();e.apiKey&&(S.apiKey=e.apiKey),e.baseUrl&&(S.baseUrl=e.baseUrl)}const ne=localStorage.getItem("video_model");ne&&Array.from(s.modelSelect.options).some(e=>e.value===ne)&&(s.modelSelect.value=ne);const se=localStorage.getItem("video_sora_variant");se&&Array.from(s.soraVariant.options).some(e=>e.value===se)&&(s.soraVariant.value=se);const re=localStorage.getItem("video_aspect_ratio");re&&Array.from(s.aspectRatio.options).some(e=>e.value===re)&&(s.aspectRatio.value=re);const ie=localStorage.getItem("video_duration");ie&&Array.from(s.duration.options).some(e=>e.value===ie)&&(s.duration.value=ie);const Le=localStorage.getItem("video_batch_count");if(Le){const e=Number.parseInt(Le,10);Number.isFinite(e)&&e>=1&&e<=y.maxBatchCount&&(s.batchCount.value=String(e))}rt();function rt(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-target")||"",t=o?document.getElementById(o):null;t&&(t.type=t.type==="password"?"text":"password")})})}if(s.modelSelect.addEventListener("change",()=>{localStorage.setItem("video_model",s.modelSelect.value),ke()}),s.soraVariant.addEventListener("change",()=>{localStorage.setItem("video_sora_variant",s.soraVariant.value),W()}),s.aspectRatio.addEventListener("change",()=>{localStorage.setItem("video_aspect_ratio",s.aspectRatio.value)}),s.duration.addEventListener("change",()=>{localStorage.setItem("video_duration",s.duration.value),W()}),s.soraHd.addEventListener("change",W),s.batchCount.addEventListener("change",()=>{const e=Number.parseInt(String(s.batchCount.value||"1"),10);if(Number.isFinite(e)){const o=Math.min(y.maxBatchCount,Math.max(1,e));s.batchCount.value=String(o),localStorage.setItem("video_batch_count",String(o))}}),s.soraPickFiles&&s.soraImages&&(s.soraPickFiles.addEventListener("click",()=>s.soraImages.click()),s.soraImages.addEventListener("change",async()=>{const e=s.soraImages.files?Array.from(s.soraImages.files):[];await Q(e,{source:"sora"}),s.soraImages.value=""})),s.promptPickFiles&&s.promptImages&&(s.promptPickFiles.addEventListener("click",()=>s.promptImages.click()),s.promptImages.addEventListener("change",async()=>{const e=s.promptImages.files?Array.from(s.promptImages.files):[];await Q(e,{source:"prompt"}),s.promptImages.value=""})),s.soraClearImages&&s.soraClearImages.addEventListener("click",()=>{b.items=[],N(),I("已清空参考图片","info")}),s.promptClearImages&&s.promptClearImages.addEventListener("click",()=>{b.items=[],N(),I("已清空参考图片","info")}),s.soraAddImageSources&&s.soraImageSourceInput&&(s.soraAddImageSources.addEventListener("click",()=>{const e=s.soraImageSourceInput.value,o=de(e);o>0&&(s.soraImageSourceInput.value="",N(),I(`已添加 ${o} 个图片来源`,"success"))}),s.soraImageSourceInput.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),s.soraAddImageSources.click())})),lt(),ct(),(Qe=s.generateBtn)==null||Qe.addEventListener("click",Je),(Ye=s.clearCompletedBtn)==null||Ye.addEventListener("click",()=>{Et(),q(),g("已清理已完成任务","info")}),(Xe=s.loadMoreTasksBtn)==null||Xe.addEventListener("click",()=>{p.renderLimit+=y.renderPageSize,q()}),s.historyBtn&&s.historyBtn.addEventListener("click",()=>{var e;(e=s.historyPanel)==null||e.classList.add("open"),document.body.classList.add("panel-open")}),s.closeHistoryBtn&&s.closeHistoryBtn.addEventListener("click",()=>{var e;(e=s.historyPanel)==null||e.classList.remove("open"),document.body.classList.remove("panel-open")}),(Ze=s.historyPanel)==null||Ze.addEventListener("click",e=>{e.target===s.historyPanel&&(s.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"))}),document.querySelectorAll(".collapsible-header").forEach(e=>{const o=e.dataset.target,t=document.getElementById(o);if(!t)return;const n=localStorage.getItem(`collapsed_${o}`);(n===null?o==="configContent":n==="true")&&(e.classList.add("collapsed"),t.classList.add("collapsed")),e.addEventListener("click",()=>{const r=e.classList.toggle("collapsed");t.classList.toggle("collapsed",r),localStorage.setItem(`collapsed_${o}`,String(r))})}),s.promptInput&&s.charCount){const e=()=>{s.charCount.textContent=`${s.promptInput.value.length} 字符`};s.promptInput.addEventListener("input",e),e()}s.inlineHistoryToggle&&s.inlineHistoryContent&&(localStorage.getItem("inlineHistoryCollapsed")==="true"&&((et=s.inlineHistorySection)==null||et.classList.add("collapsed")),s.inlineHistoryToggle.addEventListener("click",()=>{var t;const o=(t=s.inlineHistorySection)==null?void 0:t.classList.toggle("collapsed");localStorage.setItem("inlineHistoryCollapsed",String(o))})),document.addEventListener("keydown",e=>{var o;if(e.key==="Escape"){(o=s.historyPanel)!=null&&o.classList.contains("open")&&(s.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"),e.preventDefault());const t=document.getElementById("editPromptModalOverlay");t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.preventDefault())}(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&document.activeElement===s.promptInput&&(e.preventDefault(),Je())});const H={items:[],displayLimit:6,loading:!1};async function K(){if(!H.loading){H.loading=!0;try{const e=await fetch("/api/v1/videos?limit=50",{credentials:"include",headers:G()});if(!e.ok){if(e.status===401){H.items=[],ae();return}throw new Error(`加载失败 (${e.status})`)}const o=await e.json();H.items=Array.isArray(o)?o:o.items||[],ae()}catch(e){I(`加载历史记录失败: ${e.message}`,"error")}finally{H.loading=!1}}}function ae(){if(!s.inlineHistoryGrid||!s.inlineHistoryCount)return;const e=H.items;if(s.inlineHistoryCount.textContent=e.length,e.length===0){s.inlineHistoryGrid.innerHTML='<div class="inline-history-empty">暂无生成记录</div>',s.showMoreHistoryBtn&&(s.showMoreHistoryBtn.style.display="none");return}const o=e.slice(0,H.displayLimit);s.inlineHistoryGrid.innerHTML="",o.forEach(t=>{var v;const n=document.createElement("div");n.className="inline-history-item",n.dataset.id=t.id;const i=document.createElement("div");if(i.className="inline-history-thumb",t.video_url||t.thumbnail_url){const w=document.createElement("video");w.src=t.video_url||"",w.muted=!0,w.loop=!0,w.playsInline=!0,w.preload="metadata",i.appendChild(w),n.addEventListener("mouseenter",()=>w.play().catch(()=>{})),n.addEventListener("mouseleave",()=>{w.pause(),w.currentTime=0})}else i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';const a=document.createElement("div");a.className="inline-history-info";const r=document.createElement("div");r.className="inline-history-prompt",r.textContent=(t.prompt||"无提示词").slice(0,60)+(((v=t.prompt)==null?void 0:v.length)>60?"...":""),r.title=t.prompt||"";const l=document.createElement("div");l.className="inline-history-meta";const c=t.model||"unknown",d=t.created_at?new Date(t.created_at).toLocaleDateString():"";l.textContent=`${c} · ${d}`,a.appendChild(r),a.appendChild(l);const u=document.createElement("div");u.className="inline-history-actions";const f=document.createElement("button");f.className="inline-history-btn",f.title="加载",f.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',f.addEventListener("click",w=>{w.stopPropagation(),Te(t)});const h=document.createElement("button");h.className="inline-history-btn",h.title="编辑提示词",h.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',h.addEventListener("click",w=>{w.stopPropagation(),it(t)});const m=document.createElement("button");m.className="inline-history-btn danger",m.title="删除",m.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',m.addEventListener("click",w=>{w.stopPropagation(),at(t.id)}),u.appendChild(f),u.appendChild(h),u.appendChild(m),n.appendChild(i),n.appendChild(a),n.appendChild(u),n.addEventListener("click",()=>Te(t)),s.inlineHistoryGrid.appendChild(n)}),s.showMoreHistoryBtn&&(s.showMoreHistoryBtn.style.display=e.length>H.displayLimit?"":"none")}function Te(e){var o,t;e.prompt&&(s.promptInput.value=e.prompt,s.charCount&&(s.charCount.textContent=`${e.prompt.length} 字符`)),e.video_url&&s.resultContainer&&s.resultVideo&&((o=s.resultPlaceholder)==null||o.classList.add("hidden"),(t=s.loadingState)==null||t.classList.add("hidden"),s.resultContainer.classList.remove("hidden"),s.resultVideo.src=e.video_url),g("已加载历史记录","success")}function it(e){const o=document.getElementById("editPromptModalOverlay"),t=document.getElementById("editPromptTextarea"),n=document.getElementById("saveEditPromptBtn"),i=document.getElementById("cancelEditPromptBtn");if(!o||!t)return;t.value=e.prompt||"",o.classList.remove("hidden"),t.focus();const a=async()=>{const d=t.value.trim();if(!d){g("提示词不能为空","error");return}try{const u=await fetch(`/api/v1/videos/${e.id}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json",...G()},body:JSON.stringify({prompt:d})});if(!u.ok)throw new Error(`更新失败 (${u.status})`);o.classList.add("hidden"),g("提示词已更新","success"),K()}catch(u){g(`更新失败: ${u.message}`,"error")}},r=()=>{o.classList.add("hidden")},l=n.cloneNode(!0),c=i.cloneNode(!0);n.parentNode.replaceChild(l,n),i.parentNode.replaceChild(c,i),l.addEventListener("click",a),c.addEventListener("click",r)}async function at(e){if(confirm("确定要删除这条记录吗？"))try{const o=await fetch(`/api/v1/videos/${e}`,{method:"DELETE",credentials:"include",headers:G()});if(!o.ok)throw new Error(`删除失败 (${o.status})`);g("已删除","success"),K()}catch(o){g(`删除失败: ${o.message}`,"error")}}s.showMoreHistoryBtn&&s.showMoreHistoryBtn.addEventListener("click",()=>{H.displayLimit+=6,ae()});function O(e){if(!(!s.statusDot||!s.statusText))switch(s.statusDot.className="status-dot",e){case"ready":s.statusDot.classList.add("ready"),s.statusText.textContent="就绪";break;case"generating":s.statusDot.classList.add("generating"),s.statusText.textContent="生成中...";break;case"error":s.statusDot.classList.add("error"),s.statusText.textContent="错误";break;default:s.statusText.textContent=e}}function Me(e){if(!(!s.resultPlaceholder||!s.loadingState||!s.resultContainer)){if(!e){s.resultPlaceholder.classList.remove("hidden"),s.loadingState.classList.add("hidden"),s.resultContainer.classList.add("hidden"),O("ready");return}if(e.status==="completed"&&e.videoUrl)s.resultPlaceholder.classList.add("hidden"),s.loadingState.classList.add("hidden"),s.resultContainer.classList.remove("hidden"),s.resultVideo&&(s.resultVideo.src=e.videoUrl),O("ready");else if(["pending","processing","queued"].includes(e.status)){s.resultPlaceholder.classList.add("hidden"),s.loadingState.classList.remove("hidden"),s.resultContainer.classList.add("hidden");const o=typeof e.progress=="number"?e.progress:0,t=Math.min(100,Math.max(0,o)),n=t>0?t:e.status==="queued"?1:2;s.progressFill&&(s.progressFill.style.width=`${n}%`),s.progressText&&(s.progressText.textContent=`${n}%`),O("generating")}else e.status==="failed"&&(s.resultPlaceholder.classList.remove("hidden"),s.loadingState.classList.add("hidden"),s.resultContainer.classList.add("hidden"),O("error"))}}K(),O("ready");const Pe=document.getElementById("downloadBtn"),$e=document.getElementById("shareBtn"),Ue=document.getElementById("fullscreenBtn"),He=document.getElementById("showPromptHistory"),Ne=document.getElementById("closeEditPromptModal");Pe&&Pe.addEventListener("click",()=>{var t;const e=(t=s.resultVideo)==null?void 0:t.src;if(!e){g("没有可下载的视频","warning");return}const o=document.createElement("a");o.href=e,o.download=`video_${Date.now()}.mp4`,o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o),g("开始下载视频","success")}),$e&&$e.addEventListener("click",async()=>{var o;const e=(o=s.resultVideo)==null?void 0:o.src;if(!e){g("没有可分享的视频","warning");return}if(navigator.share)try{await navigator.share({title:"Generated Video",url:e})}catch(t){t.name!=="AbortError"&&(Y(e),g("链接已复制到剪贴板","success"))}else Y(e),g("链接已复制到剪贴板","success")}),Ue&&Ue.addEventListener("click",()=>{const e=s.resultVideo;e&&(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}),He&&He.addEventListener("click",()=>{s.inlineHistorySection&&(s.inlineHistorySection.classList.remove("collapsed"),s.inlineHistorySection.scrollIntoView({behavior:"smooth",block:"start"}))}),Ne&&Ne.addEventListener("click",()=>{const e=document.getElementById("editPromptModalOverlay");e&&e.classList.add("hidden")}),s.taskList.addEventListener("click",e=>{const o=e.target instanceof Element?e.target:null;if(!o)return;const t=o.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const n=t.getAttribute("data-action")||"",i=t.closest("[data-local-id]"),a=i==null?void 0:i.getAttribute("data-local-id");if(a){if(n==="cancel"){It(a);return}if(n==="retry"){Ct(a);return}if(n==="copy-url"){const r=p.byLocalId.get(a),l=(r==null?void 0:r.videoUrl)||"";l&&(Y(l),g("已复制视频链接","success"));return}if(n==="save"){const r=p.byLocalId.get(a);r&&ge(r,{manual:!0});return}}}),ke(),N(),q();const z={message:"",type:"",at:0};function I(e,o="info"){const t=String(e||""),n=String(o||"info");console[n==="error"?"error":n==="warning"?"warn":"log"](`[${n}] ${t}`);const a=n==="error"?"error":n==="warning"?"warning":n==="success"?"success":"info",r=Date.now();t&&(z.message!==t||z.type!==a||r-z.at>1200)&&(z.message=t,z.type=a,z.at=r,g(t,a))}function g(e,o="info",t={}){const n=Number.parseInt(String(t.durationMs??2800),10),i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`t-${Date.now()}-${Math.random().toString(16).slice(2)}`,a=document.createElement("div");a.className=`toast toast-${o}`,a.setAttribute("data-toast-id",i),a.textContent=String(e||""),s.toastContainer.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")});const r=()=>{a.classList.remove("show"),a.classList.add("hide"),setTimeout(()=>a.remove(),220)};setTimeout(r,Number.isFinite(n)?n:2800),a.addEventListener("click",r)}function ke(){const o=s.modelSelect.value==="sora2";s.sora2Params.classList.toggle("hidden",!o),o&&W()}function W(){if(s.modelSelect.value!=="sora2")return;const e=s.soraVariant.value,o=Number.parseInt(s.duration.value,10),t=e==="sora-2-pro",n=t,i=t&&o!==25;for(const a of Array.from(s.duration.options))a.value==="25"&&(a.disabled=!n);!n&&o===25&&(s.duration.value="15"),s.soraHd.disabled=!i,i||(s.soraHd.checked=!1)}function lt(){const e="drag-over";[{zone:s.soraDropzone,input:s.soraImages,source:"sora"},{zone:s.promptDropzone,input:s.promptImages,source:"prompt"}].filter(t=>t.zone&&t.input).forEach(({zone:t,input:n,source:i})=>{const a=r=>{const l=r.relatedTarget;l instanceof Node&&t.contains(l)||t.classList.remove(e)};t.addEventListener("dragenter",r=>{r.preventDefault(),r.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragover",r=>{r.preventDefault(),r.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragleave",r=>{r.preventDefault(),r.stopPropagation(),a(r)}),t.addEventListener("drop",async r=>{var c;r.preventDefault(),r.stopPropagation(),t.classList.remove(e);const l=(c=r.dataTransfer)!=null&&c.files?Array.from(r.dataTransfer.files):[];await Q(l,{source:i})}),t.addEventListener("paste",async r=>{var d;const c=((d=r.clipboardData)!=null&&d.items?Array.from(r.clipboardData.items):[]).filter(u=>u.kind==="file").map(u=>u.getAsFile()).filter(Boolean);c.length&&(r.preventDefault(),await Q(c,{source:i}))}),t.addEventListener("click",r=>{const l=r.target;l instanceof HTMLElement&&l.closest("button")||n.click()})})}function ct(){const e=()=>me();s.modalBackdrop.addEventListener("click",e),s.modalClose.addEventListener("click",e),document.addEventListener("keydown",o=>{o.key==="Escape"&&!s.imageModal.classList.contains("hidden")&&e()}),s.modalCopy.addEventListener("click",async()=>{const o=String(s.modalValue.value||"");try{await navigator.clipboard.writeText(o),I("已复制到剪贴板","success")}catch{const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),I("已复制到剪贴板","success")}}),s.modalSave.addEventListener("click",()=>{const o=b.editingId;if(!o)return;const t=String(s.modalValue.value||"").trim();if(!t){I("错误: 图片内容不能为空","error");return}if(!le(t)){I("错误: 仅支持 http/https URL 或 data:image/...base64","error");return}const n=b.items.find(i=>i.id===o);n&&(n.value=t,n.kind=t.startsWith("data:image")?"data":"url",N(),me(),I("已更新图片内容","success"))})}function dt(e){return new Promise((o,t)=>{const n=new FileReader;n.onload=()=>o(String(n.result||"")),n.onerror=()=>t(n.error||new Error("读取文件失败")),n.readAsDataURL(e)})}function De(e){return String(e||"").split(/\r?\n/).map(o=>o.trim()).filter(Boolean)}function le(e){const o=String(e||"").trim();if(!o)return!1;if(o.startsWith("data:image"))return!0;try{const t=new URL(o);return["http:","https:"].includes(t.protocol)}catch{return!1}}function mt(e){if(!e)return null;const o=e.trim();if(!o)return null;let t;try{t=new URL(o)}catch{throw new Error("notify_hook 必须是合法的 URL")}if(!["http:","https:"].includes(t.protocol))throw new Error("notify_hook 必须是 http/https URL");return t.toString()}function ut(e){const o=String(e||"").trim();if(!o)throw new Error("请输入 Base URL");let t;try{t=new URL(o)}catch{throw new Error("Base URL 不是合法的 URL")}if(t.protocol!=="https:")throw new Error("Base URL 必须使用 HTTPS 协议");if(!t.hostname)throw new Error("Base URL 缺少 host，例如 https://api.example.com");const n=t.origin;return(t.pathname!=="/"||t.search||t.hash)&&I(`提示: Base URL 包含路径/参数，已自动使用 origin: ${n}`,"warning"),n}function pt(e){const o=t=>encodeURIComponent(String(t||""));switch(e){case"sora2":return{createPath:"/v2/videos/generations",statusPath:t=>`/v2/videos/generations/${o(t)}`};case"veo":return{createPath:"/v1/video/veo/text-to-video",statusPath:t=>`/v1/video/veo/tasks/${o(t)}`};case"seedance":return{createPath:"/v1/video/seedance/text-to-video",statusPath:t=>`/v1/video/seedance/tasks/${o(t)}`};case"newmodel":return{createPath:"/v1/video/newmodel/text-to-video",statusPath:t=>`/v1/video/newmodel/tasks/${o(t)}`};default:throw new Error(`不支持的模型: ${e}`)}}function _e(e,o=!1){const n={Authorization:`Bearer ${Ae(e)}`};return o&&(n["Content-Type"]="application/json"),n}function Ae(e){return String(e||"").trim().replace(/^bearer\\s+/i,"").trim()}async function ce(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const t=await e.text();try{return JSON.parse(t)}catch{return t}}function gt(e,o){const i=`; ${typeof document<"u"?document.cookie:""}`.split(`; ${e}=`);return i.length===2?i.pop().split(";").shift():null}function G(){const e=gt("csrf_token");return e?{"X-CSRF-Token":e}:{}}function ft(e,o){if(typeof e=="string")return e;if(!e||typeof e!="object")return o;const t=e.detail??e.error??e.message;if(typeof t=="string")return t;if(Array.isArray(t))return t.map(n=>{if(!n||typeof n!="object")return String(n);const i=Array.isArray(n.loc)?n.loc.join("."):"",a=n.msg?String(n.msg):JSON.stringify(n);return i?`${i}: ${a}`:a}).join("; ");try{return JSON.stringify(t)}catch{return o}}function J(e){const o=Number(e||0);if(!Number.isFinite(o)||o<=0)return"0 B";const t=["B","KB","MB","GB"];let n=0,i=o;for(;i>=1024&&n<t.length-1;)i/=1024,n+=1;const a=n===0?0:n===1?1:2;return`${i.toFixed(a)} ${t[n]}`}function Re(e){const o=e==="prompt"?"prompt":"sora";return{zone:o==="prompt"?s.promptDropzone:s.soraDropzone,pickBtn:o==="prompt"?s.promptPickFiles:s.soraPickFiles,clearBtn:o==="prompt"?null:s.soraClearImages,textEl:o==="prompt"?s.promptUploadText:s.soraUploadText,progressEl:o==="prompt"?s.promptUploadProgress:s.soraUploadProgress,metaEl:o==="prompt"?s.promptUploadMeta:s.soraUploadMeta}}function U(e,{isProcessing:o,state:t,text:n,progress:i,meta:a}={}){const r=Re(e);if(r.zone&&(typeof o=="boolean"&&r.zone.classList.toggle("is-processing",o),t==="success"||t==="error"?(r.zone.classList.toggle("is-success",t==="success"),r.zone.classList.toggle("is-error",t==="error")):t==="clear"&&(r.zone.classList.remove("is-success"),r.zone.classList.remove("is-error")),r.textEl&&typeof n=="string"&&(r.textEl.textContent=n),r.metaEl&&typeof a=="string"&&(r.metaEl.textContent=a),r.progressEl&&typeof i=="number")){const l=Math.min(100,Math.max(0,i));r.progressEl.style.width=`${l}%`}}function Fe(e,o){const t=Re(e);t.zone&&(t.zone.classList.toggle("is-loading",o),t.pickBtn&&(t.pickBtn.disabled=o),t.clearBtn&&(t.clearBtn.disabled=o||b.items.length===0),e!=="prompt"&&(s.soraAddImageSources.disabled=o))}async function ht(e,o={}){const t=Number(o.thresholdBytes??y.imageCompressThresholdBytes),n=Number(o.maxDimension??y.imageMaxDimension);if(!e||!Number.isFinite(e.size)||e.size<=t)return{file:e,compressed:!1,originalBytes:(e==null?void 0:e.size)||0,outputBytes:(e==null?void 0:e.size)||0};const a=await(async()=>{if(globalThis.createImageBitmap)return await globalThis.createImageBitmap(e);const r=URL.createObjectURL(e);try{const l=new Image;return l.decoding="async",l.src=r,await new Promise((c,d)=>{l.onload=c,l.onerror=()=>d(new Error("图片解码失败"))}),l}finally{URL.revokeObjectURL(r)}})();try{const r=a.width||a.naturalWidth||0,l=a.height||a.naturalHeight||0;if(!r||!l)return{file:e,compressed:!1,originalBytes:e.size,outputBytes:e.size};const c=document.createElement("canvas"),d=c.getContext("2d",{alpha:!0});if(!d)throw new Error("Canvas 初始化失败");let u=1;const f=Math.max(r,l);Number.isFinite(n)&&n>0&&f>n&&(u=n/f);let h=Math.max(1,Math.round(r*u)),m=Math.max(1,Math.round(l*u));c.width=h,c.height=m;const v=(P,T)=>new Promise(C=>{c.toBlob(j=>C(j),P,T)}),w=()=>{d.clearRect(0,0,c.width,c.height),d.drawImage(a,0,0,c.width,c.height)};w();const L=e.size;let F=null,D=1/0,_=.84,V="image/jpeg";for(let P=0;P<4;P+=1){const T=await v(V,_);if(!T)break;const C=T.size||0;if(C>0&&C<D&&(F=T,D=C),C>0&&C<=t)break;_=Math.max(.58,_-.12),h=Math.max(1,Math.round(h*.92)),m=Math.max(1,Math.round(m*.92)),c.width=h,c.height=m,w()}if(!F||D>=L)return{file:e,compressed:!1,originalBytes:L,outputBytes:L};const A=new File([F],e.name.replace(/\.\w+$/,"")+".jpg",{type:V,lastModified:Date.now()});return{file:A,compressed:!0,originalBytes:L,outputBytes:A.size}}finally{typeof(a==null?void 0:a.close)=="function"&&a.close()}}async function Q(e,o={}){const t=o.source==="prompt"?"prompt":"sora",n=(e||[]).filter(i=>{if(!i)return!1;if(String(i.type||"").startsWith("image/"))return!0;const r=String(i.name||"");return/\.(png|jpe?g|webp|gif|bmp|svg|ico|tiff?)$/i.test(r)});if(n.length===0){e&&e.length&&I("未检测到可用的图片文件","warning");return}b.readingCount+=n.length,Fe(t,!0),U(t,{isProcessing:!0,state:"clear",text:"处理中…",progress:0,meta:""});try{const i=n.length;let a=0;for(let r=0;r<i;r+=1){const l=n[r];U(t,{text:l.size>y.imageCompressThresholdBytes?"压缩中…":"读取中…",meta:`${r+1}/${i} · ${l.name} · ${J(l.size)}`,progress:Math.round(a/i*100)});let c=l;if(l.size>y.imageCompressThresholdBytes){const f=l.size,h=await ht(l,{thresholdBytes:y.imageCompressThresholdBytes,maxDimension:y.imageMaxDimension});c=h.file,h.compressed?U(t,{text:"压缩完成，读取中…",meta:`${r+1}/${i} · ${l.name} · ${J(f)} → ${J(c.size)}`}):U(t,{text:"读取中…",meta:`${r+1}/${i} · ${l.name} · ${J(f)}`})}const d=await dt(c),u=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;b.items.push({id:u,kind:"data",value:d,name:(c==null?void 0:c.name)||(l==null?void 0:l.name)||"image",size:(c==null?void 0:c.size)||(l==null?void 0:l.size)||0}),a+=1,U(t,{progress:Math.round(a/i*100)})}N(),U(t,{state:"success",text:`已添加 ${n.length} 张图片`,meta:`${n.length} 张 · ${b.items.length} 张总计`,progress:100}),I(`已添加 ${n.length} 张图片（已转 Base64）`,"success"),setTimeout(()=>{U(t,{isProcessing:!1})},900),setTimeout(()=>{U(t,{state:"clear"})},1600)}catch(i){U(t,{state:"error",text:"添加失败",meta:String((i==null?void 0:i.message)||i||""),progress:0}),setTimeout(()=>U(t,{isProcessing:!1}),1400),I(`添加图片失败: ${i.message||i}`,"error")}finally{b.readingCount=Math.max(0,b.readingCount-n.length),Fe(t,b.readingCount>0),N()}}function de(e){const o=De(e);let t=0;for(const n of o){if(!le(n)){I(`跳过无效图片来源: ${n.slice(0,80)}${n.length>80?"…":""}`,"warning");continue}const i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;b.items.push({id:i,kind:n.startsWith("data:image")?"data":"url",value:n,name:n.startsWith("data:image")?"base64":"url",size:0}),t+=1}return t}function N(){const e=b.items.length,o=s.promptImageCount||s.soraImageCount,t=s.promptClearImages||s.soraClearImages,n=s.promptImagePreviewWrap||null,i=s.promptImagePreview||s.soraImagePreview;if(o&&(o.textContent=`${e} 张图片`),t&&(t.disabled=b.readingCount>0||e===0),n&&n.classList.toggle("hidden",e===0),!i||(i.innerHTML="",e===0))return;const r=`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">
                <rect width="200" height="150" rx="12" fill="#F5F5F7"/>
                <path d="M62 96l16-18 16 18 22-26 22 26" fill="none" stroke="#86868b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="78" cy="58" r="10" fill="#d1d1d6"/>
                <text x="100" y="128" font-family="system-ui, -apple-system" font-size="12" fill="#86868b" text-anchor="middle">Preview unavailable</text>
            </svg>`)}`;for(const l of b.items){const c=document.createElement("div");c.className="preview-item",c.dataset.id=l.id;const d=document.createElement("img");d.className="preview-img",d.loading="lazy",d.alt=l.name||"image",d.src=l.value,d.addEventListener("click",()=>Ve(l.id)),d.onerror=()=>{d.src=r,d.classList.add("is-fallback")};const u=document.createElement("div");u.className="preview-actions";const f=document.createElement("button");f.type="button",f.className="preview-btn",f.textContent="编辑",f.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),Ve(l.id)});const h=document.createElement("button");h.type="button",h.className="preview-btn danger",h.textContent="移除",h.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),b.items=b.items.filter(w=>w.id!==l.id),N(),I("已移除图片","info")}),u.appendChild(f),u.appendChild(h);const m=document.createElement("div");m.className="preview-caption",m.textContent=l.kind==="url"?"URL":"Base64",c.appendChild(d),c.appendChild(u),c.appendChild(m),i.appendChild(c)}}function Ve(e){const o=b.items.find(t=>t.id===e);o&&(b.editingId=e,s.modalImage.src=o.value,s.modalValue.value=o.value,s.imageModal.classList.remove("hidden"),document.body.classList.add("modal-open"),s.modalValue.focus())}function me(){b.editingId=null,s.imageModal.classList.add("hidden"),document.body.classList.remove("modal-open"),s.modalImage.src="",s.modalValue.value=""}function Y(e){var n;const o=String(e||"");if(!o)return;if((n=navigator.clipboard)!=null&&n.writeText){navigator.clipboard.writeText(o).catch(()=>{});return}const t=document.createElement("textarea");t.value=o,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove()}function ze(e,o,t,n){const i=Number.parseInt(String(e??""),10);return Number.isFinite(i)?Math.min(t,Math.max(o,i)):n}function ue(e){const o=Number(e);return!Number.isFinite(o)||o<=0?null:o<1e10?Math.round(o*1e3):Math.round(o)}function vt(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return Math.min(100,Math.max(0,Math.round(e)));const t=String(e).trim().match(/(\d+(?:\.\d+)?)/),n=t?Number.parseFloat(t[1]):0;return Number.isFinite(n)?Math.min(100,Math.max(0,Math.round(n))):0}function yt(e){const o=String(e||"").trim().toLowerCase();return o?["success","succeeded","ok","completed","done","finished","finish"].includes(o)?"completed":["fail","failed","error","timeout"].includes(o)?"failed":["cancelled","canceled","cancel"].includes(o)?"cancelled":["processing","running","executing","in_progress","in-progress","working"].includes(o)?"processing":(["queued","pending","waiting","created","init","initializing"].includes(o),"pending"):"pending"}function X(e){return{queued:"排队中",pending:"等待",processing:"处理中",completed:"成功",failed:"失败",cancelled:"已取消"}[e]||"等待"}function B(e){return["completed","failed","cancelled"].includes(String(e||""))}function bt(e){var n,i,a,r,l;const o=[e==null?void 0:e.video_url,e==null?void 0:e.videoUrl,e==null?void 0:e.url,(n=e==null?void 0:e.data)==null?void 0:n.video_url,(i=e==null?void 0:e.data)==null?void 0:i.videoUrl,(a=e==null?void 0:e.data)==null?void 0:a.url,(r=e==null?void 0:e.data)==null?void 0:r.output];for(const c of o)if(typeof c=="string"&&/^https?:\/\//i.test(c.trim()))return c.trim();const t=(l=e==null?void 0:e.data)==null?void 0:l.output;if(t&&typeof t=="object"){const c=[t.url,t.video_url,t.videoUrl];for(const d of c)if(typeof d=="string"&&/^https?:\/\//i.test(d.trim()))return d.trim()}return null}function pe(e){return{taskId:(e==null?void 0:e.task_id)||(e==null?void 0:e.taskId)||(e==null?void 0:e.id)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,rawStatus:(e==null?void 0:e.status)||null,status:yt(e==null?void 0:e.status),progress:vt(e==null?void 0:e.progress),failReason:(e==null?void 0:e.fail_reason)||(e==null?void 0:e.failReason)||(e==null?void 0:e.error)||(e==null?void 0:e.detail)||"",submitTimeMs:ue(e==null?void 0:e.submit_time),startTimeMs:ue(e==null?void 0:e.start_time),finishTimeMs:ue(e==null?void 0:e.finish_time),cost:typeof(e==null?void 0:e.cost)=="number"?e.cost:null,videoUrl:bt(e)}}function Z(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return"—"}}function Ke(e){const o=Math.max(0,Math.floor(e/1e3)),t=o%60,n=Math.floor(o/60)%60,i=Math.floor(o/3600),a=r=>String(r).padStart(2,"0");return i>0?`${i}:${a(n)}:${a(t)}`:`${a(n)}:${a(t)}`}function ee(e=4){let o=0;const t=[],n=()=>{for(;o<e&&t.length>0;){const r=t.shift();!r||r.aborted||(r.started=!0,o+=1,Promise.resolve().then(()=>r.fn()).then(r.resolve,r.reject).finally(()=>{var l;o-=1,(l=r.cleanup)==null||l.call(r),n()}))}};return{enqueue:(r,l={})=>{const c=l.signal;return new Promise((d,u)=>{const f={fn:r,resolve:d,reject:u,signal:c,started:!1,aborted:!1,cleanup:null};if(c!=null&&c.aborted){u(new DOMException("Aborted","AbortError"));return}const h=()=>{if(f.started)return;f.aborted=!0;const m=t.indexOf(f);m>=0&&t.splice(m,1),u(new DOMException("Aborted","AbortError")),n()};c&&(c.addEventListener("abort",h,{once:!0}),f.cleanup=()=>c.removeEventListener("abort",h)),t.push(f),n()})},stats:()=>({active:o,pending:t.length,concurrency:e})}}function Oe(e,o){const t=String(o||"").trim();if(e==="sora2"){const n=s.soraVariant.value,i=s.aspectRatio.value,a=Number.parseInt(s.duration.value,10),r=!!s.soraWatermark.checked,l=!!s.soraPrivate.checked,c=!!s.soraHd.checked,d=n==="sora-2-pro";if(!d&&c)throw new Error("sora-2 不支持 HD，请切换到 sora-2-pro");if(!d&&a===25)throw new Error("sora-2 不支持 25 秒，请切换到 sora-2-pro");if(a===25&&c)throw new Error("duration=25 时 hd 不生效，请关闭 HD 或选择 10/15 秒");const u=mt(s.notifyHook?s.notifyHook.value:""),f=b.items.map(v=>v.value).filter(Boolean),h={model:n,prompt:t,aspect_ratio:i,duration:a,hd:c,watermark:r,private:l,...u?{notify_hook:u}:{},...f.length?{images:f}:{}},m=`${n} · ${i} · ${a}s · images=${f.length}`;return{payload:h,metaSummary:m}}return{payload:{model:e,prompt:t},metaSummary:e}}function qe(e){const o=document.createElement("div");o.className="task-wrapper",o.setAttribute("data-local-id",e.localId);const t=document.createElement("div");t.className="task-mini-preview hidden";const n=document.createElement("video");n.className="task-mini-video",n.muted=!0,n.loop=!0,n.playsInline=!0,n.controls=!0;const i=document.createElement("div");i.className="task-mini-preview-actions";const a=document.createElement("button");a.className="task-mini-btn",a.title="复制视频链接",a.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',a.onclick=Lt=>{Lt.preventDefault(),Y(e.videoUrl),g("链接已复制","success")};const r=document.createElement("a");r.className="task-mini-btn",r.title="下载视频",r.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',r.target="_blank",i.appendChild(a),i.appendChild(r),t.appendChild(n),t.appendChild(i);const l=document.createElement("details");l.className="task-item";const c=document.createElement("summary");c.className="task-summary";const d=document.createElement("div");d.className="task-main";const u=document.createElement("div");u.className="task-title";const f=document.createElement("div");f.className="task-name",f.textContent=e.name;const h=document.createElement("div");h.className="task-meta",h.textContent=e.metaSummary||"",u.appendChild(f),u.appendChild(h);const m=document.createElement("div");m.className="task-id",m.textContent="ID: -",d.appendChild(u),d.appendChild(m);const v=document.createElement("div");v.className="task-right";const w=document.createElement("span");w.className="badge badge-pending",w.textContent="等待";const L=document.createElement("div");L.className="task-progress";const F=document.createElement("div");F.className="task-progress-bar";const D=document.createElement("div");D.className="task-progress-fill",D.style.width="0%",F.appendChild(D);const _=document.createElement("div");_.className="task-progress-text",_.textContent="0%",L.appendChild(F),L.appendChild(_);const V=document.createElement("div");V.className="task-time",V.textContent="—";const A=document.createElement("div");A.className="task-actions";const P=document.createElement("button");P.type="button",P.className="btn btn-secondary btn-sm",P.setAttribute("data-action","save"),P.textContent="保存到存储库";const T=document.createElement("button");T.type="button",T.className="btn btn-secondary btn-sm",T.setAttribute("data-action","retry"),T.textContent="重试";const C=document.createElement("button");C.type="button",C.className="btn btn-secondary btn-sm",C.setAttribute("data-action","cancel"),C.textContent="取消",A.appendChild(P),A.appendChild(T),A.appendChild(C),v.appendChild(w),v.appendChild(L),v.appendChild(V),v.appendChild(A),c.appendChild(d),c.appendChild(v);const j=document.createElement("div");j.className="task-details";const fe=document.createElement("div");fe.className="task-info";const $=document.createElement("div");$.className="task-info-grid";const he=document.createElement("div");he.className="task-info-line";const ve=document.createElement("div");ve.className="task-info-line";const ye=document.createElement("div");ye.className="task-info-line";const be=document.createElement("div");be.className="task-info-line";const we=document.createElement("div");we.className="task-info-line";const Ee=document.createElement("div");Ee.className="task-info-line";const oe=document.createElement("div");oe.className="task-info-line",oe.textContent="存储库: —";const Ie=document.createElement("div");Ie.className="task-error hidden";const Ce=document.createElement("div");return Ce.className="task-error hidden",$.appendChild(he),$.appendChild(ve),$.appendChild(ye),$.appendChild(be),$.appendChild(we),$.appendChild(Ee),$.appendChild(oe),$.appendChild(Ie),$.appendChild(Ce),fe.appendChild($),j.appendChild(fe),l.appendChild(c),l.appendChild(j),o.appendChild(t),o.appendChild(l),e.dom={root:o,badge:w,fill:D,progressText:_,idEl:m,timeEl:V,metaEl:h,nameEl:f,saveBtn:P,retryBtn:T,cancelBtn:C,platformEl:he,actionEl:ve,submitEl:ye,startEl:be,finishEl:we,costEl:Ee,repoStatusEl:oe,repoErrorEl:Ie,errorEl:Ce,miniPreview:t,miniVideo:n,miniDlBtn:r},l.addEventListener("toggle",()=>{M(e)}),o}function M(e){if(!e.dom)return;const o=e.status==="processing"?"processing":e.status==="completed"?"completed":e.status==="failed"?"failed":e.status==="cancelled"?"cancelled":"pending";e.dom.badge.className=`badge badge-${o}`,e.dom.badge.textContent=X(e.status),e.dom.progressText.textContent=`${e.progress}%`,e.dom.fill.style.width=`${e.progress}%`,e.dom.idEl.textContent=`ID: ${e.taskId||"-"}`,je(e),e.dom.platformEl.textContent=`平台: ${e.platform||"—"}`,e.dom.actionEl.textContent=`动作: ${e.action||"—"}`,e.dom.submitEl.textContent=`提交: ${Z(e.submitTimeMs)}`,e.dom.startEl.textContent=`开始: ${Z(e.startTimeMs)}`,e.dom.finishEl.textContent=`完成: ${Z(e.finishTimeMs)}`,e.dom.costEl.textContent=e.cost!=null?`花费: ${e.cost}`:"花费: —";const t=e.repoSave||{status:"idle",errorMessage:""};let n="—";e.status==="completed"&&(e.videoUrl?t.status==="saved"?n="已保存":t.status==="saving"?n="保存中...":t.status==="failed"?n="保存失败":n="待保存":n="缺少视频链接"),e.dom.repoStatusEl.textContent=`存储库: ${n}`,t.status==="failed"&&String(t.errorMessage||"").trim()?(e.dom.repoErrorEl.classList.remove("hidden"),e.dom.repoErrorEl.textContent=`保存失败: ${String(t.errorMessage).trim()}`):(e.dom.repoErrorEl.classList.add("hidden"),e.dom.repoErrorEl.textContent="");const i=String(e.failReason||"").trim();i?(e.dom.errorEl.classList.remove("hidden"),e.dom.errorEl.textContent=`错误: ${i}`):(e.dom.errorEl.classList.add("hidden"),e.dom.errorEl.textContent="");const a=!B(e.status)&&!e.controller.signal.aborted;e.dom.cancelBtn.disabled=!a;const r=B(e.status)&&e.status!=="completed";e.dom.retryBtn.style.display=r?"":"none";const l=e.status==="completed"&&!!e.videoUrl;if(e.dom.saveBtn.style.display=l?"":"none",l?t.status==="saved"?(e.dom.saveBtn.textContent="已保存",e.dom.saveBtn.disabled=!0):t.status==="saving"?(e.dom.saveBtn.textContent="保存中...",e.dom.saveBtn.disabled=!0):t.status==="failed"?(e.dom.saveBtn.textContent="重试保存",e.dom.saveBtn.disabled=!1):(e.dom.saveBtn.textContent="保存到存储库",e.dom.saveBtn.disabled=!1):e.dom.saveBtn.disabled=!0,e.videoUrl){if(e.dom.miniPreview.classList.remove("hidden"),e.dom.miniVideo.getAttribute("src")!==e.videoUrl){e.dom.miniVideo.src=e.videoUrl,e.dom.miniDlBtn.href=e.videoUrl;try{const u=new URL(e.videoUrl).pathname.split("/").pop();e.dom.miniDlBtn.download=u||`video_${e.taskId}.mp4`}catch{e.dom.miniDlBtn.download=`video_${e.taskId}.mp4`}}}else e.dom.miniPreview.classList.add("hidden"),e.dom.miniVideo.getAttribute("src")&&(e.dom.miniVideo.removeAttribute("src"),e.dom.miniVideo.load())}function je(e){var a;if(!((a=e==null?void 0:e.dom)!=null&&a.timeEl))return;const o=Date.now(),t=e.startTimeMs||e.submitTimeMs||e.createdAt||o,i=(e.finishTimeMs||(B(e.status)?e.updatedAt:null)||o)-t;e.dom.timeEl.textContent=`耗时 ${Ke(i)}`}function We(){const e=p.order.length;let o=0,t=0,n=0,i=0;for(const a of p.order){const r=p.byLocalId.get(a);r&&(r.status==="processing"?o+=1:r.status==="completed"?t+=1:r.status==="failed"?n+=1:r.status==="cancelled"&&(i+=1))}s.taskSummary.textContent=`${e} 个任务 · 处理中 ${o} · 成功 ${t} · 失败 ${n} · 取消 ${i}`}function q(){We();const e=p.order.length;s.statusContainer&&s.statusContainer.classList.toggle("hidden",e>0);const o=p.order.slice(0,p.renderLimit);s.taskList.innerHTML="";for(const t of o){const n=p.byLocalId.get(t);n&&(n.dom||qe(n),M(n),s.taskList.appendChild(n.dom.root))}s.taskListFooter&&s.taskListFooter.classList.toggle("hidden",e<=p.renderLimit)}function x(e,o,t="info"){const n=typeof e=="string"?p.byLocalId.get(e):e;if(!n)return;const i={time:new Date().toLocaleTimeString(),type:t,message:String(o||"")};Array.isArray(n.logs)||(n.logs=[]),n.logs.push(i),n.logs.length>y.maxLogsPerTask*3&&n.logs.splice(0,n.logs.length-y.maxLogsPerTask*2),M(n)}function k(e,o,t={}){const n=String(o||"").trim();if(!n)return;const i=e.status;if(e.status=n,e.updatedAt=Date.now(),Object.assign(e,t),i!==n&&x(e,`状态更新: ${X(i)} -> ${X(n)}`,"info"),M(e),We(),n==="completed"&&i!=="completed"&&setTimeout(()=>{typeof K=="function"&&K()},1500),p.order.length>0){const a=p.order[0],r=p.byLocalId.get(a);r&&r.localId===e.localId&&typeof Me=="function"&&Me(e)}}function wt(){if(p.order.length<=y.maxTasks)return;const e=p.order.slice().reverse().filter(o=>{const t=p.byLocalId.get(o);return t&&B(t.status)});for(;p.order.length>y.maxTasks&&e.length>0;)te(e.shift());for(;p.order.length>y.maxTasks;)te(p.order[p.order.length-1])}function te(e){var n;const o=String(e||""),t=p.byLocalId.get(o);if(t){if(t.cleanupTimer&&clearTimeout(t.cleanupTimer),t.pollTimer&&clearTimeout(t.pollTimer),!t.controller.signal.aborted&&!B(t.status))try{t.controller.abort()}catch{}p.byLocalId.delete(o),p.order=p.order.filter(i=>i!==o),(n=t.dom)!=null&&n.root&&t.dom.root.parentElement&&t.dom.root.remove()}}function Et(){const e=p.order.slice();for(const o of e){const t=p.byLocalId.get(o);t&&B(t.status)&&te(o)}}function R(e){e.cleanupTimer&&clearTimeout(e.cleanupTimer),e.cleanupTimer=setTimeout(()=>{te(e.localId),q()},y.cleanupAfterMs)}function It(e){const o=p.byLocalId.get(String(e||""));if(o&&!B(o.status)){x(o,"用户取消任务（停止轮询）","warning");try{o.controller.abort()}catch{}o.pollTimer&&clearTimeout(o.pollTimer),o.finishTimeMs=o.finishTimeMs||Date.now(),k(o,"cancelled"),R(o),g(`已取消：${o.name}`,"info")}}function Ct(e){const o=p.byLocalId.get(String(e||""));if(!o||!o.request)return;const t=`${o.request.name||o.name}（重试）`;Ge({...o.request,name:t})}async function xt(e){if(!e.taskId)return;const o=`${e.baseUrl}${e.apiSpec.statusPath(e.taskId)}`,t=await fetch(o,{headers:_e(e.apiKey,!1),signal:e.controller.signal}),n=await ce(t);if(!t.ok){const i=(n==null?void 0:n.detail)||(n==null?void 0:n.error)||(typeof n=="string"?n:null);throw new Error(i||`轮询失败（HTTP ${t.status}）`)}return n}function St(e){var l,c,d,u,f,h,m,v;const o=String((e==null?void 0:e.videoUrl)||"").trim();if(!o)throw new Error("缺少视频链接");const t=((c=(l=e==null?void 0:e.request)==null?void 0:l.payload)==null?void 0:c.prompt)??((d=e==null?void 0:e.payload)==null?void 0:d.prompt)??((u=e==null?void 0:e.request)==null?void 0:u.prompt)??"",n=((h=(f=e==null?void 0:e.request)==null?void 0:f.payload)==null?void 0:h.model)??((m=e==null?void 0:e.payload)==null?void 0:m.model)??((v=e==null?void 0:e.request)==null?void 0:v.model)??(e==null?void 0:e.platform)??(e==null?void 0:e.modelKey)??"unknown",i=String(t||"").trim()||"No prompt",a=String(n||"").trim()||"unknown",r={provider_task_id:(e==null?void 0:e.taskId)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,cost:(e==null?void 0:e.cost)??null};return{title:(e==null?void 0:e.name)||(e!=null&&e.taskId?`Task ${e.taskId}`:"未命名任务"),model:a,prompt:i,video_url:o,status:"completed",metadata:r}}async function ge(e,{manual:o=!1}={}){const t=e;if(!t)return;const n=t.repoSave||{status:"idle",savedVideoId:null};if(n.status==="saving"){o&&g("正在保存...","info",{durationMs:1800});return}if(n.status==="saved"){o&&g("已保存到存储库","success",{durationMs:1800});return}if(t.status!=="completed"){o&&g("仅支持保存已完成的任务","warning");return}let i;try{i=St(t)}catch(r){const l=String((r==null?void 0:r.message)||r||"保存数据无效");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:null},M(t),I(`保存失败: ${l}`,"error");return}t.repoSave={status:"saving",errorMessage:"",savedVideoId:n.savedVideoId||null,payload:i},M(t),x(t,"开始保存到存储库","info");const a=async()=>{let r;try{r=await fetch("/api/v1/videos",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...G()},body:JSON.stringify(i)})}catch(d){const u=String((d==null?void 0:d.message)||d||"网络错误");t.repoSave={status:"failed",errorMessage:u,savedVideoId:null,payload:i},M(t),x(t,`保存失败: ${u}`,"error"),g(`保存失败：${u}`,"error");return}if(r.status===401){const d="登录已过期，请重新登录后再保存";t.repoSave={status:"failed",errorMessage:d,savedVideoId:null,payload:i},M(t),x(t,`保存失败: ${d}`,"warning"),g(d,"warning"),window.location.href="/login?next=/video";return}const l=await ce(r);if(!r.ok){let d=ft(l,`保存失败（HTTP ${r.status}）`);r.status===403&&d.toLowerCase().includes("csrf")&&(d=`${d}（请刷新页面后重试）`),t.repoSave={status:"failed",errorMessage:d,savedVideoId:null,payload:i},M(t),x(t,`保存失败: ${d}`,"error"),g(`保存失败：${d}`,"error",{durationMs:5200});return}const c=(l==null?void 0:l.id)||null;t.repoSave={status:"saved",errorMessage:"",savedVideoId:c,payload:i},M(t),x(t,"已保存到存储库","success"),g(`已保存到存储库：${t.name||t.taskId||""}`.trim(),"success",{durationMs:2200})};p.saveQueue.enqueue(a).catch(r=>{const l=String((r==null?void 0:r.message)||r||"保存失败");t.repoSave={status:"failed",errorMessage:l,savedVideoId:null,payload:i},M(t),x(t,`保存失败: ${l}`,"error"),I(`保存失败: ${l}`,"error")})}function Bt(e){if(!e.taskId||e.controller.signal.aborted)return;e.pollTimer&&clearTimeout(e.pollTimer);const o=async()=>{if(!e.controller.signal.aborted&&!B(e.status))try{const t=await p.pollQueue.enqueue(()=>xt(e),{signal:e.controller.signal});e.pollErrorCount=0;const n=pe(t);let i=n.status;n.videoUrl&&n.progress>=100&&!["failed","cancelled"].includes(i)&&(i="completed");const a=e.status;if(n.taskId&&(e.taskId=String(n.taskId)),e.platform=n.platform||e.platform,e.action=n.action||e.action,e.progress=n.progress,e.failReason=n.failReason||e.failReason,e.submitTimeMs=n.submitTimeMs||e.submitTimeMs,e.startTimeMs=n.startTimeMs||e.startTimeMs,e.finishTimeMs=n.finishTimeMs||e.finishTimeMs,e.cost=n.cost!=null?n.cost:e.cost,e.videoUrl=n.videoUrl||e.videoUrl,e.updatedAt=Date.now(),k(e,i),a!==e.status&&B(e.status)){const r=e.status==="completed"?"任务成功":e.status==="failed"?"任务失败":"任务已取消";x(e,r,e.status==="completed"?"success":e.status==="failed"?"error":"warning"),e.status==="completed"&&e.videoUrl&&ge(e)}if(e.status==="completed"&&e.videoUrl,B(e.status)){e.status==="completed"&&e.videoUrl?g(`完成：${e.name}`,"success"):e.status==="failed"&&g(`失败：${e.name}`,"error"),R(e);return}}catch(t){if((t==null?void 0:t.name)==="AbortError")return;if(e.pollErrorCount+=1,x(e,`轮询错误(${e.pollErrorCount}/${y.maxPollErrors}): ${t.message||t}`,"warning"),e.pollErrorCount>=y.maxPollErrors){e.failReason=e.failReason||String(t.message||t),k(e,"failed"),R(e),g(`轮询失败：${e.name}`,"error");return}}finally{const t=y.pollIntervalMs+Math.floor(Math.random()*y.pollJitterMs);e.pollTimer=setTimeout(o,t)}};e.pollTimer=setTimeout(o,1e3)}function Ge(e){const o=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,t={localId:o,name:e.name,modelKey:e.modelKey,metaSummary:e.metaSummary,baseUrl:e.baseUrl,apiKey:e.apiKey,apiSpec:e.apiSpec,payload:e.payload,request:e,status:"queued",progress:0,taskId:null,platform:null,action:null,failReason:"",videoUrl:null,createdAt:Date.now(),updatedAt:Date.now(),submitTimeMs:null,startTimeMs:null,finishTimeMs:null,cost:null,logs:[],pollTimer:null,pollErrorCount:0,cleanupTimer:null,controller:new AbortController,dom:null};p.byLocalId.set(o,t),p.order.unshift(o),wt(),qe(t),x(t,"已加入队列","info"),q();const n=p.createQueue.enqueue(async()=>{k(t,"pending");const i=await fetch(`${t.baseUrl}${t.apiSpec.createPath}`,{method:"POST",headers:_e(t.apiKey,!0),body:JSON.stringify(t.payload),signal:t.controller.signal}),a=await ce(i);if(!i.ok){const r=(a==null?void 0:a.detail)||(a==null?void 0:a.error)||(typeof a=="string"?a:null);throw new Error(r||`请求失败（HTTP ${i.status}）`)}return a},{signal:t.controller.signal});return t.createPromise=n,n.then(i=>{const a=pe(i);let r=a.status;if(a.videoUrl&&a.progress>=100&&!["failed","cancelled"].includes(r)&&(r="completed"),t.taskId=a.taskId?String(a.taskId):t.taskId,t.platform=a.platform||t.platform,t.action=a.action||t.action,t.progress=a.progress,t.failReason=a.failReason||"",t.submitTimeMs=a.submitTimeMs||t.submitTimeMs,t.startTimeMs=a.startTimeMs||t.startTimeMs,t.finishTimeMs=a.finishTimeMs||t.finishTimeMs,t.cost=a.cost!=null?a.cost:t.cost,t.videoUrl=a.videoUrl||t.videoUrl,!t.taskId){t.failReason=t.failReason||"响应缺少 task_id",k(t,"failed"),R(t),g(`创建失败：${t.name}`,"error");return}if(k(t,r),x(t,`任务创建成功: ${t.taskId}`,"success"),g(`已提交：${t.name}`,"success",{durationMs:1800}),t.status==="completed"&&t.videoUrl&&ge(t),B(t.status)){R(t);return}Bt(t)}).catch(i=>{if((i==null?void 0:i.name)==="AbortError"){k(t,"cancelled"),R(t);return}t.failReason=String((i==null?void 0:i.message)||i),k(t,"failed"),x(t,`创建失败: ${t.failReason}`,"error"),R(t),g(`创建失败：${t.name}`,"error")}),t}async function Je(){const e=Date.now();if(e-p.lastSubmitAt<y.submitDebounceMs)return;p.lastSubmitAt=e;const o=[["promptInput",s.promptInput],["modelSelect",s.modelSelect],["batchCount",s.batchCount],["taskNameInput",s.taskNameInput]];for(const[m,v]of o)if(!v){g(`页面缺少必要表单字段：${m}`,"error");return}await st();const t=Ae(S.apiKey);if(!t){g("??????? API Key ??????? API_KEY","error");return}let n;try{n=ut(S.baseUrl)}catch(m){g(`${m.message||"Base URL ??"}??????? Base URL ??????? API_BASE_URL`,"error");return}const i=s.promptInput.value.trim();if(!i){g("请输入提示词","error"),s.promptInput.focus();return}const a=s.modelSelect.value;let r;try{r=pt(a)}catch(m){g(m.message||"模型不支持","error");return}if(a==="sora2"&&b.readingCount>0){g("图片读取中，请稍候…","warning");return}if(a==="sora2"){const m=s.soraImageSourceInput?String(s.soraImageSourceInput.value||"").trim():"";m&&de(m)>0&&(s.soraImageSourceInput&&(s.soraImageSourceInput.value=""),N())}let l;try{l=Oe(a,i)}catch(m){g(m.message||"参数有误","error");return}const c=ze(s.batchCount.value,1,y.maxBatchCount,1);if(c>=y.confirmBatchThreshold&&!confirm(`将提交 ${c} 个任务，确认继续？`))return;const u=String(s.taskNameInput.value||"").trim()||i.slice(0,18)||"任务",f=Array.from({length:c},(m,v)=>{const w=c>1?` #${v+1}`:"";return{name:`${u}${w}`,modelKey:a,metaSummary:l.metaSummary,baseUrl:n,apiKey:t,apiSpec:r,payload:l.payload}});g(`已加入队列：${c} 个任务`,"success");const h=f.map(m=>{const v=Ge({...m,request:null});return v.request={name:m.name,modelKey:m.modelKey,metaSummary:m.metaSummary,baseUrl:m.baseUrl,apiKey:m.apiKey,apiSpec:m.apiSpec,payload:m.payload},v});Promise.allSettled(h.map(m=>m.createPromise)).then(m=>{const v=m.filter(L=>L.status==="fulfilled").length,w=m.length-v;m.length>1&&g(`创建结果：成功 ${v}，失败 ${w}`,w?"warning":"success",{durationMs:3600})}).catch(()=>{})}setInterval(()=>{const e=p.order.slice(0,p.renderLimit);for(const o of e){const t=p.byLocalId.get(o);t&&je(t)}},1e3)});Ut(kt).mount("#app");
