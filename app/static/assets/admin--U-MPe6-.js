import{d as T,c as M,a as P,f as F,b as a,i as E,g as D}from"./runtime-dom.esm-bundler-8m2sFMtS.js";/* empty css                   */const N={class:"admin-page"},R=T({__name:"admin-page",setup(h){return(f,d)=>(P(),M("div",N,[...d[0]||(d[0]=[F('<div class="admin-container"><header class="admin-header"><div><h1>Admin Dashboard</h1><div class="meta-text">User management and system stats</div></div><div class="header-actions"><a href="/" class="btn btn-secondary" style="text-decoration:none;">Home</a><a href="/video" class="btn btn-secondary" style="text-decoration:none;">Video</a><a href="/storage" class="btn btn-secondary" style="text-decoration:none;">Storage</a></div></header><section id="errorBanner" class="card admin-banner" style="display:none;"></section><section class="stats-grid" id="statsGrid"><div class="card stat-card"><div class="stat-label">Total Users</div><div class="stat-value" id="statTotalUsers">-</div></div><div class="card stat-card"><div class="stat-label">Active Users</div><div class="stat-value" id="statActiveUsers">-</div></div><div class="card stat-card"><div class="stat-label">Storage Used</div><div class="stat-value" id="statStorageUsed">-</div></div><div class="card stat-card"><div class="stat-label">Storage Quota</div><div class="stat-value" id="statStorageQuota">-</div></div><div class="card stat-card"><div class="stat-label">Videos</div><div class="stat-value" id="statVideos">-</div></div><div class="card stat-card"><div class="stat-label">Images</div><div class="stat-value" id="statImages">-</div></div><div class="card stat-card"><div class="stat-label">Active Sessions</div><div class="stat-value" id="statSessions">-</div></div></section><section class="card"><div class="toolbar"><div class="toolbar-left"><input id="searchInput" type="text" placeholder="Search username or email…"><select id="filterActive" aria-label="Filter active status"><option value="">All statuses</option><option value="true">Active</option><option value="false">Inactive</option></select><select id="filterAdmin" aria-label="Filter admin role"><option value="">All roles</option><option value="true">Admins</option><option value="false">Non-admin</option></select></div><div class="toolbar-right"><button class="btn btn-secondary" id="refreshBtn" type="button">Refresh</button></div></div><div class="table-wrap"><table class="admin-table" aria-label="User table"><thead><tr><th>Username</th><th>Email</th><th>Status</th><th>Role</th><th>Storage</th><th>Created</th><th>Last Login</th><th style="width:200px;">Actions</th></tr></thead><tbody id="userTbody"><tr><td colspan="8" class="meta-text">Loading…</td></tr></tbody></table></div><div class="pagination"><button class="btn btn-secondary btn-sm" id="prevPageBtn" type="button">Prev</button><span class="meta-text" id="pageLabel">Page 1</span><button class="btn btn-secondary btn-sm" id="nextPageBtn" type="button">Next</button></div></section></div>',1),a("div",{id:"userModal",class:"modal hidden",role:"dialog","aria-modal":"true","aria-labelledby":"userModalTitle"},[a("div",{class:"modal-backdrop",id:"userModalBackdrop"}),a("div",{class:"modal-content admin-modal",role:"document"},[a("div",{class:"modal-header"},[a("h3",{id:"userModalTitle"},"User"),a("button",{id:"userModalClose",class:"btn btn-ghost btn-icon",type:"button","aria-label":"Close"},[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a("line",{x1:"6",y1:"6",x2:"18",y2:"18"})])])]),a("div",{class:"modal-body"},[a("div",{class:"form-grid"},[a("div",{class:"form-group"},[a("label",{for:"editEmail"},"Email"),a("input",{id:"editEmail",type:"email",autocomplete:"off"})]),a("div",{class:"form-group"},[a("label",{for:"editQuota"},"Storage quota (bytes)"),a("input",{id:"editQuota",type:"number",min:"0",step:"1"}),a("div",{class:"form-hint"},"Bytes (e.g. 1073741824 for 1 GiB)")])]),a("div",{class:"checkbox-row"},[a("label",{class:"checkbox-item"},[a("input",{type:"checkbox",id:"editActive"}),E(" Active")]),a("label",{class:"checkbox-item"},[a("input",{type:"checkbox",id:"editAdmin"}),E(" Admin")])]),a("div",{class:"admin-kv","aria-label":"User stats"},[a("div",{class:"card"},[a("div",{class:"kv-label"},"Storage"),a("div",{class:"kv-value",id:"detailStorage"},"-")]),a("div",{class:"card"},[a("div",{class:"kv-label"},"Videos"),a("div",{class:"kv-value",id:"detailVideos"},"-")]),a("div",{class:"card"},[a("div",{class:"kv-label"},"Images"),a("div",{class:"kv-value",id:"detailImages"},"-")]),a("div",{class:"card"},[a("div",{class:"kv-label"},"Active Sessions"),a("div",{class:"kv-value",id:"detailSessions"},"-")])]),a("div",{class:"login-attempts"},[a("h2",{style:{"margin-top":"8px"}},"Recent login attempts"),a("div",{class:"table-wrap",style:{"min-width":"0"}},[a("table",{"aria-label":"Login attempts table"},[a("thead",null,[a("tr",null,[a("th",null,"Time"),a("th",null,"Result"),a("th",null,"Reason"),a("th",null,"IP")])]),a("tbody",{id:"loginAttemptTbody"},[a("tr",null,[a("td",{colspan:"4",class:"meta-text"},"-")])])])])])]),a("div",{class:"modal-actions"},[a("button",{id:"deleteUserBtn",type:"button",class:"btn btn-secondary"},"Delete"),a("div",{style:{flex:"1"}}),a("button",{id:"cancelUserBtn",type:"button",class:"btn btn-secondary"},"Cancel"),a("button",{id:"saveUserBtn",type:"button",class:"btn btn-primary"},"Save")])])],-1)])]))}});(function(){function h(e){const n=`; ${document.cookie||""}`.split(`; ${e}=`);return n.length===2?n.pop().split(";").shift():null}function f(){const e=h("csrf_token");return e?{"X-CSRF-Token":e}:{}}function d(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}async function m(e){const t=await e.text();try{const n=JSON.parse(t);return(n==null?void 0:n.detail)||t}catch{return t}}function v(e){const t=Number(e||0);if(!Number.isFinite(t)||t<=0)return"0 B";const n=["B","KiB","MiB","GiB","TiB"];let r=t,l=0;for(;r>=1024&&l<n.length-1;)r/=1024,l+=1;const u=l===0?0:l<=2?1:2;return`${r.toFixed(u)} ${n[l]}`}function i(e){const t=document.getElementById("errorBanner");if(t){if(!e){t.style.display="none",t.textContent="";return}t.style.display="block",t.textContent=e}}function g(e){return e.status===401?(window.location.href="/login?next=/admin",!1):e.status===403?(window.location.href="/?error=Admin%20access%20required",!1):!0}const s={limit:50,offset:0,lastPageSize:0,selectedUserId:null,selectedUser:null,search:"",isActive:"",isAdmin:""};function B(){const e=new URLSearchParams;return e.set("limit",String(s.limit)),e.set("offset",String(s.offset)),s.search&&e.set("search",s.search),s.isActive!==""&&e.set("is_active",s.isActive),s.isAdmin!==""&&e.set("is_admin",s.isAdmin),e.toString()}async function p(){const e=await fetch("/api/v1/admin/stats",{credentials:"include"});if(!g(e))return;if(!e.ok)throw new Error(await m(e)||"Failed to load stats");const t=await e.json();document.getElementById("statTotalUsers").textContent=String(t.total_user_count??0),document.getElementById("statActiveUsers").textContent=String(t.active_user_count??0),document.getElementById("statStorageUsed").textContent=v(t.total_storage_used_bytes),document.getElementById("statStorageQuota").textContent=v(t.total_storage_quota_bytes),document.getElementById("statVideos").textContent=String(t.total_video_count??0),document.getElementById("statImages").textContent=String(t.total_image_count??0),document.getElementById("statSessions").textContent=String(t.active_session_count??0)}function y(e,t){return`<span class="pill ${t}">${d(e)}</span>`}function w(e){const t=document.getElementById("userTbody");if(t){if(!Array.isArray(e)||e.length===0){t.innerHTML='<tr><td colspan="8" class="meta-text">No users found.</td></tr>';return}t.innerHTML=e.map(n=>{const r=n.is_active?y("Active","pill-green"):y("Inactive","pill-red"),l=n.is_admin?y("Admin","pill-blue"):y("User","pill-gray"),u=`${v(n.storage_used_bytes)} / ${v(n.storage_quota_bytes)}`,o=n.created_at?new Date(n.created_at).toLocaleString():"-",$=n.last_login_at?new Date(n.last_login_at).toLocaleString():"-";return`
                <tr>
                    <td>${d(n.username)}</td>
                    <td>${d(n.email)}</td>
                    <td>${r}</td>
                    <td>${l}</td>
                    <td>${d(u)}</td>
                    <td>${d(o)}</td>
                    <td>${d($)}</td>
                    <td>
                        <div class="row-actions">
                            <button class="btn btn-secondary btn-sm" type="button" data-action="view" data-user-id="${d(n.id)}">View</button>
                            <button class="btn btn-secondary btn-sm" type="button" data-action="edit" data-user-id="${d(n.id)}">Edit</button>
                            <button class="btn btn-secondary btn-sm" type="button" data-action="delete" data-user-id="${d(n.id)}">Delete</button>
                        </div>
                    </td>
                </tr>
            `}).join("")}}async function c(){const e=await fetch(`/api/v1/admin/users?${B()}`,{credentials:"include"});if(!g(e))return;if(!e.ok)throw new Error(await m(e)||"Failed to load users");const t=await e.json();s.lastPageSize=Array.isArray(t)?t.length:0,w(t),I()}function I(){const e=document.getElementById("pageLabel");e&&(e.textContent=`Page ${Math.floor(s.offset/s.limit)+1}`);const t=document.getElementById("prevPageBtn"),n=document.getElementById("nextPageBtn");t&&(t.disabled=s.offset<=0),n&&(n.disabled=s.lastPageSize<s.limit)}function b(e){const t=document.getElementById("userModal");t&&t.classList.toggle("hidden",!e)}function _(e){const t=document.getElementById("loginAttemptTbody");if(t){if(!Array.isArray(e)||e.length===0){t.innerHTML='<tr><td colspan="4" class="meta-text">No login attempts.</td></tr>';return}t.innerHTML=e.map(n=>{const r=n.created_at?new Date(n.created_at).toLocaleString():"-",l=n.success?y("Success","pill-green"):y("Failed","pill-red"),u=n.failure_reason?d(n.failure_reason):"-",o=n.ip_address?d(n.ip_address):"-";return`<tr><td>${d(r)}</td><td>${l}</td><td>${u}</td><td>${o}</td></tr>`}).join("")}}async function S(e){const t=await fetch(`/api/v1/admin/users/${encodeURIComponent(e)}`,{credentials:"include"});if(!g(t))return null;if(!t.ok)throw new Error(await m(t)||"Failed to load user");return await t.json()}async function A(e){i("");const t=await S(e);t&&(s.selectedUserId=e,s.selectedUser=t,document.getElementById("userModalTitle").textContent=`User: ${t.username}`,document.getElementById("editEmail").value=t.email||"",document.getElementById("editQuota").value=String(t.storage_quota_bytes??0),document.getElementById("editActive").checked=!!t.is_active,document.getElementById("editAdmin").checked=!!t.is_admin,document.getElementById("detailStorage").textContent=`${v(t.storage_used_bytes)} / ${v(t.storage_quota_bytes)}`,document.getElementById("detailVideos").textContent=String(t.total_video_count??0),document.getElementById("detailImages").textContent=String(t.total_image_count??0),document.getElementById("detailSessions").textContent=String(t.active_session_count??0),_(t.recent_login_attempts||[]),b(!0))}async function x(){if(!s.selectedUserId)return;const e={email:String(document.getElementById("editEmail").value||"").trim(),is_active:!!document.getElementById("editActive").checked,is_admin:!!document.getElementById("editAdmin").checked,storage_quota_bytes:Number(document.getElementById("editQuota").value||0)},t=await fetch(`/api/v1/admin/users/${encodeURIComponent(s.selectedUserId)}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(e)});if(g(t)){if(!t.ok)throw new Error(await m(t)||"Failed to update user");b(!1),s.selectedUserId=null,s.selectedUser=null,await c()}}async function k(){if(!s.selectedUserId||!confirm("Delete this user permanently?"))return;const e=await fetch(`/api/v1/admin/users/${encodeURIComponent(s.selectedUserId)}`,{method:"DELETE",credentials:"include",headers:{...f()}});if(g(e)){if(!e.ok)throw new Error(await m(e)||"Failed to delete user");b(!1),s.selectedUserId=null,s.selectedUser=null,await p(),await c()}}function U(e,t){let n=null;return(...r)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...r),t)}}function L(){document.getElementById("refreshBtn").addEventListener("click",async()=>{i("");try{await p(),await c()}catch(t){i((t==null?void 0:t.message)||String(t))}});const e=async()=>{s.offset=0,s.search=String(document.getElementById("searchInput").value||"").trim(),s.isActive=String(document.getElementById("filterActive").value||""),s.isAdmin=String(document.getElementById("filterAdmin").value||""),i("");try{await c()}catch(t){i((t==null?void 0:t.message)||String(t))}};document.getElementById("searchInput").addEventListener("input",U(e,250)),document.getElementById("filterActive").addEventListener("change",e),document.getElementById("filterAdmin").addEventListener("change",e),document.getElementById("prevPageBtn").addEventListener("click",async()=>{s.offset=Math.max(0,s.offset-s.limit),i("");try{await c()}catch(t){i((t==null?void 0:t.message)||String(t))}}),document.getElementById("nextPageBtn").addEventListener("click",async()=>{s.offset+=s.limit,i("");try{await c()}catch(t){i((t==null?void 0:t.message)||String(t))}}),document.getElementById("userTbody").addEventListener("click",async t=>{var u;const n=(u=t.target)==null?void 0:u.closest("button[data-action][data-user-id]");if(!n)return;const r=n.getAttribute("data-action"),l=n.getAttribute("data-user-id");if(l){i("");try{if(r==="delete"){if(!confirm("Delete this user permanently?"))return;const o=await fetch(`/api/v1/admin/users/${encodeURIComponent(l)}`,{method:"DELETE",credentials:"include",headers:{...f()}});if(!g(o))return;if(!o.ok)throw new Error(await m(o)||"Failed to delete user");await p(),await c();return}await A(l)}catch(o){i((o==null?void 0:o.message)||String(o))}}}),document.getElementById("userModalClose").addEventListener("click",()=>b(!1)),document.getElementById("userModalBackdrop").addEventListener("click",()=>b(!1)),document.getElementById("cancelUserBtn").addEventListener("click",()=>b(!1)),document.getElementById("saveUserBtn").addEventListener("click",async()=>{i("");try{await x()}catch(t){i((t==null?void 0:t.message)||String(t))}}),document.getElementById("deleteUserBtn").addEventListener("click",async()=>{i("");try{await k()}catch(t){i((t==null?void 0:t.message)||String(t))}})}async function C(){i("");try{await p(),await c()}catch(e){i((e==null?void 0:e.message)||String(e))}L()}document.addEventListener("DOMContentLoaded",C)})();D(R).mount("#app");
