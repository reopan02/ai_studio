import{s as re,y as St}from"./supabase-yVp6g-J3.js";(function(){var Ze,ke,et,tt,nt;const o={apiKey:document.getElementById("apiKey"),baseUrl:document.getElementById("baseUrl"),toggleApiKey:document.getElementById("toggleApiKey"),modelSelect:document.getElementById("modelSelect"),promptInput:document.getElementById("promptInput"),taskNameInput:document.getElementById("taskNameInput"),batchCount:document.getElementById("batchCount"),sora2Params:document.getElementById("sora2Params"),soraVariant:document.getElementById("soraVariant"),soraSeconds:document.getElementById("soraSeconds"),soraSize:document.getElementById("soraSize"),soraImages:document.getElementById("soraImages"),soraDropzone:document.getElementById("soraDropzone"),soraPickFiles:document.getElementById("soraPickFiles"),soraClearImages:document.getElementById("soraClearImages"),soraImageCount:document.getElementById("soraImageCount"),soraImagePreview:document.getElementById("soraImagePreview"),soraImageSourceInput:document.getElementById("soraImageSourceInput"),soraAddImageSources:document.getElementById("soraAddImageSources"),soraUploadFeedback:document.getElementById("soraUploadFeedback"),soraUploadText:document.getElementById("soraUploadText"),soraUploadProgress:document.getElementById("soraUploadProgress"),soraUploadMeta:document.getElementById("soraUploadMeta"),promptImages:document.getElementById("promptImages"),promptDropzone:document.getElementById("promptDropzone"),promptPickFiles:document.getElementById("promptPickFiles"),promptUploadFeedback:document.getElementById("promptUploadFeedback"),promptUploadText:document.getElementById("promptUploadText"),promptUploadProgress:document.getElementById("promptUploadProgress"),promptUploadMeta:document.getElementById("promptUploadMeta"),promptImagePreviewWrap:document.getElementById("promptImagePreviewWrap"),promptImageCount:document.getElementById("promptImageCount"),promptImagePreview:document.getElementById("promptImagePreview"),promptClearImages:document.getElementById("promptClearImages"),notifyHook:document.getElementById("notifyHook"),generateBtn:document.getElementById("generateBtn"),statusContainer:document.getElementById("statusContainer"),statusContent:document.getElementById("statusContent"),taskSummary:document.getElementById("taskSummary"),clearCompletedBtn:document.getElementById("clearCompletedBtn"),taskList:document.getElementById("taskList"),taskListFooter:document.getElementById("taskListFooter"),loadMoreTasksBtn:document.getElementById("loadMoreTasksBtn"),imageModal:document.getElementById("imageModal"),modalBackdrop:document.getElementById("modalBackdrop"),modalClose:document.getElementById("modalClose"),modalImage:document.getElementById("modalImage"),modalValue:document.getElementById("modalValue"),modalCopy:document.getElementById("modalCopy"),modalSave:document.getElementById("modalSave"),toastContainer:document.getElementById("toastContainer"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),saveConfigBtn:document.getElementById("saveConfigBtn"),resetConfigBtn:document.getElementById("resetConfigBtn"),charCount:document.getElementById("charCount"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultVideo:document.getElementById("resultVideo"),progressFill:document.getElementById("progressFill"),progressText:document.getElementById("progressText")},b={submitDebounceMs:120,confirmBatchThreshold:6,maxBatchCount:20,renderPageSize:20,maxTasks:200,cleanupAfterMs:600*1e3,pollIntervalMs:4e3,pollJitterMs:600,maxPollErrors:3,createConcurrency:4,pollConcurrency:8,saveConcurrency:2,maxLogsPerTask:200,imageCompressThresholdBytes:5*1024*1024,imageMaxDimension:2048},g={items:[],editingId:null,inputReferenceFile:null,inputReferencePreviewUrl:null,readingCount:0},f={byLocalId:new Map,order:[],renderLimit:b.renderPageSize,nextIndex:1,lastSubmitAt:0,createQueue:te(b.createConcurrency),pollQueue:te(b.pollConcurrency),saveQueue:te(b.saveConcurrency)};function se(){if(g.inputReferencePreviewUrl&&String(g.inputReferencePreviewUrl).startsWith("blob:"))try{URL.revokeObjectURL(g.inputReferencePreviewUrl)}catch{}g.inputReferenceFile=null,g.inputReferencePreviewUrl=null,g.items=[]}o.apiKey.value=localStorage.getItem("video_api_key")||void 0||"";const Le=o.baseUrl.value||void 0||"",ot=localStorage.getItem("video_base_url")||Le;try{o.baseUrl.value=G(ot)}catch{o.baseUrl.value=Le,localStorage.removeItem("video_base_url")}const ie=localStorage.getItem("video_model");ie&&Array.from(o.modelSelect.options).some(e=>e.value===ie)&&(o.modelSelect.value=ie);const ae=localStorage.getItem("video_sora_variant");ae&&Array.from(o.soraVariant.options).some(e=>e.value===ae)&&(o.soraVariant.value=ae);const le=localStorage.getItem("video_sora_seconds");le&&o.soraSeconds&&Array.from(o.soraSeconds.options).some(e=>e.value===le)&&(o.soraSeconds.value=le);const ce=localStorage.getItem("video_sora_size");ce&&o.soraSize&&Array.from(o.soraSize.options).some(e=>e.value===ce)&&(o.soraSize.value=ce);const Be=localStorage.getItem("video_batch_count");if(Be){const e=Number.parseInt(Be,10);Number.isFinite(e)&&e>=1&&e<=b.maxBatchCount&&(o.batchCount.value=String(e))}rt();function rt(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const n=e.getAttribute("data-target")||"",t=n?document.getElementById(n):null;t&&(t.type=t.type==="password"?"text":"password")})})}if(o.apiKey.addEventListener("change",()=>localStorage.setItem("video_api_key",o.apiKey.value)),o.baseUrl.addEventListener("change",()=>{try{const e=G(o.baseUrl.value);o.baseUrl.value=e,localStorage.setItem("video_base_url",e)}catch(e){E(`错误: ${e.message}`,"error"),localStorage.removeItem("video_base_url"),o.baseUrl.focus()}}),o.modelSelect.addEventListener("change",()=>{localStorage.setItem("video_model",o.modelSelect.value),Re()}),o.soraVariant&&o.soraVariant.addEventListener("change",()=>{localStorage.setItem("video_sora_variant",o.soraVariant.value),De()}),o.soraSeconds&&o.soraSeconds.addEventListener("change",()=>{localStorage.setItem("video_sora_seconds",o.soraSeconds.value)}),o.soraSize&&o.soraSize.addEventListener("change",()=>{localStorage.setItem("video_sora_size",o.soraSize.value)}),o.batchCount.addEventListener("change",()=>{const e=Number.parseInt(String(o.batchCount.value||"1"),10);if(Number.isFinite(e)){const n=Math.min(b.maxBatchCount,Math.max(1,e));o.batchCount.value=String(n),localStorage.setItem("video_batch_count",String(n))}}),o.soraPickFiles&&o.soraImages&&(o.soraPickFiles.addEventListener("click",()=>o.soraImages.click()),o.soraImages.addEventListener("change",async()=>{const e=o.soraImages.files?Array.from(o.soraImages.files):[];await Y(e,{source:"sora"}),o.soraImages.value=""})),o.promptPickFiles&&o.promptImages&&(o.promptPickFiles.addEventListener("click",()=>o.promptImages.click()),o.promptImages.addEventListener("change",async()=>{const e=o.promptImages.files?Array.from(o.promptImages.files):[];await Y(e,{source:"prompt"}),o.promptImages.value=""})),o.soraClearImages&&o.soraClearImages.addEventListener("click",()=>{se(),x(),E("已清空参考图片","info")}),o.promptClearImages&&o.promptClearImages.addEventListener("click",()=>{se(),x(),E("已清空参考图片","info")}),o.soraAddImageSources&&o.soraImageSourceInput&&(o.soraAddImageSources.addEventListener("click",()=>{const e=o.soraImageSourceInput.value,n=ue(e);n>0&&(o.soraImageSourceInput.value="",x(),E(`已添加 ${n} 个图片来源`,"success"))}),o.soraImageSourceInput.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),o.soraAddImageSources.click())})),at(),lt(),(Ze=o.generateBtn)==null||Ze.addEventListener("click",Ye),(ke=o.clearCompletedBtn)==null||ke.addEventListener("click",()=>{ft(),O(),v("已清理已完成任务","info")}),(et=o.loadMoreTasksBtn)==null||et.addEventListener("click",()=>{f.renderLimit+=b.renderPageSize,O()}),o.historyBtn&&o.historyBtn.addEventListener("click",()=>{var e;(e=o.historyPanel)==null||e.classList.add("open"),document.body.classList.add("panel-open")}),o.closeHistoryBtn&&o.closeHistoryBtn.addEventListener("click",()=>{var e;(e=o.historyPanel)==null||e.classList.remove("open"),document.body.classList.remove("panel-open")}),(tt=o.historyPanel)==null||tt.addEventListener("click",e=>{e.target===o.historyPanel&&(o.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"))}),document.querySelectorAll(".collapsible-header").forEach(e=>{const n=e.dataset.target,t=document.getElementById(n);if(!t)return;const r=localStorage.getItem(`collapsed_${n}`);(r===null?n==="configContent":r==="true")&&(e.classList.add("collapsed"),t.classList.add("collapsed")),e.addEventListener("click",()=>{const s=e.classList.toggle("collapsed");t.classList.toggle("collapsed",s),localStorage.setItem(`collapsed_${n}`,String(s))})}),o.saveConfigBtn&&o.saveConfigBtn.addEventListener("click",()=>{localStorage.setItem("video_api_key",o.apiKey.value);try{const e=G(o.baseUrl.value);localStorage.setItem("video_base_url",e),o.baseUrl.value=e}catch(e){E(`Base URL 错误: ${e.message}`,"error")}v("配置已保存","success")}),o.resetConfigBtn&&o.resetConfigBtn.addEventListener("click",()=>{confirm("确定要重置配置吗？这将清除保存的 API Key 和 Base URL。")&&(localStorage.removeItem("video_api_key"),localStorage.removeItem("video_base_url"),o.apiKey.value="",o.baseUrl.value="https://api.gpt-best.com",v("配置已重置","info"))}),o.promptInput&&o.charCount){const e=()=>{o.charCount.textContent=`${o.promptInput.value.length} 字符`};o.promptInput.addEventListener("input",e),e()}o.inlineHistoryToggle&&o.inlineHistoryContent&&(localStorage.getItem("inlineHistoryCollapsed")==="true"&&((nt=o.inlineHistorySection)==null||nt.classList.add("collapsed")),o.inlineHistoryToggle.addEventListener("click",()=>{var t;const n=(t=o.inlineHistorySection)==null?void 0:t.classList.toggle("collapsed");localStorage.setItem("inlineHistoryCollapsed",String(n))})),document.addEventListener("keydown",e=>{var n;if(e.key==="Escape"){(n=o.historyPanel)!=null&&n.classList.contains("open")&&(o.historyPanel.classList.remove("open"),document.body.classList.remove("panel-open"),e.preventDefault());const t=document.getElementById("editPromptModalOverlay");t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),e.preventDefault())}(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&document.activeElement===o.promptInput&&(e.preventDefault(),Ye())});const _={items:[],displayLimit:6,loading:!1};async function V(){if(!_.loading){_.loading=!0;try{const{data:e,error:n}=await re.from("user_videos").select("id,title,model,prompt,video_url,created_at").order("created_at",{ascending:!1}).limit(50);if(n)throw n;_.items=Array.isArray(e)?e:[],Te()}catch(e){E(`加载历史记录失败: ${e.message}`,"error")}finally{_.loading=!1}}}function Te(){if(!o.inlineHistoryGrid||!o.inlineHistoryCount)return;const e=_.items;if(o.inlineHistoryCount.textContent=e.length,e.length===0){o.inlineHistoryGrid.innerHTML='<div class="inline-history-empty">暂无生成记录</div>',o.showMoreHistoryBtn&&(o.showMoreHistoryBtn.style.display="none");return}const n=e.slice(0,_.displayLimit);o.inlineHistoryGrid.innerHTML="",n.forEach(t=>{var h;const r=document.createElement("div");r.className="inline-history-item",r.dataset.id=t.id;const i=document.createElement("div");if(i.className="inline-history-thumb",t.video_url||t.thumbnail_url){const I=document.createElement("video");I.src=t.video_url||"",I.muted=!0,I.loop=!0,I.playsInline=!0,I.preload="metadata",i.appendChild(I),r.addEventListener("mouseenter",()=>I.play().catch(()=>{})),r.addEventListener("mouseleave",()=>{I.pause(),I.currentTime=0})}else i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';const l=document.createElement("div");l.className="inline-history-info";const s=document.createElement("div");s.className="inline-history-prompt",s.textContent=(t.prompt||"无提示词").slice(0,60)+(((h=t.prompt)==null?void 0:h.length)>60?"...":""),s.title=t.prompt||"";const a=document.createElement("div");a.className="inline-history-meta";const c=t.model||"unknown",d=t.created_at?new Date(t.created_at).toLocaleDateString():"";a.textContent=`${c} · ${d}`,l.appendChild(s),l.appendChild(a);const u=document.createElement("div");u.className="inline-history-actions";const p=document.createElement("button");p.className="inline-history-btn",p.title="加载",p.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',p.addEventListener("click",I=>{I.stopPropagation(),xe(t)});const y=document.createElement("button");y.className="inline-history-btn",y.title="编辑提示词",y.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',y.addEventListener("click",I=>{I.stopPropagation(),st(t)});const m=document.createElement("button");m.className="inline-history-btn danger",m.title="删除",m.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',m.addEventListener("click",I=>{I.stopPropagation(),it(t.id)}),u.appendChild(p),u.appendChild(y),u.appendChild(m),r.appendChild(i),r.appendChild(l),r.appendChild(u),r.addEventListener("click",()=>xe(t)),o.inlineHistoryGrid.appendChild(r)}),o.showMoreHistoryBtn&&(o.showMoreHistoryBtn.style.display=e.length>_.displayLimit?"":"none")}function xe(e){var n,t;e.prompt&&(o.promptInput.value=e.prompt,o.charCount&&(o.charCount.textContent=`${e.prompt.length} 字符`)),e.video_url&&o.resultContainer&&o.resultVideo&&((n=o.resultPlaceholder)==null||n.classList.add("hidden"),(t=o.loadingState)==null||t.classList.add("hidden"),o.resultContainer.classList.remove("hidden"),o.resultVideo.src=e.video_url),v("已加载历史记录","success")}function st(e){const n=document.getElementById("editPromptModalOverlay"),t=document.getElementById("editPromptTextarea"),r=document.getElementById("saveEditPromptBtn"),i=document.getElementById("cancelEditPromptBtn");if(!n||!t)return;t.value=e.prompt||"",n.classList.remove("hidden"),t.focus();const l=async()=>{const d=t.value.trim();if(!d){v("提示词不能为空","error");return}try{const{error:u}=await re.from("user_videos").update({prompt:d,updated_at:new Date().toISOString()}).eq("id",e.id);if(u)throw u;n.classList.add("hidden"),v("提示词已更新","success"),V()}catch(u){v(`更新失败: ${u.message}`,"error")}},s=()=>{n.classList.add("hidden")},a=r.cloneNode(!0),c=i.cloneNode(!0);r.parentNode.replaceChild(a,r),i.parentNode.replaceChild(c,i),a.addEventListener("click",l),c.addEventListener("click",s)}async function it(e){if(confirm("确定要删除这条记录吗？"))try{const{error:n}=await re.from("user_videos").delete().eq("id",e);if(n)throw n;v("已删除","success"),V()}catch(n){v(`删除失败: ${n.message}`,"error")}}o.showMoreHistoryBtn&&o.showMoreHistoryBtn.addEventListener("click",()=>{_.displayLimit+=6,Te()});function j(e){if(!(!o.statusDot||!o.statusText))switch(o.statusDot.className="status-dot",e){case"ready":o.statusDot.classList.add("ready"),o.statusText.textContent="就绪";break;case"generating":o.statusDot.classList.add("generating"),o.statusText.textContent="生成中...";break;case"error":o.statusDot.classList.add("error"),o.statusText.textContent="错误";break;default:o.statusText.textContent=e}}function Me(e){if(!(!o.resultPlaceholder||!o.loadingState||!o.resultContainer)){if(!e){o.resultPlaceholder.classList.remove("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.add("hidden"),j("ready");return}if(e.status==="completed"&&e.videoUrl)o.resultPlaceholder.classList.add("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.remove("hidden"),o.resultVideo&&(o.resultVideo.src=e.videoUrl),j("ready");else if(["pending","processing","queued"].includes(e.status)){o.resultPlaceholder.classList.add("hidden"),o.loadingState.classList.remove("hidden"),o.resultContainer.classList.add("hidden");const n=typeof e.progress=="number"?e.progress:0,t=Math.min(100,Math.max(0,n)),r=t>0?t:e.status==="queued"?1:2;o.progressFill&&(o.progressFill.style.width=`${r}%`),o.progressText&&(o.progressText.textContent=`${r}%`),j("generating")}else e.status==="failed"&&(o.resultPlaceholder.classList.remove("hidden"),o.loadingState.classList.add("hidden"),o.resultContainer.classList.add("hidden"),j("error"))}}V(),j("ready");const Ue=document.getElementById("downloadBtn"),$e=document.getElementById("shareBtn"),Pe=document.getElementById("fullscreenBtn"),_e=document.getElementById("showPromptHistory"),Ne=document.getElementById("closeEditPromptModal");Ue&&Ue.addEventListener("click",()=>{var t;const e=(t=o.resultVideo)==null?void 0:t.src;if(!e){v("没有可下载的视频","warning");return}const n=document.createElement("a");n.href=e,n.download=`video_${Date.now()}.mp4`,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n),v("开始下载视频","success")}),$e&&$e.addEventListener("click",async()=>{var n;const e=(n=o.resultVideo)==null?void 0:n.src;if(!e){v("没有可分享的视频","warning");return}if(navigator.share)try{await navigator.share({title:"Generated Video",url:e})}catch(t){t.name!=="AbortError"&&(Z(e),v("链接已复制到剪贴板","success"))}else Z(e),v("链接已复制到剪贴板","success")}),Pe&&Pe.addEventListener("click",()=>{const e=o.resultVideo;e&&(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}),_e&&_e.addEventListener("click",()=>{o.inlineHistorySection&&(o.inlineHistorySection.classList.remove("collapsed"),o.inlineHistorySection.scrollIntoView({behavior:"smooth",block:"start"}))}),Ne&&Ne.addEventListener("click",()=>{const e=document.getElementById("editPromptModalOverlay");e&&e.classList.add("hidden")}),o.taskList.addEventListener("click",e=>{const n=e.target instanceof Element?e.target:null;if(!n)return;const t=n.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();const r=t.getAttribute("data-action")||"",i=t.closest("[data-local-id]"),l=i==null?void 0:i.getAttribute("data-local-id");if(l){if(r==="cancel"){ht(l);return}if(r==="retry"){yt(l);return}if(r==="copy-url"){const s=f.byLocalId.get(l),a=(s==null?void 0:s.videoUrl)||"";a&&(Z(a),v("已复制视频链接","success"));return}if(r==="save"){const s=f.byLocalId.get(l);s&&q(s,{manual:!0});return}}}),Re(),x(),O();const F={message:"",type:"",at:0};function E(e,n="info"){const t=String(e||""),r=String(n||"info");console[r==="error"?"error":r==="warning"?"warn":"log"](`[${r}] ${t}`);const l=r==="error"?"error":r==="warning"?"warning":r==="success"?"success":"info",s=Date.now();t&&(F.message!==t||F.type!==l||s-F.at>1200)&&(F.message=t,F.type=l,F.at=s,v(t,l))}function v(e,n="info",t={}){const r=Number.parseInt(String(t.durationMs??2800),10),i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`t-${Date.now()}-${Math.random().toString(16).slice(2)}`,l=document.createElement("div");l.className=`toast toast-${n}`,l.setAttribute("data-toast-id",i),l.textContent=String(e||""),o.toastContainer.appendChild(l),requestAnimationFrame(()=>{l.classList.add("show")});const s=()=>{l.classList.remove("show"),l.classList.add("hide"),setTimeout(()=>l.remove(),220)};setTimeout(s,Number.isFinite(r)?r:2800),l.addEventListener("click",s)}function Re(){const n=o.modelSelect.value==="sora2";o.sora2Params.classList.toggle("hidden",!n),n&&De()}function De(){if(o.modelSelect.value!=="sora2")return;const n=o.soraVariant.value==="sora-2-pro";if(!o.soraSize)return;const t=new Set(n?["1280x720","720x1280","1024x1792","1792x1024"]:["1280x720","720x1280"]);for(const i of Array.from(o.soraSize.options))i.disabled=!t.has(i.value);const r=String(o.soraSize.value||"").trim();if(!t.has(r)){const i=t.has("720x1280")?"720x1280":Array.from(t)[0];o.soraSize.value=i,localStorage.setItem("video_sora_size",i)}}function at(){const e="drag-over";[{zone:o.soraDropzone,input:o.soraImages,source:"sora"},{zone:o.promptDropzone,input:o.promptImages,source:"prompt"}].filter(t=>t.zone&&t.input).forEach(({zone:t,input:r,source:i})=>{const l=s=>{const a=s.relatedTarget;a instanceof Node&&t.contains(a)||t.classList.remove(e)};t.addEventListener("dragenter",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add(e)}),t.addEventListener("dragleave",s=>{s.preventDefault(),s.stopPropagation(),l(s)}),t.addEventListener("drop",async s=>{var c;s.preventDefault(),s.stopPropagation(),t.classList.remove(e);const a=(c=s.dataTransfer)!=null&&c.files?Array.from(s.dataTransfer.files):[];await Y(a,{source:i})}),t.addEventListener("paste",async s=>{var d;const c=((d=s.clipboardData)!=null&&d.items?Array.from(s.clipboardData.items):[]).filter(u=>u.kind==="file").map(u=>u.getAsFile()).filter(Boolean);c.length&&(s.preventDefault(),await Y(c,{source:i}))}),t.addEventListener("click",s=>{const a=s.target;a instanceof HTMLElement&&a.closest("button")||r.click()})})}function lt(){const e=()=>pe();o.modalBackdrop.addEventListener("click",e),o.modalClose.addEventListener("click",e),document.addEventListener("keydown",n=>{n.key==="Escape"&&!o.imageModal.classList.contains("hidden")&&e()}),o.modalCopy.addEventListener("click",async()=>{const n=String(o.modalValue.value||"");try{await navigator.clipboard.writeText(n),E("已复制到剪贴板","success")}catch{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),E("已复制到剪贴板","success")}}),o.modalSave.addEventListener("click",()=>{const n=g.editingId;if(!n)return;const t=String(o.modalValue.value||"").trim();if(!t){E("错误: 图片内容不能为空","error");return}if(!de(t)){E("错误: 仅支持 http/https URL 或 data:image/...base64","error");return}const r=g.items.find(i=>i.id===n);r&&(r.value=t,r.kind=t.startsWith("data:image")?"data":"url",x(),pe(),E("已更新图片内容","success"))})}function ct(e){return new Promise((n,t)=>{const r=new FileReader;r.onload=()=>n(String(r.result||"")),r.onerror=()=>t(r.error||new Error("读取文件失败")),r.readAsDataURL(e)})}function ze(e){return String(e||"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean)}function de(e){const n=String(e||"").trim();if(!n)return!1;if(n.startsWith("data:image"))return!0;try{const t=new URL(n);return["http:","https:"].includes(t.protocol)}catch{return!1}}function G(e){const n=String(e||"").trim();if(!n)throw new Error("请输入 Base URL");let t;try{t=new URL(n)}catch{throw new Error("Base URL 不是合法的 URL")}if(t.protocol!=="https:")throw new Error("Base URL 必须使用 HTTPS 协议");if(!t.hostname)throw new Error("Base URL 缺少 host，例如 https://api.example.com");const r=t.origin;return(t.pathname!=="/"||t.search||t.hash)&&E(`提示: Base URL 包含路径/参数，已自动使用 origin: ${r}`,"warning"),r}function dt(e){const n=t=>encodeURIComponent(String(t||""));switch(e){case"sora2":return{createPath:"/v1/videos",createBodyType:"multipart",statusPath:t=>`/v1/videos/${n(t)}`,contentPath:t=>`/v1/videos/${n(t)}/content`};case"veo":return{createPath:"/v1/video/veo/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/veo/tasks/${n(t)}`};case"seedance":return{createPath:"/v1/video/seedance/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/seedance/tasks/${n(t)}`};case"newmodel":return{createPath:"/v1/video/newmodel/text-to-video",createBodyType:"json",statusPath:t=>`/v1/video/newmodel/tasks/${n(t)}`};default:throw new Error(`不支持的模型: ${e}`)}}function me(e,n=!1){const r={Authorization:`Bearer ${Ae(e)}`};return n&&(r["Content-Type"]="application/json"),r}function Ae(e){return String(e||"").trim().replace(/^bearer\\s+/i,"").trim()}async function Q(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const t=await e.text();try{return JSON.parse(t)}catch{return t}}function J(e,n){const t=i=>{let l=i;for(let s=0;s<3;s+=1){if(typeof l=="string"){const a=l.trim();if(!a)return"";if(a.startsWith("{")||a.startsWith("["))try{l=JSON.parse(a);continue}catch{return l}return l}if(l&&typeof l=="object"){const a=l.error;if(a&&typeof a=="object"){const d=a.message??a.detail??a.error;if(typeof d=="string")return t(d)}const c=l.detail??l.error??l.message;if(typeof c=="string"){l=c;continue}try{return JSON.stringify(l)}catch{return String(i||"")}}return String(l??"")}return typeof l=="string"?l:String(l??"")};if(typeof e=="string")return e;if(!e||typeof e!="object")return n;const r=e.detail??e.error??e.message;if(typeof r=="string")return t(r);if(Array.isArray(r))return r.map(i=>{if(!i||typeof i!="object")return String(i);const l=Array.isArray(i.loc)?i.loc.join("."):"",s=i.msg?String(i.msg):JSON.stringify(i);return l?`${l}: ${s}`:s}).join("; ");try{return t(r)}catch{return n}}function K(e){const n=Number(e||0);if(!Number.isFinite(n)||n<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,i=n;for(;i>=1024&&r<t.length-1;)i/=1024,r+=1;const l=r===0?0:r===1?1:2;return`${i.toFixed(l)} ${t[r]}`}function He(e){const n=e==="prompt"?"prompt":"sora";return{zone:n==="prompt"?o.promptDropzone:o.soraDropzone,pickBtn:n==="prompt"?o.promptPickFiles:o.soraPickFiles,clearBtn:n==="prompt"?null:o.soraClearImages,textEl:n==="prompt"?o.promptUploadText:o.soraUploadText,progressEl:n==="prompt"?o.promptUploadProgress:o.soraUploadProgress,metaEl:n==="prompt"?o.promptUploadMeta:o.soraUploadMeta}}function S(e,{isProcessing:n,state:t,text:r,progress:i,meta:l}={}){const s=He(e);if(s.zone&&(typeof n=="boolean"&&s.zone.classList.toggle("is-processing",n),t==="success"||t==="error"?(s.zone.classList.toggle("is-success",t==="success"),s.zone.classList.toggle("is-error",t==="error")):t==="clear"&&(s.zone.classList.remove("is-success"),s.zone.classList.remove("is-error")),s.textEl&&typeof r=="string"&&(s.textEl.textContent=r),s.metaEl&&typeof l=="string"&&(s.metaEl.textContent=l),s.progressEl&&typeof i=="number")){const a=Math.min(100,Math.max(0,i));s.progressEl.style.width=`${a}%`}}function X(e,n){const t=He(e);t.zone&&(t.zone.classList.toggle("is-loading",n),t.pickBtn&&(t.pickBtn.disabled=n),t.clearBtn&&(t.clearBtn.disabled=n||g.items.length===0),e!=="prompt"&&(o.soraAddImageSources.disabled=n))}async function mt(e,n={}){const t=Number(n.thresholdBytes??b.imageCompressThresholdBytes),r=Number(n.maxDimension??b.imageMaxDimension);if(!e||!Number.isFinite(e.size)||e.size<=t)return{file:e,compressed:!1,originalBytes:(e==null?void 0:e.size)||0,outputBytes:(e==null?void 0:e.size)||0};const l=await(async()=>{if(globalThis.createImageBitmap)return await globalThis.createImageBitmap(e);const s=URL.createObjectURL(e);try{const a=new Image;return a.decoding="async",a.src=s,await new Promise((c,d)=>{a.onload=c,a.onerror=()=>d(new Error("图片解码失败"))}),a}finally{URL.revokeObjectURL(s)}})();try{const s=l.width||l.naturalWidth||0,a=l.height||l.naturalHeight||0;if(!s||!a)return{file:e,compressed:!1,originalBytes:e.size,outputBytes:e.size};const c=document.createElement("canvas"),d=c.getContext("2d",{alpha:!0});if(!d)throw new Error("Canvas 初始化失败");let u=1;const p=Math.max(s,a);Number.isFinite(r)&&r>0&&p>r&&(u=r/p);let y=Math.max(1,Math.round(s*u)),m=Math.max(1,Math.round(a*u));c.width=y,c.height=m;const h=(M,T)=>new Promise(C=>{c.toBlob(W=>C(W),M,T)}),I=()=>{d.clearRect(0,0,c.width,c.height),d.drawImage(l,0,0,c.width,c.height)};I();const B=e.size;let A=null,N=1/0,R=.84,H="image/jpeg";for(let M=0;M<4;M+=1){const T=await h(H,R);if(!T)break;const C=T.size||0;if(C>0&&C<N&&(A=T,N=C),C>0&&C<=t)break;R=Math.max(.58,R-.12),y=Math.max(1,Math.round(y*.92)),m=Math.max(1,Math.round(m*.92)),c.width=y,c.height=m,I()}if(!A||N>=B)return{file:e,compressed:!1,originalBytes:B,outputBytes:B};const D=new File([A],e.name.replace(/\.\w+$/,"")+".jpg",{type:H,lastModified:Date.now()});return{file:D,compressed:!0,originalBytes:B,outputBytes:D.size}}finally{typeof(l==null?void 0:l.close)=="function"&&l.close()}}async function Y(e,n={}){const t=n.source==="prompt"?"prompt":"sora",r=(e||[]).filter(s=>{if(!s)return!1;if(String(s.type||"").startsWith("image/"))return!0;const c=String(s.name||"");return/\.(png|jpe?g|webp|gif|bmp|svg|ico|tiff?)$/i.test(c)});if(r.length===0){e&&e.length&&E("未检测到可用的图片文件","warning");return}const i=()=>{if(g.inputReferencePreviewUrl&&String(g.inputReferencePreviewUrl).startsWith("blob:"))try{URL.revokeObjectURL(g.inputReferencePreviewUrl)}catch{}g.inputReferenceFile=null,g.inputReferencePreviewUrl=null,g.items=[]},l=async s=>{if(!s||!o.soraSize)return;let a;try{a=URL.createObjectURL(s);const c=new Image;c.decoding="async",c.src=a,await new Promise((y,m)=>{c.onload=y,c.onerror=()=>m(new Error("参考图解码失败"))});const d=c.naturalWidth||0,u=c.naturalHeight||0;if(!d||!u)return;const p=`${d}x${u}`;Array.from(o.soraSize.options).some(y=>y.value===p&&!y.disabled)&&(o.soraSize.value=p,localStorage.setItem("video_sora_size",p))}catch{}finally{if(a)try{URL.revokeObjectURL(a)}catch{}}};if(t==="prompt"){const s=r[0];r.length>1&&E("仅使用第一张参考图作为 input_reference","warning"),g.readingCount+=1,X(t,!0),S(t,{isProcessing:!0,state:"clear",text:"读取中…",progress:10,meta:`${s.name} · ${K(s.size)}`});try{i(),g.inputReferenceFile=s,g.inputReferencePreviewUrl=URL.createObjectURL(s);const a=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;g.items=[{id:a,kind:"file",value:g.inputReferencePreviewUrl,name:s.name||"input_reference",size:s.size||0}],await l(s),x(),S(t,{state:"success",text:"已添加参考图",meta:"将作为 input_reference 上传",progress:100}),setTimeout(()=>S(t,{isProcessing:!1}),700),setTimeout(()=>S(t,{state:"clear"}),1400)}catch(a){i(),S(t,{state:"error",text:"添加失败",meta:String((a==null?void 0:a.message)||a||""),progress:0}),setTimeout(()=>S(t,{isProcessing:!1}),1400),E(`添加参考图失败: ${a.message||a}`,"error")}finally{g.readingCount=Math.max(0,g.readingCount-1),X(t,g.readingCount>0),x()}return}g.readingCount+=r.length,X(t,!0),S(t,{isProcessing:!0,state:"clear",text:"处理中…",progress:0,meta:""});try{const s=r.length;let a=0;for(let c=0;c<s;c+=1){const d=r[c];S(t,{text:d.size>b.imageCompressThresholdBytes?"压缩中…":"读取中…",meta:`${c+1}/${s} · ${d.name} · ${K(d.size)}`,progress:Math.round(a/s*100)});let u=d;if(d.size>b.imageCompressThresholdBytes){const m=d.size,h=await mt(d,{thresholdBytes:b.imageCompressThresholdBytes,maxDimension:b.imageMaxDimension});u=h.file,h.compressed?S(t,{text:"压缩完成，读取中…",meta:`${c+1}/${s} · ${d.name} · ${K(m)} → ${K(u.size)}`}):S(t,{text:"读取中…",meta:`${c+1}/${s} · ${d.name} · ${K(m)}`})}const p=await ct(u),y=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;g.items.push({id:y,kind:"data",value:p,name:(u==null?void 0:u.name)||(d==null?void 0:d.name)||"image",size:(u==null?void 0:u.size)||(d==null?void 0:d.size)||0}),a+=1,S(t,{progress:Math.round(a/s*100)})}x(),S(t,{state:"success",text:`已添加 ${r.length} 张图片`,meta:`${r.length} 张 · ${g.items.length} 张总计`,progress:100}),E(`已添加 ${r.length} 张图片（已转 Base64）`,"success"),setTimeout(()=>{S(t,{isProcessing:!1})},900),setTimeout(()=>{S(t,{state:"clear"})},1600)}catch(s){S(t,{state:"error",text:"添加失败",meta:String((s==null?void 0:s.message)||s||""),progress:0}),setTimeout(()=>S(t,{isProcessing:!1}),1400),E(`添加图片失败: ${s.message||s}`,"error")}finally{g.readingCount=Math.max(0,g.readingCount-r.length),X(t,g.readingCount>0),x()}}function ue(e){const n=ze(e);let t=0;for(const r of n){if(!de(r)){E(`跳过无效图片来源: ${r.slice(0,80)}${r.length>80?"…":""}`,"warning");continue}const i=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;g.items.push({id:i,kind:r.startsWith("data:image")?"data":"url",value:r,name:r.startsWith("data:image")?"base64":"url",size:0}),t+=1}return t}function x(){const e=g.items.length,n=o.promptImageCount||o.soraImageCount,t=o.promptClearImages||o.soraClearImages,r=o.promptImagePreviewWrap||null,i=o.promptImagePreview||o.soraImagePreview;if(n&&(n.textContent=`${e} 张图片`),t&&(t.disabled=g.readingCount>0||e===0),r&&r.classList.toggle("hidden",e===0),!i||(i.innerHTML="",e===0))return;const s=`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">
                <rect width="200" height="150" rx="12" fill="#F5F5F7"/>
                <path d="M62 96l16-18 16 18 22-26 22 26" fill="none" stroke="#86868b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="78" cy="58" r="10" fill="#d1d1d6"/>
                <text x="100" y="128" font-family="system-ui, -apple-system" font-size="12" fill="#86868b" text-anchor="middle">Preview unavailable</text>
            </svg>`)}`;for(const a of g.items){const c=document.createElement("div");c.className="preview-item",c.dataset.id=a.id;const d=document.createElement("img");d.className="preview-img",d.loading="lazy",d.alt=a.name||"image",d.src=a.value,d.addEventListener("click",()=>{a.kind!=="file"&&Fe(a.id)}),d.onerror=()=>{d.src=s,d.classList.add("is-fallback")};const u=document.createElement("div");u.className="preview-actions";const p=document.createElement("button");if(p.type="button",p.className="preview-btn danger",p.textContent="移除",p.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),a.kind==="file"?se():g.items=g.items.filter(h=>h.id!==a.id),x(),E("已移除图片","info")}),a.kind!=="file"){const m=document.createElement("button");m.type="button",m.className="preview-btn",m.textContent="编辑",m.addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),Fe(a.id)}),u.appendChild(m)}u.appendChild(p);const y=document.createElement("div");y.className="preview-caption",y.textContent=a.kind==="file"?"File":a.kind==="url"?"URL":"Base64",c.appendChild(d),c.appendChild(u),c.appendChild(y),i.appendChild(c)}}function Fe(e){const n=g.items.find(t=>t.id===e);n&&(g.editingId=e,o.modalImage.src=n.value,o.modalValue.value=n.value,o.imageModal.classList.remove("hidden"),document.body.classList.add("modal-open"),o.modalValue.focus())}function pe(){g.editingId=null,o.imageModal.classList.add("hidden"),document.body.classList.remove("modal-open"),o.modalImage.src="",o.modalValue.value=""}function Z(e){var r;const n=String(e||"");if(!n)return;if((r=navigator.clipboard)!=null&&r.writeText){navigator.clipboard.writeText(n).catch(()=>{});return}const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove()}function Ve(e,n,t,r){const i=Number.parseInt(String(e??""),10);return Number.isFinite(i)?Math.min(t,Math.max(n,i)):r}function ge(e){const n=Number(e);return!Number.isFinite(n)||n<=0?null:n<1e10?Math.round(n*1e3):Math.round(n)}function ut(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return Math.min(100,Math.max(0,Math.round(e)));const t=String(e).trim().match(/(\d+(?:\.\d+)?)/),r=t?Number.parseFloat(t[1]):0;return Number.isFinite(r)?Math.min(100,Math.max(0,Math.round(r))):0}function pt(e){const n=String(e||"").trim().toLowerCase();return n?["success","succeeded","ok","completed","done","finished","finish"].includes(n)?"completed":["fail","failed","error","timeout"].includes(n)?"failed":["cancelled","canceled","cancel"].includes(n)?"cancelled":["processing","running","executing","in_progress","in-progress","working"].includes(n)?"processing":(["queued","pending","waiting","created","init","initializing"].includes(n),"pending"):"pending"}function k(e){return{queued:"排队中",pending:"等待",processing:"处理中",completed:"成功",failed:"失败",cancelled:"已取消"}[e]||"等待"}function L(e){return["completed","failed","cancelled"].includes(String(e||""))}function je(e){var r,i,l,s,a;const n=[e==null?void 0:e.video_url,e==null?void 0:e.videoUrl,e==null?void 0:e.url,(r=e==null?void 0:e.data)==null?void 0:r.video_url,(i=e==null?void 0:e.data)==null?void 0:i.videoUrl,(l=e==null?void 0:e.data)==null?void 0:l.url,(s=e==null?void 0:e.data)==null?void 0:s.output];for(const c of n)if(typeof c=="string"&&/^https?:\/\//i.test(c.trim()))return c.trim();const t=(a=e==null?void 0:e.data)==null?void 0:a.output;if(t&&typeof t=="object"){const c=[t.url,t.video_url,t.videoUrl];for(const d of c)if(typeof d=="string"&&/^https?:\/\//i.test(d.trim()))return d.trim()}return null}function Ke(e){if(typeof e!="string")return!1;const n=e.trim();return/^https?:\/\//i.test(n)}function fe(e){return{taskId:(e==null?void 0:e.task_id)||(e==null?void 0:e.taskId)||(e==null?void 0:e.id)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,rawStatus:(e==null?void 0:e.status)||null,status:pt(e==null?void 0:e.status),progress:ut((e==null?void 0:e.progress)??(e==null?void 0:e.process)),failReason:(e==null?void 0:e.fail_reason)||(e==null?void 0:e.failReason)||(e==null?void 0:e.error)||(e==null?void 0:e.detail)||"",submitTimeMs:ge((e==null?void 0:e.created_at)??(e==null?void 0:e.submit_time)),startTimeMs:ge((e==null?void 0:e.started_at)??(e==null?void 0:e.start_time)),finishTimeMs:ge((e==null?void 0:e.completed_at)??(e==null?void 0:e.finish_time)),cost:typeof(e==null?void 0:e.cost)=="number"?e.cost:null,videoUrl:je(e)}}async function Oe(e){var l;if(!(e!=null&&e.taskId))throw new Error("缺少 video_id");if(!((l=e==null?void 0:e.apiSpec)!=null&&l.contentPath))throw new Error("该任务不支持 content 获取");const n=`${e.baseUrl}${e.apiSpec.contentPath(e.taskId)}`,t=await fetch(n,{headers:me(e.apiKey,!1),signal:e.controller.signal});if((t.headers.get("content-type")||"").includes("application/json")){const s=await Q(t);if(!t.ok){const c=(s==null?void 0:s.detail)||(s==null?void 0:s.error)||(typeof s=="string"?s:null);throw new Error(c||`获取内容失败（HTTP ${t.status}）`)}const a=je(s);if(a)return a;throw new Error("content 响应未包含可用的视频链接")}if(!t.ok){const s=await Q(t),a=(s==null?void 0:s.detail)||(s==null?void 0:s.error)||(typeof s=="string"?s:null);throw new Error(a||`获取内容失败（HTTP ${t.status}）`)}const i=await t.blob();return URL.createObjectURL(i)}function ee(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return"—"}}function qe(e){const n=Math.max(0,Math.floor(e/1e3)),t=n%60,r=Math.floor(n/60)%60,i=Math.floor(n/3600),l=s=>String(s).padStart(2,"0");return i>0?`${i}:${l(r)}:${l(t)}`:`${l(r)}:${l(t)}`}function te(e=4){let n=0;const t=[],r=()=>{for(;n<e&&t.length>0;){const s=t.shift();!s||s.aborted||(s.started=!0,n+=1,Promise.resolve().then(()=>s.fn()).then(s.resolve,s.reject).finally(()=>{var a;n-=1,(a=s.cleanup)==null||a.call(s),r()}))}};return{enqueue:(s,a={})=>{const c=a.signal;return new Promise((d,u)=>{const p={fn:s,resolve:d,reject:u,signal:c,started:!1,aborted:!1,cleanup:null};if(c!=null&&c.aborted){u(new DOMException("Aborted","AbortError"));return}const y=()=>{if(p.started)return;p.aborted=!0;const m=t.indexOf(p);m>=0&&t.splice(m,1),u(new DOMException("Aborted","AbortError")),r()};c&&(c.addEventListener("abort",y,{once:!0}),p.cleanup=()=>c.removeEventListener("abort",y)),t.push(p),r()})},stats:()=>({active:n,pending:t.length,concurrency:e})}}function We(e,n){var r,i;const t=String(n||"").trim();if(e==="sora2"){const l=o.soraVariant.value,s=String(((r=o.soraSeconds)==null?void 0:r.value)||"4").trim(),a=String(((i=o.soraSize)==null?void 0:i.value)||"720x1280").trim();if(!new Set(["4","8","12"]).has(s))throw new Error("seconds 可选值为 4 / 8 / 12");const d=l==="sora-2-pro";if(!new Set(d?["1280x720","720x1280","1024x1792","1792x1024"]:["1280x720","720x1280"]).has(a))throw new Error(d?"size 可选值为 1280x720 / 720x1280 / 1024x1792 / 1792x1024":"size 对于 sora-2 仅支持 1280x720 / 720x1280");const p=g.inputReferenceFile||null;if(p&&!String(p.type||"").startsWith("image/"))throw new Error("input_reference 必须是图片文件（jpeg/png/webp）");const y={model:l,prompt:t,seconds:s,size:a},m=`${l} · ${a} · ${s}s${p?" · ref=1":""}`;return{payload:y,metaSummary:m,inputReference:p}}return{payload:{model:e,prompt:t},metaSummary:e}}function Ge(e){const n=document.createElement("div");n.className="task-wrapper",n.setAttribute("data-local-id",e.localId);const t=document.createElement("div");t.className="task-mini-preview hidden";const r=document.createElement("video");r.className="task-mini-video",r.muted=!0,r.loop=!0,r.playsInline=!0,r.controls=!0;const i=document.createElement("div");i.className="task-mini-preview-actions";const l=document.createElement("button");l.className="task-mini-btn",l.title="复制视频链接",l.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',l.onclick=Et=>{Et.preventDefault(),Z(e.videoUrl),v("链接已复制","success")};const s=document.createElement("a");s.className="task-mini-btn",s.title="下载视频",s.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',s.target="_blank",i.appendChild(l),i.appendChild(s),t.appendChild(r),t.appendChild(i);const a=document.createElement("details");a.className="task-item";const c=document.createElement("summary");c.className="task-summary";const d=document.createElement("div");d.className="task-main";const u=document.createElement("div");u.className="task-title";const p=document.createElement("div");p.className="task-name",p.textContent=e.name;const y=document.createElement("div");y.className="task-meta",y.textContent=e.metaSummary||"",u.appendChild(p),u.appendChild(y);const m=document.createElement("div");m.className="task-id",m.textContent="ID: -",d.appendChild(u),d.appendChild(m);const h=document.createElement("div");h.className="task-right";const I=document.createElement("span");I.className="badge badge-pending",I.textContent="等待";const B=document.createElement("div");B.className="task-progress";const A=document.createElement("div");A.className="task-progress-bar";const N=document.createElement("div");N.className="task-progress-fill",N.style.width="0%",A.appendChild(N);const R=document.createElement("div");R.className="task-progress-text",R.textContent="0%",B.appendChild(A),B.appendChild(R);const H=document.createElement("div");H.className="task-time",H.textContent="—";const D=document.createElement("div");D.className="task-actions";const M=document.createElement("button");M.type="button",M.className="btn btn-secondary btn-sm",M.setAttribute("data-action","save"),M.textContent="保存到存储库";const T=document.createElement("button");T.type="button",T.className="btn btn-secondary btn-sm",T.setAttribute("data-action","retry"),T.textContent="重试";const C=document.createElement("button");C.type="button",C.className="btn btn-secondary btn-sm",C.setAttribute("data-action","cancel"),C.textContent="取消",D.appendChild(M),D.appendChild(T),D.appendChild(C),h.appendChild(I),h.appendChild(B),h.appendChild(H),h.appendChild(D),c.appendChild(d),c.appendChild(h);const W=document.createElement("div");W.className="task-details";const he=document.createElement("div");he.className="task-info";const U=document.createElement("div");U.className="task-info-grid";const ye=document.createElement("div");ye.className="task-info-line";const ve=document.createElement("div");ve.className="task-info-line";const Ie=document.createElement("div");Ie.className="task-info-line";const be=document.createElement("div");be.className="task-info-line";const Ee=document.createElement("div");Ee.className="task-info-line";const Se=document.createElement("div");Se.className="task-info-line";const oe=document.createElement("div");oe.className="task-info-line",oe.textContent="存储库: —";const we=document.createElement("div");we.className="task-error hidden";const Ce=document.createElement("div");return Ce.className="task-error hidden",U.appendChild(ye),U.appendChild(ve),U.appendChild(Ie),U.appendChild(be),U.appendChild(Ee),U.appendChild(Se),U.appendChild(oe),U.appendChild(we),U.appendChild(Ce),he.appendChild(U),W.appendChild(he),a.appendChild(c),a.appendChild(W),n.appendChild(t),n.appendChild(a),e.dom={root:n,badge:I,fill:N,progressText:R,idEl:m,timeEl:H,metaEl:y,nameEl:p,saveBtn:M,retryBtn:T,cancelBtn:C,platformEl:ye,actionEl:ve,submitEl:Ie,startEl:be,finishEl:Ee,costEl:Se,repoStatusEl:oe,repoErrorEl:we,errorEl:Ce,miniPreview:t,miniVideo:r,miniDlBtn:s},a.addEventListener("toggle",()=>{P(e)}),n}function P(e){if(!e.dom)return;const n=e.status==="processing"?"processing":e.status==="completed"?"completed":e.status==="failed"?"failed":e.status==="cancelled"?"cancelled":"pending";e.dom.badge.className=`badge badge-${n}`,e.dom.badge.textContent=k(e.status),e.dom.progressText.textContent=`${e.progress}%`,e.dom.fill.style.width=`${e.progress}%`,e.dom.idEl.textContent=`ID: ${e.taskId||"-"}`,Qe(e),e.dom.platformEl.textContent=`平台: ${e.platform||"—"}`,e.dom.actionEl.textContent=`动作: ${e.action||"—"}`,e.dom.submitEl.textContent=`提交: ${ee(e.submitTimeMs)}`,e.dom.startEl.textContent=`开始: ${ee(e.startTimeMs)}`,e.dom.finishEl.textContent=`完成: ${ee(e.finishTimeMs)}`,e.dom.costEl.textContent=e.cost!=null?`花费: ${e.cost}`:"花费: —";const t=e.repoSave||{status:"idle",errorMessage:""};let r="—";e.status==="completed"&&(e.videoUrl?t.status==="saved"?r="已保存":t.status==="saving"?r="保存中...":t.status==="failed"?r="保存失败":r="待保存":r="缺少视频链接"),e.dom.repoStatusEl.textContent=`存储库: ${r}`,t.status==="failed"&&String(t.errorMessage||"").trim()?(e.dom.repoErrorEl.classList.remove("hidden"),e.dom.repoErrorEl.textContent=`保存失败: ${String(t.errorMessage).trim()}`):(e.dom.repoErrorEl.classList.add("hidden"),e.dom.repoErrorEl.textContent="");const i=String(e.failReason||"").trim();i?(e.dom.errorEl.classList.remove("hidden"),e.dom.errorEl.textContent=`错误: ${i}`):(e.dom.errorEl.classList.add("hidden"),e.dom.errorEl.textContent="");const l=!L(e.status)&&!e.controller.signal.aborted;e.dom.cancelBtn.disabled=!l;const s=L(e.status)&&e.status!=="completed";e.dom.retryBtn.style.display=s?"":"none";const a=e.status==="completed"&&!!e.videoUrl;if(e.dom.saveBtn.style.display=a?"":"none",a?t.status==="saved"?(e.dom.saveBtn.textContent="已保存",e.dom.saveBtn.disabled=!0):t.status==="saving"?(e.dom.saveBtn.textContent="保存中...",e.dom.saveBtn.disabled=!0):t.status==="failed"?(e.dom.saveBtn.textContent="重试保存",e.dom.saveBtn.disabled=!1):(e.dom.saveBtn.textContent="保存到存储库",e.dom.saveBtn.disabled=!1):e.dom.saveBtn.disabled=!0,e.videoUrl){if(e.dom.miniPreview.classList.remove("hidden"),e.dom.miniVideo.getAttribute("src")!==e.videoUrl){e.dom.miniVideo.src=e.videoUrl,e.dom.miniDlBtn.href=e.videoUrl;try{const u=new URL(e.videoUrl).pathname.split("/").pop();e.dom.miniDlBtn.download=u||`video_${e.taskId}.mp4`}catch{e.dom.miniDlBtn.download=`video_${e.taskId}.mp4`}}}else e.dom.miniPreview.classList.add("hidden"),e.dom.miniVideo.getAttribute("src")&&(e.dom.miniVideo.removeAttribute("src"),e.dom.miniVideo.load())}function Qe(e){var l;if(!((l=e==null?void 0:e.dom)!=null&&l.timeEl))return;const n=Date.now(),t=e.startTimeMs||e.submitTimeMs||e.createdAt||n,i=(e.finishTimeMs||(L(e.status)?e.updatedAt:null)||n)-t;e.dom.timeEl.textContent=`耗时 ${qe(i)}`}function Je(){const e=f.order.length;let n=0,t=0,r=0,i=0;for(const l of f.order){const s=f.byLocalId.get(l);s&&(s.status==="processing"?n+=1:s.status==="completed"?t+=1:s.status==="failed"?r+=1:s.status==="cancelled"&&(i+=1))}o.taskSummary.textContent=`${e} 个任务 · 处理中 ${n} · 成功 ${t} · 失败 ${r} · 取消 ${i}`}function O(){Je();const e=f.order.length;o.statusContainer&&o.statusContainer.classList.toggle("hidden",e>0);const n=f.order.slice(0,f.renderLimit);o.taskList.innerHTML="";for(const t of n){const r=f.byLocalId.get(t);r&&(r.dom||Ge(r),P(r),o.taskList.appendChild(r.dom.root))}o.taskListFooter&&o.taskListFooter.classList.toggle("hidden",e<=f.renderLimit)}function w(e,n,t="info"){const r=typeof e=="string"?f.byLocalId.get(e):e;if(!r)return;const i={time:new Date().toLocaleTimeString(),type:t,message:String(n||"")};Array.isArray(r.logs)||(r.logs=[]),r.logs.push(i),r.logs.length>b.maxLogsPerTask*3&&r.logs.splice(0,r.logs.length-b.maxLogsPerTask*2),P(r)}function $(e,n,t={}){const r=String(n||"").trim();if(!r)return;const i=e.status;if(e.status=r,e.updatedAt=Date.now(),Object.assign(e,t),i!==r&&w(e,`状态更新: ${k(i)} -> ${k(r)}`,"info"),P(e),Je(),r==="completed"&&i!=="completed"&&setTimeout(()=>{typeof V=="function"&&V()},1500),f.order.length>0){const l=f.order[0],s=f.byLocalId.get(l);s&&s.localId===e.localId&&typeof Me=="function"&&Me(e)}}function gt(){if(f.order.length<=b.maxTasks)return;const e=f.order.slice().reverse().filter(n=>{const t=f.byLocalId.get(n);return t&&L(t.status)});for(;f.order.length>b.maxTasks&&e.length>0;)ne(e.shift());for(;f.order.length>b.maxTasks;)ne(f.order[f.order.length-1])}function ne(e){var r;const n=String(e||""),t=f.byLocalId.get(n);if(t){if(t.cleanupTimer&&clearTimeout(t.cleanupTimer),t.pollTimer&&clearTimeout(t.pollTimer),!t.controller.signal.aborted&&!L(t.status))try{t.controller.abort()}catch{}if(typeof t.videoUrl=="string"&&t.videoUrl.startsWith("blob:"))try{URL.revokeObjectURL(t.videoUrl)}catch{}f.byLocalId.delete(n),f.order=f.order.filter(i=>i!==n),(r=t.dom)!=null&&r.root&&t.dom.root.parentElement&&t.dom.root.remove()}}function ft(){const e=f.order.slice();for(const n of e){const t=f.byLocalId.get(n);t&&L(t.status)&&ne(n)}}function z(e){e.cleanupTimer&&clearTimeout(e.cleanupTimer),e.cleanupTimer=setTimeout(()=>{ne(e.localId),O()},b.cleanupAfterMs)}function ht(e){const n=f.byLocalId.get(String(e||""));if(n&&!L(n.status)){w(n,"用户取消任务（停止轮询）","warning");try{n.controller.abort()}catch{}n.pollTimer&&clearTimeout(n.pollTimer),n.finishTimeMs=n.finishTimeMs||Date.now(),$(n,"cancelled"),z(n),v(`已取消：${n.name}`,"info")}}function yt(e){const n=f.byLocalId.get(String(e||""));if(!n||!n.request)return;const t=`${n.request.name||n.name}（重试）`;Xe({...n.request,name:t})}async function vt(e){if(!e.taskId)return;const n=`${e.baseUrl}${e.apiSpec.statusPath(e.taskId)}`,t=await fetch(n,{headers:me(e.apiKey,!1),signal:e.controller.signal}),r=await Q(t);if(!t.ok)throw new Error(J(r,`轮询失败（HTTP ${t.status}）`));if(r&&typeof r=="object"&&typeof r.code=="string"&&r.code.startsWith("fail_"))throw new Error(J(r,`轮询失败（${r.code}）`));return r}function It(e){var c,d,u,p,y,m,h,I;const n=String((e==null?void 0:e.videoUrl)||"").trim(),t=Ke(n)?n:null,r=((d=(c=e==null?void 0:e.request)==null?void 0:c.payload)==null?void 0:d.prompt)??((u=e==null?void 0:e.payload)==null?void 0:u.prompt)??((p=e==null?void 0:e.request)==null?void 0:p.prompt)??"",i=((m=(y=e==null?void 0:e.request)==null?void 0:y.payload)==null?void 0:m.model)??((h=e==null?void 0:e.payload)==null?void 0:h.model)??((I=e==null?void 0:e.request)==null?void 0:I.model)??(e==null?void 0:e.platform)??(e==null?void 0:e.modelKey)??"unknown",l=String(r||"").trim()||"No prompt",s=String(i||"").trim()||"unknown",a={provider_task_id:(e==null?void 0:e.taskId)||null,platform:(e==null?void 0:e.platform)||null,action:(e==null?void 0:e.action)||null,cost:(e==null?void 0:e.cost)??null,original_url:n||null};return{title:(e==null?void 0:e.name)||(e!=null&&e.taskId?`Task ${e.taskId}`:"未命名任务"),model:s,prompt:l,video_url:t,status:"completed",metadata:a}}async function q(e,{manual:n=!1}={}){const t=e;if(!t)return;const r=t.repoSave||{status:"idle",savedVideoId:null};if(r.status==="saving"){n&&v("正在保存...","info",{durationMs:1800});return}if(r.status==="saved"){n&&v("已保存到存储库","success",{durationMs:1800});return}if(t.status!=="completed"){n&&v("仅支持保存已完成的任务","warning");return}let i;try{i=It(t)}catch(s){const a=String((s==null?void 0:s.message)||s||"保存数据无效");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:null},P(t),E(`保存失败: ${a}`,"error");return}t.repoSave={status:"saving",errorMessage:"",savedVideoId:r.savedVideoId||null,payload:i},P(t),w(t,"开始保存到存储库","info");const l=async()=>{try{const s=await St();if(!s){window.location.href="/login?next=/video";return}const a={user_id:s,title:i.title,model:i.model,prompt:i.prompt,status:i.status,video_url:i.video_url,metadata:i.metadata,request:{modelKey:t.modelKey||null,baseUrl:t.baseUrl||null,payload:t.payload||null},response:{task_id:t.taskId||null,status:t.status,progress:t.progress,video_url:t.videoUrl||null,platform:t.platform||null,action:t.action||null,cost:t.cost??null}},{data:c,error:d}=await re.from("user_videos").insert(a).select("id").single();if(d)throw d;const u=(c==null?void 0:c.id)||null;t.repoSave={status:"saved",errorMessage:"",savedVideoId:u,payload:i},P(t),w(t,"已保存到存储库","success"),v(`已保存到存储库：${t.name||t.taskId||""}`.trim(),"success",{durationMs:2200})}catch(s){const a=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:i},P(t),w(t,`保存失败: ${a}`,"error"),v(`保存失败：${a}`,"error");return}};f.saveQueue.enqueue(l).catch(s=>{const a=String((s==null?void 0:s.message)||s||"保存失败");t.repoSave={status:"failed",errorMessage:a,savedVideoId:null,payload:i},P(t),w(t,`保存失败: ${a}`,"error"),E(`保存失败: ${a}`,"error")})}function bt(e){if(!e.taskId||e.controller.signal.aborted)return;e.pollTimer&&clearTimeout(e.pollTimer);const n=async()=>{var t;if(!e.controller.signal.aborted&&!L(e.status))try{const r=await f.pollQueue.enqueue(()=>vt(e),{signal:e.controller.signal});e.pollErrorCount=0;const i=fe(r);let l=i.status;i.videoUrl&&i.progress>=100&&!["failed","cancelled"].includes(l)&&(l="completed");const s=e.status;if(i.taskId&&(e.taskId=String(i.taskId)),e.platform=i.platform||e.platform,e.action=i.action||e.action,e.progress=i.progress,e.failReason=i.failReason||e.failReason,e.submitTimeMs=i.submitTimeMs||e.submitTimeMs,e.startTimeMs=i.startTimeMs||e.startTimeMs,e.finishTimeMs=i.finishTimeMs||e.finishTimeMs,e.cost=i.cost!=null?i.cost:e.cost,e.videoUrl=i.videoUrl||e.videoUrl,e.updatedAt=Date.now(),$(e,l),s!==e.status&&L(e.status)){const a=e.status==="completed"?"任务成功":e.status==="failed"?"任务失败":"任务已取消";w(e,a,e.status==="completed"?"success":e.status==="failed"?"error":"warning"),e.status==="completed"&&q(e)}if(e.status==="completed"&&e.videoUrl,e.status==="completed"&&!e.videoUrl&&((t=e.apiSpec)!=null&&t.contentPath)){w(e,"视频生成完成，正在获取视频内容…","info");try{const a=await f.pollQueue.enqueue(()=>Oe(e),{signal:e.controller.signal});$(e,"completed",{videoUrl:a}),q(e)}catch(a){w(e,`获取视频内容失败: ${(a==null?void 0:a.message)||a}`,"warning"),q(e)}}if(L(e.status)){e.status==="completed"&&e.videoUrl?v(`完成：${e.name}`,"success"):e.status==="failed"&&v(`失败：${e.name}`,"error"),z(e);return}}catch(r){if((r==null?void 0:r.name)==="AbortError")return;if(e.pollErrorCount+=1,w(e,`轮询错误(${e.pollErrorCount}/${b.maxPollErrors}): ${r.message||r}`,"warning"),e.pollErrorCount>=b.maxPollErrors){e.failReason=e.failReason||String(r.message||r),$(e,"failed"),z(e),v(`轮询失败：${e.name}`,"error");return}}finally{const r=b.pollIntervalMs+Math.floor(Math.random()*b.pollJitterMs);e.pollTimer=setTimeout(n,r)}};e.pollTimer=setTimeout(n,1e3)}function Xe(e){const n=globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,t={localId:n,name:e.name,modelKey:e.modelKey,metaSummary:e.metaSummary,baseUrl:e.baseUrl,apiKey:e.apiKey,apiSpec:e.apiSpec,payload:e.payload,inputReferenceFile:e.inputReferenceFile||null,request:e,status:"queued",progress:0,taskId:null,platform:null,action:null,failReason:"",videoUrl:null,createdAt:Date.now(),updatedAt:Date.now(),submitTimeMs:null,startTimeMs:null,finishTimeMs:null,cost:null,logs:[],pollTimer:null,pollErrorCount:0,cleanupTimer:null,controller:new AbortController,dom:null};f.byLocalId.set(n,t),f.order.unshift(n),gt(),Ge(t),w(t,"已加入队列","info"),O();const r=f.createQueue.enqueue(async()=>{var d,u,p,y,m;$(t,"pending");const i=((d=t.apiSpec)==null?void 0:d.createBodyType)||"json",l=me(t.apiKey,i==="json");let s;if(i==="multipart"){const h=new FormData;h.append("prompt",String(((u=t.payload)==null?void 0:u.prompt)??"")),h.append("model",String(((p=t.payload)==null?void 0:p.model)??"")),h.append("seconds",String(((y=t.payload)==null?void 0:y.seconds)??"4")),h.append("size",String(((m=t.payload)==null?void 0:m.size)??"720x1280")),t.inputReferenceFile&&h.append("input_reference",t.inputReferenceFile,t.inputReferenceFile.name||"input_reference"),s=h}else s=JSON.stringify(t.payload);const a=await fetch(`${t.baseUrl}${t.apiSpec.createPath}`,{method:"POST",headers:l,body:s,signal:t.controller.signal}),c=await Q(a);if(!a.ok)throw new Error(J(c,`请求失败（HTTP ${a.status}）`));if(c&&typeof c=="object"&&typeof c.code=="string"&&c.code.startsWith("fail_"))throw new Error(J(c,`请求失败（${c.code}）`));return c},{signal:t.controller.signal});return t.createPromise=r,r.then(async i=>{var a;const l=fe(i);let s=l.status;if(l.videoUrl&&l.progress>=100&&!["failed","cancelled"].includes(s)&&(s="completed"),t.taskId=l.taskId?String(l.taskId):t.taskId,t.platform=l.platform||t.platform,t.action=l.action||t.action,t.progress=l.progress,t.failReason=l.failReason||"",t.submitTimeMs=l.submitTimeMs||t.submitTimeMs,t.startTimeMs=l.startTimeMs||t.startTimeMs,t.finishTimeMs=l.finishTimeMs||t.finishTimeMs,t.cost=l.cost!=null?l.cost:t.cost,t.videoUrl=l.videoUrl||t.videoUrl,!t.taskId){t.failReason=t.failReason||"响应缺少 task_id",$(t,"failed"),z(t),v(`创建失败：${t.name}`,"error");return}if($(t,s),w(t,`任务创建成功: ${t.taskId}`,"success"),v(`已提交：${t.name}`,"success",{durationMs:1800}),t.status==="completed"&&!t.videoUrl&&((a=t.apiSpec)!=null&&a.contentPath)){w(t,"视频生成完成，正在获取视频内容…","info");try{const c=await f.pollQueue.enqueue(()=>Oe(t),{signal:t.controller.signal});$(t,"completed",{videoUrl:c})}catch(c){w(t,`获取视频内容失败: ${(c==null?void 0:c.message)||c}`,"warning")}}if(t.status==="completed"&&t.videoUrl&&Ke(t.videoUrl)&&q(t),L(t.status)){z(t);return}bt(t)}).catch(i=>{if((i==null?void 0:i.name)==="AbortError"){$(t,"cancelled"),z(t);return}t.failReason=String((i==null?void 0:i.message)||i),$(t,"failed"),w(t,`创建失败: ${t.failReason}`,"error"),z(t),v(`创建失败：${t.name}`,"error")}),t}function Ye(){const e=Date.now();if(e-f.lastSubmitAt<b.submitDebounceMs)return;f.lastSubmitAt=e;const n=[["apiKey",o.apiKey],["baseUrl",o.baseUrl],["promptInput",o.promptInput],["modelSelect",o.modelSelect],["batchCount",o.batchCount],["taskNameInput",o.taskNameInput]];for(const[m,h]of n)if(!h){v(`页面缺少必要表单字段：${m}`,"error");return}const t=Ae(o.apiKey.value);if(!t){v("请先输入 API Key","error"),o.apiKey.focus();return}let r;try{r=G(o.baseUrl.value)}catch(m){v(m.message||"Base URL 无效","error"),o.baseUrl.focus();return}const i=o.promptInput.value.trim();if(!i){v("请输入提示词","error"),o.promptInput.focus();return}const l=o.modelSelect.value;let s;try{s=dt(l)}catch(m){v(m.message||"模型不支持","error");return}if(l==="sora2"&&g.readingCount>0){v("图片读取中，请稍候…","warning");return}if(l==="sora2"){const m=o.soraImageSourceInput?String(o.soraImageSourceInput.value||"").trim():"";m&&ue(m)>0&&(o.soraImageSourceInput&&(o.soraImageSourceInput.value=""),x())}let a;try{a=We(l,i)}catch(m){v(m.message||"参数有误","error");return}const c=Ve(o.batchCount.value,1,b.maxBatchCount,1);if(c>=b.confirmBatchThreshold&&!confirm(`将提交 ${c} 个任务，确认继续？`))return;const u=String(o.taskNameInput.value||"").trim()||i.slice(0,18)||"任务",p=Array.from({length:c},(m,h)=>{const I=c>1?` #${h+1}`:"";return{name:`${u}${I}`,modelKey:l,metaSummary:a.metaSummary,baseUrl:r,apiKey:t,apiSpec:s,payload:a.payload,inputReferenceFile:l==="sora2"&&a.inputReference||null}});v(`已加入队列：${c} 个任务`,"success");const y=p.map(m=>{const h=Xe({...m,request:null});return h.request={name:m.name,modelKey:m.modelKey,metaSummary:m.metaSummary,baseUrl:m.baseUrl,apiKey:m.apiKey,apiSpec:m.apiSpec,payload:m.payload},h});Promise.allSettled(y.map(m=>m.createPromise)).then(m=>{const h=m.filter(B=>B.status==="fulfilled").length,I=m.length-h;m.length>1&&v(`创建结果：成功 ${h}，失败 ${I}`,I?"warning":"success",{durationMs:3600})}).catch(()=>{})}setInterval(()=>{const e=f.order.slice(0,f.renderLimit);for(const n of e){const t=f.byLocalId.get(n);t&&Qe(t)}},1e3)})();
