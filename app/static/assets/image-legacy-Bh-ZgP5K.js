const h={apiKey:"video_api_key",baseUrl:"video_base_url"},b="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200" viewBox="0 0 320 200"><rect width="320" height="200" fill="#111827"/><rect x="52" y="40" width="216" height="120" rx="12" fill="none" stroke="#9CA3AF" stroke-width="6"/><path d="M76 142l54-64 44 52 30-36 70 84H76z" fill="#374151"/><circle cx="116" cy="82" r="10" fill="#6B7280"/><line x1="92" y1="62" x2="228" y2="138" stroke="#9CA3AF" stroke-width="6"/><line x1="228" y1="62" x2="92" y2="138" stroke="#9CA3AF" stroke-width="6"/></svg>');function Y(e){return String(e||"").trim().replace(/^bearer\s+/i,"").trim()}function J(e,o){e&&e.querySelectorAll(o).forEach(a=>{a.addEventListener("error",()=>{a.dataset.fallbackApplied||(a.dataset.fallbackApplied="true",a.alt="Image unavailable",a.src=b)},{once:!0})})}function re(e){const a=`; ${document.cookie||""}`.split(`; ${e}=`);return a.length===2?a.pop().split(";").shift():null}function se(){const e=re("csrf_token");return e?{"X-CSRF-Token":e}:{}}function W(e){const o=String(e||"").trim();if(!o)return null;let a;try{a=new URL(o)}catch{throw new Error("Base URL is not a valid URL")}if(a.protocol!=="https:")throw new Error("Base URL must use HTTPS");if(!a.hostname)throw new Error("Base URL is missing host (e.g. https://api.example.com)");return a.origin}async function O(e){if((e.headers.get("content-type")||"").includes("application/json"))return await e.json();const a=await e.text();try{return JSON.parse(a)}catch{return a}}function le(e,o){if(typeof e=="string")return e;if(!e||typeof e!="object")return o;const a=e.detail??e.error??e.message;if(typeof a=="string")return a;try{return JSON.stringify(a??e)}catch{return o}}const n={config:{apiKey:localStorage.getItem(h.apiKey)||localStorage.getItem("apiKey")||"",baseUrl:localStorage.getItem(h.baseUrl)||localStorage.getItem("baseUrl")||""},images:[],currentImageIndex:-1,prompt:"",promptHistory:(()=>{try{return JSON.parse(localStorage.getItem("promptHistory")||"[]")}catch{return localStorage.removeItem("promptHistory"),[]}})(),generationHistory:(()=>{try{return JSON.parse(localStorage.getItem("generationHistory")||"[]")}catch{return localStorage.removeItem("generationHistory"),[]}})(),inlineHistoryCollapsed:localStorage.getItem("inlineHistoryCollapsed")==="true",inlineHistoryLimit:6,inlineHistoryShowAll:!1,editingHistoryIndex:-1,isGenerating:!1,currentZoom:100,canvasZoom:100,canvasHistory:[],canvasHistoryIndex:-1,originalImage:null,originalWidth:0,originalHeight:0,displayScale:1},t={apiKey:document.getElementById("apiKey"),baseUrl:document.getElementById("baseUrl"),saveConfigBtn:document.getElementById("saveConfigBtn"),resetConfigBtn:document.getElementById("resetConfigBtn"),modelSelect:document.getElementById("modelSelect"),modelSearch:document.getElementById("modelSearch"),aspectRatio:document.getElementById("aspectRatio"),imageSize:document.getElementById("imageSize"),uploadArea:document.getElementById("uploadArea"),fileInput:document.getElementById("fileInput"),imagePreviewGrid:document.getElementById("imagePreviewGrid"),editMaskBtn:document.getElementById("editMaskBtn"),maskModalOverlay:document.getElementById("maskModalOverlay"),closeMaskModal:document.getElementById("closeMaskModal"),cancelMaskBtn:document.getElementById("cancelMaskBtn"),canvasContainer:document.getElementById("canvasContainer"),canvasWrapper:document.getElementById("canvasWrapper"),maskCanvas:document.getElementById("maskCanvas"),brushSize:document.getElementById("brushSize"),brushSizeLabel:document.getElementById("brushSizeLabel"),brushColor:document.getElementById("brushColor"),undoBtn:document.getElementById("undoBtn"),redoBtn:document.getElementById("redoBtn"),clearCanvasBtn:document.getElementById("clearCanvasBtn"),saveMaskBtn:document.getElementById("saveMaskBtn"),resetMaskBtn:document.getElementById("resetMaskBtn"),canvasZoomInBtn:document.getElementById("canvasZoomInBtn"),canvasZoomOutBtn:document.getElementById("canvasZoomOutBtn"),canvasZoomResetBtn:document.getElementById("canvasZoomResetBtn"),canvasZoomLevel:document.getElementById("canvasZoomLevel"),promptInput:document.getElementById("promptInput"),charCount:document.getElementById("charCount"),showPromptHistory:document.getElementById("showPromptHistory"),promptHistoryDropdown:document.getElementById("promptHistoryDropdown"),imagePreviewOverlay:document.getElementById("imagePreviewOverlay"),imagePreviewImg:document.getElementById("imagePreviewImg"),imagePreviewInfo:document.getElementById("imagePreviewInfo"),closeImagePreview:document.getElementById("closeImagePreview"),resultArea:document.getElementById("resultArea"),resultPlaceholder:document.getElementById("resultPlaceholder"),loadingState:document.getElementById("loadingState"),resultContainer:document.getElementById("resultContainer"),resultImage:document.getElementById("resultImage"),generateBtn:document.getElementById("generateBtn"),downloadBtn:document.getElementById("downloadBtn"),shareBtn:document.getElementById("shareBtn"),fullscreenBtn:document.getElementById("fullscreenBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),zoomLevel:document.getElementById("zoomLevel"),statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),historyBtn:document.getElementById("historyBtn"),historyPanel:document.getElementById("historyPanel"),closeHistoryBtn:document.getElementById("closeHistoryBtn"),historyList:document.getElementById("historyList"),inlineHistorySection:document.getElementById("inlineHistorySection"),inlineHistoryToggle:document.getElementById("inlineHistoryToggle"),inlineHistoryContent:document.getElementById("inlineHistoryContent"),inlineHistoryGrid:document.getElementById("inlineHistoryGrid"),inlineHistoryCount:document.getElementById("inlineHistoryCount"),inlineHistoryShowMore:document.getElementById("inlineHistoryShowMore"),showMoreHistoryBtn:document.getElementById("showMoreHistoryBtn"),editPromptModalOverlay:document.getElementById("editPromptModalOverlay"),editPromptTextarea:document.getElementById("editPromptTextarea"),closeEditPromptModal:document.getElementById("closeEditPromptModal"),cancelEditPromptBtn:document.getElementById("cancelEditPromptBtn"),saveEditPromptBtn:document.getElementById("saveEditPromptBtn"),imageZoomOverlay:document.getElementById("imageZoomOverlay"),zoomImage:document.getElementById("zoomImage"),closeZoomBtn:document.getElementById("closeZoomBtn"),toastContainer:document.getElementById("toastContainer")};let g=null,m=null,y=null,k=!1,M="brush",B=0,H=0;function s(e,o,a){const i=document.createElement("div");i.className=`toast ${e}`;const r={success:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',error:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'};i.innerHTML=`
        ${r[e]}
        <div class="toast-content">
            <div class="toast-title">${o}</div>
            ${a?`<div class="toast-message">${a}</div>`:""}
        </div>
        <button class="toast-close">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    `,t.toastContainer.appendChild(i),i.querySelector(".toast-close").addEventListener("click",()=>{i.remove()}),setTimeout(()=>{i.remove()},5e3)}function u(e,o){t.statusDot.className="status-dot "+e,t.statusText.textContent=o}function V(e){return new Intl.DateTimeFormat("zh-CN",{hour:"2-digit",minute:"2-digit"}).format(e)}function ce(e){return new Intl.DateTimeFormat("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function de(){t.apiKey.value=n.config.apiKey,t.baseUrl.value=n.config.baseUrl,n.config.apiKey||n.config.baseUrl?u("connected","Configured"):u("","Ready")}function me(){const e=Y(t.apiKey.value);let o=null;try{o=W(t.baseUrl.value)}catch(a){s("error","Invalid Base URL",(a==null?void 0:a.message)||"Invalid Base URL");return}n.config.apiKey=e,n.config.baseUrl=o||"",t.apiKey.value=n.config.apiKey,t.baseUrl.value=n.config.baseUrl,localStorage.setItem(h.apiKey,n.config.apiKey),localStorage.setItem(h.baseUrl,n.config.baseUrl),localStorage.setItem("apiKey",n.config.apiKey),localStorage.setItem("baseUrl",n.config.baseUrl),n.config.apiKey||n.config.baseUrl?(u("connected","Configured"),s("success","Configuration saved","API settings have been saved")):(u("","Ready"),s("success","Configuration cleared","Using server defaults"))}function ge(){t.apiKey.value="",t.baseUrl.value="",n.config.apiKey="",n.config.baseUrl="",localStorage.removeItem(h.apiKey),localStorage.removeItem(h.baseUrl),localStorage.removeItem("apiKey"),localStorage.removeItem("baseUrl"),u("","Ready"),s("success","Configuration reset","API settings have been cleared")}function T(e){Array.from(e).forEach(o=>{if(!o.type.startsWith("image/")){s("error","Invalid file type","Please upload an image file");return}if(o.size>10*1024*1024){s("error","File too large","Maximum file size is 10MB");return}const a=new FileReader;a.onload=i=>{n.images.push({id:Date.now()+Math.random(),name:o.name,originalData:i.target.result,data:i.target.result,hasMask:!1}),p(),n.images.length===1&&Q(0)},a.readAsDataURL(o)})}function p(){t.imagePreviewGrid.innerHTML=n.images.map((e,o)=>`
        <div class="image-preview-item ${o===n.currentImageIndex?"active":""}" data-index="${o}">
            <img src="${e.data}" alt="${e.name}">
            <button class="remove-btn" data-index="${o}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            ${e.hasMask?'<span class="edit-indicator">Mask</span>':""}
        </div>
    `).join(""),t.imagePreviewGrid.querySelectorAll(".image-preview-item").forEach(e=>{e.addEventListener("click",o=>{o.target.closest(".remove-btn")||Q(parseInt(e.dataset.index))})}),t.imagePreviewGrid.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),ye(parseInt(e.dataset.index))})}),ue()}function ue(){t.editMaskBtn.disabled=n.images.length===0||n.currentImageIndex<0}function Q(e){n.currentImageIndex=e,p()}function ye(e){n.images.splice(e,1),n.currentImageIndex>=n.images.length&&(n.currentImageIndex=n.images.length-1),p()}function pe(){if(n.currentImageIndex<0||!n.images[n.currentImageIndex]){s("warning","No image selected","Please select an image first");return}t.maskModalOverlay.classList.add("show"),setTimeout(()=>{P()},100)}function f(){t.maskModalOverlay.classList.remove("show")}function P(){if(n.currentImageIndex<0||!n.images[n.currentImageIndex])return;n.canvasZoom=100,L();const e=new Image;e.onload=()=>{n.originalWidth=e.width,n.originalHeight=e.height,n.originalImage=e,m=document.createElement("canvas"),m.width=e.width,m.height=e.height,y=m.getContext("2d"),y.drawImage(e,0,0);const o=t.canvasContainer.clientWidth-40,a=t.canvasContainer.clientHeight-40||500;let i=e.width,r=e.height;const d=o/e.width,c=a/e.height;n.displayScale=Math.min(d,c,1),i=Math.floor(e.width*n.displayScale),r=Math.floor(e.height*n.displayScale);const l=t.maskCanvas;l.width=i,l.height=r,l.style.width=i+"px",l.style.height=r+"px",g=l.getContext("2d"),g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.drawImage(e,0,0,i,r),n.canvasHistory=[{display:l.toDataURL(),fullRes:m.toDataURL()}],n.canvasHistoryIndex=0},e.src=n.images[n.currentImageIndex].data}function ee(e){const o=t.maskCanvas.getBoundingClientRect(),a=t.maskCanvas.width/o.width,i=t.maskCanvas.height/o.height;return{x:(e.clientX-o.left)*a,y:(e.clientY-o.top)*i}}function R(e){if(!g||!y)return;k=!0;const o=ee(e);B=o.x,H=o.y}function Z(e){if(!k||!g||!y)return;const o=ee(e),a=o.x,i=o.y,r=parseInt(t.brushSize.value),d=t.brushColor.value;z(g,B,H,a,i,r,d,M==="eraser");const c=B/n.displayScale,l=H/n.displayScale,v=a/n.displayScale,S=i/n.displayScale,U=r/n.displayScale;z(y,c,l,v,S,U,d,M==="eraser"),B=a,H=i}function z(e,o,a,i,r,d,c,l){e.beginPath(),e.moveTo(o,a),e.lineTo(i,r),e.strokeStyle=c,e.lineWidth=d,e.lineCap="round",e.lineJoin="round",l?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over",e.stroke(),e.globalCompositeOperation="source-over"}function C(){k&&(k=!1,ve(),n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].hasMask=!0,p()))}function ve(){!t.maskCanvas||!m||(n.canvasHistoryIndex++,n.canvasHistory=n.canvasHistory.slice(0,n.canvasHistoryIndex),n.canvasHistory.push({display:t.maskCanvas.toDataURL(),fullRes:m.toDataURL()}),n.canvasHistory.length>50&&(n.canvasHistory.shift(),n.canvasHistoryIndex--))}function $(){n.canvasHistoryIndex>0&&(n.canvasHistoryIndex--,te())}function K(){n.canvasHistoryIndex<n.canvasHistory.length-1&&(n.canvasHistoryIndex++,te())}function te(){const e=n.canvasHistory[n.canvasHistoryIndex];if(!e)return;const o=new Image;o.onload=()=>{g.clearRect(0,0,t.maskCanvas.width,t.maskCanvas.height),g.drawImage(o,0,0)},o.src=e.display;const a=new Image;a.onload=()=>{y.clearRect(0,0,m.width,m.height),y.drawImage(a,0,0)},a.src=e.fullRes}function he(){n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].data=n.images[n.currentImageIndex].originalData,n.images[n.currentImageIndex].hasMask=!1,P(),p())}function G(){if(!m||n.currentImageIndex<0){s("warning","No mask to save","Please draw on the image first");return}const e=m.toDataURL("image/png");n.images[n.currentImageIndex].data=e,n.images[n.currentImageIndex].hasMask=!0,saveToDrawingHistory(e),p(),f(),s("success","Mask saved","The mask has been applied to the image")}function fe(){n.currentImageIndex>=0&&n.images[n.currentImageIndex]&&(n.images[n.currentImageIndex].data=n.images[n.currentImageIndex].originalData,n.images[n.currentImageIndex].hasMask=!1,P(),p(),s("success","Mask reset","Image restored to original"))}function L(){t.canvasZoomLevel.textContent=`${n.canvasZoom}%`,t.canvasWrapper.style.transform=`scale(${n.canvasZoom/100})`}function N(){n.canvasZoom<300&&(n.canvasZoom+=25,L())}function F(){n.canvasZoom>50&&(n.canvasZoom-=25,L())}function Ie(){n.canvasZoom=100,L()}async function we(){try{return(await fetch("/api/v1/auth/me",{credentials:"include"})).ok?!0:(window.location.href="/login?next=/image",!1)}catch(e){return console.error("Authentication check failed:",e),window.location.href="/login?next=/image",!1}}async function ne(){try{const e=await fetch("/api/v1/images?limit=50",{credentials:"include"});if(!e.ok){if(e.status===401){window.location.href="/login?next=/image";return}throw new Error("Failed to load images")}const o=await e.json()}catch(e){console.error("Failed to load images from repository:",e),s("error","Load failed",e.message||"Failed to load images from repository")}}function q(){t.imagePreviewOverlay.classList.remove("show"),setTimeout(()=>{t.imagePreviewImg.src=""},300)}function w(){const e=t.promptInput.value.length;t.charCount.textContent=e}function Ee(e){if(e.trim()){n.promptHistory=n.promptHistory.filter(o=>o.text!==e),n.promptHistory.unshift({text:e,time:new Date().toISOString()}),n.promptHistory=n.promptHistory.slice(0,20);try{localStorage.setItem("promptHistory",JSON.stringify(n.promptHistory))}catch(o){console.warn("Failed to persist prompt history:",o)}}}function oe(){if(n.promptHistory.length===0){t.promptHistoryDropdown.innerHTML='<p style="padding: 12px; text-align: center; color: var(--text-muted);">No history yet</p>';return}t.promptHistoryDropdown.innerHTML=n.promptHistory.map((e,o)=>`
	                <div class="prompt-history-item" data-index="${o}">
	                    <span class="prompt-text">${e.text}</span>
	                    <div class="prompt-history-actions">
	                        <span class="prompt-time">${V(new Date(e.time))}</span>
	                        <button class="prompt-history-delete" data-index="${o}" title="Delete">
	                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M18 6L6 18M6 6l12 12"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `).join(""),t.promptHistoryDropdown.querySelectorAll(".prompt-history-item").forEach(e=>{e.addEventListener("click",o=>{o.target.closest(".prompt-history-delete")||(t.promptInput.value=n.promptHistory[parseInt(e.dataset.index)].text,w(),t.promptHistoryDropdown.classList.remove("show"))})}),t.promptHistoryDropdown.querySelectorAll(".prompt-history-delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),Be(parseInt(e.dataset.index))})})}function Be(e){if(!(Number.isNaN(e)||e<0||e>=n.promptHistory.length)){n.promptHistory.splice(e,1);try{localStorage.setItem("promptHistory",JSON.stringify(n.promptHistory))}catch(o){console.warn("Failed to persist prompt history:",o)}oe(),s("success","Deleted","Prompt history item removed")}}function He(e,o){n.generationHistory.unshift({prompt:e,imageUrl:o,model:t.modelSelect.value,time:new Date().toISOString()}),n.generationHistory=n.generationHistory.slice(0,50);try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(a){console.warn("Failed to persist generation history:",a)}x(),E()}function x(){if(n.generationHistory.length===0){t.historyList.innerHTML='<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>';return}t.historyList.innerHTML=n.generationHistory.map((e,o)=>`
	                <div class="history-item" data-index="${o}">
	                    <img class="history-item-image" src="${e.imageUrl}" alt="Generated" loading="lazy" decoding="async">
	                    <div class="history-item-content">
	                        <div class="history-item-prompt">${e.prompt}</div>
	                        <div class="history-item-meta">${e.model} - ${V(new Date(e.time))}</div>
	                    </div>
	                    <button class="history-item-delete" data-index="${o}" title="Delete">
	                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M18 6L6 18M6 6l12 12"/>
	                        </svg>
	                    </button>
	                </div>
	            `).join(""),t.historyList.querySelectorAll(".history-item").forEach(e=>{e.addEventListener("click",o=>{if(o.target.closest(".history-item-delete"))return;const a=n.generationHistory[parseInt(e.dataset.index)];D(a.imageUrl),t.promptInput.value=a.prompt,w()})}),t.historyList.querySelectorAll(".history-item-delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation(),Me(parseInt(e.dataset.index))})}),J(t.historyList,".history-item-image")}function E(){const e=n.generationHistory,o=e.length;if(t.inlineHistoryCount.textContent=o,n.inlineHistoryCollapsed?t.inlineHistorySection.classList.add("collapsed"):t.inlineHistorySection.classList.remove("collapsed"),o===0){t.inlineHistoryGrid.innerHTML='<p class="inline-history-empty">No generation history yet. Create your first image!</p>',t.inlineHistoryShowMore.style.display="none";return}const a=n.inlineHistoryShowAll?o:Math.min(n.inlineHistoryLimit,o),i=e.slice(0,a);t.inlineHistoryGrid.innerHTML=i.map((r,d)=>{const c=r.prompt.length>100?r.prompt.substring(0,100)+"...":r.prompt,l=ce(new Date(r.time));return`
            <div class="inline-history-item" data-index="${d}">
                <div class="inline-history-item-actions">
                    <button class="inline-history-action-btn load" data-index="${d}" title="Load prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn edit" data-index="${d}" title="Edit prompt">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="inline-history-action-btn delete" data-index="${d}" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
                <img class="inline-history-item-image" src="${r.imageUrl}" alt="Generated" loading="lazy">
                <div class="inline-history-item-info">
                    <div class="inline-history-item-prompt" title="${r.prompt.replace(/"/g,"&quot;")}">${c}</div>
                    <div class="inline-history-item-meta">
                        <span>${r.model}</span>
                        <span>â€¢</span>
                        <span>${l}</span>
                    </div>
                </div>
            </div>
        `}).join(""),o>n.inlineHistoryLimit&&!n.inlineHistoryShowAll?(t.inlineHistoryShowMore.style.display="flex",t.showMoreHistoryBtn.textContent=`Show more (${o-a} more)`):n.inlineHistoryShowAll&&o>n.inlineHistoryLimit?(t.inlineHistoryShowMore.style.display="flex",t.showMoreHistoryBtn.textContent="Show less"):t.inlineHistoryShowMore.style.display="none",ke(),J(t.inlineHistoryGrid,".inline-history-item-image")}function ke(){t.inlineHistoryGrid.querySelectorAll(".inline-history-item").forEach(e=>{e.addEventListener("click",o=>{if(o.target.closest(".inline-history-action-btn"))return;const a=parseInt(e.dataset.index);_(a)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.load").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(e.dataset.index);_(a)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.edit").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(e.dataset.index);xe(a)})}),t.inlineHistoryGrid.querySelectorAll(".inline-history-action-btn.delete").forEach(e=>{e.addEventListener("click",o=>{o.stopPropagation();const a=parseInt(e.dataset.index);ae(a)})})}function _(e){const o=n.generationHistory[e];o&&(D(o.imageUrl),t.promptInput.value=o.prompt,w(),s("success","Loaded","Prompt and image loaded from history"))}function ae(e){if(confirm("Delete this generation from history?")){n.generationHistory.splice(e,1);try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(o){console.warn("Failed to persist generation history:",o)}E(),x(),s("success","Deleted","Generation removed from history")}}function Le(e,o){if(!(e<0||e>=n.generationHistory.length)){n.generationHistory[e].prompt=o;try{localStorage.setItem("generationHistory",JSON.stringify(n.generationHistory))}catch(a){console.warn("Failed to persist generation history:",a)}E(),x(),s("success","Updated","Prompt has been updated")}}function xe(e){const o=n.generationHistory[e];o&&(n.editingHistoryIndex=e,t.editPromptTextarea.value=o.prompt,t.editPromptModalOverlay.classList.add("show"),t.editPromptTextarea.focus())}function I(){t.editPromptModalOverlay.classList.remove("show"),n.editingHistoryIndex=-1,t.editPromptTextarea.value=""}function Se(){if(n.editingHistoryIndex<0)return;const e=t.editPromptTextarea.value.trim();if(!e){s("error","Invalid","Prompt cannot be empty");return}Le(n.editingHistoryIndex,e),I()}function Ce(){n.inlineHistoryCollapsed=!n.inlineHistoryCollapsed,localStorage.setItem("inlineHistoryCollapsed",n.inlineHistoryCollapsed.toString()),n.inlineHistoryCollapsed?t.inlineHistorySection.classList.add("collapsed"):t.inlineHistorySection.classList.remove("collapsed")}function be(){n.inlineHistoryShowAll=!n.inlineHistoryShowAll,E()}function Me(e){ae(e)}async function j(){const e=t.promptInput.value.trim();if(!e){s("error","Prompt required","Please enter a prompt");return}n.isGenerating=!0,t.generateBtn.disabled=!0,t.resultPlaceholder.style.display="none",t.resultContainer.style.display="none",t.loadingState.style.display="block",u("generating","Generating...");try{const o=new FormData;o.append("model",t.modelSelect.value),o.append("prompt",e),o.append("response_format","url"),t.aspectRatio.value&&o.append("aspect_ratio",t.aspectRatio.value),t.imageSize.value&&o.append("image_size",t.imageSize.value);for(const v of n.images){const S=v.data,ie=await(await fetch(S)).blob();o.append("image",ie,v.name||"image.png")}const a=Y(n.config.apiKey),i=W(n.config.baseUrl),r=await fetch("/api/v1/images/edits",{method:"POST",credentials:"include",headers:{...se(),...a?{"X-API-Key":a}:{},...i?{"X-Base-Url":i}:{}},body:o});if(!r.ok){const v=await O(r);if(r.status===401){window.location.href="/login?next=/image";return}throw new Error(le(v,`Request failed (HTTP ${r.status})`))}const d=await O(r),c=d&&typeof d=="object"&&d.response?d.response:d;let l=null;if(c.data&&c.data[0]?(l=c.data[0].url||c.data[0].b64_json,c.data[0].b64_json&&!c.data[0].url&&(l=`data:image/png;base64,${c.data[0].b64_json}`)):c.url?l=c.url:c.b64_json&&(l=`data:image/png;base64,${c.b64_json}`),!l)throw new Error("No image URL in response");D(l),Ee(e),He(e,l),s("success","Image generated","Your image has been created successfully"),ne()}catch(o){console.error("Generation error:",o),s("error","Generation failed",o.message),t.loadingState.style.display="none",t.resultPlaceholder.style.display="block",u("error","Error")}finally{n.isGenerating=!1,t.generateBtn.disabled=!1}}function D(e){t.loadingState.style.display="none",t.resultPlaceholder.style.display="none",t.resultContainer.style.display="block",t.resultImage.src=e,n.currentZoom=100,A(),u("connected","Complete")}function A(){t.zoomLevel.textContent=`${n.currentZoom}%`,t.resultImage.style.transform=`scale(${n.currentZoom/100})`}function Pe(){n.currentZoom<200&&(n.currentZoom+=25,A())}function De(){n.currentZoom>25&&(n.currentZoom-=25,A())}function Ae(){const e=t.resultImage.src;if(!e)return;const o=document.createElement("a");o.href=e,o.download=`generated-${Date.now()}.png`,document.body.appendChild(o),o.click(),document.body.removeChild(o),s("success","Download started","Image is being downloaded")}function Ue(){const e=t.resultImage.src;e&&(navigator.share?navigator.share({title:"Generated Image",text:t.promptInput.value,url:e}).catch(()=>{}):navigator.clipboard.writeText(e).then(()=>{s("success","Link copied","Image URL copied to clipboard")}))}function Oe(){const e=t.resultImage.src;e&&(t.zoomImage.src=e,t.imageZoomOverlay.classList.add("show"))}function Te(){const e=t.modelSearch.value.toLowerCase(),o=t.modelSelect.options;for(let a=0;a<o.length;a++){const i=o[a],r=i.textContent.toLowerCase();i.style.display=r.includes(e)?"":"none"}}function Re(){document.querySelectorAll(".collapsible-header").forEach(e=>{const o=e.dataset.target,a=o?document.getElementById(o):null;a&&(o==="configContent"&&(e.classList.add("collapsed"),a.classList.add("collapsed")),e.addEventListener("click",()=>{const i=e.classList.toggle("collapsed");a.classList.toggle("collapsed",i)}))})}function Ze(){document.querySelectorAll(".toggle-visibility").forEach(e=>{e.addEventListener("click",()=>{const o=document.getElementById(e.dataset.target),a=o.type==="password";o.type=a?"text":"password",e.innerHTML=a?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'})})}function ze(){t.saveConfigBtn.addEventListener("click",me),t.resetConfigBtn.addEventListener("click",ge),t.fileInput.addEventListener("change",e=>T(e.target.files)),t.uploadArea.addEventListener("dragover",e=>{e.preventDefault(),t.uploadArea.classList.add("drag-over")}),t.uploadArea.addEventListener("dragleave",()=>{t.uploadArea.classList.remove("drag-over")}),t.uploadArea.addEventListener("drop",e=>{e.preventDefault(),t.uploadArea.classList.remove("drag-over"),T(e.dataTransfer.files)}),t.editMaskBtn.addEventListener("click",pe),t.closeMaskModal.addEventListener("click",f),t.cancelMaskBtn.addEventListener("click",f),t.maskModalOverlay.addEventListener("click",e=>{e.target===t.maskModalOverlay&&f()}),t.closeImagePreview.addEventListener("click",q),t.imagePreviewOverlay.addEventListener("click",e=>{e.target===t.imagePreviewOverlay&&q()}),t.maskCanvas.addEventListener("mousedown",R),t.maskCanvas.addEventListener("mousemove",Z),t.maskCanvas.addEventListener("mouseup",C),t.maskCanvas.addEventListener("mouseout",C),t.maskCanvas.addEventListener("touchstart",e=>{e.preventDefault();const o=e.touches[0];R({clientX:o.clientX,clientY:o.clientY})}),t.maskCanvas.addEventListener("touchmove",e=>{e.preventDefault();const o=e.touches[0];Z({clientX:o.clientX,clientY:o.clientY})}),t.maskCanvas.addEventListener("touchend",C),document.querySelectorAll("[data-tool]").forEach(e=>{e.addEventListener("click",()=>{M=e.dataset.tool,document.querySelectorAll("[data-tool]").forEach(o=>o.classList.remove("active")),e.classList.add("active")})}),t.brushSize.addEventListener("input",()=>{t.brushSizeLabel.textContent=t.brushSize.value+"px"}),t.undoBtn.addEventListener("click",$),t.redoBtn.addEventListener("click",K),t.clearCanvasBtn.addEventListener("click",he),t.saveMaskBtn.addEventListener("click",G),t.resetMaskBtn.addEventListener("click",fe),t.canvasZoomInBtn.addEventListener("click",N),t.canvasZoomOutBtn.addEventListener("click",F),t.canvasZoomResetBtn.addEventListener("click",Ie),t.promptInput.addEventListener("input",w),t.showPromptHistory.addEventListener("click",()=>{oe(),t.promptHistoryDropdown.classList.toggle("show")}),document.addEventListener("click",e=>{e.target.closest(".main-prompt-section")||t.promptHistoryDropdown.classList.remove("show")}),t.modelSearch.addEventListener("input",Te),t.generateBtn.addEventListener("click",j),t.zoomInBtn.addEventListener("click",Pe),t.zoomOutBtn.addEventListener("click",De),t.downloadBtn.addEventListener("click",Ae),t.shareBtn.addEventListener("click",Ue),t.fullscreenBtn.addEventListener("click",Oe),t.resultImage.addEventListener("error",()=>{(t.resultImage.getAttribute("src")||"")!==b&&(t.resultImage.alt="Image unavailable",t.resultImage.src=b)}),t.closeZoomBtn.addEventListener("click",()=>{t.imageZoomOverlay.classList.remove("show")}),t.imageZoomOverlay.addEventListener("click",e=>{e.target===t.imageZoomOverlay&&t.imageZoomOverlay.classList.remove("show")}),t.historyBtn.addEventListener("click",()=>{t.historyPanel.classList.toggle("show")}),t.closeHistoryBtn.addEventListener("click",()=>{t.historyPanel.classList.remove("show")}),t.inlineHistoryToggle.addEventListener("click",Ce),t.showMoreHistoryBtn.addEventListener("click",be),t.closeEditPromptModal.addEventListener("click",I),t.cancelEditPromptBtn.addEventListener("click",I),t.saveEditPromptBtn.addEventListener("click",Se),t.editPromptModalOverlay.addEventListener("click",e=>{e.target===t.editPromptModalOverlay&&I()}),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="z"?(e.preventDefault(),e.shiftKey?K():$()):e.key==="Enter"?(e.preventDefault(),j()):e.key==="s"&&(e.preventDefault(),G())),e.key==="Escape"&&(f(),I(),t.imageZoomOverlay.classList.remove("show"),t.historyPanel.classList.remove("show"))}),t.canvasContainer.addEventListener("wheel",e=>{(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.deltaY<0?N():F())})}function X(){de(),Re(),Ze(),ze(),x(),E(),w(),we().then(e=>{e&&ne()})}document.readyState!=="loading"?X():document.addEventListener("DOMContentLoaded",X);
