import{d as Re,r as u,q as qe,c as J,o as ze,a as i,b as r,g as ne,e as s,f as d,i as He,t as p,u as E,n as oe,F as ie,p as re,w as $,l as F,s as I,x as Z,y as Je,j as We,k as Ge}from"./supabase-Cqce9izT.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                     */const Ke={class:"products-page"},Xe={class:"main-container"},Ye={class:"sidebar"},Ze={class:"sidebar-section"},et={class:"section-header"},tt={class:"section-title section-title-lg"},at={class:"form-group"},st=["disabled"],nt={class:"upload-actions"},ot=["disabled"],it={class:"form-group"},rt={class:"preview-box"},lt=["src"],ct={key:1,class:"preview-placeholder"},ut={key:0,class:"form-hint"},dt={key:0,class:"image-meta"},vt={class:"meta-text"},mt={key:0,class:"meta-text"},ft={key:1,class:"image-preview-grid product-image-grid"},pt=["src","alt"],gt={key:0,class:"preview-badge"},ht={class:"preview-actions"},_t=["onClick"],yt=["onClick"],bt={key:2,class:"image-preview-grid product-image-grid"},wt=["src","alt"],xt={key:0,class:"preview-badge"},kt={class:"form-group"},Tt={class:"form-group"},Ct={class:"form-group"},It=["disabled"],St={class:"form-group"},Mt={class:"form-group"},Pt={class:"form-actions"},Ut=["disabled"],Dt=["disabled"],jt=["disabled"],Et={class:"main-content"},Ot={class:"content-scroll"},Bt={key:0,class:"notice-banner error"},At={key:1,class:"notice-banner success"},Lt={class:"content-section"},Vt={class:"content-header"},$t={class:"search-wrapper"},Ft={key:0,class:"loading-state"},Nt={key:1},Rt={key:0,class:"empty-state"},qt={key:1,class:"products-grid"},zt={class:"product-thumb"},Ht=["src","alt"],Jt={key:0,class:"image-count-badge"},Wt={class:"product-body"},Gt={class:"product-title"},Qt={class:"product-meta"},Kt={key:0},Xt={key:1},Yt={key:2},Zt={key:0,class:"product-meta"},ea={class:"product-actions"},ta=["disabled","onClick"],aa=["disabled","onClick"],sa={key:2,class:"pagination"},na=["disabled"],oa={class:"meta-text"},ia=["disabled"],ra=Re({__name:"products-page",setup(ua){const W=u([]),ee=u(!1),c=u(!1),N=u(""),R=u(""),g=u(0),x=u(20),O=u(0),te=u("");let ae=null;const le=u(null),B=u(!1),l=u([]),_=u([]),v=u(0),k=u(null),M=u(null),A=u(!1),L=u(null),o=qe({name:"",dimensions:"",featuresText:"",characteristicsText:"",rawText:""}),h=J(()=>!!k.value),se=J(()=>l.value[v.value]??null),we=J(()=>_.value.find(a=>a.is_primary)??_.value[0]??null),ce=J(()=>{var a,e;return((a=se.value)==null?void 0:a.url)||((e=we.value)==null?void 0:e.image_url)||null}),ue=J(()=>l.value.length>0?l.value.length:_.value.length);function P(){N.value="",R.value=""}function y(a){N.value=a,R.value=""}function q(a){R.value=a,N.value=""}function xe(a){try{return new Date(a).toLocaleString()}catch{return a}}function G(a){return a.split(`
`).map(e=>e.trim()).filter(Boolean)}function z(){M.value=null,L.value=null}function Q(){for(const a of l.value)a.url.startsWith("blob:")&&URL.revokeObjectURL(a.url)}function ke(){return globalThis.crypto&&"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Te(a){const e=a.type.toLowerCase();if(e==="image/jpeg"||e==="image/png")return!0;const t=a.name.toLowerCase();return t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".png")}function de(a){if(h.value){y("编辑模式下无法更换图片");return}const e=Array.from(a);if(e.length===0)return;P();let t=0;for(const n of e){if(!Te(n)){t+=1;continue}const m=URL.createObjectURL(n);l.value.push({id:ke(),file:n,url:m})}l.value.length>0&&(v.value=Math.min(v.value,l.value.length-1),k.value=null,_.value=[],z()),t>0&&y("仅支持 JPG/PNG 图片")}function ve(){var a;h.value||(a=le.value)==null||a.click()}function Ce(){h.value||(B.value=!0)}function Ie(){h.value||(B.value=!0)}function Se(){B.value=!1}function Me(a){var e;h.value||(B.value=!1,(e=a.dataTransfer)!=null&&e.files&&de(a.dataTransfer.files))}function Pe(){Q(),l.value=[],v.value=0,z()}function Ue(a){var t;const[e]=l.value.splice(a,1);(t=e==null?void 0:e.url)!=null&&t.startsWith("blob:")&&URL.revokeObjectURL(e.url),l.value.length===0||a===v.value?v.value=0:a<v.value&&(v.value-=1),z()}function De(a){a<0||a>=l.value.length||(v.value=a,z())}function je(a){const e=a.target;e.files&&(de(e.files),e.value="")}async function me(a){const e=await a.text();try{const t=JSON.parse(e),n=(t==null?void 0:t.detail)??(t==null?void 0:t.error)??(t==null?void 0:t.message)??e;if(typeof n=="string")return n;if(n&&typeof n=="object"){const m=n==null?void 0:n.message;return typeof m=="string"?m:JSON.stringify(n)}return String(n||`HTTP ${a.status}`)}catch{return e||`HTTP ${a.status}`}}async function U(){ee.value=!0;try{const a=g.value,e=g.value+x.value-1,t=te.value.trim();let n=I.from("products").select("id,user_id,name,dimensions,original_image_url,recognition_confidence,created_at,updated_at",{count:"exact"}).order("created_at",{ascending:!1}).range(a,e);t&&(n=n.ilike("name",`%${t}%`));const{data:m,error:f,count:T}=await n;if(f)throw f;const D=m||[],V=D.map(b=>b.id),C=new Map;if(V.length){const{data:b,error:H}=await I.from("product_images").select("id,product_id").in("product_id",V);if(H)throw H;for(const K of b||[]){const j=K.product_id;C.set(j,(C.get(j)||0)+1)}}W.value=D.map(b=>({...b,image_count:C.get(b.id)||1})),O.value=T||0}catch(a){y(a.message||String(a))}finally{ee.value=!1}}async function fe(a){const{data:e,error:t}=await I.from("products").select("*").eq("id",a).single();if(t)throw t;const{data:n,error:m}=await I.from("product_images").select("id,image_url,is_primary,created_at,updated_at").eq("product_id",a).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(m)throw m;const f=n||[];return{...e,images:f,image_count:f.length||1}}function pe(){P(),Q(),l.value=[],_.value=[],v.value=0,B.value=!1,k.value=null,z(),o.name="",o.dimensions="",o.featuresText="",o.characteristicsText="",o.rawText=""}async function Ee(){if(P(),!se.value){y("请先选择图片");return}A.value=!0;try{const a=new FormData;a.append("image",se.value.file);const e=o.rawText.trim();e&&a.append("raw_text",e);const t=await Z("/api/v1/products/recognize",{method:"POST",body:a});if(!t.ok)throw new Error(await me(t));const n=await t.json();o.name=n.name||"",o.dimensions=n.dimensions||"",o.featuresText=(n.features||[]).join(`
`),o.characteristicsText=(n.characteristics||[]).join(`
`),M.value=n.confidence,L.value={confidence:n.confidence,metadata:n.metadata||{}},q(`AI整理完成（置信度：${Math.round(n.confidence*100)}%），可编辑后保存`)}catch(a){y(a.message||String(a))}finally{A.value=!1}}async function Oe(){var e,t,n,m;if(P(),l.value.length===0){y("请先选择图片");return}c.value=!0;let a=[];try{const f=await Je();if(!f)throw new Error("Not authenticated");const T=globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,w=>{const be=Math.random()*16|0;return(w==="x"?be:be&3|8).toString(16)}),D=new FormData;D.append("product_id",T),D.append("primary_index",String(v.value));for(const w of l.value)D.append("images",w.file);const V=await Z("/api/v1/uploads/products",{method:"POST",body:D});if(!V.ok)throw new Error(await me(V));const C=await V.json();a=(C.images||[]).map(w=>w.image_url);const b=((e=C.images.find(w=>w.is_primary))==null?void 0:e.image_url)||((t=C.images[0])==null?void 0:t.image_url)||"";if(!b)throw new Error("Upload failed");const H=o.name.trim()||"未命名产品",K=o.dimensions.trim()||null,j=G(o.featuresText),X=G(o.characteristicsText),ge=((n=L.value)==null?void 0:n.confidence)??null,he=((m=L.value)==null?void 0:m.metadata)??null,{error:_e}=await I.from("products").insert({id:T,user_id:f,name:H,dimensions:K,features:j.length?j:null,characteristics:X.length?X:null,original_image_url:b,recognition_confidence:ge,recognition_metadata:he,updated_at:null});if(_e)throw _e;const Ne=C.images.map(w=>({product_id:T,user_id:f,image_url:w.image_url,is_primary:w.is_primary})),{data:Y,error:ye}=await I.from("product_images").insert(Ne).select("id,image_url,is_primary,created_at,updated_at");if(ye)throw ye;const S={id:T,user_id:f,name:H,dimensions:K,original_image_url:b,recognition_confidence:ge,image_count:(Y==null?void 0:Y.length)||C.images.length||1,created_at:new Date().toISOString(),updated_at:null,features:j.length?j:null,characteristics:X.length?X:null,recognition_metadata:he,images:Y||[]};q(`创建成功（AI：${Math.round((S.recognition_confidence??0)*100)}%），可继续编辑后保存`),k.value=S.id,M.value=S.recognition_confidence??0,L.value=null,Q(),l.value=[],v.value=0,_.value=S.images||[],o.name=S.name||"",o.dimensions=S.dimensions||"",o.featuresText=(S.features||[]).join(`
`),o.characteristicsText=(S.characteristics||[]).join(`
`),await U()}catch(f){if(a.length)for(const T of a)try{await Z("/api/v1/uploads/products/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_url:T})})}catch{}y(f.message||String(f))}finally{c.value=!1}}async function Be(){if(P(),!!k.value){if(!o.name.trim()){y("产品名称不能为空");return}c.value=!0;try{const a={name:o.name.trim(),dimensions:o.dimensions.trim()||null,features:G(o.featuresText),characteristics:G(o.characteristicsText),updated_at:new Date().toISOString()},{error:e}=await I.from("products").update(a).eq("id",k.value);if(e)throw e;const t=await fe(k.value);M.value=t.recognition_confidence,_.value=t.images||_.value,q("已保存修改"),await U()}catch(a){y(a.message||String(a))}finally{c.value=!1}}}async function Ae(a){P(),c.value=!0;try{const e=await fe(a);k.value=e.id,M.value=e.recognition_confidence??null,Q(),l.value=[],v.value=0,_.value=e.images||[],L.value=null,o.name=e.name||"",o.dimensions=e.dimensions||"",o.featuresText=(e.features||[]).join(`
`),o.characteristicsText=(e.characteristics||[]).join(`
`),q("已加载产品信息，可编辑后保存")}catch(e){y(e.message||String(e))}finally{c.value=!1}}async function Le(a){if(P(),!!confirm("确定要删除该产品吗？删除后将释放存储空间。")){c.value=!0;try{const{data:e,error:t}=await I.from("product_images").select("image_url").eq("product_id",a);if(t)throw t;const n=(e||[]).map(f=>f.image_url).filter(Boolean),{error:m}=await I.from("products").delete().eq("id",a);if(m)throw m;for(const f of n)try{await Z("/api/v1/uploads/products/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_url:f})})}catch{}k.value===a&&pe(),q("已删除产品"),g.value>0&&W.value.length===1&&(g.value=Math.max(0,g.value-x.value)),await U()}catch(e){y(e.message||String(e))}finally{c.value=!1}}}function Ve(){g.value=Math.max(0,g.value-x.value),U()}function $e(){g.value+x.value>=O.value||(g.value=g.value+x.value,U())}function Fe(){ae&&window.clearTimeout(ae),ae=window.setTimeout(()=>{g.value=0,U()},250)}return ze(async()=>{await U()}),(a,e)=>(r(),i("div",Ke,[e[18]||(e[18]=ne('<header class="header" data-v-79af1c4a><div class="logo" data-v-79af1c4a><div class="logo-icon" data-v-79af1c4a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-79af1c4a><rect x="3" y="3" width="18" height="18" rx="2" data-v-79af1c4a></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-79af1c4a></circle><polyline points="21 15 16 10 5 21" data-v-79af1c4a></polyline></svg></div><span data-v-79af1c4a>产品库</span></div><div class="header-actions" data-v-79af1c4a><a href="/" class="btn btn-secondary" style="text-decoration:none;display:flex;align-items:center;gap:8px;" data-v-79af1c4a><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-79af1c4a><path d="M19 12H5M12 19l-7-7 7-7" data-v-79af1c4a></path></svg> 返回主页面 </a><a href="/video" class="btn btn-secondary" style="text-decoration:none;" data-v-79af1c4a>视频生成</a><a href="/image" class="btn btn-secondary" style="text-decoration:none;" data-v-79af1c4a>图像处理</a><a href="/storage" class="btn btn-secondary" style="text-decoration:none;" data-v-79af1c4a>存储库</a></div></header>',1)),s("div",Xe,[s("aside",Ye,[s("section",Ze,[s("div",et,[s("div",tt,[e[6]||(e[6]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),s("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),s("polyline",{points:"21 15 16 10 5 21"})],-1)),He(" "+p(h.value?"编辑产品":"创建产品"),1)]),h.value?(r(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:pe}," 退出编辑 ")):d("",!0)]),e[15]||(e[15]=s("div",{class:"section-subtitle"},"上传产品图片，AI 自动识别结构化信息，支持多图管理",-1)),s("div",at,[e[8]||(e[8]=s("label",{class:"form-label"},"产品图片",-1)),s("div",{class:oe(["upload-area",{"drag-over":B.value,"is-loading":c.value||A.value,"is-disabled":h.value}]),onClick:E(ve,["stop"]),onDragenter:E(Ce,["prevent"]),onDragover:E(Ie,["prevent"]),onDragleave:E(Se,["prevent"]),onDrop:E(Me,["prevent"])},[s("input",{ref_key:"fileInput",ref:le,type:"file",accept:"image/jpeg,image/png",multiple:"",disabled:h.value,onChange:je},null,40,st),e[7]||(e[7]=ne('<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-79af1c4a><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-79af1c4a></path><polyline points="17 8 12 3 7 8" data-v-79af1c4a></polyline><line x1="12" y1="3" x2="12" y2="15" data-v-79af1c4a></line></svg><p class="upload-text" data-v-79af1c4a><strong data-v-79af1c4a>拖拽或点击上传多张产品图</strong></p><p class="upload-hint" data-v-79af1c4a>主图用于 AI 识别与列表展示</p>',3))],34),s("div",nt,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:h.value,onClick:E(ve,["stop"])}," 选择图片 ",8,ot),l.value.length>0?(r(),i("button",{key:0,class:"btn btn-ghost btn-sm",type:"button",onClick:E(Pe,["stop"])}," 清空 ")):d("",!0)])]),s("div",it,[e[9]||(e[9]=s("label",{class:"form-label"},"主图预览",-1)),s("div",rt,[ce.value?(r(),i("img",{key:0,src:ce.value,alt:"preview",class:"preview-image"},null,8,lt)):(r(),i("div",ct,"未选择图片"))]),M.value!==null?(r(),i("div",ut," AI 置信度："+p(Math.round(M.value*100))+"% ",1)):d("",!0)]),ue.value>0?(r(),i("div",dt,[s("span",vt,"已选择 "+p(ue.value)+" 张图片",1),h.value&&l.value.length===0?(r(),i("span",mt,"编辑模式下图片不可替换")):d("",!0)])):d("",!0),l.value.length>0?(r(),i("div",ft,[(r(!0),i(ie,null,re(l.value,(t,n)=>(r(),i("div",{key:t.id,class:oe(["preview-item",{"is-primary":n===v.value}])},[s("img",{src:t.url,alt:`image-${n+1}`,class:"preview-img"},null,8,pt),n===v.value?(r(),i("div",gt,"主图")):d("",!0),s("div",ht,[n!==v.value?(r(),i("button",{key:0,class:"preview-action-btn",type:"button",onClick:m=>De(n)}," 设为主图 ",8,_t)):d("",!0),s("button",{class:"preview-action-btn danger",type:"button",onClick:m=>Ue(n)},"移除",8,yt)])],2))),128))])):_.value.length>0?(r(),i("div",bt,[(r(!0),i(ie,null,re(_.value,t=>(r(),i("div",{key:t.id,class:oe(["preview-item",{"is-primary":t.is_primary}])},[s("img",{src:t.image_url,alt:t.id,class:"preview-img"},null,8,wt),t.is_primary?(r(),i("div",xt,"主图")):d("",!0)],2))),128))])):d("",!0),s("div",kt,[e[10]||(e[10]=s("label",{class:"form-label"},"产品名称",-1)),$(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>o.name=t),class:"form-input",type:"text",maxlength:"200",placeholder:"例如：保温杯"},null,512),[[F,o.name]])]),s("div",Tt,[e[11]||(e[11]=s("label",{class:"form-label"},"尺寸规格",-1)),$(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>o.dimensions=t),class:"form-input",type:"text",maxlength:"100",placeholder:"例如：350ml"},null,512),[[F,o.dimensions]])]),s("div",Ct,[e[12]||(e[12]=s("label",{class:"form-label"},"无结构化信息（可选）",-1)),$(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=t=>o.rawText=t),rows:"3",class:"form-input",disabled:h.value,placeholder:"粘贴产品信息，例如从商品页面复制的描述文本，AI会结合图片提取结构化信息"},null,8,It),[[F,o.rawText]])]),s("div",St,[e[13]||(e[13]=s("label",{class:"form-label"},"功能特征（每行一个）",-1)),$(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>o.featuresText=t),rows:"4",class:"form-input"},null,512),[[F,o.featuresText]])]),s("div",Mt,[e[14]||(e[14]=s("label",{class:"form-label"},"产品特点（每行一个）",-1)),$(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=t=>o.characteristicsText=t),rows:"4",class:"form-input",placeholder:`例如：
便携
大容量`},null,512),[[F,o.characteristicsText]])]),s("div",Pt,[h.value?d("",!0):(r(),i("button",{key:0,class:"btn btn-secondary",type:"button",disabled:c.value||A.value,onClick:Ee},p(A.value?"AI整理中...":"AI整理预填"),9,Ut)),h.value?(r(),i("button",{key:2,class:"btn btn-primary",type:"button",disabled:c.value,onClick:Be},p(c.value?"保存中...":"保存修改"),9,jt)):(r(),i("button",{key:1,class:"btn btn-primary",type:"button",disabled:c.value||A.value,onClick:Oe},p(c.value?"保存中...":"保存产品"),9,Dt))])])]),s("main",Et,[s("div",Ot,[N.value?(r(),i("section",Bt,p(N.value),1)):d("",!0),R.value?(r(),i("section",At,p(R.value),1)):d("",!0),s("section",Lt,[s("div",Vt,[e[17]||(e[17]=ne('<div class="section-title section-title-lg" data-v-79af1c4a><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-79af1c4a><path d="M3 3h7v7H3z" data-v-79af1c4a></path><path d="M14 3h7v7h-7z" data-v-79af1c4a></path><path d="M3 14h7v7H3z" data-v-79af1c4a></path><path d="M14 14h7v7h-7z" data-v-79af1c4a></path></svg> 产品列表 </div>',1)),s("div",$t,[e[16]||(e[16]=s("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("circle",{cx:"11",cy:"11",r:"8"}),s("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),$(s("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>te.value=t),class:"form-input",type:"text",placeholder:"搜索产品名称...",onInput:Fe},null,544),[[F,te.value]])])]),ee.value?(r(),i("div",Ft,"加载中...")):(r(),i("div",Nt,[W.value.length===0?(r(),i("div",Rt,"暂无产品")):(r(),i("div",qt,[(r(!0),i(ie,null,re(W.value,t=>(r(),i("div",{key:t.id,class:"product-card"},[s("div",zt,[s("img",{src:t.original_image_url,alt:t.name},null,8,Ht),t.image_count>1?(r(),i("span",Jt,p(t.image_count)+" 张",1)):d("",!0)]),s("div",Wt,[s("div",Gt,p(t.name),1),s("div",Qt,[t.dimensions?(r(),i("span",Kt,p(t.dimensions),1)):d("",!0),t.image_count>1?(r(),i("span",Xt,"· "+p(t.image_count)+" 张",1)):d("",!0),t.created_at?(r(),i("span",Yt,"· "+p(xe(t.created_at)),1)):d("",!0)]),t.recognition_confidence!==null?(r(),i("div",Zt," AI："+p(Math.round((t.recognition_confidence??0)*100))+"% ",1)):d("",!0),s("div",ea,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:c.value,onClick:n=>Ae(t.id)}," 编辑 ",8,ta),s("button",{class:"btn btn-ghost btn-sm danger",type:"button",disabled:c.value,onClick:n=>Le(t.id)}," 删除 ",8,aa)])])]))),128))])),O.value>x.value?(r(),i("div",sa,[s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:g.value===0||c.value,onClick:Ve}," 上一页 ",8,na),s("span",oa," 第 "+p(Math.floor(g.value/x.value)+1)+" / "+p(Math.max(1,Math.ceil(O.value/x.value)))+" 页（"+p(O.value)+" 条） ",1),s("button",{class:"btn btn-secondary btn-sm",type:"button",disabled:g.value+x.value>=O.value||c.value,onClick:$e}," 下一页 ",8,ia)])):d("",!0)]))])])])])]))}}),la=Qe(ra,[["__scopeId","data-v-79af1c4a"]]);async function ca(){await We(),Ge(la).mount("#app")}ca();
