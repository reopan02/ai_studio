<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>产品库 - Product Library</title>
    <link rel="icon" href="/static/favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .header h1 {
        margin-bottom: 10px;
      }

      .nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .nav-btn {
        padding: 8px 16px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        color: #333;
      }

      .nav-btn:hover {
        background: #f0f0f0;
      }

      .upload-section {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .file-input-wrapper {
        border: 2px dashed #ddd;
        padding: 40px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-input-wrapper:hover {
        border-color: #4CAF50;
        background: #f9f9f9;
      }

      .file-input-wrapper input {
        display: none;
      }

      .preview-section {
        margin-top: 20px;
      }

      .preview-image {
        max-width: 400px;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }

      .form-section {
        margin-top: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .confidence-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
      }

      .confidence-high {
        background: #4CAF50;
        color: white;
      }

      .confidence-medium {
        background: #FFC107;
        color: white;
      }

      .confidence-low {
        background: #F44336;
        color: white;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #4CAF50;
        color: white;
      }

      .btn-primary:hover {
        background: #45a049;
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .product-card {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .product-info {
        padding: 15px;
      }

      .product-name {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .product-dimensions {
        color: #666;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .product-actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-danger {
        background: #F44336;
        color: white;
      }

      .btn-danger:hover {
        background: #da190b;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .success-message {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .search-box {
        margin-bottom: 20px;
      }

      .search-box input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <!-- Header -->
        <div class="header">
          <h1>产品库 Product Library</h1>
          <div class="nav">
            <a href="/video" class="nav-btn">视频生成</a>
            <a href="/image" class="nav-btn">图片编辑</a>
            <a href="/storage" class="nav-btn">存储管理</a>
            <a href="/products" class="nav-btn" style="background: #4CAF50; color: white;">产品库</a>
          </div>
        </div>

        <!-- Error/Success Messages -->
        <div v-if="errorMessage" class="error-message">
          {{ errorMessage }}
          <button @click="errorMessage = ''" style="float: right; background: none; border: none; cursor: pointer;">✕</button>
        </div>
        <div v-if="successMessage" class="success-message">
          {{ successMessage }}
          <button @click="successMessage = ''" style="float: right; background: none; border: none; cursor: pointer;">✕</button>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
          <h2>上传产品图片</h2>
          <div class="file-input-wrapper" @click="$refs.fileInput.click()">
            <input
              ref="fileInput"
              type="file"
              accept="image/*"
              @change="handleFileSelect"
            />
            <p v-if="!selectedFile">点击或拖拽图片到此处上传</p>
            <p v-else>已选择: {{ selectedFile.name }}</p>
          </div>

          <!-- Image Preview and Form -->
          <div v-if="previewUrl" class="preview-section">
            <h3>图片预览</h3>
            <img :src="previewUrl" alt="Preview" class="preview-image" />

            <div class="form-section" v-if="recognitionResult">
              <h3>
                AI识别结果
                <span :class="['confidence-badge', confidenceClass]">
                  置信度: {{ (recognitionResult.confidence * 100).toFixed(0) }}%
                </span>
              </h3>

              <div class="form-group">
                <label>产品名称</label>
                <input v-model="productData.name" type="text" placeholder="产品名称" />
              </div>

              <div class="form-group">
                <label>尺寸规格</label>
                <input v-model="productData.dimensions" type="text" placeholder="例如: 350ml" />
              </div>

              <div class="form-group">
                <label>功能特征</label>
                <textarea v-model="featuresText" placeholder="每行一个特征,例如:\n24小时保温\n不锈钢内胆"></textarea>
              </div>

              <div class="form-group">
                <label>产品特点</label>
                <textarea v-model="characteristicsText" placeholder="每行一个特点,例如:\n便携\n大容量"></textarea>
              </div>

              <button
                @click="uploadProduct"
                :disabled="uploading"
                class="btn btn-primary"
              >
                {{ uploading ? '上传中...' : '保存到产品库' }}
              </button>
            </div>
            <div v-else class="form-section">
              <p>正在进行AI识别...</p>
            </div>
          </div>
        </div>

        <!-- Products List -->
        <div>
          <h2>我的产品</h2>

          <div class="search-box">
            <input
              v-model="searchQuery"
              @input="searchProducts"
              type="text"
              placeholder="搜索产品名称..."
            />
          </div>

          <div v-if="loading" class="loading">加载中...</div>

          <div v-else class="products-grid">
            <div v-for="product in products" :key="product.id" class="product-card">
              <img :src="'/static' + product.original_image_url" :alt="product.name" class="product-image" />
              <div class="product-info">
                <div class="product-name">{{ product.name }}</div>
                <div class="product-dimensions" v-if="product.dimensions">{{ product.dimensions }}</div>
                <div v-if="product.recognition_confidence !== null">
                  <span :class="['confidence-badge', getConfidenceClass(product.recognition_confidence)]">
                    AI: {{ (product.recognition_confidence * 100).toFixed(0) }}%
                  </span>
                </div>
                <div class="product-actions">
                  <button @click="deleteProduct(product.id)" class="btn btn-small btn-danger">
                    删除
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div v-if="!loading && products.length === 0" class="loading">
            暂无产品,请上传第一个产品
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            selectedFile: null,
            previewUrl: null,
            recognitionResult: null,
            productData: {
              name: '',
              dimensions: '',
            },
            featuresText: '',
            characteristicsText: '',
            uploading: false,
            loading: false,
            products: [],
            searchQuery: '',
            errorMessage: '',
            successMessage: '',
          };
        },
        computed: {
          confidenceClass() {
            if (!this.recognitionResult) return '';
            const conf = this.recognitionResult.confidence;
            if (conf >= 0.7) return 'confidence-high';
            if (conf >= 0.5) return 'confidence-medium';
            return 'confidence-low';
          }
        },
        mounted() {
          this.loadProducts();
        },
        methods: {
          handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            this.selectedFile = file;
            this.previewUrl = URL.createObjectURL(file);
            this.recognizeProduct(file);
          },

          async recognizeProduct(file) {
            // For simplicity, we'll let the backend handle recognition
            // Just prepare form data
            this.recognitionResult = {
              name: '产品',
              dimensions: '',
              features: [],
              characteristics: [],
              confidence: 0.0
            };
            this.productData.name = '产品';
            this.productData.dimensions = '';
            this.featuresText = '';
            this.characteristicsText = '';
          },

          async uploadProduct() {
            if (!this.selectedFile) {
              this.errorMessage = '请先选择图片';
              return;
            }

            this.uploading = true;
            this.errorMessage = '';

            try {
              const formData = new FormData();
              formData.append('image', this.selectedFile);

              if (this.productData.name) {
                formData.append('name', this.productData.name);
              }
              if (this.productData.dimensions) {
                formData.append('dimensions', this.productData.dimensions);
              }

              const features = this.featuresText.split('\n').filter(f => f.trim());
              if (features.length > 0) {
                formData.append('features', JSON.stringify(features));
              }

              const characteristics = this.characteristicsText.split('\n').filter(c => c.trim());
              if (characteristics.length > 0) {
                formData.append('characteristics', JSON.stringify(characteristics));
              }

              const response = await fetch('/api/v1/products', {
                method: 'POST',
                body: formData,
              });

              if (response.ok) {
                this.successMessage = '产品上传成功!';
                this.selectedFile = null;
                this.previewUrl = null;
                this.recognitionResult = null;
                this.productData = { name: '', dimensions: '' };
                this.featuresText = '';
                this.characteristicsText = '';
                this.$refs.fileInput.value = '';
                await this.loadProducts();
              } else {
                const error = await response.json();
                this.errorMessage = error.detail?.message || error.detail || '上传失败';
              }
            } catch (error) {
              this.errorMessage = '上传失败: ' + error.message;
            } finally {
              this.uploading = false;
            }
          },

          async loadProducts() {
            this.loading = true;
            try {
              const url = this.searchQuery
                ? `/api/v1/products?name=${encodeURIComponent(this.searchQuery)}`
                : '/api/v1/products';

              const response = await fetch(url);
              if (response.ok) {
                const data = await response.json();
                this.products = data.products;
              } else {
                this.errorMessage = '加载产品列表失败';
              }
            } catch (error) {
              this.errorMessage = '加载失败: ' + error.message;
            } finally {
              this.loading = false;
            }
          },

          async searchProducts() {
            // Debounce search
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
              this.loadProducts();
            }, 300);
          },

          async deleteProduct(productId) {
            if (!confirm('确定要删除这个产品吗?删除后将释放存储空间。')) {
              return;
            }

            try {
              const response = await fetch(`/api/v1/products/${productId}`, {
                method: 'DELETE',
              });

              if (response.ok || response.status === 204) {
                this.successMessage = '产品已删除';
                await this.loadProducts();
              } else {
                this.errorMessage = '删除失败';
              }
            } catch (error) {
              this.errorMessage = '删除失败: ' + error.message;
            }
          },

          getConfidenceClass(confidence) {
            if (confidence >= 0.7) return 'confidence-high';
            if (confidence >= 0.5) return 'confidence-medium';
            return 'confidence-low';
          }
        }
      }).mount('#app');
    </script>
  </body>
</html>
