<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Edit API - Professional Studio</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #cbd5e1;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 360px 1fr;
            grid-template-rows: auto 1fr auto;
            min-height: calc(100vh - 69px);
            gap: 0;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            grid-row: 1 / -1;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title svg {
            width: 16px;
            height: 16px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-wrapper .toggle-visibility:hover {
            color: var(--text-primary);
        }

        .input-wrapper .form-input {
            padding-right: 40px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-primary:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Select */
        .form-select {
            width: 100%;
            padding: 10px 36px 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: var(--transition);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Search Input */
        .search-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .search-wrapper svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .search-wrapper .form-input {
            padding-left: 38px;
        }

        /* Image Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--text-muted);
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .upload-text strong {
            color: var(--primary);
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Image Preview Grid */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .image-preview-item.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .image-preview-item:hover .remove-btn {
            opacity: 1;
        }

        .image-preview-item .edit-indicator {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Edit Mask Button */
        .edit-mask-btn {
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .edit-mask-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .edit-mask-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Mask Editor Modal */
        .mask-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 20px;
        }

        .mask-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .mask-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: var(--transition);
        }

        .mask-modal-overlay.show .mask-modal {
            transform: scale(1);
        }

        .mask-modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
        }

        .mask-modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mask-modal-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .mask-modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .mask-modal-body {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .canvas-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid var(--border);
        }

        .tool-group:last-child {
            border-right: none;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .tool-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .tool-btn.active {
            background: var(--primary);
            color: white;
        }

        .brush-size-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 2px;
            outline: none;
        }

        .brush-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .color-picker-wrapper {
            position: relative;
        }

        .color-picker {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            padding: 0;
        }

        .canvas-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a2e;
            flex: 1;
            min-height: 400px;
            overflow: auto;
        }

        .canvas-wrapper {
            position: relative;
            transform-origin: center center;
            transition: transform 0.1s ease;
        }

        .canvas-container canvas {
            display: block;
            cursor: crosshair;
        }

        /* Canvas Zoom Controls */
        .canvas-zoom-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }

        .canvas-zoom-level {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 45px;
            text-align: center;
        }

        /* Save Mask Button */
        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .mask-modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            justify-content: flex-end;
        }

        .mask-modal-footer .btn {
            padding: 12px 24px;
        }



        /* Image Preview Modal */
        .image-preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 20px;
        }

        .image-preview-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .image-preview-container {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .image-preview-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius-md);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .image-preview-close {
            position: absolute;
            top: -50px;
            right: 0;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .image-preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .image-preview-close svg {
            width: 24px;
            height: 24px;
        }

        .image-preview-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-align: center;
        }

        /* Prompt Area */
        .main-prompt-section {
            padding: 24px 40px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .prompt-input-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .prompt-input-wrapper {
            flex: 1;
            position: relative;
        }

        .prompt-textarea {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
            transition: var(--transition);
            min-height: 100px;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .generate-btn-large {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            min-width: 160px;
            height: fit-content;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
        }

        .generate-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .generate-btn-large:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .generate-btn-large svg {
            width: 20px;
            height: 20px;
        }

        .prompt-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .char-count {
            font-size: 12px;
            color: var(--text-muted);
        }

        .prompt-history-btn {
            font-size: 12px;
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .prompt-history-btn:hover {
            text-decoration: underline;
        }

        /* Prompt History Dropdown */
        .prompt-history-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .prompt-history-dropdown.show {
            display: block;
        }

        .prompt-history-item {
            padding: 10px 12px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .prompt-history-item:last-child {
            border-bottom: none;
        }

        .prompt-history-item:hover {
            background: var(--bg-tertiary);
        }

        .prompt-history-item .prompt-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

	        .prompt-history-item .prompt-time {
	            font-size: 11px;
	            color: var(--text-muted);
	            white-space: nowrap;
	        }

	        .prompt-history-actions {
	            display: flex;
	            align-items: center;
	            gap: 8px;
	            flex-shrink: 0;
	        }

	        .prompt-history-delete {
	            width: 18px;
	            height: 18px;
	            border-radius: 50%;
	            background: rgba(0, 0, 0, 0.6);
	            border: none;
	            cursor: pointer;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            opacity: 0;
	            transition: var(--transition);
	        }

	        .prompt-history-item:hover .prompt-history-delete {
	            opacity: 1;
	        }

	        .prompt-history-delete:hover {
	            background: var(--error);
	        }

	        .prompt-history-delete svg {
	            width: 10px;
	            height: 10px;
	            color: white;
	        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        /* Result Area */
        .result-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            min-height: 400px;
        }

        .result-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .result-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .result-placeholder h3 {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .result-placeholder p {
            font-size: 14px;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-state p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 12px auto 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Result Image */
        .result-image-container {
            position: relative;
            max-width: 100%;
            max-height: calc(100vh - 300px);
        }

        .result-image-container img {
            max-width: 100%;
            max-height: calc(100vh - 300px);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
        }

        .zoom-level {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: center;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
            transform: scale(0.9);
            transition: var(--transition);
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 69px;
            bottom: 0;
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 90;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .history-panel.show {
            right: 0;
        }

        .history-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

	        .history-item {
	            position: relative;
	            display: flex;
	            gap: 12px;
	            padding: 12px 40px 12px 12px;
	            border-radius: var(--radius-sm);
	            cursor: pointer;
	            margin-bottom: 8px;
	            border: 1px solid transparent;
	            transition: var(--transition);
	        }

	        .history-item:hover {
	            background: var(--bg-tertiary);
	            border-color: var(--border);
	        }

	        .history-item-delete {
	            position: absolute;
	            top: 8px;
	            right: 8px;
	            width: 24px;
	            height: 24px;
	            border-radius: 50%;
	            background: rgba(0, 0, 0, 0.6);
	            border: none;
	            cursor: pointer;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            opacity: 0;
	            transition: var(--transition);
	        }

	        .history-item:hover .history-item-delete {
	            opacity: 1;
	        }

	        .history-item-delete:hover {
	            background: var(--error);
	        }

	        .history-item-delete svg {
	            width: 14px;
	            height: 14px;
	            color: white;
	        }

        .history-item-image {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
        }

        .history-item-content {
            flex: 1;
            overflow: hidden;
        }

        .history-item-prompt {
            font-size: 13px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .status-dot.error {
            background: var(--error);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                grid-row: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-section {
                padding: 16px;
            }

            .result-area {
                min-height: 300px;
                padding: 20px;
            }

            .drawing-history-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 16px;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 12px 16px;
            }

            .logo {
                font-size: 16px;
            }

            .prompt-input-row {
                flex-direction: column;
            }

            .generate-btn-large {
                width: 100%;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }

            .mask-modal {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }

            .drawing-history-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }

            .image-preview-overlay {
                padding: 10px;
            }

            .image-preview-close {
                top: 10px;
                right: 10px;
            }

            .image-preview-img {
                max-height: 70vh;
            }
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collapsible-header .chevron {
            transition: transform 0.2s;
        }

        .collapsible-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
        }

        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .status-badge.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-badge.generating {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Image zoom overlay */
        .image-zoom-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .image-zoom-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .image-zoom-overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-zoom-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
            </div>
            <span>Image Edit Studio</span>
        </div>
        <div class="header-actions">
            <a href="/" class="btn btn-secondary" style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                返回主页面
            </a>
            <button class="btn btn-ghost btn-icon" id="historyBtn" title="History">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </button>
            <button class="btn btn-ghost btn-icon" id="settingsBtn" title="Settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Config Section -->
            <section class="sidebar-section">
                <div class="section-title collapsible-header" data-target="configContent">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4"/>
                        </svg>
                        API Configuration
                    </span>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="collapsible-content" id="configContent">
                    <div style="padding-top: 16px;">
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <div class="input-wrapper">
                                <input type="password" class="form-input" id="apiKey" placeholder="Enter your API key">
                                <button class="toggle-visibility" data-target="apiKey">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base URL</label>
                            <div class="input-wrapper">
                                <input type="password" class="form-input" id="baseUrl" placeholder="https://api.example.com">
                                <button class="toggle-visibility" data-target="baseUrl">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 16px;">
                            <button class="btn btn-primary" id="saveConfigBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Save
                            </button>
                            <button class="btn btn-secondary" id="resetConfigBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"/>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                </svg>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Model Selection -->
            <section class="sidebar-section">
                <div class="section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                        <polyline points="2 17 12 22 22 17"/>
                        <polyline points="2 12 12 17 22 12"/>
                    </svg>
                    Model Selection
                </div>
                <div class="search-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" class="form-input" id="modelSearch" placeholder="Search models...">
                </div>
                <select class="form-select" id="modelSelect">
                    <option value="gpt-image-1.5">gpt-image-1.5</option>
                    <option value="nano-banana-2-4k">nano-banana-2-4k</option>
                    <option value="nano-banana-2-2k">nano-banana-2-2k</option>
                    <option value="nano-banana-2">nano-banana-2</option>
                    <option value="nano-banana">nano-banana</option>
                </select>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Aspect Ratio</label>
                    <select class="form-select" id="aspectRatio">
                        <option value="">Auto</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="9:16">9:16 (Portrait)</option>
                        <option value="4:3">4:3</option>
                        <option value="3:4">3:4</option>
                        <option value="3:2">3:2</option>
                        <option value="2:3">2:3</option>
                        <option value="4:5">4:5</option>
                        <option value="5:4">5:4</option>
                        <option value="21:9">21:9 (Ultrawide)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Image Size</label>
                    <select class="form-select" id="imageSize">
                        <option value="">Default</option>
                        <option value="1K">1K</option>
                        <option value="2K">2K</option>
                        <option value="4K">4K</option>
                    </select>
                </div>
            </section>

            <!-- Image Upload -->
            <section class="sidebar-section">
                <div class="section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Reference Images
                </div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept="image/*" multiple>
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <p class="upload-text"><strong>Click to upload</strong> or drag and drop</p>
                    <p class="upload-hint">PNG, JPG, WEBP up to 10MB</p>
                </div>
                <div class="image-preview-grid" id="imagePreviewGrid"></div>

                <!-- Edit Mask Button -->
                <button class="edit-mask-btn" id="editMaskBtn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/>
                        <path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"/>
                    </svg>
                    Edit Mask
                </button>
            </section>


        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="result-area" id="resultArea">
                <div class="result-placeholder" id="resultPlaceholder">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <h3>Ready to Create</h3>
                    <p>Upload reference images, enter a prompt, and click Generate</p>
                </div>

                <div class="loading-state" id="loadingState" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating your image...</p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>

                <div id="resultContainer" style="display: none;">
                    <div class="result-image-container">
                        <img id="resultImage" src="" alt="Generated image">
                    </div>
                    <div class="result-actions">
                        <div class="zoom-controls">
                            <button class="btn btn-ghost btn-icon" id="zoomOutBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    <line x1="8" y1="11" x2="14" y2="11"/>
                                </svg>
                            </button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="btn btn-ghost btn-icon" id="zoomInBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    <line x1="11" y1="8" x2="11" y2="14"/>
                                    <line x1="8" y1="11" x2="14" y2="11"/>
                                </svg>
                            </button>
                        </div>
                        <button class="btn btn-secondary" id="downloadBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download
                        </button>
                        <button class="btn btn-secondary" id="shareBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            Share
                        </button>
                        <button class="btn btn-secondary" id="fullscreenBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 3 21 3 21 9"/>
                                <polyline points="9 21 3 21 3 15"/>
                                <line x1="21" y1="3" x2="14" y2="10"/>
                                <line x1="3" y1="21" x2="10" y2="14"/>
                            </svg>
                            Fullscreen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prompt Section -->
            <div class="main-prompt-section">
                <div class="prompt-input-row">
                    <div class="prompt-input-wrapper">
                        <textarea class="prompt-textarea" id="promptInput" placeholder="Describe what you want to generate or edit..."></textarea>
                        <div class="prompt-history-dropdown" id="promptHistoryDropdown"></div>
                    </div>
                </div>
                <div class="prompt-footer">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span class="char-count"><span id="charCount">0</span> characters</span>
                        <div class="status-indicator">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText">Ready</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="prompt-history-btn" id="showPromptHistory">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            History
                        </button>
                        <button class="generate-btn-large" id="generateBtn" style="padding: 12px 24px; min-width: 140px; font-size: 15px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            Generate
                        </button>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-preview-overlay" id="imagePreviewOverlay">
        <div class="image-preview-container">
            <button class="image-preview-close" id="closeImagePreview">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <img class="image-preview-img" id="imagePreviewImg" src="" alt="Preview">
            <div class="image-preview-info" id="imagePreviewInfo"></div>
        </div>
    </div>

    <!-- Mask Editor Modal -->
    <div class="mask-modal-overlay" id="maskModalOverlay">
        <div class="mask-modal">
            <div class="mask-modal-header">
                <h3 class="mask-modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/>
                        <path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"/>
                    </svg>
                    Mask Editor
                </h3>
                <button class="mask-modal-close" id="closeMaskModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="mask-modal-body">
                <div class="canvas-toolbar">
                    <div class="tool-group">
                        <button class="tool-btn active" data-tool="brush" title="Brush">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/>
                                <path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-tool="eraser" title="Eraser">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1l10-10c.6-.6 1.5-.6 2.1 0l7 7c.6.6.6 1.5 0 2.1l-9 9"/>
                                <path d="M6 11l8 8"/>
                            </svg>
                        </button>
                    </div>
                    <div class="tool-group">
                        <span style="font-size: 12px; color: var(--text-muted);">Size:</span>
                        <input type="range" class="brush-size-slider" id="brushSize" min="5" max="100" value="20">
                        <span style="font-size: 12px; color: var(--text-muted); min-width: 35px;" id="brushSizeLabel">20px</span>
                    </div>
                    <div class="tool-group">
                        <span style="font-size: 12px; color: var(--text-muted);">Color:</span>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-picker" id="brushColor" value="#ff0000">
                        </div>
                    </div>
                    <div class="tool-group">
                        <button class="tool-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="redoBtn" title="Redo (Ctrl+Shift+Z)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="clearCanvasBtn" title="Clear All">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                    <div class="canvas-zoom-controls">
                        <button class="tool-btn" id="canvasZoomOutBtn" title="Zoom Out">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                <line x1="8" y1="11" x2="14" y2="11"/>
                            </svg>
                        </button>
                        <span class="canvas-zoom-level" id="canvasZoomLevel">100%</span>
                        <button class="tool-btn" id="canvasZoomInBtn" title="Zoom In">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                <line x1="11" y1="8" x2="11" y2="14"/>
                                <line x1="8" y1="11" x2="14" y2="11"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="canvasZoomResetBtn" title="Reset (100%)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="maskCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="mask-modal-footer">
                <button class="btn btn-secondary" id="resetMaskBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"/>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                    Reset
                </button>
                <button class="btn btn-ghost" id="cancelMaskBtn">Cancel</button>
                <button class="btn btn-success" id="saveMaskBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Generation History</h3>
            <button class="btn btn-ghost btn-icon" id="closeHistoryBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="history-list" id="historyList">
            <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>
        </div>
    </div>

    <!-- Image Zoom Overlay -->
    <div class="image-zoom-overlay" id="imageZoomOverlay">
        <button class="image-zoom-close" id="closeZoomBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <img id="zoomImage" src="" alt="Zoomed image">
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const STORAGE_KEYS = {
            apiKey: 'video_api_key',
            baseUrl: 'video_base_url'
        };

        function normalizeApiKey(value) {
            const raw = String(value || '').trim();
            return raw.replace(/^bearer\s+/i, '').trim();
        }

        function getCookie(name) {
            const value = `; ${document.cookie || ''}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function csrfHeaders() {
            const token = getCookie('csrf_token');
            return token ? { 'X-CSRF-Token': token } : {};
        }

        function normalizeApiBaseUrl(value) {
            const raw = String(value || '').trim();
            if (!raw) return null;

            let u;
            try {
                u = new URL(raw);
            } catch {
                throw new Error('Base URL is not a valid URL');
            }

            if (u.protocol !== 'https:') {
                throw new Error('Base URL must use HTTPS');
            }
            if (!u.hostname) {
                throw new Error('Base URL is missing host (e.g. https://api.example.com)');
            }

            return u.origin;
        }

        async function readJsonOrText(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) return await response.json();
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch {
                return text;
            }
        }

        function extractErrorMessage(data, fallback) {
            if (typeof data === 'string') return data;
            if (!data || typeof data !== 'object') return fallback;

            const detail = data.detail ?? data.error ?? data.message;
            if (typeof detail === 'string') return detail;
            try {
                return JSON.stringify(detail ?? data);
            } catch {
                return fallback;
            }
        }

        // ==========================================
        // Application State
        // ==========================================
	        const state = {
	            config: {
	                apiKey: localStorage.getItem(STORAGE_KEYS.apiKey) || localStorage.getItem('apiKey') || '',
	                baseUrl: localStorage.getItem(STORAGE_KEYS.baseUrl) || localStorage.getItem('baseUrl') || ''
	            },
	            images: [],
	            currentImageIndex: -1,
	            prompt: '',
	            promptHistory: (() => {
	                try {
	                    return JSON.parse(localStorage.getItem('promptHistory') || '[]');
	                } catch {
	                    localStorage.removeItem('promptHistory');
	                    return [];
	                }
	            })(),
	            generationHistory: (() => {
	                try {
	                    return JSON.parse(localStorage.getItem('generationHistory') || '[]');
	                } catch {
	                    localStorage.removeItem('generationHistory');
	                    return [];
	                }
	            })(),

	            isGenerating: false,
	            currentZoom: 100,
	            canvasZoom: 100,
	            canvasHistory: [],
            canvasHistoryIndex: -1,
            // High-resolution canvas state
            originalImage: null,
            originalWidth: 0,
            originalHeight: 0,
            displayScale: 1
        };

        // ==========================================
        // DOM Elements
        // ==========================================
        const elements = {
            // Config
            apiKey: document.getElementById('apiKey'),
            baseUrl: document.getElementById('baseUrl'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            resetConfigBtn: document.getElementById('resetConfigBtn'),

            // Model
            modelSelect: document.getElementById('modelSelect'),
            modelSearch: document.getElementById('modelSearch'),
            aspectRatio: document.getElementById('aspectRatio'),
            imageSize: document.getElementById('imageSize'),

            // Upload
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            imagePreviewGrid: document.getElementById('imagePreviewGrid'),
            editMaskBtn: document.getElementById('editMaskBtn'),

            // Mask Modal
            maskModalOverlay: document.getElementById('maskModalOverlay'),
            closeMaskModal: document.getElementById('closeMaskModal'),
            cancelMaskBtn: document.getElementById('cancelMaskBtn'),

            // Canvas
            canvasContainer: document.getElementById('canvasContainer'),
            canvasWrapper: document.getElementById('canvasWrapper'),
            maskCanvas: document.getElementById('maskCanvas'),
            brushSize: document.getElementById('brushSize'),
            brushSizeLabel: document.getElementById('brushSizeLabel'),
            brushColor: document.getElementById('brushColor'),
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            clearCanvasBtn: document.getElementById('clearCanvasBtn'),
            saveMaskBtn: document.getElementById('saveMaskBtn'),
            resetMaskBtn: document.getElementById('resetMaskBtn'),
            canvasZoomInBtn: document.getElementById('canvasZoomInBtn'),
            canvasZoomOutBtn: document.getElementById('canvasZoomOutBtn'),
            canvasZoomResetBtn: document.getElementById('canvasZoomResetBtn'),
            canvasZoomLevel: document.getElementById('canvasZoomLevel'),

            // Prompt
            promptInput: document.getElementById('promptInput'),
            charCount: document.getElementById('charCount'),
            showPromptHistory: document.getElementById('showPromptHistory'),
            promptHistoryDropdown: document.getElementById('promptHistoryDropdown'),



            // Image Preview Modal
            imagePreviewOverlay: document.getElementById('imagePreviewOverlay'),
            imagePreviewImg: document.getElementById('imagePreviewImg'),
            imagePreviewInfo: document.getElementById('imagePreviewInfo'),
            closeImagePreview: document.getElementById('closeImagePreview'),

            // Results
            resultArea: document.getElementById('resultArea'),
            resultPlaceholder: document.getElementById('resultPlaceholder'),
            loadingState: document.getElementById('loadingState'),
            resultContainer: document.getElementById('resultContainer'),
            resultImage: document.getElementById('resultImage'),

            // Controls
            generateBtn: document.getElementById('generateBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            shareBtn: document.getElementById('shareBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            zoomLevel: document.getElementById('zoomLevel'),

            // Status
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),

            // History
            historyBtn: document.getElementById('historyBtn'),
            historyPanel: document.getElementById('historyPanel'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            historyList: document.getElementById('historyList'),

            // Zoom
            imageZoomOverlay: document.getElementById('imageZoomOverlay'),
            zoomImage: document.getElementById('zoomImage'),
            closeZoomBtn: document.getElementById('closeZoomBtn'),

            // Toast
            toastContainer: document.getElementById('toastContainer')
        };

        // ==========================================
        // Canvas Drawing State
        // ==========================================
        let canvasCtx = null;
        let fullResCanvas = null;  // Hidden full-resolution canvas
        let fullResCtx = null;
        let isDrawing = false;
        let currentTool = 'brush';
        let lastX = 0;
        let lastY = 0;

        // ==========================================
        // Utility Functions
        // ==========================================
        function showToast(type, title, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                warning: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
            };

            toast.innerHTML = `
                ${icons[type]}
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `;

            elements.toastContainer.appendChild(toast);

            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function updateStatus(status, text) {
            elements.statusDot.className = 'status-dot ' + status;
            elements.statusText.textContent = text;
        }

        function formatTime(date) {
            return new Intl.DateTimeFormat('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function formatDateTime(date) {
            return new Intl.DateTimeFormat('zh-CN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        // ==========================================
        // Configuration Management
        // ==========================================
        function loadConfig() {
            elements.apiKey.value = state.config.apiKey;
            elements.baseUrl.value = state.config.baseUrl;

            if (state.config.apiKey || state.config.baseUrl) updateStatus('connected', 'Configured');
            else updateStatus('', 'Ready');
        }

        function saveConfig() {
            const apiKey = normalizeApiKey(elements.apiKey.value);
            let baseUrl = null;
            try {
                baseUrl = normalizeApiBaseUrl(elements.baseUrl.value);
            } catch (e) {
                showToast('error', 'Invalid Base URL', e?.message || 'Invalid Base URL');
                return;
            }

            state.config.apiKey = apiKey;
            state.config.baseUrl = baseUrl || '';
            elements.apiKey.value = state.config.apiKey;
            elements.baseUrl.value = state.config.baseUrl;

            localStorage.setItem(STORAGE_KEYS.apiKey, state.config.apiKey);
            localStorage.setItem(STORAGE_KEYS.baseUrl, state.config.baseUrl);
            localStorage.setItem('apiKey', state.config.apiKey);
            localStorage.setItem('baseUrl', state.config.baseUrl);

            if (state.config.apiKey || state.config.baseUrl) {
                updateStatus('connected', 'Configured');
                showToast('success', 'Configuration saved', 'API settings have been saved');
            } else {
                updateStatus('', 'Ready');
                showToast('success', 'Configuration cleared', 'Using server defaults');
            }
        }

        function resetConfig() {
            elements.apiKey.value = '';
            elements.baseUrl.value = '';
            state.config.apiKey = '';
            state.config.baseUrl = '';
            localStorage.removeItem(STORAGE_KEYS.apiKey);
            localStorage.removeItem(STORAGE_KEYS.baseUrl);
            localStorage.removeItem('apiKey');
            localStorage.removeItem('baseUrl');
            updateStatus('', 'Ready');
            showToast('success', 'Configuration reset', 'API settings have been cleared');
        }

        // ==========================================
        // Image Upload & Management
        // ==========================================
        function handleFileSelect(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('error', 'Invalid file type', 'Please upload an image file');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showToast('error', 'File too large', 'Maximum file size is 10MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    state.images.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        originalData: e.target.result,  // Keep original
                        data: e.target.result,          // Current (may have mask)
                        hasMask: false
                    });
                    renderImagePreviews();

                    // Auto-select the first image
                    if (state.images.length === 1) {
                        selectImage(0);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreviews() {
            elements.imagePreviewGrid.innerHTML = state.images.map((img, index) => `
                <div class="image-preview-item ${index === state.currentImageIndex ? 'active' : ''}" data-index="${index}">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="remove-btn" data-index="${index}">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    ${img.hasMask ? '<span class="edit-indicator">Mask</span>' : ''}
                </div>
            `).join('');

            // Add event listeners
            elements.imagePreviewGrid.querySelectorAll('.image-preview-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.remove-btn')) {
                        selectImage(parseInt(item.dataset.index));
                    }
                });
            });

            elements.imagePreviewGrid.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeImage(parseInt(btn.dataset.index));
                });
            });

            // Update edit mask button state
            updateEditMaskButtonState();
        }

        function updateEditMaskButtonState() {
            elements.editMaskBtn.disabled = state.images.length === 0 || state.currentImageIndex < 0;
        }

        function selectImage(index) {
            state.currentImageIndex = index;
            renderImagePreviews();
        }

        function removeImage(index) {
            state.images.splice(index, 1);
            if (state.currentImageIndex >= state.images.length) {
                state.currentImageIndex = state.images.length - 1;
            }
            renderImagePreviews();
        }

        // ==========================================
        // Mask Modal Functions
        // ==========================================
        function openMaskModal() {
            if (state.currentImageIndex < 0 || !state.images[state.currentImageIndex]) {
                showToast('warning', 'No image selected', 'Please select an image first');
                return;
            }
            elements.maskModalOverlay.classList.add('show');
            // Initialize canvas after modal is visible
            setTimeout(() => {
                initCanvas();
            }, 100);
        }

        function closeMaskModal() {
            elements.maskModalOverlay.classList.remove('show');
        }

        // ==========================================
        // High-Precision Canvas Drawing
        // ==========================================
        function initCanvas() {
            if (state.currentImageIndex < 0 || !state.images[state.currentImageIndex]) {
                return;
            }

            state.canvasZoom = 100;
            updateCanvasZoomLevel();

            const img = new Image();
            img.onload = () => {
                // Store original dimensions
                state.originalWidth = img.width;
                state.originalHeight = img.height;
                state.originalImage = img;

                // Create hidden full-resolution canvas for actual drawing
                fullResCanvas = document.createElement('canvas');
                fullResCanvas.width = img.width;
                fullResCanvas.height = img.height;
                fullResCtx = fullResCanvas.getContext('2d');
                fullResCtx.drawImage(img, 0, 0);

                // Calculate display size (fit within modal container)
                const containerWidth = elements.canvasContainer.clientWidth - 40;
                const containerHeight = elements.canvasContainer.clientHeight - 40 || 500;

                let displayWidth = img.width;
                let displayHeight = img.height;

                // Scale to fit
                const scaleX = containerWidth / img.width;
                const scaleY = containerHeight / img.height;
                state.displayScale = Math.min(scaleX, scaleY, 1); // Don't upscale

                displayWidth = Math.floor(img.width * state.displayScale);
                displayHeight = Math.floor(img.height * state.displayScale);

                // Set display canvas size
                const canvas = elements.maskCanvas;
                canvas.width = displayWidth;
                canvas.height = displayHeight;
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';

                canvasCtx = canvas.getContext('2d');
                canvasCtx.imageSmoothingEnabled = true;
                canvasCtx.imageSmoothingQuality = 'high';

                // Draw scaled image
                canvasCtx.drawImage(img, 0, 0, displayWidth, displayHeight);

                // Reset history
                state.canvasHistory = [{
                    display: canvas.toDataURL(),
                    fullRes: fullResCanvas.toDataURL()
                }];
                state.canvasHistoryIndex = 0;
            };

            // Use current data (which may already have mask applied)
            img.src = state.images[state.currentImageIndex].data;
        }

        function getCanvasCoordinates(e) {
            const rect = elements.maskCanvas.getBoundingClientRect();
            const scaleX = elements.maskCanvas.width / rect.width;
            const scaleY = elements.maskCanvas.height / rect.height;

            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            if (!canvasCtx || !fullResCtx) return;
            isDrawing = true;
            const coords = getCanvasCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            if (!isDrawing || !canvasCtx || !fullResCtx) return;

            const coords = getCanvasCoordinates(e);
            const x = coords.x;
            const y = coords.y;

            // Get brush settings
            const brushSize = parseInt(elements.brushSize.value);
            const color = elements.brushColor.value;

            // Draw on display canvas
            drawLine(canvasCtx, lastX, lastY, x, y, brushSize, color, currentTool === 'eraser');

            // Draw on full-resolution canvas (scale coordinates)
            const fullResLastX = lastX / state.displayScale;
            const fullResLastY = lastY / state.displayScale;
            const fullResX = x / state.displayScale;
            const fullResY = y / state.displayScale;
            const fullResBrushSize = brushSize / state.displayScale;

            drawLine(fullResCtx, fullResLastX, fullResLastY, fullResX, fullResY, fullResBrushSize, color, currentTool === 'eraser');

            lastX = x;
            lastY = y;
        }

        function drawLine(ctx, x1, y1, x2, y2, size, color, isEraser) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (isEraser) {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
            }

            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over';
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveCanvasState();

                // Mark image as having unsaved changes
                if (state.currentImageIndex >= 0 && state.images[state.currentImageIndex]) {
                    state.images[state.currentImageIndex].hasMask = true;
                    renderImagePreviews();
                }
            }
        }

        function saveCanvasState() {
            if (!elements.maskCanvas || !fullResCanvas) return;

            state.canvasHistoryIndex++;
            state.canvasHistory = state.canvasHistory.slice(0, state.canvasHistoryIndex);
            state.canvasHistory.push({
                display: elements.maskCanvas.toDataURL(),
                fullRes: fullResCanvas.toDataURL()
            });

            // Limit history size
            if (state.canvasHistory.length > 50) {
                state.canvasHistory.shift();
                state.canvasHistoryIndex--;
            }
        }

        function undo() {
            if (state.canvasHistoryIndex > 0) {
                state.canvasHistoryIndex--;
                loadCanvasState();
            }
        }

        function redo() {
            if (state.canvasHistoryIndex < state.canvasHistory.length - 1) {
                state.canvasHistoryIndex++;
                loadCanvasState();
            }
        }

        function loadCanvasState() {
            const historyItem = state.canvasHistory[state.canvasHistoryIndex];
            if (!historyItem) return;

            // Load display canvas
            const displayImg = new Image();
            displayImg.onload = () => {
                canvasCtx.clearRect(0, 0, elements.maskCanvas.width, elements.maskCanvas.height);
                canvasCtx.drawImage(displayImg, 0, 0);
            };
            displayImg.src = historyItem.display;

            // Load full-res canvas
            const fullResImg = new Image();
            fullResImg.onload = () => {
                fullResCtx.clearRect(0, 0, fullResCanvas.width, fullResCanvas.height);
                fullResCtx.drawImage(fullResImg, 0, 0);
            };
            fullResImg.src = historyItem.fullRes;
        }

        function clearCanvas() {
            if (state.currentImageIndex >= 0 && state.images[state.currentImageIndex]) {
                // Reset to original image
                state.images[state.currentImageIndex].data = state.images[state.currentImageIndex].originalData;
                state.images[state.currentImageIndex].hasMask = false;
                initCanvas();
                renderImagePreviews();
            }
        }

        // ==========================================
        // Save Mask - Apply mask to image
        // ==========================================
        function saveMask() {
            if (!fullResCanvas || state.currentImageIndex < 0) {
                showToast('warning', 'No mask to save', 'Please draw on the image first');
                return;
            }

            // Get the full-resolution masked image
            const maskedImageData = fullResCanvas.toDataURL('image/png');

            // Update the current image data
            state.images[state.currentImageIndex].data = maskedImageData;
            state.images[state.currentImageIndex].hasMask = true;

            // Save to drawing history
            saveToDrawingHistory(maskedImageData);

            // Update preview
            renderImagePreviews();

            // Close the modal
            closeMaskModal();

            showToast('success', 'Mask saved', 'The mask has been applied to the image');
        }

        function resetMask() {
            if (state.currentImageIndex >= 0 && state.images[state.currentImageIndex]) {
                state.images[state.currentImageIndex].data = state.images[state.currentImageIndex].originalData;
                state.images[state.currentImageIndex].hasMask = false;
                initCanvas();
                renderImagePreviews();
                showToast('success', 'Mask reset', 'Image restored to original');
            }
        }

        // ==========================================
        // Canvas Zoom Controls
        // ==========================================
        function updateCanvasZoomLevel() {
            elements.canvasZoomLevel.textContent = `${state.canvasZoom}%`;
            elements.canvasWrapper.style.transform = `scale(${state.canvasZoom / 100})`;
        }

        function canvasZoomIn() {
            if (state.canvasZoom < 300) {
                state.canvasZoom += 25;
                updateCanvasZoomLevel();
            }
        }

        function canvasZoomOut() {
            if (state.canvasZoom > 50) {
                state.canvasZoom -= 25;
                updateCanvasZoomLevel();
            }
        }

        function canvasZoomReset() {
            state.canvasZoom = 100;
            updateCanvasZoomLevel();
        }

	        // ==========================================
	        // API Integration for Image Repository
	        // ==========================================

	        function getCookie(name) {
	            const value = `; ${document.cookie}`;
	            const parts = value.split(`; ${name}=`);
	            if (parts.length === 2) return parts.pop().split(';').shift();
	            return null;
	        }

	        function csrfHeaders() {
	            const token = getCookie('csrf_token');
	            return token ? { 'X-CSRF-Token': token } : {};
	        }

	        async function checkAuthentication() {
	            try {
	                const res = await fetch('/api/v1/auth/me', { credentials: 'include' });
	                if (!res.ok) {
	                    window.location.href = '/login?next=/image';
	                    return false;
	                }
	                return true;
	            } catch (err) {
	                console.error('Authentication check failed:', err);
	                window.location.href = '/login?next=/image';
	                return false;
	            }
	        }

	        async function loadImagesFromRepository() {
	            try {
	                const res = await fetch('/api/v1/images?limit=50', { credentials: 'include' });
	                if (!res.ok) {
	                    if (res.status === 401) {
	                        window.location.href = '/login?next=/image';
	                        return;
	                    }
	                    throw new Error('Failed to load images');
	                }

	                const images = await res.json();
                // state.drawingHistory = images.map(img => ({ ... })); // Removed
                /*
	                state.drawingHistory = images.map(img => ({
	                    id: img.id,
	                    imageUrl: img.image_url,
	                    thumbnail: img.image_url,
	                    time: img.created_at,
	                    model: img.model,
	                    prompt: img.prompt,
	                    title: img.title
	                }));
                */

	                // renderDrawingHistory(); // Removed
	            } catch (err) {
	                console.error('Failed to load images from repository:', err);
	                showToast('error', 'Load failed', err.message || 'Failed to load images from repository');
	            }
	        }

	        async function saveImageToRepository(imageUrl, model, prompt) {
	            if (!imageUrl) {
	                console.warn('No image URL to save');
	                return null;
	            }

	            try {
	                const payload = {
	                    image_url: imageUrl,
	                    model: model || 'unknown',
	                    prompt: prompt || '',
	                    status: 'completed',
	                    title: null
	                };

	                const res = await fetch('/api/v1/images', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        ...csrfHeaders()
	                    },
	                    credentials: 'include',
	                    body: JSON.stringify(payload)
	                });

	                if (!res.ok) {
	                    if (res.status === 413) {
	                        showToast('error', '存储空间不足', 'Storage quota exceeded');
	                        return null;
	                    }
	                    const errorText = await res.text();
	                    throw new Error(errorText || 'Failed to save image');
	                }

	                const savedImage = await res.json();
	                showToast('success', '保存成功', 'Image saved to repository');

	                // Reload images from repository
	                await loadImagesFromRepository();

	                return savedImage;
	            } catch (err) {
	                console.error('Failed to save image to repository:', err);
	                showToast('error', '保存失败', err.message || 'Failed to save image');
	                return null;
	            }
	        }

	        async function deleteImageFromRepository(imageId) {
	            if (!confirm('确定要删除这条记录吗？')) return;

	            try {
	                const res = await fetch(`/api/v1/images/${encodeURIComponent(imageId)}`, {
	                    method: 'DELETE',
	                    headers: csrfHeaders(),
	                    credentials: 'include'
	                });

	                if (!res.ok) {
	                    throw new Error('Failed to delete image');
	                }

	                showToast('success', '删除成功', 'Image deleted from repository');

	                // Reload images from repository
	                await loadImagesFromRepository();
	            } catch (err) {
	                console.error('Failed to delete image from repository:', err);
	                showToast('error', '删除失败', err.message || 'Failed to delete image');
	            }
	        }



	        // Show image preview modal
	        function showImagePreview(imageUrl, date) {
	            elements.imagePreviewImg.src = imageUrl;
	            elements.imagePreviewInfo.textContent = `生成时间: ${date}`;
	            elements.imagePreviewOverlay.classList.add('show');
	        }

	        // Close image preview modal
	        function closeImagePreview() {
	            elements.imagePreviewOverlay.classList.remove('show');
	            setTimeout(() => {
	                elements.imagePreviewImg.src = '';
	            }, 300);
	        }

	        function formatTime(date) {
	            const now = new Date();
	            const diff = now - date;
	            const seconds = Math.floor(diff / 1000);
	            const minutes = Math.floor(seconds / 60);
	            const hours = Math.floor(minutes / 60);
	            const days = Math.floor(hours / 24);

	            if (days > 0) return `${days}天前`;
	            if (hours > 0) return `${hours}小时前`;
	            if (minutes > 0) return `${minutes}分钟前`;
	            return '刚刚';
	        }

	        // ==========================================
	        // Prompt Management
	        // ==========================================
        function updateCharCount() {
            const count = elements.promptInput.value.length;
            elements.charCount.textContent = count;
        }

	        function savePromptToHistory(prompt) {
	            if (!prompt.trim()) return;

	            // Remove duplicates
	            state.promptHistory = state.promptHistory.filter(p => p.text !== prompt);

            // Add new prompt
            state.promptHistory.unshift({
                text: prompt,
                time: new Date().toISOString()
            });

	            // Keep only last 20
	            state.promptHistory = state.promptHistory.slice(0, 20);

	            try {
	                localStorage.setItem('promptHistory', JSON.stringify(state.promptHistory));
	            } catch (err) {
	                console.warn('Failed to persist prompt history:', err);
	            }
	        }

	        function renderPromptHistory() {
	            if (state.promptHistory.length === 0) {
	                elements.promptHistoryDropdown.innerHTML = '<p style="padding: 12px; text-align: center; color: var(--text-muted);">No history yet</p>';
	                return;
	            }

	            elements.promptHistoryDropdown.innerHTML = state.promptHistory.map((item, index) => `
	                <div class="prompt-history-item" data-index="${index}">
	                    <span class="prompt-text">${item.text}</span>
	                    <div class="prompt-history-actions">
	                        <span class="prompt-time">${formatTime(new Date(item.time))}</span>
	                        <button class="prompt-history-delete" data-index="${index}" title="Delete">
	                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M18 6L6 18M6 6l12 12"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `).join('');

	            elements.promptHistoryDropdown.querySelectorAll('.prompt-history-item').forEach(item => {
	                item.addEventListener('click', (e) => {
	                    if (e.target.closest('.prompt-history-delete')) return;
	                    elements.promptInput.value = state.promptHistory[parseInt(item.dataset.index)].text;
	                    updateCharCount();
	                    elements.promptHistoryDropdown.classList.remove('show');
	                });
	            });

	            elements.promptHistoryDropdown.querySelectorAll('.prompt-history-delete').forEach(btn => {
	                btn.addEventListener('click', (e) => {
	                    e.stopPropagation();
	                    deletePromptHistoryItem(parseInt(btn.dataset.index));
	                });
	            });
	        }

	        function deletePromptHistoryItem(index) {
	            if (Number.isNaN(index) || index < 0 || index >= state.promptHistory.length) return;

	            state.promptHistory.splice(index, 1);
	            try {
	                localStorage.setItem('promptHistory', JSON.stringify(state.promptHistory));
	            } catch (err) {
	                console.warn('Failed to persist prompt history:', err);
	            }
	            renderPromptHistory();
	            showToast('success', 'Deleted', 'Prompt history item removed');
	        }

        // ==========================================
        // Generation History
        // ==========================================
	        function saveToGenerationHistory(prompt, imageUrl) {
	            state.generationHistory.unshift({
	                prompt,
	                imageUrl,
	                model: elements.modelSelect.value,
	                time: new Date().toISOString()
	            });

	            // Keep only last 50
	            state.generationHistory = state.generationHistory.slice(0, 50);
	            try {
	                localStorage.setItem('generationHistory', JSON.stringify(state.generationHistory));
	            } catch (err) {
	                console.warn('Failed to persist generation history:', err);
	            }
	            renderGenerationHistory();
	        }

	        function renderGenerationHistory() {
	            if (state.generationHistory.length === 0) {
                elements.historyList.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No generation history yet</p>';
                return;
            }

	            elements.historyList.innerHTML = state.generationHistory.map((item, index) => `
	                <div class="history-item" data-index="${index}">
	                    <img class="history-item-image" src="${item.imageUrl}" alt="Generated">
	                    <div class="history-item-content">
	                        <div class="history-item-prompt">${item.prompt}</div>
	                        <div class="history-item-meta">${item.model} - ${formatTime(new Date(item.time))}</div>
	                    </div>
	                    <button class="history-item-delete" data-index="${index}" title="Delete">
	                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M18 6L6 18M6 6l12 12"/>
	                        </svg>
	                    </button>
	                </div>
	            `).join('');

	            elements.historyList.querySelectorAll('.history-item').forEach(item => {
	                item.addEventListener('click', (e) => {
	                    if (e.target.closest('.history-item-delete')) return;
	                    const historyItem = state.generationHistory[parseInt(item.dataset.index)];
	                    showResult(historyItem.imageUrl);
	                    elements.promptInput.value = historyItem.prompt;
	                    updateCharCount();
	                });
	            });

	            elements.historyList.querySelectorAll('.history-item-delete').forEach(btn => {
	                btn.addEventListener('click', (e) => {
	                    e.stopPropagation();
	                    deleteGenerationHistoryItem(parseInt(btn.dataset.index));
	                });
	            });
	        }



        // ==========================================
        // API Call - Fixed to send masked images
        // ==========================================
        async function generateImage() {
            const prompt = elements.promptInput.value.trim();

            // Validation
            if (!prompt) {
                showToast('error', 'Prompt required', 'Please enter a prompt');
                return;
            }

            // Update UI
            state.isGenerating = true;
            elements.generateBtn.disabled = true;
            elements.resultPlaceholder.style.display = 'none';
            elements.resultContainer.style.display = 'none';
            elements.loadingState.style.display = 'block';
            updateStatus('generating', 'Generating...');

            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('model', elements.modelSelect.value);
                formData.append('prompt', prompt);
                formData.append('response_format', 'url');

                if (elements.aspectRatio.value) {
                    formData.append('aspect_ratio', elements.aspectRatio.value);
                }

                if (elements.imageSize.value) {
                    formData.append('image_size', elements.imageSize.value);
                }

                // Add images - use the current data which includes masks
                for (const img of state.images) {
                    // Use img.data which contains the masked version if saved
                    const imageData = img.data;
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    formData.append('image', blob, img.name || 'image.png');
                }

                const apiKey = normalizeApiKey(state.config.apiKey);
                const baseUrl = normalizeApiBaseUrl(state.config.baseUrl);

                // Make API call via backend (/api/v1/images/edits)
                const response = await fetch('/api/v1/images/edits', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        ...csrfHeaders(),
                        ...(apiKey ? { 'X-API-Key': apiKey } : {}),
                        ...(baseUrl ? { 'X-Base-Url': baseUrl } : {}),
                    },
                    body: formData
                });

                if (!response.ok) {
                    const data = await readJsonOrText(response);
                    if (response.status === 401) {
                        window.location.href = '/login?next=/image';
                        return;
                    }
                    throw new Error(extractErrorMessage(data, `Request failed (HTTP ${response.status})`));
                }

                const data = await readJsonOrText(response);
                const result = data && typeof data === 'object' && data.response ? data.response : data;

                // Extract image URL
                let imageUrl = null;
                if (result.data && result.data[0]) {
                    imageUrl = result.data[0].url || result.data[0].b64_json;
                    if (result.data[0].b64_json && !result.data[0].url) {
                        imageUrl = `data:image/png;base64,${result.data[0].b64_json}`;
                    }
                } else if (result.url) {
                    imageUrl = result.url;
                } else if (result.b64_json) {
                    imageUrl = `data:image/png;base64,${result.b64_json}`;
                }

                if (!imageUrl) {
                    throw new Error('No image URL in response');
                }

                // Show result
                showResult(imageUrl);
                savePromptToHistory(prompt);
                saveToGenerationHistory(prompt, imageUrl);
                showToast('success', 'Image generated', 'Your image has been created successfully');

                // Refresh repository to show the newly saved image
                loadImagesFromRepository();

            } catch (error) {
                console.error('Generation error:', error);
                showToast('error', 'Generation failed', error.message);
                elements.loadingState.style.display = 'none';
                elements.resultPlaceholder.style.display = 'block';
                updateStatus('error', 'Error');
            } finally {
                state.isGenerating = false;
                elements.generateBtn.disabled = false;
            }
        }

        function showResult(imageUrl) {
            elements.loadingState.style.display = 'none';
            elements.resultPlaceholder.style.display = 'none';
            elements.resultContainer.style.display = 'block';
            elements.resultImage.src = imageUrl;
            state.currentZoom = 100;
            updateZoomLevel();
            updateStatus('connected', 'Complete');
        }

        // ==========================================
        // Zoom Controls
        // ==========================================
        function updateZoomLevel() {
            elements.zoomLevel.textContent = `${state.currentZoom}%`;
            elements.resultImage.style.transform = `scale(${state.currentZoom / 100})`;
        }

        function zoomIn() {
            if (state.currentZoom < 200) {
                state.currentZoom += 25;
                updateZoomLevel();
            }
        }

        function zoomOut() {
            if (state.currentZoom > 25) {
                state.currentZoom -= 25;
                updateZoomLevel();
            }
        }

        // ==========================================
        // Download & Share
        // ==========================================
        function downloadImage() {
            const imageUrl = elements.resultImage.src;
            if (!imageUrl) return;

            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `generated-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('success', 'Download started', 'Image is being downloaded');
        }

        function shareImage() {
            const imageUrl = elements.resultImage.src;
            if (!imageUrl) return;

            if (navigator.share) {
                navigator.share({
                    title: 'Generated Image',
                    text: elements.promptInput.value,
                    url: imageUrl
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(imageUrl).then(() => {
                    showToast('success', 'Link copied', 'Image URL copied to clipboard');
                });
            }
        }

        function showFullscreen() {
            const imageUrl = elements.resultImage.src;
            if (!imageUrl) return;

            elements.zoomImage.src = imageUrl;
            elements.imageZoomOverlay.classList.add('show');
        }

        // ==========================================
        // Model Search
        // ==========================================
        function filterModels() {
            const search = elements.modelSearch.value.toLowerCase();
            const options = elements.modelSelect.options;

            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? '' : 'none';
            }
        }

        // ==========================================
        // Collapsible Sections
        // ==========================================
        function initCollapsibles() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const target = document.getElementById(header.dataset.target);
                    header.classList.toggle('collapsed');
                    target.classList.toggle('collapsed');
                });
            });
        }

        // ==========================================
        // Toggle Visibility
        // ==========================================
        function initToggleVisibility() {
            document.querySelectorAll('.toggle-visibility').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById(btn.dataset.target);
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    btn.innerHTML = isPassword ?
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' :
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
                });
            });
        }

        // ==========================================
        // Event Listeners
        // ==========================================
        function initEventListeners() {
            // Config
            elements.saveConfigBtn.addEventListener('click', saveConfig);
            elements.resetConfigBtn.addEventListener('click', resetConfig);

            // File upload
            elements.fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('drag-over');
            });
            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.classList.remove('drag-over');
            });
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files);
            });

            // Mask Modal
            elements.editMaskBtn.addEventListener('click', openMaskModal);
            elements.closeMaskModal.addEventListener('click', closeMaskModal);
            elements.cancelMaskBtn.addEventListener('click', closeMaskModal);
            elements.maskModalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.maskModalOverlay) {
                    closeMaskModal();
                }
            });

            // Image Preview Modal
            elements.closeImagePreview.addEventListener('click', closeImagePreview);
            elements.imagePreviewOverlay.addEventListener('click', (e) => {
                if (e.target === elements.imagePreviewOverlay) {
                    closeImagePreview();
                }
            });

            // Canvas mouse events
            elements.maskCanvas.addEventListener('mousedown', startDrawing);
            elements.maskCanvas.addEventListener('mousemove', draw);
            elements.maskCanvas.addEventListener('mouseup', stopDrawing);
            elements.maskCanvas.addEventListener('mouseout', stopDrawing);

            // Touch support for canvas
            elements.maskCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startDrawing({clientX: touch.clientX, clientY: touch.clientY});
            });
            elements.maskCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                draw({clientX: touch.clientX, clientY: touch.clientY});
            });
            elements.maskCanvas.addEventListener('touchend', stopDrawing);

            // Tool buttons
            document.querySelectorAll('[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTool = btn.dataset.tool;
                    document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Brush size
            elements.brushSize.addEventListener('input', () => {
                elements.brushSizeLabel.textContent = elements.brushSize.value + 'px';
            });

            // Undo/Redo/Clear
            elements.undoBtn.addEventListener('click', undo);
            elements.redoBtn.addEventListener('click', redo);
            elements.clearCanvasBtn.addEventListener('click', clearCanvas);

            // Save/Reset Mask
            elements.saveMaskBtn.addEventListener('click', saveMask);
            elements.resetMaskBtn.addEventListener('click', resetMask);

            // Canvas zoom
            elements.canvasZoomInBtn.addEventListener('click', canvasZoomIn);
            elements.canvasZoomOutBtn.addEventListener('click', canvasZoomOut);
            elements.canvasZoomResetBtn.addEventListener('click', canvasZoomReset);

            // Drawing history - removed clearDrawingHistory event (now using API)

            // Prompt
            elements.promptInput.addEventListener('input', updateCharCount);
            elements.showPromptHistory.addEventListener('click', () => {
                renderPromptHistory();
                elements.promptHistoryDropdown.classList.toggle('show');
            });

            // Close prompt history when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.main-prompt-section')) {
                    elements.promptHistoryDropdown.classList.remove('show');
                }
            });

            // Model search
            elements.modelSearch.addEventListener('input', filterModels);

            // Generate
            elements.generateBtn.addEventListener('click', generateImage);

            // Zoom controls
            elements.zoomInBtn.addEventListener('click', zoomIn);
            elements.zoomOutBtn.addEventListener('click', zoomOut);

            // Download/Share
            elements.downloadBtn.addEventListener('click', downloadImage);
            elements.shareBtn.addEventListener('click', shareImage);
            elements.fullscreenBtn.addEventListener('click', showFullscreen);

            // Fullscreen overlay
            elements.closeZoomBtn.addEventListener('click', () => {
                elements.imageZoomOverlay.classList.remove('show');
            });
            elements.imageZoomOverlay.addEventListener('click', (e) => {
                if (e.target === elements.imageZoomOverlay) {
                    elements.imageZoomOverlay.classList.remove('show');
                }
            });

            // History panel
            elements.historyBtn.addEventListener('click', () => {
                elements.historyPanel.classList.toggle('show');
            });
            elements.closeHistoryBtn.addEventListener('click', () => {
                elements.historyPanel.classList.remove('show');
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        generateImage();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        saveMask();
                    }
                }

                if (e.key === 'Escape') {
                    closeMaskModal();
                    elements.imageZoomOverlay.classList.remove('show');
                    elements.historyPanel.classList.remove('show');
                }
            });

            // Canvas wheel zoom
            elements.canvasContainer.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        canvasZoomIn();
                    } else {
                        canvasZoomOut();
                    }
                }
            });
        }

        // ==========================================
        // Initialize Application
        // ==========================================
        function init() {
            loadConfig();
            initCollapsibles();
            initToggleVisibility();
            initEventListeners();
            renderGenerationHistory();
            renderDrawingHistory();
            updateCharCount();

            // Check authentication and load images from API
            checkAuthentication().then(isAuth => {
                if (isAuth) {
                    loadImagesFromRepository();
                }
            });
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
